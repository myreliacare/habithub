<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#2a1f21">
    <title>Our Life Hub</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Dancing+Script:wght@700&family=Philosopher:ital,wght@0,400;0,700;1,400&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        html {
            background: #3d2f31 !important;
            overflow-x: hidden;
        }

        body {
            background: #3d2f31 !important;
            color: #e0d2d0;
            font-family: 'Philosopher', Georgia, serif;
            font-weight: 500;
            min-height: 100vh;
            line-height: 1.6;
        }

        .container { max-width: 680px; margin: 0 auto; padding: 120px 24px 80px; width: 100%; }

        /* Sync Status */
        .sync-status {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #666;
            position: absolute;
            right: 24px;
            transition: background 0.3s;
        }
        .sync-status.synced {
            background: #a3b899;
            animation: pulse 2s infinite;
        }
        .sync-status.connecting {
            background: #999;
            animation: pulse 1s infinite;
        }
        .sync-status.error {
            background: #c9a9a6;
        }
        .sync-dot { display: none; }
        #syncText { display: none; }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        /* Container mobile overrides */
        @media (max-width: 768px) {
            .container {
                padding: 72px 16px 60px;
            }
        }

        @media (max-width: 480px) {
            .container {
                padding: 64px 10px 50px;
            }
        }

        /* Header */
        .home-header { display: flex; align-items: center; justify-content: center; gap: 20px; padding: 10px 0 24px; margin-left: -28px; }
        .header-photo-container {
            width: 110px; height: 110px; flex-shrink: 0;
            border-radius: 50%; overflow: hidden; position: relative;
            border: 2px solid rgba(163, 184, 153, 0.4);
            background: linear-gradient(145deg, #3d6b6b 0%, #1c1c1c 100%);
            transition: border-color 0.2s, box-shadow 0.2s;
        }
        .header-photo-inner { width: 100%; height: 100%; position: relative; overflow: hidden; }
        .header-photo-draggable { position: absolute; cursor: default; }
        .header-photo-draggable.editing { cursor: move; }
        .header-photo-draggable img { display: block; pointer-events: none; }
        .photo-placeholder {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            display: flex; align-items: center; justify-content: center;
            color: rgba(242, 235, 224, 0.2); font-size: 1.5rem;
            cursor: pointer;
        }
        .upload-photo-btn {
            position: absolute; bottom: 0; right: 0; width: 28px; height: 28px;
            background: #3d6b6b; border: none; border-radius: 50%; cursor: pointer;
            opacity: 0; pointer-events: none; transition: opacity 0.2s;
        }
        /* Only show upload btn when no photo exists (placeholder visible) */
        .header-photo-container:hover .upload-photo-btn.no-photo { opacity: 1; pointer-events: auto; }
        
        /* Subtle edit hint icon - always visible on photo */
        .photo-edit-hint {
            position: absolute; bottom: 4px; right: 4px; z-index: 4;
            width: 22px; height: 22px; border-radius: 50%;
            background: rgba(42, 31, 33, 0.7); 
            display: none; align-items: center; justify-content: center;
            cursor: pointer; transition: background 0.2s;
            border: 1px solid rgba(163, 184, 153, 0.3);
        }
        .photo-edit-hint.visible { display: flex; }
        .photo-edit-hint:hover { background: rgba(42, 31, 33, 0.9); border-color: rgba(163, 184, 153, 0.6); }
        .photo-edit-hint svg { width: 10px; height: 10px; fill: none; stroke: rgba(163, 184, 153, 0.6); stroke-width: 2; stroke-linecap: round; stroke-linejoin: round; }
        .header-photo-container.edit-mode .photo-edit-hint { display: none; }
        
        /* Photo edit overlay */
        .photo-edit-overlay {
            position: absolute; top: 0; left: 0; right: 0; bottom: 0;
            display: none; flex-direction: column; align-items: center; justify-content: center;
            background: rgba(0,0,0,0.5); z-index: 5; gap: 6px;
        }
        .photo-edit-overlay.visible { display: flex; }
        .photo-edit-btn {
            background: rgba(61, 107, 107, 0.9); border: none; color: #f2ebe0;
            font-size: 0.6rem; padding: 4px 8px; cursor: pointer; font-family: inherit;
            letter-spacing: 0.05em; border-radius: 2px; white-space: nowrap;
        }
        .photo-edit-btn:hover { background: rgba(61, 107, 107, 1); }
        
        /* Edit mode ring */
        .header-photo-container.edit-mode {
            border-color: rgba(163, 184, 153, 0.8);
            box-shadow: 0 0 0 2px rgba(163, 184, 153, 0.3);
        }
        .photo-edit-controls {
            display: none; position: absolute; bottom: -36px; left: 50%; transform: translateX(-50%);
            gap: 6px; z-index: 10; white-space: nowrap;
        }
        .photo-wrapper.edit-mode .photo-edit-controls { display: flex; }
        .photo-ctrl-btn {
            background: #3d6b6b; border: none; color: #f2ebe0;
            font-size: 0.65rem; padding: 5px 10px; cursor: pointer; font-family: inherit;
            border-radius: 2px; transition: background 0.2s;
        }
        .photo-ctrl-btn:hover { background: #4a7a7a; }
        .photo-ctrl-btn.done { background: #a3b899; color: #1c1c1c; font-weight: 600; }
        .home-title {
            font-family: 'Dancing Script', cursive;
            font-size: 2rem; font-weight: 700;
            letter-spacing: 0.02em; text-transform: none; color: #f2ebe0;
            margin: 0;
        }
        .home-date {
            color: rgba(163, 184, 153, 0.5);
            font-size: 0.75rem;
            margin: 2px 0 0;
            letter-spacing: 0.08em;
        }

        /* Reminder Section */
        .reminder-section {
            margin-bottom: 28px;
            padding: 8px;
            background: rgba(163, 184, 153, 0.03);
            border-radius: 2px;
        }
        .elemental-divider {
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 32px 0;
            gap: 16px;
        }
        .divider-line {
            flex: 1;
            height: 1px;
            background: linear-gradient(to right, transparent, rgba(163, 184, 153, 0.3), transparent);
        }
        .divider-icon {
            color: #a3b899;
            font-size: 0.7rem;
            opacity: 0.5;
        }
        .current-reminder {
            background: rgba(163, 184, 153, 0.08);
            border: 2px solid #a3b899;
            padding: 24px 28px;
            margin-bottom: 14px;
            display: none;
            box-shadow: 0 4px 12px rgba(163, 184, 153, 0.15);
        }
        .current-reminder.visible { display: block; }
        .reminder-content {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            gap: 20px;
            margin-bottom: 16px;
        }
        .reminder-info { flex: 1; }
        .reminder-eyebrow {
            font-size: 0.65rem; text-transform: uppercase;
            letter-spacing: 0.25em; color: #a3b899; margin-bottom: 10px;
            font-weight: 600;
        }
        .reminder-title {
            font-size: 1.25rem; color: #f2ebe0; font-weight: 500;
            margin-bottom: 6px; line-height: 1.4;
        }
        .reminder-due { font-size: 0.95rem; color: #c9a9a6; margin-bottom: 0; font-weight: 500; }
        .reminder-links { display: flex; gap: 10px; flex-direction: column; align-items: flex-end; }
        .reminder-links:empty { display: none; }
        .reminder-link {
            background: rgba(163, 184, 153, 0.2);
            border: 1px solid rgba(163, 184, 153, 0.5);
            color: #a3b899;
            padding: 10px 18px;
            text-decoration: none;
            font-size: 0.85rem;
            font-weight: 500;
            font-family: inherit;
            transition: all 0.2s ease;
            white-space: nowrap;
        }
        .reminder-link:hover {
            background: rgba(163, 184, 153, 0.3);
            border-color: #a3b899;
        }
        .reminder-actions { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .reminder-btn {
            background: transparent;
            border: 1px solid rgba(163, 184, 153, 0.5);
            color: #a3b899;
            padding: 11px 14px;
            cursor: pointer;
            font-size: 0.85rem;
            font-weight: 500;
            font-family: inherit;
            transition: all 0.2s ease;
            text-align: center;
        }
        .reminder-btn:hover {
            background: rgba(163, 184, 153, 0.2);
            border-color: #a3b899;
        }
        .reminder-btn.primary {
            background: #a3b899;
            border-color: #a3b899;
            color: #1c1c1c;
            font-weight: 600;
        }
        .reminder-btn.primary:hover {
            background: #b4c9aa;
            border-color: #b4c9aa;
        }
        .reminder-btn.subtle { border-color: rgba(224, 210, 208, 0.2); color: rgba(224, 210, 208, 0.6); }
        .reminder-btn.subtle:hover { border-color: rgba(224, 210, 208, 0.4); color: #e0d2d0; }

        .quick-add { display: flex; gap: 0; margin-bottom: 6px; }
        .quick-add input[type="text"] {
            flex: 1;
            background: rgba(61, 47, 49, 0.3);
            border: 1px solid rgba(163, 184, 153, 0.3);
            border-right: none;
            color: #f2ebe0;
            padding: 13px 16px;
            font-size: 0.9rem;
            font-family: inherit;
            transition: all 0.2s ease;
            border-radius: 0;
        }
        .quick-add input[type="text"]:focus {
            outline: none;
            border-color: rgba(163, 184, 153, 0.6);
            background: rgba(61, 47, 49, 0.5);
        }
        .quick-add input[type="text"]::placeholder { color: rgba(242, 235, 224, 0.35); font-style: italic; }
        .quick-add input[type="date"] {
            background: rgba(61, 47, 49, 0.3);
            border: 1px solid rgba(163, 184, 153, 0.3);
            border-right: none;
            color: #f2ebe0;
            padding: 13px 10px;
            font-size: 0.8rem;
            font-family: inherit;
            transition: all 0.2s ease;
            width: 130px;
            min-width: 130px;
            border-radius: 0;
            color-scheme: dark;
        }
        .quick-add input[type="date"]:focus {
            outline: none;
            border-color: rgba(163, 184, 153, 0.6);
            background: rgba(61, 47, 49, 0.5);
        }
        .quick-add button {
            background: #a3b899;
            border: 1px solid #a3b899;
            color: #1c1c1c;
            padding: 13px 18px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            font-family: inherit;
            transition: all 0.2s ease;
        }
        .quick-add button:hover { background: #b4c9aa; border-color: #b4c9aa; }
        .manage-link { 
            display: flex; 
            justify-content: space-between; 
            align-items: center;
        }
        .manage-link button {
            background: transparent; border: none;
            color: rgba(242, 235, 224, 0.4); font-size: 0.7rem;
            font-family: inherit; cursor: pointer;
            letter-spacing: 0.1em; text-transform: uppercase;
            padding: 6px 0; transition: color 0.2s ease;
        }
        .manage-link button:hover { color: rgba(242, 235, 224, 0.7); }

        /* Navigation */
        .nav-buttons { display: flex; gap: 12px; margin-bottom: 12px; }
        .hub-nav-btn {
            flex: 1; background: transparent;
            border: 1px solid rgba(201, 169, 166, 0.5); color: #c9a9a6;
            text-decoration: none; padding: 14px 20px; text-align: center;
            font-size: 0.85rem; font-family: inherit;
            transition: all 0.2s ease; letter-spacing: 0.05em;
        }
        .hub-nav-btn:hover { border-color: rgba(201, 169, 166, 0.8); background: rgba(201, 169, 166, 0.1); }
        .hub-nav-btn.charlie { color: #a3b899; border-color: rgba(163, 184, 153, 0.5); }
        .hub-nav-btn.charlie:hover { border-color: rgba(163, 184, 153, 0.8); background: rgba(163, 184, 153, 0.1); }
        .hub-nav-btn.dreams {
            display: block; width: 100%;
            background: transparent; border: 1px solid rgba(242, 235, 224, 0.4);
            color: #f2ebe0; margin-bottom: 24px;
        }
        .hub-nav-btn.dreams:hover { background: rgba(242, 235, 224, 0.1); border-color: #f2ebe0; }

        /* Section Cards */
        .section {
            background: #2a1f21;
            border: 1px solid rgba(61, 107, 107, 0.25);
            padding: 22px; margin-bottom: 20px;
        }
        .section-title {
            font-size: 0.65rem; font-weight: 400;
            letter-spacing: 0.2em; text-transform: uppercase;
            color: #3d6b6b; margin-bottom: 16px;
        }

        /* Calendar */
        .calendar-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; flex-wrap: wrap; gap: 10px; }
        .calendar-nav { display: flex; align-items: center; gap: 12px; }
        .calendar-nav button {
            background: transparent; border: 1px solid rgba(61, 107, 107, 0.4);
            color: #a3b899; padding: 8px 14px; cursor: pointer;
            font-size: 0.8rem; font-family: inherit; transition: all 0.2s;
        }
        .calendar-nav button:hover { background: rgba(61, 107, 107, 0.15); }
        .calendar-title { color: #f2ebe0; font-size: 1rem; letter-spacing: 0.1em; }
        .calendar-view-toggle { display: flex; gap: 8px; }
        .view-toggle-btn {
            background: transparent; border: 1px solid rgba(61, 107, 107, 0.3);
            color: rgba(163, 184, 153, 0.7); padding: 6px 12px; cursor: pointer;
            font-size: 0.75rem; font-family: inherit; transition: all 0.2s;
        }
        .view-toggle-btn:hover { border-color: rgba(61, 107, 107, 0.5); color: #a3b899; }
        .view-toggle-btn.active { background: rgba(61, 107, 107, 0.2); border-color: #3d6b6b; color: #a3b899; }
        .view-toggle {
            background: transparent; border: 1px solid rgba(61, 107, 107, 0.3);
            color: rgba(163, 184, 153, 0.7); padding: 6px 12px; cursor: pointer;
            font-size: 0.75rem; font-family: inherit; transition: all 0.2s;
        }
        .view-toggle:hover { border-color: rgba(61, 107, 107, 0.5); color: #a3b899; }
        .view-toggle.active { background: rgba(61, 107, 107, 0.2); border-color: #3d6b6b; color: #a3b899; }
        
        /* Month Grid */
        .calendar-grid {
            display: grid; grid-template-columns: repeat(7, 1fr); gap: 2px;
        }
        .calendar-day-header {
            background: rgba(61, 107, 107, 0.2); padding: 8px 4px;
            text-align: center; font-size: 0.7rem; color: #a3b899;
            text-transform: uppercase; letter-spacing: 0.1em;
        }
        .calendar-month-day {
            background: #2a1f21; padding: 8px;
            min-height: 70px; cursor: pointer; transition: all 0.2s;
            border: 1px solid transparent;
        }
        .calendar-month-day:hover { background: #2a1f21; border-color: rgba(61, 107, 107, 0.3); }
        .calendar-month-day.today { background: rgba(61, 107, 107, 0.15); border-color: #3d6b6b; }
        .calendar-month-day.other-month { opacity: 0.4; }
        .calendar-month-day .day-number {
            font-size: 0.9rem; color: #f2ebe0; margin-bottom: 4px;
         font-weight: 600;}
        .calendar-month-day.today .day-number { color: #a3b899; font-weight: 700; }
        .calendar-month-day .day-count {
            font-size: 0.7rem; color: #c9a9a6; 
        }
        .calendar-month-day .day-dot {
            width: 6px; height: 6px; background: #a3b899; border-radius: 50%;
            display: inline-block; margin-right: 3px;
        }
        
        /* List view days (2-day and week) */
        .calendar-day {
            background: #2a1f21; padding: 12px;
            border: 1px solid rgba(61, 107, 107, 0.15); min-height: 80px;
            margin-bottom: 8px;
        }
        .calendar-day.today { border-color: #3d6b6b; background: rgba(61, 107, 107, 0.1); }
        .calendar-date { font-size: 0.85rem; color: #a3b899; margin-bottom: 10px; font-weight: 400; }
        .calendar-event {
            background: rgba(163, 184, 153, 0.2); padding: 8px 12px;
            margin-bottom: 6px; font-size: 0.85rem; color: #f2ebe0;
            border-left: 2px solid #a3b899; cursor: pointer;
            display: flex; justify-content: space-between; align-items: center;
        }
        .calendar-event:hover { background: rgba(163, 184, 153, 0.3); }
        .calendar-event-time { font-size: 0.75rem; color: #c9a9a6; }
        .no-events { color: rgba(242, 235, 224, 0.4); font-size: 0.85rem; font-style: italic; }
        
        /* List view styles (2-day and week) */
        .week-day {
            background: #2a1f21; padding: 16px;
            border: 1px solid rgba(61, 107, 107, 0.15); margin-bottom: 12px;
        }
        .week-day.today { border-color: #3d6b6b; background: rgba(61, 107, 107, 0.1); }
        .week-day-header {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 12px; padding-bottom: 10px;
            border-bottom: 1px solid rgba(61, 107, 107, 0.15);
        }
        .week-day-name { color: #f2ebe0; font-size: 0.95rem;  font-weight: 600;}
        .week-day-date { color: #a3b899; font-size: 0.85rem; }
        .event-item {
            display: flex; justify-content: space-between; align-items: flex-start;
            background: rgba(163, 184, 153, 0.15); padding: 10px 14px;
            margin-bottom: 8px; border-left: 2px solid #a3b899;
        }
        .event-title { color: #f2ebe0; font-size: 0.9rem; margin-bottom: 2px; font-weight: 600; }
        .event-note { color: rgba(242, 235, 224, 0.5); font-size: 0.8rem; font-style: italic; }

        /* Event check-off heart */
        .event-check {
            background: transparent; border: none;
            cursor: pointer; margin-right: 10px; margin-top: 1px;
            flex-shrink: 0; padding: 0;
            font-size: 1rem; line-height: 1;
            transition: transform 0.2s ease;
            min-height: auto; min-width: auto;
        }
        .event-check::after { content: '♡'; color: rgba(201, 169, 166, 0.4); }
        .event-check:hover::after { color: rgba(201, 169, 166, 0.7); }
        .event-check.checked::after { content: '♥'; color: #c9a9a6; }
        .event-check.checked:hover::after { color: #c9a9a6; }
        .event-check.checked { transform: scale(1.1); }
        .event-item.done { opacity: 0.45; }
        .event-item.done .event-title { text-decoration: line-through; }
        .event-item.done .event-note { text-decoration: line-through; }
        
        /* Event Action Buttons */
        .event-actions {
            display: flex;
            gap: 6px;
            flex-shrink: 0;
        }
        .event-edit-btn, .event-delete-btn {
            padding: 6px 12px;
            font-size: 0.75rem;
            border: 1px solid;
            background: transparent;
            cursor: pointer;
            font-family: inherit;
            transition: all 0.2s ease;
            font-weight: 500;
        }
        .event-edit-btn {
            color: #a3b899;
            border-color: #a3b899;
        }
        .event-edit-btn:hover {
            background: rgba(163, 184, 153, 0.2);
        }
        .event-delete-btn {
            color: #c9a9a6;
            border-color: #c9a9a6;
        }
        .event-delete-btn:hover {
            background: rgba(201, 169, 166, 0.2);
        }
        
        /* CRM Event Styles */
        .crm-event {
            background: rgba(61, 107, 107, 0.15) !important;
            border-left-color: #3d6b6b !important;
        }
        
        .empty-state { color: rgba(242, 235, 224, 0.4); font-size: 0.85rem; font-style: italic; padding: 8px 0; }
        
        /* Day Detail Modal */
        .day-modal-overlay {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0, 0, 0, 0.7); z-index: 2000;
            display: none; align-items: center; justify-content: center;
            padding: 20px;
        }
        .day-modal-overlay.visible { display: flex; }
        
        /* Add Event Modal */
        .modal-overlay {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0, 0, 0, 0.7); z-index: 2000;
            display: none; align-items: center; justify-content: center;
            padding: 20px;
        }
        .modal-overlay.visible { display: flex; }
        .modal {
            background: #3d2f31; border: 1px solid rgba(61, 107, 107, 0.4);
            width: 100%; max-width: 550px; max-height: 85vh;
            overflow-y: auto; border-radius: 4px;
        }
        .modal-header {
            display: flex; justify-content: space-between; align-items: center;
            padding: 20px 24px;
            border-bottom: 1px solid rgba(61, 107, 107, 0.2);
        }
        .modal-title { font-size: 1.2rem; color: #f2ebe0; font-weight: 600; }
        .modal-close {
            background: transparent; border: none; color: #c9a9a6;
            font-size: 1.8rem; cursor: pointer; padding: 0; line-height: 1;
        }
        .modal-close:hover { color: #f2ebe0; }
        .modal-body { padding: 24px; }
        
        .day-modal {
            background: #3d2f31; border: 1px solid rgba(61, 107, 107, 0.4);
            width: 100%; max-width: 500px; max-height: 80vh;
            overflow-y: auto; padding: 24px;
        }
        .day-modal-header {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 20px; padding-bottom: 12px;
            border-bottom: 1px solid rgba(61, 107, 107, 0.2);
        }
        .day-modal-title { font-size: 1.1rem; color: #f2ebe0; }
        .day-modal-close {
            background: transparent; border: none; color: #c9a9a6;
            font-size: 1.5rem; cursor: pointer; padding: 0; line-height: 1;
        }
        .day-modal-close:hover { color: #f2ebe0; }
        .day-modal-events { margin-bottom: 20px; }
        .day-modal-event {
            background: #2a1f21; padding: 14px;
            margin-bottom: 10px; border-left: 2px solid #a3b899;
        }
        .day-modal-event-header {
            display: flex; justify-content: space-between; align-items: flex-start;
            margin-bottom: 6px;
        }
        .day-modal-event-title { color: #f2ebe0; font-size: 0.95rem; }
        .day-modal-event-actions { display: flex; gap: 8px; }
        .day-modal-event-actions button {
            background: transparent; border: none; cursor: pointer;
            font-size: 0.75rem; padding: 2px 6px; transition: color 0.2s;
        }
        .day-modal-edit { color: rgba(163, 184, 153, 0.6); }
        .day-modal-edit:hover { color: #a3b899; }
        .day-modal-delete { color: rgba(201, 169, 166, 0.5); }
        .day-modal-delete:hover { color: #c9a9a6; }
        .day-modal-event-time { font-size: 0.8rem; color: #c9a9a6; margin-bottom: 4px; }
        .day-modal-event-note { font-size: 0.85rem; color: rgba(242, 235, 224, 0.6); font-style: italic; }
        .day-modal-empty { color: rgba(242, 235, 224, 0.4); font-style: italic; padding: 20px 0; text-align: center; }
        .day-modal-add {
            width: 100%; background: transparent;
            border: 1px solid rgba(61, 107, 107, 0.4); color: #3d6b6b;
            padding: 12px; cursor: pointer; font-size: 0.85rem;
            font-family: inherit; transition: all 0.2s;
        }
        .day-modal-add:hover { background: rgba(61, 107, 107, 0.1); border-color: #3d6b6b; }
        
        /* Edit form in modal */
        .day-modal-form { display: none; margin-top: 16px; padding-top: 16px; border-top: 1px solid rgba(61, 107, 107, 0.2); }
        .day-modal-form.visible { display: block; }
        .day-modal-form input, .day-modal-form textarea {
            width: 100%; background: #2a1f21;
            border: 1px solid rgba(61, 107, 107, 0.25); color: #f2ebe0;
            padding: 10px 12px; font-size: 0.9rem; font-family: inherit;
            margin-bottom: 10px;
        }
        .day-modal-form input:focus, .day-modal-form textarea:focus {
            outline: none; border-color: rgba(61, 107, 107, 0.5);
        }
        .day-modal-form-row { display: flex; gap: 10px; }
        .day-modal-form-row input { flex: 1; }
        .day-modal-form-actions { display: flex; gap: 10px; justify-content: flex-end; margin-top: 10px; }
        
        /* Reminder Management Modal */
        .reminder-modal-overlay {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0, 0, 0, 0.7); z-index: 2000;
            display: none; align-items: center; justify-content: center;
            padding: 20px;
        }
        .reminder-modal-overlay.visible { display: flex; }
        .reminder-modal {
            background: #3d2f31; border: 1px solid rgba(61, 107, 107, 0.4);
            width: 100%; max-width: 550px; max-height: 85vh;
            overflow-y: auto; padding: 24px;
        }
        .reminder-modal-header {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 20px; padding-bottom: 12px;
            border-bottom: 1px solid rgba(61, 107, 107, 0.2);
        }
        .reminder-modal-title { font-size: 1.1rem; color: #f2ebe0; }
        .reminder-modal-close {
            background: transparent; border: none; color: #c9a9a6;
            font-size: 1.5rem; cursor: pointer; padding: 0; line-height: 1;
        }
        .reminder-modal-close:hover { color: #f2ebe0; }
        .reminder-list { margin-bottom: 20px; }
        .reminder-list-item {
            background: rgba(163, 184, 153, 0.08);
            padding: 16px;
            margin-bottom: 12px;
            border-left: 3px solid #a3b899;
            border: 1px solid rgba(163, 184, 153, 0.25);
            border-left: 3px solid #a3b899;
            transition: all 0.2s ease;
        }
        .reminder-list-item:hover {
            background: rgba(163, 184, 153, 0.12);
            border-color: rgba(163, 184, 153, 0.4);
        }
        .reminder-list-item.overdue {
            border-left-color: #c9a9a6;
            background: rgba(201, 169, 166, 0.08);
        }
        .reminder-list-item.overdue:hover {
            background: rgba(201, 169, 166, 0.12);
        }
        .reminder-list-header {
            display: flex; justify-content: space-between; align-items: flex-start;
            margin-bottom: 8px;
        }
        .reminder-list-title { color: #f2ebe0; font-size: 0.95rem; flex: 1; }
        .reminder-list-actions { display: flex; gap: 8px; }
        .reminder-list-actions button {
            background: transparent; border: none; cursor: pointer;
            font-size: 0.75rem; padding: 2px 6px; transition: color 0.2s;
        }
        .reminder-edit-btn { color: rgba(163, 184, 153, 0.6); }
        .reminder-edit-btn:hover { color: #a3b899; }
        .reminder-delete-btn { color: rgba(201, 169, 166, 0.5); }
        .reminder-delete-btn:hover { color: #c9a9a6; }
        .reminder-list-meta { font-size: 0.8rem; color: rgba(242, 235, 224, 0.5); display: flex; flex-wrap: wrap; gap: 4px; }
        .reminder-list-meta span { margin-right: 12px; }
        .reminder-list-link { 
            display: inline-block; margin-top: 6px;
            font-size: 0.8rem; color: #3d6b6b; 
        }
        .reminder-list-link:hover { color: #5a9a9a; }
        .reminder-add-form {
            background: #2a1f21; padding: 16px;
            margin-bottom: 16px; border: 1px solid rgba(61, 107, 107, 0.2);
        }
        .reminder-add-form h4 {
            color: #a3b899; font-size: 0.8rem; margin-bottom: 12px;
            text-transform: uppercase; letter-spacing: 0.1em;
        }
        .reminder-form-row { margin-bottom: 10px; }
        .reminder-form-row label {
            display: block; font-size: 0.75rem; color: rgba(242, 235, 224, 0.6);
            margin-bottom: 4px;
        }
        .reminder-form-row input, .reminder-form-row select {
            width: 100%; background: #2a1f21;
            border: 1px solid rgba(61, 107, 107, 0.25); color: #f2ebe0;
            padding: 10px 12px; font-size: 0.9rem; font-family: inherit;
        }
        .reminder-form-row input:focus, .reminder-form-row select:focus {
            outline: none; border-color: rgba(61, 107, 107, 0.5);
        }
        .reminder-form-row input::placeholder { color: rgba(242, 235, 224, 0.4); }
        .reminder-form-inline { display: flex; gap: 10px; }
        .reminder-form-inline > div { flex: 1; }
        .reminder-form-actions { display: flex; gap: 10px; justify-content: flex-end; margin-top: 14px; }
        .reminder-empty { 
            color: rgba(242, 235, 224, 0.4); font-style: italic; 
            text-align: center; padding: 30px 0; 
        }
        
        .add-event-btn {
            width: 100%; background: transparent;
            border: 1px solid rgba(61, 107, 107, 0.3); color: #3d6b6b;
            padding: 12px; margin-top: 16px; cursor: pointer;
            font-size: 0.85rem; font-family: inherit; transition: all 0.2s;
        }
        .add-event-btn:hover { background: rgba(61, 107, 107, 0.1); border-color: rgba(61, 107, 107, 0.5); }
        .form-group { margin-bottom: 16px; }
        .form-group label { display: block; font-size: 0.75rem; color: #a3b899; margin-bottom: 6px; text-transform: uppercase; letter-spacing: 0.1em; }
        .form-group input, .form-group select, .form-group textarea {
            width: 100%; max-width: 100%; background: #2a1f21;
            border: 1px solid rgba(61, 107, 107, 0.25); color: #f2ebe0;
            padding: 10px 12px; font-size: 0.9rem; font-family: inherit;
        }
        .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
            outline: none; border-color: rgba(61, 107, 107, 0.5);
        }
        .form-actions { display: flex; gap: 10px; justify-content: flex-end; }
        .cancel-btn {
            background: transparent !important;
            border: 1px solid rgba(163, 184, 153, 0.3) !important;
            color: rgba(242, 235, 224, 0.6) !important;
        }
        .cancel-btn:hover {
            background: rgba(163, 184, 153, 0.1) !important;
            color: #f2ebe0 !important;
        }
        .btn {
            background: #3d6b6b; border: none; color: #f2ebe0;
            padding: 10px 20px; cursor: pointer; font-size: 0.85rem;
            font-family: inherit; transition: background 0.2s;
        }
        .btn:hover { background: #4a7a7a; }
        .repeat-mode { display: none; }

        /* Grocery */
        .grocery-item {
            display: flex; align-items: center; flex-direction: row-reverse;
            padding: 10px 14px;
            background: rgba(61, 47, 49, 0.3);
            border: 1px solid rgba(61, 107, 107, 0.2);
            margin-bottom: 6px;
            gap: 12px;
            transition: all 0.6s ease;
        }
        .grocery-item:hover {
            background: rgba(61, 47, 49, 0.5);
            border-color: rgba(163, 184, 153, 0.3);
        }
        .grocery-item.done span {
            text-decoration: line-through;
            color: #7ba886;
        }
        .grocery-item.fading {
            opacity: 0;
            transform: translateX(-20px);
        }
        .grocery-item:last-of-type { margin-bottom: 0; }
        .grocery-item input[type="checkbox"] {
            width: 18px; height: 18px;
            accent-color: #a3b899;
            cursor: pointer;
            flex-shrink: 0;
        }
        .grocery-item span {
            flex: 1;
            color: #f2ebe0;
            font-size: 0.88rem;
            line-height: 1.4;
        }
        .add-input { display: flex; gap: 8px; margin-top: 16px; }
        .add-input input {
            flex: 1;
            background: rgba(61, 47, 49, 0.3);
            border: 1px solid rgba(163, 184, 153, 0.25);
            color: #f2ebe0;
            padding: 13px 16px;
            font-size: 0.95rem;
            font-family: inherit;
            transition: all 0.2s ease;
        }
        .add-input input:focus {
            outline: none;
            background: rgba(61, 47, 49, 0.5);
            border-color: rgba(163, 184, 153, 0.5);
        }
        .add-input input::placeholder { color: rgba(242, 235, 224, 0.35); }
        .add-input button {
            background: #a3b899;
            border: 1px solid #a3b899;
            color: #1c1c1c;
            padding: 13px 20px;
            cursor: pointer;
            font-size: 1.1rem;
            font-weight: 600;
            transition: all 0.2s ease;
        }
        .add-input button:hover {
            background: #b4c9aa;
            border-color: #b4c9aa;
        }

        /* Phone Book */
        .phonebook-header { display: flex; justify-content: space-between; align-items: center; cursor: pointer; }
        .expand-icon { color: rgba(61, 107, 107, 0.5); font-size: 0.65rem; transition: transform 0.3s; }
        .phonebook-content { max-height: 0; overflow: hidden; transition: max-height 0.3s ease; }
        .phonebook-content.expanded { max-height: 10000px; }
        .collapsible-header { display: flex; justify-content: space-between; align-items: center; cursor: pointer; }
        .collapsible-content { max-height: 0; overflow: hidden; transition: max-height 0.3s ease; }
        .collapsible-content.expanded { max-height: 10000px; }
        .phonebook-search { margin: 16px 0 12px; }
        .phonebook-search input {
            width: 100%; background: #2a1f21;
            border: 1px solid rgba(61, 107, 107, 0.2); color: #f2ebe0;
            padding: 10px 14px; font-size: 0.85rem; font-family: inherit;
        }
        .phonebook-search input:focus { outline: none; border-color: rgba(61, 107, 107, 0.4); }
        .phonebook-search input::placeholder { color: rgba(242, 235, 224, 0.3); }
        .contact {
            background: #2a1f21; padding: 14px;
            margin-bottom: 8px; border-left: 2px solid #3d6b6b;
        }
        .contact-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 8px; }
        .contact-name { color: #f2ebe0; font-size: 0.95rem; }
        .contact-actions { display: flex; gap: 6px; }
        .contact-edit-btn, .contact-delete-btn {
            background: transparent; border: none; cursor: pointer;
            font-size: 0.75rem; font-family: inherit; padding: 2px 6px; transition: color 0.2s;
        }
        .contact-edit-btn { color: rgba(163, 184, 153, 0.5); }
        .contact-edit-btn:hover { color: #a3b899; }
        .contact-delete-btn { color: rgba(201, 169, 166, 0.4); }
        .contact-delete-btn:hover { color: #c9a9a6; }
        .contact-links { display: flex; flex-wrap: wrap; gap: 8px; }
        .contact-link {
            background: rgba(61, 107, 107, 0.15); color: #3d6b6b;
            padding: 7px 12px; text-decoration: none;
            font-size: 0.8rem; transition: all 0.2s ease;
        }
        .contact-link:hover { background: rgba(61, 107, 107, 0.25); }
        .contact-link.phone { background: rgba(201, 169, 166, 0.15); color: #c9a9a6; }
        .contact-link.phone:hover { background: rgba(201, 169, 166, 0.25); }
        .contact-notes {
            margin-top: 10px; padding-top: 10px;
            border-top: 1px solid rgba(61, 107, 107, 0.1);
            color: rgba(242, 235, 224, 0.5); font-size: 0.8rem; font-style: italic;
        }
        .add-contact-btn {
            width: 100%; background: transparent;
            border: 1px solid rgba(61, 107, 107, 0.3); color: #3d6b6b;
            padding: 12px; cursor: pointer; font-size: 0.85rem;
            font-family: inherit; margin-top: 8px; transition: all 0.2s;
        }
        .add-contact-btn:hover { background: rgba(61, 107, 107, 0.1); border-color: rgba(61, 107, 107, 0.5); }
        .add-contact-form {
            display: none; background: #2a1f21;
            padding: 16px; margin-top: 12px;
        }
        .add-contact-form.visible { display: block; }
        .add-contact-form input, .add-contact-form textarea {
            width: 100%; background: #2a1f21;
            border: 1px solid rgba(61, 107, 107, 0.2); color: #f2ebe0;
            padding: 10px 12px; font-size: 0.85rem; font-family: inherit; margin-bottom: 10px;
        }
        .add-contact-form input:focus, .add-contact-form textarea:focus { outline: none; border-color: rgba(61, 107, 107, 0.4); }
        .add-contact-form textarea { min-height: 60px; resize: vertical; }
        .add-contact-form .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .save-contact-btn {
            background: #3d6b6b; border: none; color: #f2ebe0;
            padding: 10px 16px; cursor: pointer; font-size: 0.85rem;
            font-family: inherit; transition: background 0.2s;
        }
        .save-contact-btn:hover { background: #4a7a7a; }
        .cancel-contact-btn {
            background: transparent; border: 1px solid rgba(201, 169, 166, 0.3);
            color: #c9a9a6; padding: 10px 16px; cursor: pointer;
            font-size: 0.85rem; font-family: inherit; transition: all 0.2s;
        }
        .cancel-contact-btn:hover { border-color: rgba(201, 169, 166, 0.5); }

        /* Responsive */
        @media (max-width: 600px) {
            .nav-buttons { flex-direction: column; }
            .reminder-content { flex-direction: column; gap: 12px; }
            .reminder-links { align-items: flex-start; flex-direction: row; flex-wrap: wrap; }
            .reminder-actions { grid-template-columns: 1fr 1fr; gap: 8px; }
            .reminder-btn { width: 100%; text-align: center; padding: 12px 6px; font-size: 0.78rem; white-space: nowrap; overflow: visible; }
            .add-contact-form .form-row { grid-template-columns: 1fr; }
            .calendar-header { flex-direction: column; align-items: stretch; }
            .calendar-view-toggle { width: 100%; }
            .view-toggle-btn { flex: 1; text-align: center; }

            /* Section cards */
            .section { padding: 16px; margin-bottom: 14px; }

            /* Reminder section */
            .current-reminder { padding: 16px 14px; }
            .reminder-title { font-size: 1.1rem; }
            .reminder-link { padding: 10px 14px; font-size: 0.8rem; }

            /* Calendar month grid - tighter on mobile */
            .calendar-month-day { padding: 5px; min-height: 52px; }
            .calendar-month-day .day-number { font-size: 0.8rem; }
            .calendar-month-day .day-count { font-size: 0.6rem; }
            .calendar-month-day .day-dot { width: 4px; height: 4px; }
            .calendar-day-header { padding: 6px 2px; font-size: 0.6rem; }
            .calendar-nav button { padding: 8px 10px; font-size: 0.75rem; }
            .calendar-title { font-size: 0.9rem; }

            /* Week/two-day view */
            .week-day { padding: 12px; }
            .week-day-name { font-size: 0.85rem; }
            .week-day-date { font-size: 0.8rem; }
            .event-item { padding: 8px 10px; flex-wrap: wrap; gap: 6px; }
            .event-title { font-size: 0.85rem; }
            .event-actions { gap: 4px; }
            .event-edit-btn, .event-delete-btn { padding: 6px 8px; font-size: 0.7rem; }

            /* Modals */
            .modal { max-width: 100%; border-radius: 4px; }
            .modal-header { padding: 16px; }
            .modal-body { padding: 16px; }
            .modal-title { font-size: 1.05rem; }
            .day-modal { padding: 16px; max-width: 100%; }
            .day-modal-overlay, .modal-overlay, .reminder-modal-overlay { padding: 10px; }
            .reminder-modal { padding: 16px; max-width: 100%; }
            .reminder-form-inline { flex-direction: column; gap: 0; }

            /* Grocery */
            .grocery-item { padding: 8px 12px; }
            .grocery-item span { font-size: 0.82rem; }
            .add-input input { padding: 12px; font-size: 0.9rem; }
            .add-input button { padding: 12px 16px; }
            .quick-add input[type="text"] { padding: 12px; font-size: 0.85rem; }
            .quick-add input[type="date"] { padding: 12px 8px; font-size: 0.75rem; width: 105px; min-width: 105px; }
            .quick-add button { padding: 12px 14px; }
            .quick-add { flex-wrap: wrap; }
            .quick-add input[type="text"] { flex: 1 1 100%; border-right: 1px solid rgba(163, 184, 153, 0.3); }
            .quick-add input[type="date"] { flex: 1 1 auto; border-right: none; }
            .quick-add button { flex: 0 0 auto; }

            /* Center calendar nav */
            .calendar-nav { justify-content: center; width: 100%; }
            .calendar-view-toggle { justify-content: center; }

            /* Phone book */
            .contact { padding: 12px; }
            .contact-name { font-size: 0.9rem; }
            .contact-links { gap: 6px; }
            .contact-link { padding: 8px 10px; font-size: 0.75rem; }
            .add-contact-form input, .add-contact-form textarea { font-size: 0.85rem; padding: 10px; }

            /* Elemental divider */
            .elemental-divider { margin: 20px 0; }

            /* Home header */
            .home-title { font-size: 1.6rem; letter-spacing: 0.02em; }
            .header-photo-container { width: 85px; height: 85px; }
        }

        /* Extra small screens */
        @media (max-width: 380px) {
            .section { padding: 12px; }
            .current-reminder { padding: 14px 12px; }
            .reminder-title { font-size: 1rem; }
            .reminder-actions { grid-template-columns: 1fr; }
            .calendar-month-day { padding: 3px; min-height: 44px; }
            .calendar-month-day .day-number { font-size: 0.75rem; }
            .home-title { font-size: 1.4rem; letter-spacing: 0.02em; }
            .event-item { flex-direction: column; align-items: flex-start; }
            .event-actions { align-self: flex-end; }
        }
    

/* ===== APP-LIKE BEHAVIOR ===== */
html {
    overflow-x: hidden;
    overflow-y: scroll;
    overscroll-behavior: none;
    -webkit-text-size-adjust: 100%;
    min-height: 100%;
    scroll-behavior: smooth;
    background: #3d2f31 !important;
}

* {
    -webkit-tap-highlight-color: transparent;
}

body {
    -webkit-font-smoothing: antialiased;
    -moz-osx-font-smoothing: grayscale;
    overscroll-behavior-y: contain;
    -webkit-overflow-scrolling: touch;
    min-height: 100%;
    min-height: 100dvh;
}

/* Prevent pull-to-refresh on mobile */
body.nav-open {
    overflow: hidden;
    position: fixed;
    width: 100%;
}

/* No text select on interactive elements */
button, .btn, .nav-link, .nav-link-mobile, .nav-logo, .nav-hamburger,
select, .tab, .view-toggle-btn, .hub-nav-btn, label {
    -webkit-user-select: none;
    user-select: none;
}

/* Smooth touch scrolling for scrollable containers */
.scrollable, .container {
    -webkit-overflow-scrolling: touch;
}

/* Better touch targets - minimum 44px */
button, .btn, a.nav-link, .nav-link-mobile, select, input[type="checkbox"] {
    min-height: 44px;
    min-width: 44px;
}

a.nav-link {
    display: inline-flex;
    align-items: center;
}

/* Safe area insets for notched phones */
.top-nav {
    padding-top: env(safe-area-inset-top) !important;
    padding-left: max(16px, env(safe-area-inset-left)) !important;
    padding-right: max(16px, env(safe-area-inset-right)) !important;
}

.container {
    padding-left: max(16px, env(safe-area-inset-left));
    padding-right: max(16px, env(safe-area-inset-right));
    padding-bottom: max(40px, env(safe-area-inset-bottom));
}

/* Active states for touch feedback */
button:active, .btn:active, .nav-link-mobile:active {
    opacity: 0.7;
    transition: opacity 0.05s;
}

/* Smoother page transitions feel */
.section, .card, [class*="card"], [class*="section"] {
    transform: translateZ(0);
    will-change: auto;
}

/* Input focus styles - more app-like */
input:focus, textarea:focus, select:focus {
    outline: none;
}

/* Disable long-press context menu on interactive elements (mobile) */
button, .btn, a, .nav-refresh {
        display: block;
        background: none;
        border: none;
        color: #b59197;
        font-size: 1.4rem;
        cursor: pointer;
        padding: 2px 0;
        z-index: 10001;
        line-height: 1;
    }
    .nav-refresh:active {
        transform: rotate(180deg);
        transition: transform 0.3s;
    }
    .nav-hamburger {
    -webkit-touch-callout: none;
}

@media (max-width: 768px) {
    /* Account for safe area in nav height */
    .top-nav {
        padding-top: env(safe-area-inset-top) !important;
    }
}
/* ===== END APP-LIKE BEHAVIOR ===== */

/* ===== UNIFIED NAV BAR ===== */
.top-nav {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    background: #2a1f21;
    border-bottom: 1px solid rgba(163, 184, 153, 0.2);
    z-index: 9999;
    padding: 0 24px;
    font-family: 'Philosopher', Georgia, serif;
}

.nav-container {
    max-width: 1200px;
    margin: 0 auto;
    display: flex;
    align-items: center;
    justify-content: space-between;
    height: 56px;
}

.nav-logo {
    font-size: 1.1rem;
    font-weight: 700;
    color: #a3b899;
    text-decoration: none;
    letter-spacing: 0.03em;
    white-space: nowrap;
}

.nav-links {
    display: flex;
    gap: 28px;
    align-items: center;
}

.nav-link {
    color: rgba(242, 235, 224, 0.6);
    text-decoration: none;
    font-size: 0.88rem;
    transition: color 0.2s;
    font-weight: 500;
    letter-spacing: 0.02em;
    white-space: nowrap;
}

.nav-link:hover {
    color: #f2ebe0;
}

.nav-link.active {
    color: #a3b899;
}

/* Hamburger Button */
.nav-hamburger {
    display: none;
    background: none;
    border: none;
    cursor: pointer;
    padding: 6px;
    z-index: 10001;
}

.nav-hamburger span {
    display: block;
    width: 22px;
    height: 2px;
    background: #a3b899;
    margin: 5px 0;
    transition: all 0.3s ease;
    border-radius: 1px;
}

.nav-hamburger.open span:nth-child(1) {
    transform: rotate(45deg) translate(5px, 5px);
}

.nav-hamburger.open span:nth-child(2) {
    opacity: 0;
}

.nav-hamburger.open span:nth-child(3) {
    transform: rotate(-45deg) translate(5px, -5px);
}

/* Mobile Overlay */
.nav-overlay {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: #2a1f21;
    z-index: 9998;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    gap: 8px;
    opacity: 0;
    transition: opacity 0.3s ease;
}

.nav-overlay.open {
    display: flex;
    opacity: 1;
}

.nav-overlay .nav-link-mobile {
    color: rgba(242, 235, 224, 0.6);
    text-decoration: none;
    font-size: 1.3rem;
    font-family: 'Philosopher', Georgia, serif;
    font-weight: 500;
    padding: 14px 40px;
    transition: color 0.2s;
    letter-spacing: 0.05em;
}

.nav-overlay .nav-link-mobile:hover {
    color: #f2ebe0;
}

.nav-overlay .nav-link-mobile.active {
    color: #a3b899;
}

@media (max-width: 768px) {
    .nav-hamburger {
        display: block;
    }

    .nav-links {
        display: none;
    }

    .nav-container {
        height: 52px;
    }

    .nav-logo {
        font-size: 0.95rem;
    }

    .top-nav {
        padding: 0 16px;
    }
}

@media (max-width: 480px) {
    .nav-container {
        height: 48px;
    }

    .nav-logo {
        font-size: 0.88rem;
    }

    .top-nav {
        padding: 0 12px;
    }

    .nav-overlay .nav-link-mobile {
        font-size: 1.15rem;
        padding: 12px 40px;
    }
}
/* ===== END UNIFIED NAV BAR ===== */


        /* ===== NAV OVERRIDE - GOLD STANDARD ===== */
        .top-nav {
            position: fixed !important;
            top: 0 !important; left: 0 !important; right: 0 !important;
            background: #2a1f21 !important;
            border-bottom: 1px solid rgba(163, 184, 153, 0.2) !important;
            z-index: 9999 !important;
            padding: 0 24px !important;
            font-family: 'Philosopher', Georgia, serif !important;
        }
        .nav-container {
            max-width: 1200px !important;
            margin: 0 auto !important;
            display: flex !important;
            align-items: center !important;
            justify-content: space-between !important;
            height: 56px !important;
        }
        .nav-logo {
            font-size: 1.1rem !important;
            font-weight: 700 !important;
            color: #a3b899 !important;
            text-decoration: none !important;
            white-space: nowrap !important;
        }
        .nav-links { display: flex !important; gap: 28px !important; align-items: center !important; }
        .nav-link {
            color: rgba(242, 235, 224, 0.6) !important;
            text-decoration: none !important;
            font-size: 0.88rem !important;
            font-weight: 500 !important;
            white-space: nowrap !important;
            transition: color 0.2s !important;
            letter-spacing: normal !important;
            display: inline !important;
            min-height: auto !important;
            min-width: auto !important;
        }
        .nav-link:hover { color: #f2ebe0 !important; }
        .nav-link.active { color: #a3b899 !important; }
        .nav-hamburger {
            display: none !important;
            background: none !important;
            border: none !important;
            cursor: pointer !important;
            padding: 10px !important;
            z-index: 10001 !important;
        }
        .nav-hamburger span {
            display: block !important; width: 24px !important; height: 2px !important;
            background: #a3b899 !important; margin: 5px 0 !important;
            transition: all 0.3s ease !important;
            border-radius: 0 !important;
        }
        .nav-hamburger.open span:nth-child(1) { transform: rotate(45deg) translate(5px, 5px) !important; }
        .nav-hamburger.open span:nth-child(2) { opacity: 0 !important; }
        .nav-hamburger.open span:nth-child(3) { transform: rotate(-45deg) translate(5px, -5px) !important; }
        .nav-overlay {
            display: none !important;
            position: fixed !important;
            top: 0 !important; left: 0 !important; right: 0 !important; bottom: 0 !important;
            background: #2a1f21 !important;
            z-index: 10000 !important;
            flex-direction: column !important;
            align-items: center !important;
            justify-content: center !important;
            gap: 0 !important;
            opacity: 1 !important;
        }
        .nav-overlay.open { display: flex !important; }
        .nav-link-mobile {
            color: rgba(242, 235, 224, 0.7) !important;
            text-decoration: none !important;
            font-size: 1.05rem !important;
            font-family: 'Philosopher', Georgia, serif !important;
            font-weight: 500 !important;
            padding: 12px 40px !important;
            transition: color 0.2s !important;
            display: block !important;
            width: 100% !important;
            text-align: center !important;
            letter-spacing: normal !important;
        }
        .nav-link-mobile:hover { color: #f2ebe0 !important; }
        .nav-link-mobile.active { color: #a3b899 !important; }
        @media (max-width: 768px) {
            .nav-hamburger { display: block !important; }
            .nav-links { display: none !important; }
            .nav-container { height: 56px !important; }
            .nav-logo { font-size: 1.1rem !important; }
            .top-nav { padding: 0 24px !important; }
        }
        @media (max-width: 480px) {
            .nav-container { height: 56px !important; }
            .nav-logo { font-size: 1.1rem !important; }
            .top-nav { padding: 0 24px !important; }
        }
        /* ===== END NAV OVERRIDE ===== */
        /* ===== MOBILE OPTIMIZATION ===== */
        /* Prevent iOS auto-zoom on input focus */
        @media screen and (max-width: 768px) {
            input, textarea, select {
                font-size: 16px !important;
            }
        }
        /* ===== END MOBILE OPTIMIZATION ===== */
        </style>
</head>
<body>
        <!-- Top Navigation Bar -->
    <nav class="top-nav">
        <div class="nav-container">
            <a href="index.html" class="nav-logo">Our Life Hub</a>
            <div class="nav-links">
                <a href="index.html" class="nav-link active">Home</a>
                <a href="kasey-hub.html" class="nav-link">Kasey</a>
                <a href="charlie-hub.html" class="nav-link">Charlie</a>
                <a href="our-dreams.html" class="nav-link">Us ♡</a>
                <a href="meal-plan.html" class="nav-link">Meals</a>
                <a href="settings.html" class="nav-link">Settings</a>
            </div>
            <div style="display:flex;align-items:center;gap:2px;"><button class="nav-refresh" onclick="location.reload(true)" aria-label="Refresh" title="Refresh page">↻</button>
            <button class="nav-hamburger" id="navHamburger" onclick="toggleNav()" aria-label="Menu">
                <span></span>
                <span></span>
                <span></span>
            </button></div>
        </div>
    </nav>
    <div class="nav-overlay" id="navOverlay" onclick="toggleNav()">
        <a href="index.html" class="nav-link-mobile active">Home</a>
        <a href="kasey-hub.html" class="nav-link-mobile">Kasey</a>
        <a href="charlie-hub.html" class="nav-link-mobile">Charlie</a>
        <a href="our-dreams.html" class="nav-link-mobile">Us ♡</a>
        <a href="meal-plan.html" class="nav-link-mobile">Meals</a>
        <a href="settings.html" class="nav-link-mobile">Settings</a>
    </div>



    <div class="container">
        
        <div class="home-header">
            <div class="photo-wrapper" id="photoWrapper" style="position:relative; flex-shrink:0;">
            <div class="header-photo-container" id="photoContainer">
                <div class="header-photo-inner" id="photoInner">
                    <div class="header-photo-draggable" id="photoDraggable" style="display: none;">
                        <img id="headerPhoto">
                    </div>
                </div>
                <div id="photoPlaceholder" class="photo-placeholder" onclick="document.getElementById('photoUpload').click()">
                    <span style="font-size: 2rem; opacity: 0.3;">+</span>
                </div>
                <!-- Edit overlay - shows on double-click/tap when photo exists -->
                <div class="photo-edit-overlay" id="photoEditOverlay">
                    <button class="photo-edit-btn" onclick="enterPhotoEditMode(); event.stopPropagation();">Reposition</button>
                    <button class="photo-edit-btn" onclick="document.getElementById('photoUpload').click(); hidePhotoOverlay(); event.stopPropagation();">Change Photo</button>
                </div>
                <input type="file" id="photoUpload" accept="image/*" style="display: none;">
                <button class="upload-photo-btn no-photo" id="uploadBtn" onclick="document.getElementById('photoUpload').click()"></button>
                <!-- Subtle pencil hint -->
                <div class="photo-edit-hint" id="photoEditHint" onclick="showPhotoOverlay(); event.stopPropagation();">
                    <svg viewBox="0 0 12 12"><path d="M7.5 1.5l3 3M2 8l5-5 3 3-5 5H2V8z"/></svg>
                </div>
            </div>
            <!-- Edit mode controls (zoom + done) - outside overflow:hidden -->
            <div class="photo-edit-controls" id="photoEditControls">
                <button class="photo-ctrl-btn" onclick="zoomPhoto(-0.1)">−</button>
                <button class="photo-ctrl-btn" onclick="zoomPhoto(0.1)">+</button>
                <button class="photo-ctrl-btn done" onclick="exitPhotoEditMode()">Done</button>
            </div>
            </div>
            <div>
                <h1 class="home-title">Our Life Hub</h1>
                <p class="home-date" id="homeDate"></p>
            </div>
        </div>

        <!-- REMINDER SECTION -->
        <div class="reminder-section">
            <div class="current-reminder visible" id="currentReminder">
                <div class="reminder-content">
                    <div class="reminder-info">
                        <div class="reminder-eyebrow">Reminder</div>
                        <div class="reminder-title" id="reminderTitle">Q4 estimated taxes due Jan 15</div>
                        <div class="reminder-due" id="reminderDue">In 9 days</div>
                    </div>
                    <div class="reminder-links" id="reminderLinks">
                        <a href="https://www.irs.gov/payments" target="_blank" class="reminder-link">Open Link</a>
                    </div>
                </div>
                <div class="reminder-actions">
                    <button class="reminder-btn primary" onclick="markCurrentReminderDone()">Completed</button>
                    <button class="reminder-btn subtle" onclick="showNextReminder()">Next</button>
                    <button class="reminder-btn subtle" onclick="snoozeCurrentReminder(7)">Snooze 1 week</button>
                    <button class="reminder-btn subtle" onclick="snoozeCurrentReminder(30)">Snooze 1 month</button>
                </div>
            </div>
            <div class="quick-add">
                <input type="text" id="quickReminderInput" placeholder="Add a quick reminder..." onkeypress="if(event.key==='Enter') addQuickReminder()">
                <input type="date" id="quickReminderDate">
                <button onclick="addQuickReminder()">+</button>
            </div>
            <div class="manage-link">
                <button onclick="openReminderModal()">Manage All Reminders</button>
                <button onclick="window.clearAllSnoozes()">Clear All Snoozes</button>
            </div>
        </div>

        <!-- Decorative Divider -->
        <div class="elemental-divider">
            <div class="divider-line"></div>
            <span class="divider-icon">✦</span>
            <span class="divider-icon">✧</span>
            <span class="divider-icon">✦</span>
            <div class="divider-line"></div>
        </div>

        <!-- Calendar Section -->
        <div class="section">
            <div class="calendar-header">
                <div class="calendar-nav">
                    <button onclick="calendarPrevious()">←</button>
                    <span class="calendar-title" id="calendarTitle">Loading...</span>
                    <button onclick="calendarNext()">→</button>
                </div>
                <div class="calendar-view-toggle">
                    <button class="view-toggle-btn active" data-view="twoday" onclick="calendarChangeView('twoday')">Full Week</button>
                    <button class="view-toggle-btn" data-view="month" onclick="calendarChangeView('month')">Month View</button>
                </div>
            </div>
            <div id="calendarContainer"></div>
            <button class="add-event-btn" onclick="calendarShowAddForm()">Add Event</button>
        </div>

        <!-- Add Event Modal -->
        <div class="modal-overlay" id="addEventModalOverlay" onclick="closeAddEventModal(event)">
            <div class="modal" onclick="event.stopPropagation()">
                <div class="modal-header">
                    <div class="modal-title">Add Event</div>
                    <button class="modal-close" onclick="calendarHideAddForm()">&times;</button>
                </div>
                <div class="modal-body">
                    <form onsubmit="calendarAddEvent(event)">
                        <div class="form-group">
                            <label>Event Title</label>
                            <input type="text" id="calendarEventTitle" required>
                        </div>
                        <div class="form-group">
                            <label>Date(s)</label>
                            <select id="calendarRepeatMode" onchange="toggleRepeatOptions()">
                                <option value="single">Single date</option>
                                <option value="multiple">Multiple specific dates</option>
                                <option value="range">Date range</option>
                            </select>
                        </div>
                        <div class="form-group" id="singleDateMode">
                            <input type="date" id="calendarEventDate" required>
                        </div>
                        <div class="form-group repeat-mode" id="multipleDateMode">
                            <label>Select dates:</label>
                            <div style="display: flex; gap: 8px; margin-bottom: 8px;">
                                <input type="date" id="multipleDateInput" style="flex: 1;">
                                <button type="button" class="btn" onclick="addSelectedDate()" style="padding: 8px 16px;">+</button>
                            </div>
                            <div id="selectedDatesList" style="display: flex; flex-wrap: wrap; gap: 6px;"></div>
                        </div>
                        <div class="form-group repeat-mode" id="rangeMode">
                            <label>Start Date</label>
                            <input type="date" id="calendarRangeStartDate">
                            <label style="margin-top: 8px;">End Date</label>
                            <input type="date" id="calendarEventEndDate">
                        </div>
                        <div class="form-group">
                            <label>Time (optional)</label>
                            <input type="time" id="calendarEventTime">
                        </div>
                        <div class="form-group">
                            <label>Notes (optional)</label>
                            <textarea id="calendarEventNote" rows="3"></textarea>
                        </div>
                        <div class="form-actions">
                            <button type="button" class="btn cancel-btn" onclick="calendarHideAddForm()">Cancel</button>
                            <button type="submit" class="btn">Save Event</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Grocery List -->
        <div class="section">
            <div class="collapsible-header" onclick="toggleGroceryList()">
                <div class="section-title" style="margin-bottom: 0;">Grocery List</div>
                <span class="expand-icon" id="groceryIcon" style="transform: rotate(-90deg);">▼</span>
            </div>
            <div class="collapsible-content" id="groceryContent">
                <div id="groceryList" style="margin-top: 16px;"></div>
                <div class="add-input">
                    <input type="text" id="groceryInput" placeholder="Add item..." onkeypress="if(event.key==='Enter') addGrocery()">
                    <button onclick="addGrocery()">+</button>
                </div>
            </div>
        </div>

        <!-- Phone Book -->
        <div class="section">
            <div class="phonebook-header" onclick="togglePhonebook()">
                <div class="section-title" style="margin-bottom: 0;">Phone Book</div>
                <span class="expand-icon" id="phonebookIcon" style="transform: rotate(-90deg);">▼</span>
            </div>
            <div class="phonebook-content" id="phonebookContent">
                <div class="phonebook-search">
                    <input type="text" id="phonebookSearch" placeholder="Search contacts..." oninput="filterContacts()">
                </div>
                <div id="contactsList"></div>
                <button class="add-contact-btn" onclick="toggleAddContact()">+ Add Contact</button>
                <div class="add-contact-form" id="addContactForm">
                    <input type="text" id="contactName" placeholder="Name / What it's for">
                    <div class="form-row">
                        <input type="tel" id="contactPhone" placeholder="Phone number">
                        <input type="email" id="contactEmail" placeholder="Email">
                    </div>
                    <input type="url" id="contactWebsite" placeholder="Website / Link">
                    <textarea id="contactNotes" placeholder="Notes (hours, account #, etc.)"></textarea>
                    <div class="form-row">
                        <button class="save-contact-btn" onclick="saveContact()">Save Contact</button>
                        <button class="cancel-contact-btn" onclick="toggleAddContact()">Cancel</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Day Detail Modal -->
    <div class="day-modal-overlay" id="dayModalOverlay" onclick="closeDayModal(event)">
        <div class="day-modal" onclick="event.stopPropagation()">
            <div class="day-modal-header">
                <div class="day-modal-title" id="dayModalTitle">Monday, January 6</div>
                <button class="day-modal-close" onclick="closeDayModal()">&times;</button>
            </div>
            <div class="day-modal-events" id="dayModalEvents"></div>
            <button class="day-modal-add" onclick="showDayModalForm()">+ Add Event</button>
            <div class="day-modal-form" id="dayModalForm">
                <input type="text" id="dayModalEventTitle" placeholder="Event title">
                <div class="day-modal-form-row">
                    <input type="time" id="dayModalEventTime">
                </div>
                <textarea id="dayModalEventNote" placeholder="Notes (optional)" rows="2"></textarea>
                <input type="hidden" id="dayModalEditId">
                <div class="day-modal-form-actions">
                    <button class="cancel-contact-btn" onclick="hideDayModalForm()">Cancel</button>
                    <button class="btn" onclick="saveDayModalEvent()">Save</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Reminder Management Modal -->
    <div class="reminder-modal-overlay" id="reminderModalOverlay" onclick="closeReminderModal(event)">
        <div class="reminder-modal" onclick="event.stopPropagation()">
            <div class="reminder-modal-header">
                <div class="reminder-modal-title">Manage Reminders</div>
                <button class="reminder-modal-close" onclick="closeReminderModal()">&times;</button>
            </div>
            
            <!-- Add New Reminder Form -->
            <div class="reminder-add-form">
                <h4 id="reminderFormTitle">Add New Reminder</h4>
                <div class="reminder-form-row">
                    <label>Title</label>
                    <input type="text" id="reminderModalTitle" placeholder="e.g., Car registration renewal">
                </div>
                <div class="reminder-form-inline">
                    <div class="reminder-form-row">
                        <label>Notify Date</label>
                        <input type="date" id="reminderModalDate">
                    </div>
                    <div class="reminder-form-row">
                        <label>Frequency</label>
                        <select id="reminderModalFrequency">
                            <option value="once">One-time</option>
                            <option value="yearly">Yearly</option>
                        </select>
                    </div>
                </div>
                <div class="reminder-form-row">
                    <label>Link (optional)</label>
                    <input type="url" id="reminderModalLink" placeholder="https://...">
                </div>
                <input type="hidden" id="reminderModalEditId">
                <div class="reminder-form-actions">
                    <button class="cancel-contact-btn" onclick="clearReminderForm()">Clear</button>
                    <button class="btn" onclick="saveReminderFromModal()">Save Reminder</button>
                </div>
            </div>
            
            <!-- Reminder List -->
            <div class="reminder-list" id="reminderModalList"></div>
        </div>
    </div>

    <script>
        // Initialize Firebase status to false before module loads
        window.firebaseReady = false;
        window.firebaseError = null;
        // console.log('Page script loaded, firebaseReady initially false');
    </script>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getFirestore, collection, doc, setDoc, getDoc, getDocs, deleteDoc, onSnapshot } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

        // console.log('Firebase modules imported successfully');

        try {
            // console.log('Starting Firebase initialization...');

            // Your Firebase configuration
            const firebaseConfig = {
                apiKey: "AIzaSyCDda9sPwSY-RQ5rrM5THOvcLtHvcPRYd4",
                authDomain: "our-habit-hub.firebaseapp.com",
                projectId: "our-habit-hub",
                storageBucket: "our-habit-hub.firebasestorage.app",
                messagingSenderId: "78555830496",
                appId: "1:78555830496:web:3e457e54729cc11b825885"
            };

            // console.log('Firebase config set');

            // Initialize Firebase
            const app = initializeApp(firebaseConfig);
            // console.log('Firebase app initialized');
            
            const db = getFirestore(app);
            // console.log('Firestore initialized');

            // Make Firebase available globally
            window.db = db;
            window.firestoreImports = { collection, doc, setDoc, getDoc, getDocs, deleteDoc, onSnapshot };
            window.firebaseReady = true;

            // console.log('Firebase ready flag set to true');

            // Update sync status
            function updateSyncStatus(status, message) {
                const statusEl = document.getElementById('syncStatus');
                const textEl = document.getElementById('syncText');
                
                if (!statusEl || !textEl) {
                    // console.warn('Sync status elements not found yet');
                    return;
                }
                
                statusEl.className = 'sync-status';
                if (status === 'synced') {
                    statusEl.classList.add('synced');
                } else if (status === 'error') {
                    statusEl.classList.add('error');
                } else if (status === 'connecting') {
                    statusEl.classList.add('connecting');
                }
                
                textEl.textContent = message;
            }

            // Wait for DOM to be ready before updating status
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', () => {
                    updateSyncStatus('synced', 'Synced');
                });
            } else {
                updateSyncStatus('synced', 'Synced');
            }

            // console.log('Firebase initialized successfully!');
            
            // Dispatch event when Firebase is ready
            window.dispatchEvent(new Event('firebaseReady'));
            // console.log('firebaseReady event dispatched');
            
        } catch (error) {
            // console.error('❌ Firebase initialization error:', error);
            // console.error('Error details:', error.message);
            // console.error('Stack:', error.stack);
            
            // Set firebaseReady to false explicitly so the app knows Firebase failed
            window.firebaseReady = false;
            window.firebaseError = error.message;
            
            // Try to update sync status
            setTimeout(() => {
                try {
                    const statusEl = document.getElementById('syncStatus');
                    if (statusEl) {
                        statusEl.className = 'sync-status error';
                    }
                } catch (e) {
                    // console.error('Could not update sync status:', e);
                }
            }, 100);
        }
    </script>

    <script>
        const dailyPrompts = [
            "What's one thing I did today that made you smile?",
            "What's your favorite memory of us from this past month?",
            "What's one way I can support you better this week?",
            "What's something you're grateful for about our relationship?",
            "What's a goal you have for us as a couple?",
            "What's one thing you admire about me?",
            "What's your favorite thing we do together?",
            "What's something new you'd like to try together?",
            "What's a challenge we've overcome together that you're proud of?",
            "What makes you feel most loved by me?",
            "What's something you've learned about yourself through our relationship?",
            "What's a small gesture I do that means a lot to you?",
            "What's your favorite quality about our relationship?",
            "What's something you're excited about for our future?",
            "What's one way we've grown together recently?",
            "What's a tradition you'd like to start with us?",
            "What's something I do that makes you laugh?",
            "What's your favorite way to spend quality time together?",
            "What's something you want to accomplish together this year?",
            "What's one thing about our relationship that makes you feel secure?",
            "What's a moment when you felt really connected to me?",
            "What's something you appreciate about how we handle disagreements?",
            "What's your favorite inside joke or moment between us?",
            "What's one way our relationship has changed you for the better?",
            "What's something you'd like more of in our relationship?",
            "What's a compliment you wish you heard more often?",
            "What's your favorite physical gesture of affection from me?",
            "What's something I do that helps you feel understood?",
            "What's a dream you have for us that we haven't talked about yet?",
            "What's one thing that always brightens your day when I do it?"
        ];

        const monthlyChallenges = [
            "Write each other a love letter and read them aloud together",
            "Go on a walk together at least 3 times per week",
            "Try a new restaurant or cafe you've never been to",
            "Have a technology-free evening once a week",
            "Learn something new together (a skill, hobby, or topic)",
            "Do a random act of kindness for each other every week",
            "Plan and execute a surprise date for each other",
            "Start a new tradition together",
            "Declutter and organize one space in your home together",
            "Take photos together once a week to capture memories",
            "Cook a new recipe together that neither of you has tried before",
            "Create something together (art, craft, garden, etc.)"
        ];

        let calendarView = 'twoday';
        let calendarDate = new Date();
        let calendarEvents = [];
        let reminders = [];
        let groceries = [];
        let selectedDates = [];

        // FIREBASE FUNCTIONS
        async function syncToFirebase(collectionName, data) {
            // Wait for Firebase to be ready (with timeout)
            if (!window.firebaseReady) {
                await Promise.race([
                    new Promise(resolve => {
                        if (window.firebaseReady) resolve();
                        else window.addEventListener('firebaseReady', resolve, { once: true });
                    }),
                    new Promise(resolve => setTimeout(() => {
                        // console.warn('Firebase not ready after 5s, continuing anyway');
                        resolve();
                    }, 5000))
                ]);
            }
            
            if (!window.firebaseReady || !window.db) {
                // console.warn('Firebase not available, skipping sync for:', collectionName);
                return;
            }
            
            try {
                const { setDoc, doc } = window.firestoreImports;
                await setDoc(doc(window.db, collectionName, 'data'), { items: data });
                // console.log(`${collectionName} synced to Firebase successfully`);
            } catch (error) {
                // console.error(`Error syncing ${collectionName}:`, error);
                // Don't throw - just log the error so the app continues
            }
        }

        async function loadFromFirebase(collectionName) {
            // Wait for Firebase to be ready (with timeout)
            if (!window.firebaseReady) {
                await Promise.race([
                    new Promise(resolve => {
                        if (window.firebaseReady) resolve();
                        else window.addEventListener('firebaseReady', resolve, { once: true });
                    }),
                    new Promise(resolve => setTimeout(() => {
                        // console.warn('Firebase not ready after 5s for load');
                        resolve();
                    }, 5000))
                ]);
            }
            
            if (!window.firebaseReady || !window.db) {
                // console.warn('Firebase not available, returning null for:', collectionName);
                return null;
            }
            
            try {
                const { getDoc, doc } = window.firestoreImports;
                const docRef = doc(window.db, collectionName, 'data');
                const docSnap = await getDoc(docRef);
                
                if (docSnap.exists()) {
                    return docSnap.data().items;
                }
                return null;
            } catch (error) {
                // console.error(`Error loading ${collectionName}:`, error);
                return null;
            }
        }

        async function setupFirebaseListener(collectionName, callback) {
            // Wait for Firebase to be ready (with timeout)
            if (!window.firebaseReady) {
                await Promise.race([
                    new Promise(resolve => {
                        if (window.firebaseReady) resolve();
                        else window.addEventListener('firebaseReady', resolve, { once: true });
                    }),
                    new Promise(resolve => setTimeout(() => {
                        // console.warn('Firebase not ready after 5s for listener');
                        resolve();
                    }, 5000))
                ]);
            }
            
            if (!window.firebaseReady || !window.db) {
                // console.warn('Firebase not available, skipping listener for:', collectionName);
                return;
            }
            
            try {
                const { onSnapshot, doc } = window.firestoreImports;
                const docRef = doc(window.db, collectionName, 'data');
                
                onSnapshot(docRef, (doc) => {
                    if (doc.exists()) {
                        callback(doc.data().items);
                    }
                });
            } catch (error) {
                // console.error(`Error setting up listener for ${collectionName}:`, error);
            }
        }

        // LIFE REMINDERS - Single reminder at a time, ADHD-friendly
        let lifeReminders = [];
        let currentReminderIndex = 0;

        const defaultLifeReminders = [
            // Tax reminders
            { id: 1, title: "Q4 estimated taxes", notifyDate: { month: 1, day: 15 }, frequency: "yearly", link: "https://www.irs.gov/payments" },
            { id: 2, title: "Q1 estimated taxes", notifyDate: { month: 4, day: 15 }, frequency: "yearly", link: "https://www.irs.gov/payments" },
            { id: 3, title: "Q2 estimated taxes", notifyDate: { month: 6, day: 15 }, frequency: "yearly", link: "https://www.irs.gov/payments" },
            { id: 4, title: "Q3 estimated taxes", notifyDate: { month: 9, day: 15 }, frequency: "yearly", link: "https://www.irs.gov/payments" },
            
            // Tag renewals
            { id: 5, title: "Kasey - Renew vehicle registration online", notifyDate: { month: 5, day: 25 }, frequency: "yearly", link: "https://drive.ky.gov/" },
            { id: 6, title: "Charlie - Renew vehicle registration online", notifyDate: { month: 3, day: 25 }, frequency: "yearly", link: "https://drive.ky.gov/" },
            
            // Birthday reminders (2 months prior for planning)
            { id: 7, title: "Kasey's Birthday Coming Up - Plan & Shop!", notifyDate: { month: 5, day: 1 }, frequency: "yearly" },
            { id: 8, title: "Charlie's Birthday Coming Up - Plan & Shop!", notifyDate: { month: 7, day: 29 }, frequency: "yearly" },
            
            // Anniversary reminder (2 months prior)
            { id: 9, title: "Anniversary Coming Up - Plan Something Special!", notifyDate: { month: 12, day: 14 }, frequency: "yearly" },
            
            // Mom's birthday (1 month prior)
            { id: 10, title: "Mom's Birthday - Get Card & Gift", notifyDate: { month: 9, day: 29 }, frequency: "yearly" },
            
            // Health & wellness
            { id: 11, title: "Schedule annual physical checkup", notifyDate: { month: 1, day: 15 }, frequency: "yearly" },
            { id: 12, title: "Schedule dental cleaning", notifyDate: { month: 2, day: 1 }, frequency: "yearly" },
            { id: 13, title: "Get flu shots", notifyDate: { month: 9, day: 1 }, frequency: "yearly" },
            { id: 14, title: "Schedule annual vet checkup", notifyDate: { month: 3, day: 1 }, frequency: "yearly" },
            
            // Home maintenance
            { id: 15, title: "Change HVAC filters", notifyDate: { month: 1, day: 1 }, frequency: "yearly" },
            { id: 16, title: "Change HVAC filters", notifyDate: { month: 4, day: 1 }, frequency: "yearly" },
            { id: 17, title: "Change HVAC filters", notifyDate: { month: 7, day: 1 }, frequency: "yearly" },
            { id: 18, title: "Change HVAC filters", notifyDate: { month: 10, day: 1 }, frequency: "yearly" },
            { id: 19, title: "Test & replace smoke detector batteries", notifyDate: { month: 3, day: 1 }, frequency: "yearly" },
            { id: 20, title: "Test & replace smoke detector batteries", notifyDate: { month: 9, day: 1 }, frequency: "yearly" },
            { id: 21, title: "Spring home maintenance check", notifyDate: { month: 4, day: 1 }, frequency: "yearly" },
            { id: 22, title: "Winterize home & check heating system", notifyDate: { month: 10, day: 15 }, frequency: "yearly" },
            
            // Financial
            { id: 23, title: "Check free annual credit report", notifyDate: { month: 1, day: 31 }, frequency: "yearly", link: "https://www.annualcreditreport.com" },
            { id: 24, title: "Review & update insurance policies", notifyDate: { month: 11, day: 1 }, frequency: "yearly" }
        ];

        async function loadLifeReminders() {
            const firebaseData = await loadFromFirebase('lifeReminders');
            if (firebaseData && firebaseData.length > 0) {
                lifeReminders = firebaseData;
                // Merge any missing default reminders back in
                let added = false;
                for (const def of defaultLifeReminders) {
                    const exists = lifeReminders.some(r => String(r.id) === String(def.id) || r.title === def.title);
                    if (!exists) {
                        lifeReminders.push(def);
                        added = true;
                    }
                }
                if (added) {
                    await syncToFirebase('lifeReminders', lifeReminders);
                }
            } else {
                lifeReminders = defaultLifeReminders;
                await syncToFirebase('lifeReminders', lifeReminders);
            }
            updateReminderDisplay();
        }

        async function saveLifeReminders() {
            // console.log('saveLifeReminders called, count:', lifeReminders.length);
            localStorage.setItem('lifeReminders', JSON.stringify(lifeReminders));
            try {
                await syncToFirebase('lifeReminders', lifeReminders);
                // console.log('Life reminders saved successfully');
            } catch (err) {
                // console.error('Error saving life reminders:', err);
                alert('Error saving reminders: ' + err.message);
            }
        }

        function getNextNotifyDate(reminder) {
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const currentYear = today.getFullYear();
            
            // Check if snoozed
            if (reminder.snoozedUntil) {
                const snoozed = new Date(reminder.snoozedUntil);
                snoozed.setHours(0, 0, 0, 0);
                if (snoozed > today) return snoozed;
            }
            
            // Normalize notifyDate to {month, day} regardless of format
            let nd = reminder.notifyDate;
            if (typeof nd === 'string') {
                const parts = nd.split('-');
                nd = { month: parseInt(parts[1], 10), day: parseInt(parts[2], 10) };
            }
            if (!nd || !nd.month || !nd.day) return new Date();
            
            let notifyDate = new Date(currentYear, nd.month - 1, nd.day);
            notifyDate.setHours(0, 0, 0, 0);
            
            if (reminder.frequency === 'once') {
                return notifyDate;
            } else if (reminder.frequency === 'yearly') {
                if (reminder.lastDone) {
                    const lastDoneDate = new Date(reminder.lastDone);
                    const lastDoneYear = lastDoneDate.getFullYear();
                    if (lastDoneYear === currentYear) {
                        notifyDate = new Date(currentYear + 1, nd.month - 1, nd.day);
                    }
                } else {
                    if (notifyDate < today) {
                        notifyDate = new Date(currentYear + 1, nd.month - 1, nd.day);
                    }
                }
            }
            
            return notifyDate;
        }

        function getDaysUntilNotify(reminder) {
            const notifyDate = getNextNotifyDate(reminder);
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const diffTime = notifyDate - today;
            return Math.ceil(diffTime / (1000 * 60 * 60 * 24));
        }

        function formatDueText(daysUntil) {
            if (daysUntil < 0) {
                return `${Math.abs(daysUntil)} days overdue`;
            } else if (daysUntil === 0) {
                return 'Due today';
            } else if (daysUntil === 1) {
                return 'Due tomorrow';
            } else if (daysUntil <= 14) {
                return `In ${daysUntil} days`;
            } else {
                const notifyDate = new Date();
                notifyDate.setDate(notifyDate.getDate() + daysUntil);
                return notifyDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
            }
        }

        function getUpcomingReminders(withinDays = 90) {
            const now = new Date();
            now.setHours(0, 0, 0, 0);
            
            return lifeReminders
                .map(r => {
                    const daysUntil = getDaysUntilNotify(r);
                    return { ...r, daysUntil };
                })
                .filter(r => {
                    // Show if overdue (negative days) OR within the days window
                    if (r.daysUntil < 0) {
                        // Show overdue reminders (up to 30 days overdue)
                        return r.daysUntil >= -30;
                    }
                    
                    if (r.daysUntil > withinDays) return false;
                    
                    // Check if currently snoozed
                    if (r.snoozedUntil) {
                        const snoozedDate = new Date(r.snoozedUntil);
                        snoozedDate.setHours(0, 0, 0, 0);
                        if (snoozedDate > now) return false;
                    }
                    
                    return true;
                })
                .sort((a, b) => a.daysUntil - b.daysUntil);
        }

        function updateReminderDisplay() {
            const upcoming = getUpcomingReminders(90);
            const container = document.getElementById('currentReminder');
            
            if (upcoming.length === 0) {
                // Show happy message when no reminders
                container.classList.add('visible');
                document.getElementById('reminderTitle').textContent = 'yay! no reminders';
                document.getElementById('reminderDue').textContent = 'Nothing due in the next 90 days';
                document.getElementById('reminderLinks').innerHTML = '';
                
                // Hide action buttons when showing no reminders message
                const actions = container.querySelector('.reminder-actions');
                if (actions) actions.style.display = 'none';
                return;
            }
            
            container.classList.add('visible');
            
            // Show action buttons
            const actions = container.querySelector('.reminder-actions');
            if (actions) actions.style.display = 'grid';
            
            if (currentReminderIndex >= upcoming.length) {
                currentReminderIndex = 0;
            }
            
            const reminder = upcoming[currentReminderIndex];
            
            document.getElementById('reminderTitle').textContent = reminder.title;
            document.getElementById('reminderDue').textContent = formatDueText(reminder.daysUntil);
            
            const linksContainer = document.getElementById('reminderLinks');
            linksContainer.innerHTML = '';
            
            if (reminder.link) {
                const linkEl = document.createElement('a');
                linkEl.href = reminder.link;
                linkEl.target = '_blank';
                linkEl.className = 'reminder-link';
                linkEl.textContent = 'Open Link';
                linksContainer.appendChild(linkEl);
            }
            
            if (reminder.phone) {
                const phoneEl = document.createElement('a');
                phoneEl.href = `tel:${reminder.phone}`;
                phoneEl.className = 'reminder-link';
                phoneEl.textContent = `Call: ${reminder.phone}`;
                linksContainer.appendChild(phoneEl);
            }
        }

        function showNextReminder() {
            // console.log('showNextReminder called');
            const upcoming = getUpcomingReminders(90);
            // console.log('Upcoming reminders:', upcoming.length);
            
            if (upcoming.length === 0) {
                // console.log('❌ No upcoming reminders to cycle through');
                // console.log('💡 Click "Clear All Snoozes" button to reset reminders');
                return;
            }
            
            if (upcoming.length > 1) {
                currentReminderIndex = (currentReminderIndex + 1) % upcoming.length;
                // console.log('✓ New reminder index:', currentReminderIndex);
                // console.log('✓ Now showing:', upcoming[currentReminderIndex].title);
                updateReminderDisplay();
            } else {
                // console.log('❌ Only 1 reminder - cannot cycle to next');
            }
        }

        async function markCurrentReminderDone() {
            // console.log('markCurrentReminderDone called');
            const upcoming = getUpcomingReminders(90);
            // console.log('Upcoming reminders found:', upcoming.length);
            
            if (upcoming.length === 0) {
                // console.log('❌ No upcoming reminders - cannot mark done');
                // console.log('💡 Click "Clear All Snoozes" button to reset reminders');
                return;
            }
            
            const reminder = upcoming[currentReminderIndex];
            // console.log('Marking reminder done:', reminder.title);
            const index = lifeReminders.findIndex(r => r.id === reminder.id);
            
            if (index !== -1) {
                if (reminder.frequency === 'yearly') {
                    // Yearly reminder - set lastDone to move to next year
                    lifeReminders[index].lastDone = new Date().toISOString();
                    lifeReminders[index].snoozedUntil = null;
                    // console.log('✓ Updated yearly reminder:', lifeReminders[index]);
                } else {
                    // One-time reminder - remove it completely
                    // console.log('✓ Removing one-time reminder:', lifeReminders[index].title);
                    lifeReminders.splice(index, 1);
                }
                
                await saveLifeReminders();
                currentReminderIndex = 0;
                updateReminderDisplay();
                // console.log('✓ Reminder marked done successfully!');
            } else {
                // console.error('❌ Could not find reminder in array');
            }
        }

        async function snoozeCurrentReminder(days) {
            // console.log('snoozeCurrentReminder called, days:', days);
            const upcoming = getUpcomingReminders(90);
            // console.log('Upcoming reminders found:', upcoming.length);
            
            if (upcoming.length === 0) {
                // console.log('❌ No upcoming reminders to snooze');
                return;
            }
            
            const reminder = upcoming[currentReminderIndex];
            // console.log('Snoozing reminder:', reminder.title);
            const index = lifeReminders.findIndex(r => r.id === reminder.id);
            
            if (index !== -1) {
                const snoozeDate = new Date();
                snoozeDate.setDate(snoozeDate.getDate() + days);
                lifeReminders[index].snoozedUntil = snoozeDate.toISOString();
                // console.log('✓ Snoozed until:', snoozeDate.toLocaleDateString());
                await saveLifeReminders();
                currentReminderIndex = 0;
                updateReminderDisplay();
                // console.log('✓ Reminder snoozed successfully!');
            } else {
                // console.error('❌ Could not find reminder in array');
            }
        }

        // DEBUG FUNCTIONS - Use in console to reset reminders
        window.clearAllSnoozes = async function() {
            // console.log('Clearing all snoozes...');
            lifeReminders.forEach(r => {
                r.snoozedUntil = null;
                r.lastDone = null;
            });
            await saveLifeReminders();
            updateReminderDisplay();
            // console.log('✓ All snoozes and completion dates cleared!');
        };

        window.showAllReminders = function() {
            // console.log('=== ALL LIFE REMINDERS ===');
            lifeReminders.forEach((r, i) => {
                // console.log(`${i + 1}. ${r.title}`);
                // console.log(`   Notify: ${r.notifyDate.month}/${r.notifyDate.day}`);
                // console.log(`   Snoozed: ${r.snoozedUntil || 'No'}`);
                // console.log(`   Last Done: ${r.lastDone || 'Never'}`);
                // console.log('');
            });
        };

        window.testReminderButtons = function() {
            // console.log('=== TESTING REMINDER BUTTONS ===');
            // console.log('Current reminder index:', currentReminderIndex);
            // console.log('Total reminders:', lifeReminders.length);
            
            const upcoming = getUpcomingReminders(90);
            // console.log('Upcoming reminders (within 30 days):', upcoming.length);
            
            if (upcoming.length > 0) {
                // console.log('Current reminder:', upcoming[currentReminderIndex]);
            } else {
                // console.log('No upcoming reminders to display');
            }
        };

        async function addQuickReminder() {
            const input = document.getElementById('quickReminderInput');
            const dateInput = document.getElementById('quickReminderDate');
            const title = input.value.trim();
            
            if (!title) return;
            
            if (!dateInput.value) {
                alert('Please pick a date for this reminder.');
                dateInput.focus();
                return;
            }
            
            const [year, month, day] = dateInput.value.split('-').map(Number);
            
            const newReminder = {
                id: Date.now(),
                title: title,
                notifyDate: { month: month, day: day, year: year },
                frequency: 'once',
                created: new Date().toISOString()
            };
            
            lifeReminders.push(newReminder);
            await saveLifeReminders();
            input.value = '';
            dateInput.value = '';
            updateReminderDisplay();
        }

        // REMINDER MODAL FUNCTIONS
        function openReminderModal() {
            renderReminderList();
            clearReminderForm();
            document.getElementById('reminderModalOverlay').classList.add('visible');
        }

        function closeReminderModal(event) {
            if (event && event.target !== event.currentTarget) return;
            document.getElementById('reminderModalOverlay').classList.remove('visible');
        }

        function renderReminderList() {
            const container = document.getElementById('reminderModalList');
            
            if (lifeReminders.length === 0) {
                container.innerHTML = '<div class="reminder-empty">No reminders yet. Add one above!</div>';
                return;
            }
            
            // Sort by next notify date
            const sorted = [...lifeReminders].sort((a, b) => {
                const dateA = new Date(getNextNotifyDate(a));
                const dateB = new Date(getNextNotifyDate(b));
                return dateA - dateB;
            });
            
            container.innerHTML = sorted.map(reminder => {
                const nextDate = new Date(getNextNotifyDate(reminder));
                const daysUntil = getDaysUntilNotify(reminder);
                const isOverdue = daysUntil < 0;
                const frequencyText = reminder.frequency === 'yearly' ? 'Yearly' : 'One-time';
                
                let linkHtml = '';
                if (reminder.link) {
                    linkHtml = `<a href="${reminder.link}" target="_blank" class="reminder-list-link"> ${new URL(reminder.link).hostname}</a>`;
                }
                
                return `
                    <div class="reminder-list-item ${isOverdue ? 'overdue' : ''}">
                        <div class="reminder-list-header">
                            <div class="reminder-list-title">${reminder.title}</div>
                            <div class="reminder-list-actions">
                                <button class="reminder-edit-btn" onclick="editReminder('${reminder.id}')">Edit</button>
                                <button class="reminder-delete-btn" onclick="deleteReminder('${reminder.id}')">×</button>
                            </div>
                        </div>
                        <div class="reminder-list-meta">
                            <span>${formatDueText(daysUntil)}</span>
                            <span>${frequencyText}</span>
                            <span>${nextDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })}</span>
                        </div>
                        ${linkHtml}
                    </div>
                `;
            }).join('');
        }

        function clearReminderForm() {
            document.getElementById('reminderModalTitle').value = '';
            document.getElementById('reminderModalDate').value = '';
            document.getElementById('reminderModalFrequency').value = 'once';
            document.getElementById('reminderModalLink').value = '';
            document.getElementById('reminderModalEditId').value = '';
            document.getElementById('reminderFormTitle').textContent = 'Add New Reminder';
        }

        function editReminder(id) {
            const reminder = lifeReminders.find(r => String(r.id) === String(id));
            if (!reminder) return;
            
            document.getElementById('reminderModalTitle').value = reminder.title;
            
            const nd = reminder.notifyDate;
            if (nd && typeof nd === 'object' && nd.month && nd.day) {
                const year = new Date().getFullYear();
                const dateStr = year + '-' + String(nd.month).padStart(2, '0') + '-' + String(nd.day).padStart(2, '0');
                document.getElementById('reminderModalDate').value = dateStr;
            } else if (typeof nd === 'string') {
                document.getElementById('reminderModalDate').value = nd;
            } else {
                document.getElementById('reminderModalDate').value = '';
            }
            
            document.getElementById('reminderModalFrequency').value = reminder.frequency || 'once';
            document.getElementById('reminderModalLink').value = reminder.link || '';
            document.getElementById('reminderModalEditId').value = id;
            document.getElementById('reminderFormTitle').textContent = 'Edit Reminder';
            
            document.querySelector('.reminder-modal').scrollTop = 0;
        }

        async function deleteReminder(id) {
            lifeReminders = lifeReminders.filter(r => String(r.id) !== String(id));
            await saveLifeReminders();
            renderReminderList();
            updateReminderDisplay();
        }

        async function saveReminderFromModal() {
            const title = document.getElementById('reminderModalTitle').value.trim();
            const date = document.getElementById('reminderModalDate').value;
            const frequency = document.getElementById('reminderModalFrequency').value;
            const link = document.getElementById('reminderModalLink').value.trim();
            const editId = document.getElementById('reminderModalEditId').value;
            
            if (!title) { alert('Please enter a reminder title'); return; }
            if (!date) { alert('Please select a notify date'); return; }
            
            const dateParts = date.split('-');
            const notifyDateObj = {
                month: parseInt(dateParts[1], 10),
                day: parseInt(dateParts[2], 10)
            };
            
            if (editId) {
                const index = lifeReminders.findIndex(r => String(r.id) === String(editId));
                if (index !== -1) {
                    lifeReminders[index].title = title;
                    lifeReminders[index].notifyDate = notifyDateObj;
                    lifeReminders[index].frequency = frequency;
                    lifeReminders[index].link = link || null;
                }
            } else {
                const newReminder = {
                    id: Date.now().toString(),
                    title: title,
                    notifyDate: notifyDateObj,
                    frequency: frequency,
                    link: link || null,
                    lastDone: null,
                    snoozedUntil: null
                };
                lifeReminders.push(newReminder);
            }
            
            await saveLifeReminders();
            clearReminderForm();
            renderReminderList();
            updateReminderDisplay();
        }

        // CALENDAR FUNCTIONS
        async function calendarLoadEvents() {
            const firebaseData = await loadFromFirebase('calendarEvents');
            if (firebaseData) {
                calendarEvents = firebaseData;
            } else {
                const saved = localStorage.getItem('calendarEvents');
                if (saved) {
                    calendarEvents = JSON.parse(saved);
                    await syncToFirebase('calendarEvents', calendarEvents);
                }
            }
        }

        async function calendarSaveEvents() {
            localStorage.setItem('calendarEvents', JSON.stringify(calendarEvents));
            await syncToFirebase('calendarEvents', calendarEvents);
        }

        function calendarGetEventsForDate(date) {
            const dateStr = date.toDateString();
            const events = calendarEvents.filter(event => {
                try {
                    const [year, month, day] = event.date.split('-').map(Number);
                    const eventDate = new Date(year, month - 1, day);
                    return eventDate.toDateString() === dateStr;
                } catch (e) {
                    return false;
                }
            });
            
            // Sort events by time
            events.sort((a, b) => {
                // Events without time go to the end
                if (!a.time && !b.time) return 0;
                if (!a.time) return 1;
                if (!b.time) return -1;
                
                // Compare times
                return a.time.localeCompare(b.time);
            });
            
            return events;
        }

        function formatTime12Hour(time24) {
            if (!time24) return '';
            
            const [hours, minutes] = time24.split(':');
            let hour = parseInt(hours);
            const ampm = hour >= 12 ? 'PM' : 'AM';
            
            hour = hour % 12;
            hour = hour ? hour : 12; // Convert 0 to 12
            
            return `${hour}:${minutes} ${ampm}`;
        }

        function calendarToggleView() {
            const buttons = document.querySelectorAll('.view-toggle');
            if (calendarView === 'twoday') {
                calendarView = 'week';
                buttons[0].textContent = 'Today & Tomorrow';
            } else {
                calendarView = 'twoday';
                buttons[0].textContent = 'Full Week';
            }
            calendarRender();
        }

        function calendarToggleMonthView() {
            const buttons = document.querySelectorAll('.view-toggle');
            if (calendarView === 'month') {
                calendarView = 'twoday';
                buttons[0].textContent = 'Full Week';
                buttons[1].textContent = 'Month View';
            } else {
                calendarView = 'month';
                buttons[0].textContent = 'Full Week';
                buttons[1].textContent = 'Day View';
            }
            calendarRender();
        }

        function calendarPrevious() {
            if (calendarView === 'twoday') {
                calendarDate.setDate(calendarDate.getDate() - 2);
            } else if (calendarView === 'week') {
                calendarDate.setDate(calendarDate.getDate() - 7);
            } else {
                calendarDate.setMonth(calendarDate.getMonth() - 1);
            }
            calendarRender();
        }

        function calendarNext() {
            if (calendarView === 'twoday') {
                calendarDate.setDate(calendarDate.getDate() + 2);
            } else if (calendarView === 'week') {
                calendarDate.setDate(calendarDate.getDate() + 7);
            } else {
                calendarDate.setMonth(calendarDate.getMonth() + 1);
            }
            calendarRender();
        }

        function calendarChangeView(view) {
            calendarView = view;
            
            // Update button states
            document.querySelectorAll('.view-toggle-btn').forEach(btn => {
                btn.classList.remove('active');
                if (btn.getAttribute('data-view') === view) {
                    btn.classList.add('active');
                }
            });
            
            calendarRender();
        }

        // Helper function to render an event (handles both regular and CRM events)
        function renderEventHTML(event, eventIndex, dateStr) {
            const displayTime = event.time ? formatTime12Hour(event.time) : '';
            const heartEmoji = event.fromCRM ? ' 💗' : '';
            const isDone = isEventDone(eventIndex, dateStr);
            const itemClass = (event.fromCRM ? 'event-item crm-event' : 'event-item') + (isDone ? ' done' : '');
            const checkClass = 'event-check' + (isDone ? ' checked' : '');
            
            return `
                <div class="${itemClass}">
                    <button class="${checkClass}" onclick="toggleEventDone(${eventIndex}, '${dateStr}')" aria-label="Mark done"></button>
                    <div style="flex: 1;">
                        <div class="event-title">${displayTime ? displayTime + ' - ' : ''}${event.title}${heartEmoji}</div>
                        ${event.note ? `<div class="event-note">${event.note}</div>` : ''}
                    </div>
                    <div class="event-actions">
                        <button class="event-edit-btn" onclick="calendarEditEvent(${eventIndex})">Edit</button>
                        <button class="event-delete-btn" onclick="calendarDeleteEvent(${eventIndex})">Delete</button>
                    </div>
                </div>
            `;
        }

        // Event completion tracking (per date)
        function getEventCompletions() {
            try {
                return JSON.parse(localStorage.getItem('eventCompletions') || '{}');
            } catch { return {}; }
        }

        function isEventDone(eventIndex, dateStr) {
            const completions = getEventCompletions();
            const key = eventIndex + ':' + dateStr;
            return !!completions[key];
        }

        async function toggleEventDone(eventIndex, dateStr) {
            const completions = getEventCompletions();
            const key = eventIndex + ':' + dateStr;
            if (completions[key]) {
                delete completions[key];
            } else {
                completions[key] = true;
            }
            localStorage.setItem('eventCompletions', JSON.stringify(completions));
            await syncToFirebase('eventCompletions', completions);
            calendarRender();
        }

        async function loadEventCompletions() {
            const firebaseData = await loadFromFirebase('eventCompletions');
            if (firebaseData) {
                localStorage.setItem('eventCompletions', JSON.stringify(firebaseData));
            }
        }

        function calendarRenderTwoDay() {
            const container = document.getElementById('calendarContainer');
            container.innerHTML = '';
            
            const firstDay = new Date(calendarDate);
            const secondDay = new Date(calendarDate);
            secondDay.setDate(firstDay.getDate() + 1);
            
            document.getElementById('calendarTitle').textContent = 
                `${firstDay.toLocaleDateString('en-US', { month: 'short', day: 'numeric' })} - ${secondDay.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })}`;
            
            const today = new Date();
            const todayStr = today.toDateString();
            
            for (let i = 0; i < 2; i++) {
                const date = i === 0 ? new Date(firstDay) : new Date(secondDay);
                
                const dayDiv = document.createElement('div');
                dayDiv.className = 'week-day';
                
                if (date.toDateString() === todayStr) {
                    dayDiv.classList.add('today');
                }
                
                const dayEvents = calendarGetEventsForDate(date);
                const dateStr = date.toISOString().split('T')[0];
                
                let eventsHTML = '';
                if (dayEvents.length > 0) {
                    dayEvents.forEach((event) => {
                        const eventIndex = calendarEvents.indexOf(event);
                        eventsHTML += renderEventHTML(event, eventIndex, dateStr);
                    });
                } else {
                    eventsHTML = '<div class="empty-state">No events</div>';
                }
                
                dayDiv.innerHTML = `
                    <div class="week-day-header">
                        <span class="week-day-name">${date.toLocaleDateString('en-US', { weekday: 'long' })}</span>
                        <span class="week-day-date">${date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' })}</span>
                    </div>
                    <div>${eventsHTML}</div>
                `;
                
                container.appendChild(dayDiv);
            }
        }

        function calendarRenderWeek() {
            const container = document.getElementById('calendarContainer');
            container.innerHTML = '';
            
            const startOfWeek = new Date(calendarDate);
            startOfWeek.setDate(calendarDate.getDate() - calendarDate.getDay());
            
            const endOfWeek = new Date(startOfWeek);
            endOfWeek.setDate(startOfWeek.getDate() + 6);
            
            document.getElementById('calendarTitle').textContent = 
                `${startOfWeek.toLocaleDateString('en-US', { month: 'short', day: 'numeric' })} - ${endOfWeek.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })}`;
            
            for (let i = 0; i < 7; i++) {
                const date = new Date(startOfWeek);
                date.setDate(startOfWeek.getDate() + i);
                
                const dayDiv = document.createElement('div');
                dayDiv.className = 'week-day';
                
                const today = new Date();
                if (date.toDateString() === today.toDateString()) {
                    dayDiv.classList.add('today');
                }
                
                const dayEvents = calendarGetEventsForDate(date);
                const dateStr = date.toISOString().split('T')[0];
                
                let eventsHTML = '';
                if (dayEvents.length > 0) {
                    dayEvents.forEach((event) => {
                        const eventIndex = calendarEvents.indexOf(event);
                        eventsHTML += renderEventHTML(event, eventIndex, dateStr);
                    });
                } else {
                    eventsHTML = '<div class="empty-state">No events</div>';
                }
                
                dayDiv.innerHTML = `
                    <div class="week-day-header">
                        <span class="week-day-name">${date.toLocaleDateString('en-US', { weekday: 'long' })}</span>
                        <span class="week-day-date">${date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' })}</span>
                    </div>
                    <div>${eventsHTML}</div>
                `;
                
                container.appendChild(dayDiv);
            }
        }

        function calendarRenderMonth() {
            const container = document.getElementById('calendarContainer');
            container.innerHTML = '';
            
            const year = calendarDate.getFullYear();
            const month = calendarDate.getMonth();
            
            document.getElementById('calendarTitle').textContent = 
                calendarDate.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
            
            const grid = document.createElement('div');
            grid.className = 'calendar-grid';
            
            const dayNames = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
            dayNames.forEach(day => {
                const header = document.createElement('div');
                header.className = 'calendar-day-header';
                header.textContent = day;
                grid.appendChild(header);
            });
            
            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            const daysInMonth = lastDay.getDate();
            const startingDayOfWeek = firstDay.getDay();
            
            const prevMonthLastDay = new Date(year, month, 0).getDate();
            for (let i = startingDayOfWeek - 1; i >= 0; i--) {
                const day = prevMonthLastDay - i;
                const date = new Date(year, month - 1, day);
                grid.appendChild(calendarCreateMonthDay(date, true));
            }
            
            for (let day = 1; day <= daysInMonth; day++) {
                const date = new Date(year, month, day);
                grid.appendChild(calendarCreateMonthDay(date, false));
            }
            
            const totalCells = startingDayOfWeek + daysInMonth;
            const remainingCells = totalCells % 7 === 0 ? 0 : 7 - (totalCells % 7);
            for (let day = 1; day <= remainingCells; day++) {
                const date = new Date(year, month + 1, day);
                grid.appendChild(calendarCreateMonthDay(date, true));
            }
            
            container.appendChild(grid);
        }

        function calendarCreateMonthDay(date, otherMonth) {
            const dayDiv = document.createElement('div');
            dayDiv.className = 'calendar-month-day';
            
            if (otherMonth) {
                dayDiv.classList.add('other-month');
            }
            
            const today = new Date();
            if (date.toDateString() === today.toDateString()) {
                dayDiv.classList.add('today');
            }
            
            const dayEvents = calendarGetEventsForDate(date);
            const eventCount = dayEvents.length;
            
            let countHtml = '';
            if (eventCount > 0) {
                countHtml = `<div class="day-count"><span class="day-dot"></span>${eventCount}</div>`;
            }
            
            dayDiv.innerHTML = `
                <div class="day-number">${date.getDate()}</div>
                ${countHtml}
            `;
            
            dayDiv.onclick = () => {
                openDayModal(date);
            };
            
            return dayDiv;
        }

        // Day Modal Functions
        let selectedModalDate = null;

        function openDayModal(date) {
            selectedModalDate = new Date(date);
            const overlay = document.getElementById('dayModalOverlay');
            const title = document.getElementById('dayModalTitle');
            
            title.textContent = date.toLocaleDateString('en-US', { 
                weekday: 'long', month: 'long', day: 'numeric', year: 'numeric' 
            });
            
            renderDayModalEvents();
            hideDayModalForm();
            overlay.classList.add('visible');
        }

        function closeDayModal(event) {
            if (event && event.target !== event.currentTarget) return;
            document.getElementById('dayModalOverlay').classList.remove('visible');
            selectedModalDate = null;
        }

        function renderDayModalEvents() {
            const container = document.getElementById('dayModalEvents');
            const events = calendarGetEventsForDate(selectedModalDate);
            
            if (events.length === 0) {
                container.innerHTML = '<div class="day-modal-empty">No events scheduled</div>';
                return;
            }
            
            container.innerHTML = events.map(event => {
                const timeHtml = event.time ? `<div class="day-modal-event-time">${formatTime(event.time)}</div>` : '';
                const noteHtml = event.note ? `<div class="day-modal-event-note">${event.note}</div>` : '';
                
                // Handle CRM events - now with delete button for bidirectional sync
                if (event.fromCRM) {
                    const deleteId = event.crmId || event.id;
                    const editId = event.id || event.crmId;
                    return `
                        <div class="day-modal-event crm-event">
                            <div class="day-modal-event-header">
                                <div class="day-modal-event-title">${event.title} 💗</div>
                                <div class="day-modal-event-actions">
                                    <button class="day-modal-edit" onclick="editDayModalEvent('${editId}')">Edit</button>
                                    <button class="day-modal-delete" onclick="deleteDayModalEvent('${deleteId}')">×</button>
                                </div>
                            </div>
                            ${timeHtml}
                            ${noteHtml}
                        </div>
                    `;
                } else {
                    return `
                        <div class="day-modal-event">
                            <div class="day-modal-event-header">
                                <div class="day-modal-event-title">${event.title}</div>
                                <div class="day-modal-event-actions">
                                    <button class="day-modal-edit" onclick="editDayModalEvent('${event.id}')">Edit</button>
                                    <button class="day-modal-delete" onclick="deleteDayModalEvent('${event.id}')">×</button>
                                </div>
                            </div>
                            ${timeHtml}
                            ${noteHtml}
                        </div>
                    `;
                }
            }).join('');
        }

        function formatTime(time) {
            if (!time) return '';
            const [hours, minutes] = time.split(':');
            const h = parseInt(hours);
            const ampm = h >= 12 ? 'PM' : 'AM';
            const hour12 = h % 12 || 12;
            return `${hour12}:${minutes} ${ampm}`;
        }

        function showDayModalForm() {
            document.getElementById('dayModalForm').classList.add('visible');
            document.getElementById('dayModalEventTitle').value = '';
            document.getElementById('dayModalEventTime').value = '';
            document.getElementById('dayModalEventNote').value = '';
            document.getElementById('dayModalEditId').value = '';
            document.getElementById('dayModalEventTitle').focus();
        }

        function hideDayModalForm() {
            document.getElementById('dayModalForm').classList.remove('visible');
        }

        function editDayModalEvent(eventId) {
            const event = calendarEvents.find(e => e.id === eventId || e.crmId === eventId);
            if (!event) return;
            
            // Store the actual index for editing
            const index = calendarEvents.indexOf(event);
            
            document.getElementById('dayModalEventTitle').value = event.title;
            document.getElementById('dayModalEventTime').value = event.time || '';
            document.getElementById('dayModalEventNote').value = event.note || '';
            document.getElementById('dayModalEditId').value = index;
            document.getElementById('dayModalForm').classList.add('visible');
            document.getElementById('dayModalEventTitle').focus();
        }

        async function deleteDayModalEvent(eventId) {
            if (!confirm('Delete this event?')) return;
            
            // Find the event before removing it so we can check if it's a CRM event
            const event = calendarEvents.find(e => e.id === eventId || e.crmId === eventId);
            
            // If it's a CRM event, also delete from CRM Firebase
            if (event && event.fromCRM) {
                await deleteCRMEventFromFirebase(event);
            }
            
            calendarEvents = calendarEvents.filter(e => e.id !== eventId && e.crmId !== eventId);
            await calendarSaveEvents();
            renderDayModalEvents();
            calendarRender();
        }

        // Push any change (add or edit) from Life Hub to CRM via Firebase
        async function pushChangeToCRM(type, event) {
            if (!window.firebaseReady || !window.db) return;
            
            try {
                const { getDoc, setDoc, doc } = window.firestoreImports;
                const pendingRef = doc(window.db, 'crmCalendarEvents', 'pendingChanges');
                const pendingSnap = await getDoc(pendingRef);
                let changes = [];
                
                if (pendingSnap.exists() && pendingSnap.data().changes) {
                    changes = pendingSnap.data().changes;
                }
                
                changes.push({
                    type: type, // 'add' or 'edit'
                    crmId: event.crmId || null,
                    lifeHubId: event.lifeHubId || event.id,
                    title: event.title,
                    date: event.date,
                    time: event.time || '',
                    note: event.note || '',
                    isMultiDay: event.isMultiDay || false,
                    eventGroup: event.eventGroup || null,
                    updatedAt: new Date().toISOString()
                });
                
                await setDoc(pendingRef, { 
                    changes: changes, 
                    updatedAt: new Date().toISOString(),
                    source: 'lifeHub'
                });
            } catch (error) {
                // Silently fail - local change still works
            }
        }

        async function saveDayModalEvent() {
            const title = document.getElementById('dayModalEventTitle').value.trim();
            if (!title) {
                alert('Please enter an event title');
                return;
            }
            
            const time = document.getElementById('dayModalEventTime').value;
            const note = document.getElementById('dayModalEventNote').value.trim();
            const editIndexStr = document.getElementById('dayModalEditId').value;
            
            const dateStr = selectedModalDate.toISOString().split('T')[0];
            
            if (editIndexStr !== '') {
                // Update existing event by index
                const index = parseInt(editIndexStr);
                if (index >= 0 && index < calendarEvents.length) {
                    calendarEvents[index].title = title;
                    calendarEvents[index].time = time;
                    calendarEvents[index].note = note;
                    calendarEvents[index].date = dateStr;
                    
                    // Push edit to CRM for ALL events (CRM or Life Hub originated)
                    await pushChangeToCRM('edit', calendarEvents[index]);
                }
            } else {
                // Create new event
                const lifeHubId = 'lh_' + Date.now().toString() + '_' + Math.floor(Math.random() * 10000);
                const newEvent = {
                    id: lifeHubId,
                    lifeHubId: lifeHubId,
                    title: title,
                    date: dateStr,
                    time: time,
                    note: note
                };
                calendarEvents.push(newEvent);
                
                // Push new event to CRM
                await pushChangeToCRM('add', newEvent);
            }
            
            await calendarSaveEvents();
            hideDayModalForm();
            renderDayModalEvents();
            calendarRender();
        }

        function calendarRender() {
            if (calendarView === 'twoday') {
                calendarRenderTwoDay();
            } else if (calendarView === 'week') {
                calendarRenderWeek();
            } else {
                calendarRenderMonth();
            }
        }

        function calendarShowAddForm() {
            // console.log('calendarShowAddForm called');
            const overlay = document.getElementById('addEventModalOverlay');
            // console.log('Modal overlay element:', overlay);
            overlay.classList.add('visible');
            const today = new Date();
            document.getElementById('calendarEventDate').value = today.toISOString().split('T')[0];
            // console.log('✓ Add event modal opened');
        }

        function toggleRepeatOptions() {
            const repeatMode = document.getElementById('calendarRepeatMode').value;
            const singleDateMode = document.getElementById('singleDateMode');
            const multipleDateMode = document.getElementById('multipleDateMode');
            const rangeMode = document.getElementById('rangeMode');
            
            // Hide all modes first
            singleDateMode.style.display = 'none';
            multipleDateMode.classList.remove('active');
            rangeMode.classList.remove('active');
            
            // Show the selected mode
            if (repeatMode === 'single') {
                singleDateMode.style.display = 'block';
            } else if (repeatMode === 'multiple') {
                multipleDateMode.classList.add('active');
            } else if (repeatMode === 'range') {
                rangeMode.classList.add('active');
            }
        }

        function addSelectedDate() {
            const dateInput = document.getElementById('multipleDateInput');
            const date = dateInput.value;
            
            if (!date) {
                alert('Please select a date first.');
                return;
            }
            
            if (selectedDates.includes(date)) {
                alert('This date is already added.');
                return;
            }
            
            selectedDates.push(date);
            selectedDates.sort();
            renderSelectedDates();
            dateInput.value = '';
        }

        function removeSelectedDate(date) {
            selectedDates = selectedDates.filter(d => d !== date);
            renderSelectedDates();
        }

        function renderSelectedDates() {
            const container = document.getElementById('selectedDatesList');
            if (selectedDates.length === 0) {
                container.innerHTML = '<div style="color: #666; font-size: 0.85rem;">No dates selected yet</div>';
                return;
            }
            
            container.innerHTML = selectedDates.map(date => {
                const dateObj = new Date(date + 'T00:00:00');
                const formatted = dateObj.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' });
                return `<div class="date-tag">${formatted}<button onclick="removeSelectedDate('${date}')">×</button></div>`;
            }).join('');
        }

        function calendarHideAddForm() {
            const overlay = document.getElementById('addEventModalOverlay');
            overlay.classList.remove('visible');
            document.getElementById('calendarEventTitle').value = '';
            document.getElementById('calendarEventDate').value = '';
            document.getElementById('calendarRangeStartDate').value = '';
            document.getElementById('calendarEventEndDate').value = '';
            document.getElementById('calendarEventTime').value = '';
            document.getElementById('calendarEventNote').value = '';
            document.getElementById('calendarRepeatMode').value = 'single';
            document.getElementById('multipleDateInput').value = '';
            
            selectedDates = [];
            renderSelectedDates();
            toggleRepeatOptions();
        }

        function closeAddEventModal(event) {
            if (event && event.target !== event.currentTarget) return;
            calendarHideAddForm();
        }

        async function calendarAddEvent(e) {
            e.preventDefault();
            // console.log('calendarAddEvent called');
            
            const title = document.getElementById('calendarEventTitle').value;
            const repeatMode = document.getElementById('calendarRepeatMode').value;
            const time = document.getElementById('calendarEventTime').value;
            const note = document.getElementById('calendarEventNote').value;
            
            // console.log('Form values:', { title, repeatMode, time, note });
            
            if (!title) {
                alert('Please fill in the event title.');
                return;
            }
            
            const datesToAdd = [];
            
            if (repeatMode === 'single') {
                // Single date
                const date = document.getElementById('calendarEventDate').value;
                if (!date) {
                    alert('Please select a date.');
                    return;
                }
                datesToAdd.push(date);
            } else if (repeatMode === 'multiple') {
                // Multiple specific dates
                if (selectedDates.length === 0) {
                    alert('Please add at least one date.');
                    return;
                }
                datesToAdd.push(...selectedDates);
            } else if (repeatMode === 'range') {
                // Consecutive date range
                const startDate = document.getElementById('calendarRangeStartDate').value;
                const endDate = document.getElementById('calendarEventEndDate').value;
                
                if (!startDate || !endDate) {
                    alert('Please select both start and end dates.');
                    return;
                }
                
                if (endDate < startDate) {
                    alert('End date must be after start date.');
                    return;
                }
                
                const start = new Date(startDate);
                const end = new Date(endDate);
                const currentDate = new Date(start);
                
                while (currentDate <= end) {
                    datesToAdd.push(currentDate.toISOString().split('T')[0]);
                    currentDate.setDate(currentDate.getDate() + 1);
                }
            }
            
            // Create event for each date
            const isMultiDay = datesToAdd.length > 1;
            const eventGroup = isMultiDay ? Date.now().toString() : null;
            
            // console.log(`Creating ${datesToAdd.length} event(s)...`);
            const newEvents = [];
            datesToAdd.forEach(date => {
                const lifeHubId = 'lh_' + Date.now().toString() + '_' + Math.floor(Math.random() * 10000);
                const event = {
                    id: lifeHubId,
                    lifeHubId: lifeHubId,
                    title: title,
                    date: date,
                    time: time || null,
                    note: note || null,
                    isMultiDay: isMultiDay,
                    eventGroup: eventGroup,
                    repeatMode: repeatMode
                };
                calendarEvents.push(event);
                newEvents.push(event);
                // console.log('Added event:', event);
            });
            
            await calendarSaveEvents();
            
            // Push all new events to CRM
            for (const event of newEvents) {
                await pushChangeToCRM('add', event);
            }
            
            calendarHideAddForm();
            calendarRender();
            // console.log('✓ Event(s) added successfully!');
        }

        async function calendarDeleteEvent(index) {
            if (index < 0 || index >= calendarEvents.length) return;
            
            const event = calendarEvents[index];
            const eventTitle = event.title;
            
            // Check if this is part of a multi-day event
            if (event.isMultiDay && event.eventGroup) {
                const groupEvents = calendarEvents.filter(e => e.eventGroup === event.eventGroup);
                const dateList = groupEvents.map(e => {
                    const d = new Date(e.date + 'T00:00:00');
                    return d.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                }).join(', ');
                
                if (confirm(`This event appears on multiple dates (${dateList}). Delete "${eventTitle}" from all dates?\n\nThis cannot be undone.`)) {
                    // If any of the group events are CRM events, delete from CRM too
                    for (const ge of groupEvents) {
                        if (ge.fromCRM) await deleteCRMEventFromFirebase(ge);
                    }
                    calendarEvents = calendarEvents.filter(e => e.eventGroup !== event.eventGroup);
                    await calendarSaveEvents();
                    calendarRender();
                }
            } else {
                if (confirm(`Are you sure you want to delete "${eventTitle}"?\n\nThis cannot be undone.`)) {
                    // If it's a CRM event, also delete from CRM Firebase
                    if (event.fromCRM) {
                        await deleteCRMEventFromFirebase(event);
                    }
                    calendarEvents.splice(index, 1);
                    await calendarSaveEvents();
                    calendarRender();
                }
            }
        }

        function calendarEditEvent(index) {
            if (index < 0 || index >= calendarEvents.length) return;
            
            const event = calendarEvents[index];
            
            // Set the selected modal date to the event's date
            selectedModalDate = new Date(event.date + 'T00:00:00');
            
            // Pre-fill the form with event details
            document.getElementById('dayModalEventTitle').value = event.title;
            document.getElementById('dayModalEventTime').value = event.time || '';
            document.getElementById('dayModalEventNote').value = event.note || '';
            // Store the index for editing
            document.getElementById('dayModalEditId').value = index;
            
            // Open the modal
            const overlay = document.getElementById('dayModalOverlay');
            const title = document.getElementById('dayModalTitle');
            
            title.textContent = 'Edit Event - ' + selectedModalDate.toLocaleDateString('en-US', { 
                weekday: 'long', month: 'long', day: 'numeric', year: 'numeric' 
            });
            
            // Show the form in edit mode
            document.getElementById('dayModalForm').classList.add('visible');
            overlay.classList.add('visible');
            document.getElementById('dayModalEventTitle').focus();
        }

        async function calendarInit() {
            await calendarLoadEvents();
            calendarDate = new Date();
            calendarView = 'twoday';
            calendarRender();
            
            // Setup real-time listener for local calendar events
            setupFirebaseListener('calendarEvents', (data) => {
                calendarEvents = data;
                calendarRender();
            });
            
            // Setup real-time listener for MyReliaCare CRM calendar events
            // This uses a special listener because CRM data structure is different
            if (window.firebaseReady && window.db) {
                try {
                    const { onSnapshot, doc } = window.firestoreImports;
                    const docRef = doc(window.db, 'crmCalendarEvents', 'appointments');
                    
                    onSnapshot(docRef, (docSnap) => {
                        if (docSnap.exists()) {
                            const data = docSnap.data();
                            if (data.events && Array.isArray(data.events)) {
                                // console.log(`[Life Hub] Real-time update: ${data.events.length} CRM appointments`);
                                syncWithCRMEvents(data.events);
                            }
                        }
                    });
                    
                    // console.log('[Life Hub] CRM real-time listener active');
                } catch (error) {
                    // console.error('[Life Hub] Error setting up CRM listener:', error);
                }
            }
            
            // Initial sync with MyReliaCare CRM
            await loadCRMEvents();
        }

        // Load CRM events from Firebase
        async function loadCRMEvents() {
            try {
                // console.log('[Life Hub] Loading CRM calendar events...');
                
                // Wait for Firebase
                if (!window.firebaseReady || !window.db) {
                    // console.log('[Life Hub] Firebase not ready, skipping CRM load');
                    return;
                }
                
                const { getDoc, doc } = window.firestoreImports;
                const docRef = doc(window.db, 'crmCalendarEvents', 'appointments');
                const docSnap = await getDoc(docRef);
                
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    // console.log('[Life Hub] CRM data loaded:', data);
                    
                    if (data.events && Array.isArray(data.events)) {
                        // console.log(`[Life Hub] Found ${data.events.length} CRM appointments`);
                        syncWithCRMEvents(data.events);
                    } else {
                        // console.log('[Life Hub] No events array in CRM data');
                    }
                } else {
                    // console.log('[Life Hub] No CRM calendar data found yet');
                }
            } catch (error) {
                // console.error('[Life Hub] Error loading CRM events:', error);
            }
        }

        // Sync CRM events into local calendar
        function syncWithCRMEvents(crmEvents) {
            // Remove old CRM events from calendar
            const beforeCount = calendarEvents.length;
            calendarEvents = calendarEvents.filter(e => !e.fromCRM);
            
            // Also remove any local Life Hub events that now exist in CRM
            // (they've been picked up by CRM and are coming back as CRM events)
            crmEvents.forEach(crmEvent => {
                if (crmEvent.lifeHubId) {
                    calendarEvents = calendarEvents.filter(e => 
                        e.lifeHubId !== crmEvent.lifeHubId && e.id !== crmEvent.lifeHubId
                    );
                }
            });
            
            // Add CRM events (avoids duplicates)
            let addedCount = 0;
            crmEvents.forEach(crmEvent => {
                const exists = calendarEvents.some(e => 
                    e.crmId === crmEvent.crmId || 
                    (e.title === crmEvent.title && e.date === crmEvent.date && e.time === crmEvent.time)
                );
                
                if (!exists) {
                    calendarEvents.push(crmEvent);
                    addedCount++;
                }
            });
            
            // Re-render calendar with CRM events
            calendarRender();
        }

        // Delete a CRM event from the CRM Firebase collection (bidirectional sync)
        async function deleteCRMEventFromFirebase(event) {
            if (!window.firebaseReady || !window.db) return;
            
            try {
                const { getDoc, setDoc, doc } = window.firestoreImports;
                
                // 1. Remove from the shared events doc
                const docRef = doc(window.db, 'crmCalendarEvents', 'appointments');
                const docSnap = await getDoc(docRef);
                
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    if (data.events && Array.isArray(data.events)) {
                        const updatedEvents = data.events.filter(e => {
                            if (event.crmId && e.crmId) {
                                return e.crmId !== event.crmId;
                            }
                            return !(e.title === event.title && e.date === event.date && e.time === event.time);
                        });
                        
                        await setDoc(docRef, { 
                            events: updatedEvents,
                            lastSync: data.lastSync,
                            source: data.source,
                            count: updatedEvents.length
                        });
                    }
                }
                
                // 2. Write to pendingDeletes so CRM knows to delete from its own data
                if (event.crmId) {
                    const pendingRef = doc(window.db, 'crmCalendarEvents', 'pendingDeletes');
                    const pendingSnap = await getDoc(pendingRef);
                    let deleteIds = [];
                    
                    if (pendingSnap.exists() && pendingSnap.data().ids) {
                        deleteIds = pendingSnap.data().ids;
                    }
                    
                    if (!deleteIds.includes(event.crmId)) {
                        deleteIds.push(event.crmId);
                    }
                    
                    await setDoc(pendingRef, { 
                        ids: deleteIds, 
                        updatedAt: new Date().toISOString(),
                        source: 'lifeHub'
                    });
                }
            } catch (error) {
                // Silently fail - local delete still works
            }
        }

        // DAILY PROMPT FUNCTIONS
        function setDailyPrompt() {
            const today = new Date();
            const dayOfYear = Math.floor((today - new Date(today.getFullYear(), 0, 0)) / 86400000);
            const promptIndex = dayOfYear % dailyPrompts.length;
            document.getElementById('promptQuestion').textContent = dailyPrompts[promptIndex];
        }

        function togglePromptAnswers() {
            const answersGrid = document.getElementById('answersGrid');
            const expandIcon = document.getElementById('expandIcon');
            
            if (answersGrid.classList.contains('expanded')) {
                answersGrid.classList.remove('expanded');
                expandIcon.classList.remove('expanded');
            } else {
                answersGrid.classList.add('expanded');
                expandIcon.classList.add('expanded');
            }
        }

        async function saveAnswer(person) {
            const today = new Date().toDateString();
            const inputId = person === 'kasey' ? 'kaseyAnswerInput' : 'charlieAnswerInput';
            const answer = document.getElementById(inputId).value.trim();
            
            if (!answer) {
                alert('Please write an answer before saving.');
                return;
            }
            
            const savedAnswers = await loadFromFirebase('dailyPromptAnswers') || { date: today, kasey: '', charlie: '' };
            
            if (savedAnswers.date !== today) {
                savedAnswers.date = today;
                savedAnswers.kasey = '';
                savedAnswers.charlie = '';
            }
            
            savedAnswers[person] = answer;
            localStorage.setItem('dailyPromptAnswers', JSON.stringify(savedAnswers));
            await syncToFirebase('dailyPromptAnswers', savedAnswers);
            
            loadPromptAnswers();
        }

        async function loadPromptAnswers() {
            const today = new Date().toDateString();
            const savedAnswers = await loadFromFirebase('dailyPromptAnswers') || { date: today, kasey: '', charlie: '' };
            
            if (savedAnswers.date !== today) {
                const newAnswers = { date: today, kasey: '', charlie: '' };
                localStorage.setItem('dailyPromptAnswers', JSON.stringify(newAnswers));
                await syncToFirebase('dailyPromptAnswers', newAnswers);
                
                document.getElementById('kaseyAnswerContainer').style.display = 'block';
                document.getElementById('kaseyAnswerDisplay').style.display = 'none';
                document.getElementById('charlieAnswerContainer').style.display = 'block';
                document.getElementById('charlieAnswerDisplay').style.display = 'none';
                document.getElementById('kaseyAnswerInput').value = '';
                document.getElementById('charlieAnswerInput').value = '';
            } else {
                if (savedAnswers.kasey) {
                    document.getElementById('kaseyAnswerDisplay').textContent = savedAnswers.kasey;
                    document.getElementById('kaseyAnswerContainer').style.display = 'none';
                    document.getElementById('kaseyAnswerDisplay').style.display = 'block';
                } else {
                    document.getElementById('kaseyAnswerContainer').style.display = 'block';
                    document.getElementById('kaseyAnswerDisplay').style.display = 'none';
                }
                
                if (savedAnswers.charlie) {
                    document.getElementById('charlieAnswerDisplay').textContent = savedAnswers.charlie;
                    document.getElementById('charlieAnswerContainer').style.display = 'none';
                    document.getElementById('charlieAnswerDisplay').style.display = 'block';
                } else {
                    document.getElementById('charlieAnswerContainer').style.display = 'block';
                    document.getElementById('charlieAnswerDisplay').style.display = 'none';
                }
            }
        }

        // STICKY NOTES
        async function loadReminders() {
            const firebaseData = await loadFromFirebase('reminders');
            if (firebaseData) {
                reminders = firebaseData;
            } else {
                const saved = localStorage.getItem('reminders');
                if (saved) {
                    reminders = JSON.parse(saved);
                    await syncToFirebase('reminders', reminders);
                }
            }
            renderReminders();
        }

        async function saveReminders() {
            localStorage.setItem('reminders', JSON.stringify(reminders));
            await syncToFirebase('reminders', reminders);
        }

        async function addReminder() {
            const input = document.getElementById('reminderInput');
            const text = input.value.trim();
            if (text) {
                reminders.push({ text, completed: false });
                await saveReminders();
                renderReminders();
                input.value = '';
            }
        }

        async function toggleReminder(index) {
            if (index >= 0 && index < reminders.length) {
                reminders[index].completed = !reminders[index].completed;
                await saveReminders();
                renderReminders();
            }
        }

        async function deleteStickyReminder(index) {
            if (index >= 0 && index < reminders.length) {
                reminders.splice(index, 1);
                await saveReminders();
                renderReminders();
            }
        }

        function renderReminders() {
            const list = document.getElementById('remindersList');
            const expandBtn = document.getElementById('remindersExpandBtn');
            if (!list) return;
            
            if (reminders.length === 0) {
                list.innerHTML = '<div class="empty-state" style="color: #666; font-size: 0.85rem; padding: 12px;">No reminders yet</div>';
                expandBtn.classList.remove('show');
                return;
            }

            list.innerHTML = '';
            reminders.forEach((item, index) => {
                const itemDiv = document.createElement('div');
                itemDiv.className = 'sticky-item';
                itemDiv.innerHTML = `
                    <div class="sticky-item-text ${item.completed ? 'completed' : ''}" onclick="toggleReminder(${index})">${item.text}</div>
                    <button onclick="deleteStickyReminder(${index})">×</button>
                `;
                list.appendChild(itemDiv);
            });

            // Show expand button if 5 or more items
            if (reminders.length >= 5) {
                expandBtn.classList.add('show');
            } else {
                expandBtn.classList.remove('show');
                list.classList.remove('collapsed');
            }
        }

        function toggleRemindersList() {
            const list = document.getElementById('remindersList');
            const btn = document.getElementById('remindersExpandBtn');
            
            if (list.classList.contains('collapsed')) {
                list.classList.remove('collapsed');
                btn.textContent = 'Show Less';
            } else {
                list.classList.add('collapsed');
                btn.textContent = 'Show More';
            }
        }

        async function loadGroceries() {
            const firebaseData = await loadFromFirebase('groceries');
            if (firebaseData) {
                groceries = firebaseData;
            } else {
                const saved = localStorage.getItem('groceries');
                if (saved) {
                    groceries = JSON.parse(saved);
                    await syncToFirebase('groceries', groceries);
                }
            }
            renderGroceries();
        }

        async function saveGroceries() {
            localStorage.setItem('groceries', JSON.stringify(groceries));
            await syncToFirebase('groceries', groceries);
        }

        async function addGrocery() {
            const input = document.getElementById('groceryInput');
            const text = input.value.trim();
            if (text) {
                groceries.push({ text, completed: false });
                await saveGroceries();
                renderGroceries();
                input.value = '';
                input.focus(); // Keep focus on input for quick entry
            }
        }

        async function toggleGrocery(index) {
            if (index >= 0 && index < groceries.length) {
                // Mark as completed first to show the checkmark and strikethrough
                groceries[index].completed = true;
                renderGroceries();
                
                // Wait 800ms to show the checkmark, then start fade-out
                setTimeout(() => {
                    const items = document.querySelectorAll('.grocery-item');
                    if (items[index]) {
                        items[index].classList.add('fading');
                    }
                }, 800);
                
                // After fade-out animation completes, remove the item
                setTimeout(async () => {
                    if (index < groceries.length) {
                        groceries.splice(index, 1);
                        await saveGroceries();
                        renderGroceries();
                    }
                }, 1400); // 800ms delay + 600ms fade
            }
        }

        async function deleteGrocery(index) {
            if (index >= 0 && index < groceries.length) {
                groceries.splice(index, 1);
                await saveGroceries();
                renderGroceries();
            }
        }

        function renderGroceries() {
            const list = document.getElementById('groceryList');
            if (!list) return;
            
            if (groceries.length === 0) {
                list.innerHTML = '<div class="empty-state" style="color: rgba(242, 235, 224, 0.35); font-size: 0.9rem; padding: 20px; text-align: center; font-style: italic;">No items yet</div>';
                return;
            }

            list.innerHTML = '';
            groceries.forEach((item, index) => {
                const itemDiv = document.createElement('div');
                itemDiv.className = 'grocery-item' + (item.completed ? ' done' : '');
                itemDiv.innerHTML = `
                    <input type="checkbox" ${item.completed ? 'checked' : ''} onchange="toggleGrocery(${index})">
                    <span>${item.text}</span>
                `;
                list.appendChild(itemDiv);
            });
        }

        // PHONE BOOK / CONTACTS
        let contacts = [];

        async function loadMealPlanGroceries() {
            if (groceries.length > 0) {
                if (!confirm('This will add Week 1 meal plan items to your existing list. Continue?')) return;
            }

            const mealPlanItems = [
                "Chicken breast (~4 lbs)",
                "Chicken thighs, bone-in (1 lb)",
                "Ground turkey 93% lean (~3 lbs)",
                "Rotisserie chicken (1, for Day 2 soup)",
                "Chicken sausage, nitrate-free (1 pack, Day 6)",
                "Eggs (2 dozen)",
                "Broccoli (3 large crowns)",
                "Cauliflower (2 heads or 1 head + 1 bag riced)",
                "Zucchini (4 medium)",
                "Bell peppers, mixed colors (6-8)",
                "Carrots (2 lb bag)",
                "Yellow onions (4-5)",
                "Garlic (2 heads)",
                "Baby spinach (2 bags, 5oz each)",
                "Green beans (1 lb, Day 6)",
                "Butternut squash, pre-cubed (1 small bag)",
                "Potatoes (2 medium)",
                "Cucumber (1)",
                "Avocado (1, for Day 3 mousse only)",
                "Bananas (1 bunch)",
                "Mixed berries, frozen (2 bags)",
                "Blueberries, frozen (1 bag)",
                "Strawberries, fresh (1 container)",
                "Mango, frozen diced (1 bag)",
                "Pineapple, frozen chunks (1 bag)",
                "Lemons (3-4)",
                "Limes (2)",
                "Nonfat Greek yogurt (large tub, 32oz)",
                "Unsweetened almond milk (2 cartons)",
                "Shredded mozzarella (1 bag)",
                "Parmesan, grated (1 container)",
                "Feta cheese crumbles (1 container)",
                "Part-skim ricotta (1 small tub)",
                "Shredded cheddar/Mexican cheese (1 bag)",
                "Marinara sauce (2 large jars)",
                "Enchilada sauce, red (1 can)",
                "Black beans (3 cans)",
                "Cannellini/white beans (2 cans)",
                "Chickpeas (2 cans)",
                "Roasted red peppers, jarred (2 jars)",
                "Chipotle in adobo (1 small can)",
                "Low-sodium chicken broth (1 carton)",
                "Corn, canned or frozen (1)",
                "Light coconut milk (1 can)",
                "Red lentils (1 bag)",
                "French green lentils (1 small bag)",
                "Brown rice (1 bag)",
                "Farro (1 bag)",
                "Quinoa (1 bag)",
                "Whole wheat penne (1 box)",
                "Rolled oats (1 canister)",
                "Whole grain bread (1 loaf)",
                "Whole wheat tortillas, small (1 pack)",
                "Corn tortillas (1 pack)",
                "Walnuts (1 bag)",
                "Chocolate covered almonds",
                "Pumpkin seeds / pepitas (small bag)",
                "Ground flaxseed (1 bag)",
                "Chia seeds (1 bag)",
                "Hemp hearts (1 bag)",
                "Cacao powder, NOT Dutch-processed",
                "Vital Proteins chocolate collagen",
                "L-glutamine powder",
                "Nature's Way MCT oil",
                "ON Gold Standard Banana Cream whey",
                "Natural peanut butter",
                "Walnut butter",
                "Tahini (1 jar)",
                "Hummus (1 tub)",
                "Extra virgin olive oil",
                "Sesame oil (small bottle)",
                "Balsamic glaze (small bottle)",
                "Red wine vinegar",
                "Honey",
                "Low-sodium soy sauce",
                "Hot sauce",
                "Salsa, smooth/sauce-style",
                "Italian seasoning",
                "Smoked paprika",
                "Cumin, ground",
                "Garlic powder",
                "Onion powder",
                "Red pepper flakes",
                "Cinnamon, ground",
                "Sazon seasoning",
                "Taco seasoning",
                "Dark chocolate bar (for desserts)",
                "Dark chocolate chips",
                "Mini dark chocolate chips",
                "Cocoa powder (for mousse)",
                "Coconut sugar (small bag)",
                "Toasted coconut flakes (small bag)"
            ];

            const newItems = mealPlanItems.map(text => ({ text, completed: false }));
            groceries = [...groceries, ...newItems];
            await saveGroceries();
            renderGroceries();
        }

        async function loadContacts() {
            const firebaseData = await loadFromFirebase('contacts');
            if (firebaseData) {
                contacts = firebaseData;
            } else {
                const saved = localStorage.getItem('contacts');
                if (saved) {
                    contacts = JSON.parse(saved);
                    await syncToFirebase('contacts', contacts);
                }
            }
            renderContacts();
        }

        async function saveContacts() {
            localStorage.setItem('contacts', JSON.stringify(contacts));
            await syncToFirebase('contacts', contacts);
        }

        function renderContacts() {
            const list = document.getElementById('contactsList');
            if (!list) return;
            
            const searchTerm = (document.getElementById('phonebookSearch')?.value || '').toLowerCase();
            const filtered = contacts.filter(c => 
                c.name.toLowerCase().includes(searchTerm) ||
                (c.phone && c.phone.includes(searchTerm)) ||
                (c.notes && c.notes.toLowerCase().includes(searchTerm))
            );
            
            if (filtered.length === 0) {
                list.innerHTML = contacts.length === 0 
                    ? '<div style="color: rgba(242, 235, 224, 0.4); font-size: 0.85rem; padding: 12px; font-style: italic;">No contacts yet</div>'
                    : '<div style="color: rgba(242, 235, 224, 0.4); font-size: 0.85rem; padding: 12px; font-style: italic;">No matches found</div>';
                return;
            }
            
            list.innerHTML = filtered.map((contact, i) => {
                const realIndex = contacts.indexOf(contact);
                let linksHtml = '';
                if (contact.phone) {
                    linksHtml += `<a href="tel:${contact.phone}" class="contact-link phone">Call: ${contact.phone}</a>`;
                }
                if (contact.email) {
                    linksHtml += `<a href="mailto:${contact.email}" class="contact-link">Email</a>`;
                }
                if (contact.website) {
                    linksHtml += `<a href="${contact.website}" target="_blank" class="contact-link">Website</a>`;
                }
                let notesHtml = contact.notes ? `<div class="contact-notes">${contact.notes}</div>` : '';
                
                return `
                    <div class="contact">
                        <div class="contact-header">
                            <div class="contact-name">${contact.name}</div>
                            <div class="contact-actions">
                                <button class="contact-edit-btn" onclick="editContact(${realIndex})">Edit</button>
                                <button class="contact-delete-btn" onclick="deleteContact(${realIndex})">×</button>
                            </div>
                        </div>
                        <div class="contact-links">${linksHtml}</div>
                        ${notesHtml}
                    </div>
                `;
            }).join('');
        }

        function filterContacts() {
            renderContacts();
        }

        function toggleGroceryList() {
            const content = document.getElementById('groceryContent');
            const icon = document.getElementById('groceryIcon');
            if (!content || !icon) return;
            content.classList.toggle('expanded');
            icon.style.transform = content.classList.contains('expanded') ? 'rotate(0deg)' : 'rotate(-90deg)';
        }

        function togglePhonebook() {
            const content = document.getElementById('phonebookContent');
            const icon = document.getElementById('phonebookIcon');
            if (!content || !icon) return;
            content.classList.toggle('expanded');
            icon.style.transform = content.classList.contains('expanded') ? 'rotate(0deg)' : 'rotate(-90deg)';
        }

        function toggleAddContact() {
            document.getElementById('addContactForm')?.classList.toggle('visible');
        }

        async function saveContact() {
            const name = document.getElementById('contactName')?.value.trim();
            if (!name) {
                alert('Please enter a name');
                return;
            }
            
            const contact = {
                id: Date.now(),
                name: name,
                phone: document.getElementById('contactPhone')?.value.trim() || '',
                email: document.getElementById('contactEmail')?.value.trim() || '',
                website: document.getElementById('contactWebsite')?.value.trim() || '',
                notes: document.getElementById('contactNotes')?.value.trim() || ''
            };
            
            contacts.push(contact);
            await saveContacts();
            renderContacts();
            
            // Clear form
            ['contactName', 'contactPhone', 'contactEmail', 'contactWebsite', 'contactNotes'].forEach(id => {
                const el = document.getElementById(id);
                if (el) el.value = '';
            });
            toggleAddContact();
        }

        function editContact(index) {
            const contact = contacts[index];
            if (!contact) return;
            
            document.getElementById('contactName').value = contact.name;
            document.getElementById('contactPhone').value = contact.phone || '';
            document.getElementById('contactEmail').value = contact.email || '';
            document.getElementById('contactWebsite').value = contact.website || '';
            document.getElementById('contactNotes').value = contact.notes || '';
            
            contacts.splice(index, 1);
            saveContacts();
            renderContacts();
            
            document.getElementById('addContactForm')?.classList.add('visible');
        }

        async function deleteContact(index) {
            if (confirm('Delete this contact?')) {
                contacts.splice(index, 1);
                await saveContacts();
                renderContacts();
            }
        }




        // MONTHLY CHALLENGE FUNCTIONS
        async function setMonthlyChallenge() {
            const today = new Date();
            const currentMonth = today.getMonth();
            const currentYear = today.getFullYear();
            const monthNames = ['January', 'February', 'March', 'April', 'May', 'June', 
                              'July', 'August', 'September', 'October', 'November', 'December'];
            
            document.getElementById('challengeMonth').textContent = `${monthNames[currentMonth]} ${currentYear}`;
            
            const challengeIndex = currentMonth;
            document.getElementById('challengeText').textContent = monthlyChallenges[challengeIndex];
            
            await loadChallengeStatus();
        }

        async function loadChallengeStatus() {
            const today = new Date();
            const currentMonth = `${today.getFullYear()}-${today.getMonth()}`;
            const savedChallenge = await loadFromFirebase('monthlyChallenge') || { month: currentMonth, completed: false };
            
            if (savedChallenge.month === currentMonth && savedChallenge.completed) {
                document.getElementById('challengeComplete').checked = true;
                document.getElementById('challengeStatus').textContent = 'Completed';
            } else {
                document.getElementById('challengeComplete').checked = false;
                document.getElementById('challengeStatus').textContent = 'Not completed';
                if (savedChallenge.month !== currentMonth) {
                    const newChallenge = { month: currentMonth, completed: false };
                    localStorage.setItem('monthlyChallenge', JSON.stringify(newChallenge));
                    await syncToFirebase('monthlyChallenge', newChallenge);
                }
            }
        }

        async function toggleChallenge() {
            const isCompleted = document.getElementById('challengeComplete').checked;
            const today = new Date();
            const currentMonth = `${today.getFullYear()}-${today.getMonth()}`;
            
            const challengeData = {
                month: currentMonth,
                completed: isCompleted
            };
            
            localStorage.setItem('monthlyChallenge', JSON.stringify(challengeData));
            await syncToFirebase('monthlyChallenge', challengeData);
            
            if (isCompleted) {
                document.getElementById('challengeStatus').textContent = 'Completed';
            } else {
                document.getElementById('challengeStatus').textContent = 'Not completed';
            }
        }

        function toggleChallengeNotes() {
            const content = document.getElementById('challengeNotesContent');
            const icon = document.getElementById('challengeNotesIcon');
            
            if (content.classList.contains('expanded')) {
                content.classList.remove('expanded');
                icon.classList.remove('expanded');
            } else {
                content.classList.add('expanded');
                icon.classList.add('expanded');
            }
        }

        async function saveChallengeNotes() {
            const today = new Date();
            const currentMonth = `${today.getFullYear()}-${today.getMonth()}`;
            const notes = document.getElementById('challengeNotesInput').value.trim();
            
            const notesData = {
                month: currentMonth,
                notes: notes
            };
            
            localStorage.setItem('challengeNotes', JSON.stringify(notesData));
            await syncToFirebase('challengeNotes', notesData);
            
            loadChallengeNotes();
        }

        function editChallengeNotes() {
            const displayText = document.getElementById('challengeNotesDisplay').textContent;
            document.getElementById('challengeNotesInput').value = displayText;
            document.getElementById('challengeNotesEdit').style.display = 'block';
            document.getElementById('challengeNotesDisplayContainer').style.display = 'none';
        }

        async function loadChallengeNotes() {
            const today = new Date();
            const currentMonth = `${today.getFullYear()}-${today.getMonth()}`;
            const savedNotes = await loadFromFirebase('challengeNotes') || { month: currentMonth, notes: '' };
            
            if (savedNotes.month !== currentMonth) {
                const newNotes = { month: currentMonth, notes: '' };
                localStorage.setItem('challengeNotes', JSON.stringify(newNotes));
                await syncToFirebase('challengeNotes', newNotes);
                document.getElementById('challengeNotesInput').value = '';
                document.getElementById('challengeNotesEdit').style.display = 'block';
                document.getElementById('challengeNotesDisplayContainer').style.display = 'none';
            } else if (savedNotes.notes) {
                document.getElementById('challengeNotesDisplay').textContent = savedNotes.notes;
                document.getElementById('challengeNotesEdit').style.display = 'none';
                document.getElementById('challengeNotesDisplayContainer').style.display = 'block';
            } else {
                document.getElementById('challengeNotesInput').value = '';
                document.getElementById('challengeNotesEdit').style.display = 'block';
                document.getElementById('challengeNotesDisplayContainer').style.display = 'none';
            }
        }

        // Setup real-time listeners for all collections
        function setupAllListeners() {
            setupFirebaseListener('reminders', (data) => {
                reminders = data;
                renderReminders();
            });
            
            setupFirebaseListener('groceries', (data) => {
                groceries = data;
                renderGroceries();
            });
            
            setupFirebaseListener('contacts', (data) => {
                contacts = data;
                renderContacts();
            });
            
            setupFirebaseListener('lifeReminders', (data) => {
                lifeReminders = data;
                updateReminderDisplay();
            });
            
            setupFirebaseListener('eventCompletions', (data) => {
                localStorage.setItem('eventCompletions', JSON.stringify(data));
                calendarRender();
            });
        }

        // Initialize everything
        document.addEventListener('DOMContentLoaded', async function() {
            try {
                // Set today's date in header
                const dateEl = document.getElementById('homeDate');
                if (dateEl) {
                    const now = new Date();
                    dateEl.textContent = now.toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric' });
                }
                
                // console.log('Starting initialization...');
                
                // Set a timeout for the entire initialization
                const initTimeout = setTimeout(() => {
                    // console.warn('⚠️ Initialization timeout after 10 seconds');
                    // console.log('Firebase status:', window.firebaseReady ? 'Connected' : 'NOT CONNECTED - app will use localStorage only');
                    document.body.style.opacity = '1'; // Make page visible anyway
                }, 10000); // 10 second timeout
                
                await calendarInit();
                // console.log('Calendar initialized');
                
                await loadLifeReminders();
                // console.log('Life reminders loaded');
                
                await loadReminders();
                // console.log('Reminders loaded');
                
                await loadGroceries();
                // console.log('Groceries loaded');
                
                await loadContacts();
                // console.log('Contacts loaded');
                
                await loadEventCompletions();
                
                await loadHeaderPhoto();
                // console.log('Header photo loaded');
                
                // Setup photo upload and drag
                document.getElementById('photoUpload').addEventListener('change', handlePhotoUpload);
                setupPhotoDrag();
                
                // Setup real-time listeners
                setTimeout(setupAllListeners, 1000);
                
                clearTimeout(initTimeout);
                // console.log('Initialization complete!');
                // console.log('Firebase status:', window.firebaseReady ? '✓ Connected' : '✗ Not connected');
                if (!window.firebaseReady && window.firebaseError) {
                    // console.error('Firebase error:', window.firebaseError);
                }
            } catch (error) {
                // console.error('❌ Initialization error:', error);
                // console.error('Error details:', error.message);
                // Show page anyway even if there's an error
                document.body.style.opacity = '1';
                // console.warn('⚠️ App loaded with errors - check console above for details');
                // console.log('💡 The app will work with localStorage only (no sync between devices)');
            }
        });

        let photoPosition = { x: 0, y: 0 };
        let photoScale = 1;
        let isDragging = false;
        let startPos = { x: 0, y: 0 };
        let photoEditMode = false;

        async function loadHeaderPhoto() {
            // Don't load if we're actively saving a new photo
            if (_photoSaving) return;
            
            const localRaw = localStorage.getItem('headerPhoto');
            const localPhoto = localRaw ? JSON.parse(localRaw) : null;
            const firebasePhoto = await loadFromFirebase('headerPhoto');
            
            // Use whichever is newer, or whichever exists
            let photo = null;
            if (firebasePhoto && firebasePhoto.data && localPhoto && localPhoto.data) {
                const fbTime = new Date(firebasePhoto.uploaded || 0).getTime();
                const localTime = new Date(localPhoto.uploaded || 0).getTime();
                photo = localTime >= fbTime ? localPhoto : firebasePhoto;
                // Sync the winner back
                if (localTime > fbTime) {
                    syncToFirebase('headerPhoto', localPhoto);
                } else if (fbTime > localTime) {
                    localStorage.setItem('headerPhoto', JSON.stringify(firebasePhoto));
                }
            } else {
                photo = (firebasePhoto && firebasePhoto.data) ? firebasePhoto : localPhoto;
            }
            
            if (photo && photo.data) {
                displayPhoto(photo.data, photo.position, photo.scale);
            }
        }

        function displayPhoto(dataUrl, position = { x: 0, y: 0 }, scale = 1.5) {
            const img = document.getElementById('headerPhoto');
            const draggable = document.getElementById('photoDraggable');
            const placeholder = document.getElementById('photoPlaceholder');
            const uploadBtn = document.getElementById('uploadBtn');
            
            img.src = dataUrl;
            img.onload = function() {
                photoPosition = position;
                photoScale = scale;
                updatePhotoTransform();
                draggable.style.display = 'block';
                placeholder.style.display = 'none';
                // Hide the no-photo upload button once we have a photo
                if (uploadBtn) uploadBtn.classList.remove('no-photo');
                // Show the edit hint pencil
                const hint = document.getElementById('photoEditHint');
                if (hint) hint.classList.add('visible');
            };
        }

        function updatePhotoTransform() {
            const draggable = document.getElementById('photoDraggable');
            const img = document.getElementById('headerPhoto');
            
            const containerSize = 120;
            const imgAspect = img.naturalWidth / img.naturalHeight;
            
            let width, height;
            if (imgAspect > 1) {
                height = containerSize * photoScale;
                width = height * imgAspect;
            } else {
                width = containerSize * photoScale;
                height = width / imgAspect;
            }
            
            img.style.width = width + 'px';
            img.style.height = height + 'px';
            draggable.style.left = photoPosition.x + 'px';
            draggable.style.top = photoPosition.y + 'px';
        }

        async function handlePhotoUpload(e) {
            const file = e.target.files[0];
            if (!file) return;
            
            if (!file.type.startsWith('image/')) {
                alert('Please select an image file.');
                return;
            }
            
            // Compress image to stay under Firestore 1MB limit
            const compressed = await compressImage(file, 600, 0.7);
            
            photoPosition = { x: 0, y: 0 };
            photoScale = 1.5;
            
            displayPhoto(compressed, photoPosition, photoScale);
            await savePhotoData(compressed);
            // Auto-enter edit mode so they can reposition the new photo
            enterPhotoEditMode();
        }

        function compressImage(file, maxSize, quality) {
            return new Promise((resolve) => {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const img = new Image();
                    img.onload = function() {
                        const canvas = document.createElement('canvas');
                        let w = img.width, h = img.height;
                        if (w > h && w > maxSize) { h = h * maxSize / w; w = maxSize; }
                        else if (h > maxSize) { w = w * maxSize / h; h = maxSize; }
                        canvas.width = w;
                        canvas.height = h;
                        canvas.getContext('2d').drawImage(img, 0, 0, w, h);
                        resolve(canvas.toDataURL('image/jpeg', quality));
                    };
                    img.src = e.target.result;
                };
                reader.readAsDataURL(file);
            });
        }

        let _photoSaving = false;

        async function savePhotoData(dataUrl = null) {
            _photoSaving = true;
            const img = document.getElementById('headerPhoto');
            const photoData = {
                data: dataUrl || img.src,
                position: photoPosition,
                scale: photoScale,
                uploaded: new Date().toISOString()
            };
            
            localStorage.setItem('headerPhoto', JSON.stringify(photoData));
            await syncToFirebase('headerPhoto', photoData);
            _photoSaving = false;
        }

        function zoomPhoto(delta) {
            photoScale = Math.max(0.5, Math.min(3, photoScale + delta));
            updatePhotoTransform();
            savePhotoData();
        }

        // Photo edit overlay - show on double-click/double-tap
        function showPhotoOverlay() {
            const overlay = document.getElementById('photoEditOverlay');
            if (overlay && !photoEditMode) {
                overlay.classList.add('visible');
            }
        }

        function hidePhotoOverlay() {
            const overlay = document.getElementById('photoEditOverlay');
            if (overlay) overlay.classList.remove('visible');
        }

        function enterPhotoEditMode() {
            photoEditMode = true;
            hidePhotoOverlay();
            const wrapper = document.getElementById('photoWrapper');
            const container = document.getElementById('photoContainer');
            const draggable = document.getElementById('photoDraggable');
            if (wrapper) wrapper.classList.add('edit-mode');
            if (container) container.classList.add('edit-mode');
            if (draggable) draggable.classList.add('editing');
        }

        function exitPhotoEditMode() {
            photoEditMode = false;
            const wrapper = document.getElementById('photoWrapper');
            const container = document.getElementById('photoContainer');
            const draggable = document.getElementById('photoDraggable');
            if (wrapper) wrapper.classList.remove('edit-mode');
            if (container) container.classList.remove('edit-mode');
            if (draggable) draggable.classList.remove('editing');
            savePhotoData();
        }

        // Setup drag functionality - only works in edit mode
        function setupPhotoDrag() {
            const container = document.getElementById('photoContainer');
            const draggable = document.getElementById('photoDraggable');
            
            // Close overlay if tapping outside
            document.addEventListener('click', function(e) {
                const overlay = document.getElementById('photoEditOverlay');
                if (overlay && overlay.classList.contains('visible') && !container.contains(e.target)) {
                    hidePhotoOverlay();
                }
            });
            
            // Drag - only in edit mode
            draggable.addEventListener('mousedown', startDrag);
            draggable.addEventListener('touchstart', startDrag, { passive: false });
            
            document.addEventListener('mousemove', drag);
            document.addEventListener('touchmove', drag, { passive: false });
            
            document.addEventListener('mouseup', endDrag);
            document.addEventListener('touchend', endDrag);
        }

        function startDrag(e) {
            if (!photoEditMode) return; // Only drag in edit mode
            isDragging = true;
            const draggable = document.getElementById('photoDraggable');
            draggable.classList.add('dragging');
            
            const clientX = e.touches ? e.touches[0].clientX : e.clientX;
            const clientY = e.touches ? e.touches[0].clientY : e.clientY;
            
            startPos = {
                x: clientX - photoPosition.x,
                y: clientY - photoPosition.y
            };
            
            e.preventDefault();
        }

        function drag(e) {
            if (!isDragging || !photoEditMode) return;
            
            const clientX = e.touches ? e.touches[0].clientX : e.clientX;
            const clientY = e.touches ? e.touches[0].clientY : e.clientY;
            
            photoPosition = {
                x: clientX - startPos.x,
                y: clientY - startPos.y
            };
            
            updatePhotoTransform();
            e.preventDefault();
        }

        function endDrag() {
            if (isDragging) {
                isDragging = false;
                const draggable = document.getElementById('photoDraggable');
                draggable.classList.remove('dragging');
                if (photoEditMode) savePhotoData();
            }
        }
    </script>

<script>
function toggleNav() {
    var h = document.getElementById('navHamburger');
    var o = document.getElementById('navOverlay');
    if (!h || !o) return;
    var isOpen = o.classList.contains('open');
    if (isOpen) {
        h.classList.remove('open');
        o.classList.remove('open');
        document.body.style.overflow = '';
    } else {
        h.classList.add('open');
        o.classList.add('open');
        document.body.style.overflow = 'hidden';
    }
}
</script>
</body>
</html>
