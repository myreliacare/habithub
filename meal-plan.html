<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Meal Plan | Our Life Hub</title>
    <script>
    /* Life Hub Settings Engine v2 - Complete Color Rewriting */
    (function(){
        if(window._lhEngineLoaded) return; window._lhEngineLoaded=true;

        // ── Color manipulation helpers ──
        function h2r(h){h=h.replace('#','');return[parseInt(h.substring(0,2),16),parseInt(h.substring(2,4),16),parseInt(h.substring(4,6),16)];}
        function r2h(r,g,b){return'#'+((1<<24)+(r<<16)+(g<<8)+b).toString(16).slice(1);}
        function clamp(v){return Math.max(0,Math.min(255,Math.round(v)));}
        function lighten(hex,pct){var c=h2r(hex);return r2h(clamp(c[0]+(255-c[0])*pct),clamp(c[1]+(255-c[1])*pct),clamp(c[2]+(255-c[2])*pct));}
        function darken(hex,pct){var c=h2r(hex);return r2h(clamp(c[0]*(1-pct)),clamp(c[1]*(1-pct)),clamp(c[2]*(1-pct)));}
        function rgbStr(hex){var c=h2r(hex);return c[0]+','+c[1]+','+c[2];}

        // ── Palette definitions (v3) ──
        var accentHexMap={sage:'#a3b899',blush:'#d4919e',cream:'#e8ddd0',periwinkle:'#8e9cc7',dustylilac:'#c3a6c9',powderblue:'#a4c2d8',softmint:'#a8d8c4',moss:'#8a9c6b',burntsienna:'#c97856',dustyteal:'#6d9e9e',petalpink:'#e8b4b8',apricot:'#e8b088',palejade:'#8ec4a8',raspberry:'#b0607a',denim:'#6888a8',nude:'#d4b8a8',obsidian:'#181818',darkplum:'#3d2f31',storm:'#252830'};
        var defaultSecMap={sage:'petalpink',blush:'sage',cream:'petalpink',periwinkle:'petalpink',dustylilac:'petalpink',powderblue:'petalpink',softmint:'petalpink',moss:'petalpink',burntsienna:'sage',petalpink:'sage',dustyteal:'petalpink',apricot:'sage',palejade:'petalpink',raspberry:'sage',denim:'petalpink',nude:'sage',obsidian:'petalpink',darkplum:'sage',storm:'petalpink'};
        var bgMap={dark:'#3d2f31',forest:'#1f2e2a',espresso:'#2b2220',storm:'#252830',midnight:'#141420',warmcocoa:'#362a28',deepteal:'#1a2e2e',warmlinen:'#f0e8dc',dustymauve:'#332830',obsidian:'#181818',softblush:'#f0d4da',bordeaux:'#301820'};
        var bgDkMap={dark:'#2a1f21',forest:'#15231f',espresso:'#1e1816',storm:'#1b1d24',midnight:'#0d0d16',warmcocoa:'#281e1c',deepteal:'#122020',warmlinen:'#e4dace',dustymauve:'#261c24',obsidian:'#101010',softblush:'#e5c8cf',bordeaux:'#221018'};
        var tcMap={dark:{t:'#e0d2d0',m:'rgba(242,235,224,0.6)',f:'rgba(242,235,224,0.4)'},forest:{t:'#e0d2d0',m:'rgba(242,235,224,0.6)',f:'rgba(242,235,224,0.4)'},espresso:{t:'#e0d2d0',m:'rgba(242,235,224,0.6)',f:'rgba(242,235,224,0.4)'},storm:{t:'#e0d2d0',m:'rgba(242,235,224,0.6)',f:'rgba(242,235,224,0.4)'},midnight:{t:'#e0d2d0',m:'rgba(242,235,224,0.6)',f:'rgba(242,235,224,0.4)'},warmcocoa:{t:'#e0d2d0',m:'rgba(242,235,224,0.6)',f:'rgba(242,235,224,0.4)'},deepteal:{t:'#e0d2d0',m:'rgba(242,235,224,0.6)',f:'rgba(242,235,224,0.4)'},warmlinen:{t:'#3d2f31',m:'rgba(61,47,49,0.65)',f:'rgba(61,47,49,0.4)'},dustymauve:{t:'#e0d2d0',m:'rgba(242,235,224,0.6)',f:'rgba(242,235,224,0.4)'},obsidian:{t:'#e0d2d0',m:'rgba(242,235,224,0.6)',f:'rgba(242,235,224,0.4)'},softblush:{t:'#3d2f31',m:'rgba(61,47,49,0.65)',f:'rgba(61,47,49,0.4)'},bordeaux:{t:'#e0d2d0',m:'rgba(242,235,224,0.6)',f:'rgba(242,235,224,0.4)'}};
        var fontMap={philosopher:"'Philosopher',Georgia,serif",cormorant:"'Cormorant Garamond',Georgia,serif",worksans:"'Work Sans',sans-serif",baloo:"'Baloo 2',cursive",lora:"'Lora',Georgia,serif",cardo:"'Cardo',Georgia,serif",playfair:"'Playfair Display',Georgia,serif",kalam:"'Kalam',cursive",lobster:"'Lobster',cursive",indieflower:"'Indie Flower',cursive",gilda:"'Gilda Display',Georgia,serif",cormorantinfant:"'Cormorant Infant',Georgia,serif",dmserif:"'DM Serif Display',Georgia,serif",tenor:"'Tenor Sans',sans-serif",dancing:"'Dancing Script',cursive",satisfy:"'Satisfy',cursive",greatvibes:"'Great Vibes',cursive",abril:"'Abril Fatface',Georgia,serif"};

        // ── Read settings ──
        var ac=localStorage.getItem('accentColor')||'sage';
        var sc=localStorage.getItem('secondaryColor')||'';
        // Migrate removed color keys
        if(ac==='rosegold'){ac='petalpink';localStorage.setItem('accentColor','petalpink');}
        if(sc==='rosegold'){sc='petalpink';localStorage.setItem('secondaryColor','petalpink');}

        var bc=localStorage.getItem('bgColor')||'dark';
        var ff=localStorage.getItem('fontFamily')||'philosopher';
        var hf=localStorage.getItem('headingFont')||'philosopher';
        var fs=parseInt(localStorage.getItem('fontSize')||'100',10);
        var appName=localStorage.getItem('appName')||'Our Life Hub';
        var names;try{names=JSON.parse(localStorage.getItem('userNames')||'{}');}catch(e){names={};}
        names.name1=names.name1||'Kasey'; names.name2=names.name2||'Charlie';
        var archivedPages;try{archivedPages=JSON.parse(localStorage.getItem('archivedPages')||'[]');}catch(e){archivedPages=[];}

        // Resolve colors
        var secKey=sc||defaultSecMap[ac]||'petalpink';
        var pa=accentHexMap[ac]||accentHexMap.sage;
        var secHex=accentHexMap[secKey]||accentHexMap.petalpink;
        var bg=bgMap[bc]||bgMap.dark;
        var bgDk=bgDkMap[bc]||bgDkMap.dark;
        var tc=tcMap[bc]||tcMap.dark;
        var font=fontMap[ff]||fontMap.philosopher;
        var hFont=fontMap[hf]||fontMap.philosopher;
        var basePx=Math.round(16*fs/100);

        // ── Generate color variants ──
        var A={vdark:darken(pa,0.45),dark:darken(pa,0.30),mdark:darken(pa,0.15),base:pa,light:lighten(pa,0.15),vlight:lighten(pa,0.30),xlight:lighten(pa,0.50),hover:lighten(pa,0.12)};
        var S={vdark:darken(secHex,0.45),dark:darken(secHex,0.30),mdark:darken(secHex,0.15),base:secHex,light:lighten(secHex,0.10),vlight:lighten(secHex,0.25),xlight:lighten(secHex,0.40),redish:darken(secHex,0.10)};
        var bgMid=lighten(bg,0.15);

        // ── Apply CSS custom properties ──
        var r=document.documentElement;
        r.style.setProperty('--lh-accent',A.base);
        r.style.setProperty('--lh-accent-hover',A.hover);
        r.style.setProperty('--lh-accent-muted','rgba('+rgbStr(A.base)+',0.2)');
        r.style.setProperty('--lh-accent-border','rgba('+rgbStr(A.base)+',0.3)');
        r.style.setProperty('--lh-accent-text','rgba('+rgbStr(A.base)+',0.6)');
        r.style.setProperty('--lh-bg',bg);
        r.style.setProperty('--lh-bg-darker',bgDk);
        r.style.setProperty('--lh-secondary',S.base);
        var sR=parseInt(secHex.slice(1,3),16),sG=parseInt(secHex.slice(3,5),16),sB=parseInt(secHex.slice(5,7),16);
        r.style.setProperty('--lh-secondary-muted','rgba('+sR+','+sG+','+sB+',0.15)');
        r.style.setProperty('--lh-secondary-border','rgba('+sR+','+sG+','+sB+',0.3)');
        r.style.setProperty('--lh-text',tc.t);
        r.style.setProperty('--lh-text-muted',tc.m);
        r.style.setProperty('--lh-text-faint',tc.f);
        r.style.setProperty('--lh-font',font);
        r.style.setProperty('--lh-heading-font',hFont);
        r.style.setProperty('--lh-font-size',basePx+'px');
        r.style.background=bg; r.style.fontSize=basePx+'px';

        // Load fonts
        var fontUrls={philosopher:'Philosopher:ital,wght@0,400;0,700;1,400',cormorant:'Cormorant+Garamond:wght@300;400;500;600;700',worksans:'Work+Sans:wght@400;500;600;700;800',baloo:'Baloo+2:wght@400;500;600;700;800',lora:'Lora:ital,wght@0,400;0,500;0,600;0,700;1,400',cardo:'Cardo:ital,wght@0,400;0,700;1,400',playfair:'Playfair+Display:ital,wght@0,400;0,500;0,600;0,700;1,400',kalam:'Kalam:wght@300;400;700',lobster:'Lobster',indieflower:'Indie+Flower',gilda:'Gilda+Display',cormorantinfant:'Cormorant+Infant:ital,wght@0,300;0,400;0,500;0,600;0,700;1,400',dmserif:'DM+Serif+Display:ital@0;1',tenor:'Tenor+Sans',dancing:'Dancing+Script:wght@400;500;600;700',satisfy:'Satisfy',greatvibes:'Great+Vibes',abril:'Abril+Fatface'};
        var neededFonts=[];
        [ff,hf].forEach(function(f){if(fontUrls[f]&&neededFonts.indexOf(fontUrls[f])===-1)neededFonts.push(fontUrls[f]);});
        if(neededFonts.length){var link=document.createElement('link');link.rel='stylesheet';link.href='https://fonts.googleapis.com/css2?'+neededFonts.map(function(f){return'family='+f;}).join('&')+'&display=swap';document.head.appendChild(link);}

        // Body + heading font injection
        var hfSt=document.createElement('style');hfSt.textContent='body{font-family:'+font+'!important} .top-nav,.nav-link,.nav-link-mobile{font-family:'+font+'!important} .nav-logo,.page-title,.home-title,.main-title{font-family:'+hFont+'!important}';(document.head||r).appendChild(hfSt);

        // Archive nav links
        var pageHrefs={home:'index.html',person1:'kasey-hub.html',person2:'charlie-hub.html',dreams:'our-dreams.html',meals:'meal-plan.html',settings:'settings.html'};
        var archCSS='';archivedPages.forEach(function(k){var h=pageHrefs[k];if(h)archCSS+='a.nav-link[href="'+h+'"],a.nav-link-mobile[href="'+h+'"]{display:none!important}\n';});
        if(archCSS){var st=document.createElement('style');st.textContent=archCSS;(document.head||r).appendChild(st);}

        // Expose globally
        window.LifeHubSettings={current:{appName:appName,names:names,accentColor:ac,secondaryColor:sc,bgColor:bc,fontFamily:ff,headingFont:hf,fontSize:fs,archivedPages:archivedPages,archivedSections:JSON.parse(localStorage.getItem('archivedSections')||'{}'),features:JSON.parse(localStorage.getItem('features')||'{}'),pageLabels:JSON.parse(localStorage.getItem('pageLabels')||'{}')},getName:function(p){return p===1||p==='person1'?names.name1:names.name2;},accentHexMap:accentHexMap,defaultSecMap:defaultSecMap};

        function onReady(fn){if(document.readyState!=='loading')fn();else document.addEventListener('DOMContentLoaded',fn);}
        onReady(function(){
            // ── Apply names ──
            document.querySelectorAll('.nav-logo').forEach(function(el){el.textContent=appName;});
            document.querySelectorAll('.nav-link,.nav-link-mobile').forEach(function(lnk){
                var href=lnk.getAttribute('href')||'';
                if(href==='kasey-hub.html')lnk.textContent=names.name1;
                if(href==='charlie-hub.html')lnk.textContent=names.name2;
            });
            document.querySelectorAll('[data-lh-name="app"]').forEach(function(el){el.textContent=appName;});
            document.querySelectorAll('[data-lh-name="person1"]').forEach(function(el){el.textContent=names.name1;});
            document.querySelectorAll('[data-lh-name="person2"]').forEach(function(el){el.textContent=names.name2;});
            var title=document.title;
            if(title.indexOf('Our Life Hub')!==-1)document.title=title.replace('Our Life Hub',appName);
            if(title.indexOf("Kasey's")!==-1)document.title=title.replace("Kasey's",names.name1+"'s");
            else if(title.indexOf('Kasey')!==-1)document.title=title.replace('Kasey',names.name1);
            if(title.indexOf("Charlie's")!==-1)document.title=title.replace("Charlie's",names.name2+"'s");
            else if(title.indexOf('Charlie')!==-1)document.title=title.replace('Charlie',names.name2);

            // ── Skip rewriting if all defaults ──
            if(ac==='sage'&&secKey===(defaultSecMap.sage||'petalpink')&&bc==='dark')return;

            // ── Build replacement map ──
            var reps=[];

            if(ac!=='sage'){
                var aRgb=rgbStr(A.base);

                // PRIMARY ACCENT — hex values (green family)
                reps.push(['#4a5c3f',A.vdark],['#4a6a3e',A.vdark],['#4A5C3F',A.vdark],['#4A6A3E',A.vdark]);
                reps.push(['#6d8a5e',A.dark],['#5a7a4a',A.dark],['#6D8A5E',A.dark],['#5A7A4A',A.dark]);
                reps.push(['#7d8f76',A.mdark],['#8fa87a',A.mdark],['#8fa882',A.mdark],['#7a9b6a',A.mdark]);
                reps.push(['#7D8F76',A.mdark],['#8FA87A',A.mdark],['#8FA882',A.mdark],['#7A9B6A',A.mdark]);
                reps.push(['#a3b899',A.base],['#A3B899',A.base],['#7ba886',A.base],['#7BA886',A.base]);
                reps.push(['#b4c9aa',A.light],['#B4C9AA',A.light],['#b5c9a8',A.light],['#B5C9A8',A.light]);
                reps.push(['#a8c99b',A.light],['#A8C99B',A.light],['#b8c9ad',A.light],['#B8C9AD',A.light]);
                reps.push(['#b5d4a4',A.vlight],['#B5D4A4',A.vlight],['#c4d9b5',A.vlight],['#C4D9B5',A.vlight]);
                // TEAL
                reps.push(['#3d6b6b',A.dark],['#3D6B6B',A.dark],['#4a7a7a',A.mdark],['#4A7A7A',A.mdark],['#5a9a9a',A.base],['#5A9A9A',A.base]);
                // GOLD/BROWN
                reps.push(['#c4a882',A.light],['#C4A882',A.light],['#d4a882',A.light],['#D4A882',A.light]);
                reps.push(['#8a7a2e',A.dark],['#8A7A2E',A.dark],['#b5a33d',A.mdark],['#B5A33D',A.mdark]);
                reps.push(['#c9b84a',A.base],['#C9B84A',A.base]);
                reps.push(['#edecd5',A.xlight],['#EDECD5',A.xlight]);
                // PASTELS
                reps.push(['#a8e6cf',lighten(A.base,0.40)],['#98d8c8',lighten(A.base,0.35)],['#b4f8c8',lighten(A.base,0.50)]);
                reps.push(['#4ecdc4',A.base],['#45b7d1',A.mdark],['#95c9b4',A.light]);
                // rgba green
                reps.push([/rgba\(\s*163,\s*184,\s*153,\s*([0-9.]+)\s*\)/g,'rgba('+aRgb+',$1)']);
                reps.push([/rgba\(\s*122,\s*138,\s*110,\s*([0-9.]+)\s*\)/g,'rgba('+rgbStr(A.dark)+',$1)']);
                reps.push([/rgba\(\s*168,\s*201,\s*155,\s*([0-9.]+)\s*\)/g,'rgba('+rgbStr(A.light)+',$1)']);
                reps.push([/rgba\(\s*123,\s*168,\s*134,\s*([0-9.]+)\s*\)/g,'rgba('+aRgb+',$1)']);
                reps.push([/rgba\(\s*109,\s*138,\s*94,\s*([0-9.]+)\s*\)/g,'rgba('+rgbStr(A.dark)+',$1)']);
                reps.push([/rgba\(\s*125,\s*143,\s*118,\s*([0-9.]+)\s*\)/g,'rgba('+rgbStr(A.mdark)+',$1)']);
                reps.push([/rgba\(\s*61,\s*107,\s*107,\s*([0-9.]+)\s*\)/g,'rgba('+rgbStr(A.dark)+',$1)']);
                reps.push([/rgba\(\s*196,\s*168,\s*130,\s*([0-9.]+)\s*\)/g,'rgba('+rgbStr(A.light)+',$1)']);
                reps.push([/rgba\(\s*201,\s*184,\s*74,\s*([0-9.]+)\s*\)/g,'rgba('+rgbStr(A.mdark)+',$1)']);
            }

            // SECONDARY — always remap if different from default
            if(secKey!==(defaultSecMap.sage||'petalpink')||ac!=='sage'){
                var sRgb=rgbStr(S.base);
                reps.push(['#5a4345',S.vdark],['#5a4a4c',S.vdark],['#5A4345',S.vdark],['#5A4A4C',S.vdark]);
                reps.push(['#6b5a5e',S.dark],['#7a6668',S.dark],['#6B5A5E',S.dark],['#7A6668',S.dark]);
                reps.push(['#9a7a80',S.mdark],['#a57f85',S.mdark],['#9A7A80',S.mdark],['#A57F85',S.mdark]);
                reps.push(['#b4828c',S.mdark],['#B4828C',S.mdark]);
                reps.push(['#b59197',S.base],['#B59197',S.base]);
                reps.push(['#c5a1a7',S.light],['#c9a9a6',S.light],['#c8b8bb',S.light]);
                reps.push(['#C5A1A7',S.light],['#C9A9A6',S.light],['#C8B8BB',S.light]);
                reps.push(['#d4b5b8',S.vlight],['#d4b5ba',S.vlight],['#d4a5a5',S.vlight],['#d4a5ae',S.vlight]);
                reps.push(['#D4B5B8',S.vlight],['#D4B5BA',S.vlight],['#D4A5A5',S.vlight],['#D4A5AE',S.vlight]);
                reps.push(['#e8d5d8',S.xlight],['#E8D5D8',S.xlight]);
                reps.push(['#c97a7a',S.redish],['#C97A7A',S.redish],['#d67373',S.redish],['#D67373',S.redish]);
                reps.push(['#8a7a6d',S.dark],['#8A7A6D',S.dark]);
                reps.push(['#a08cb4',S.light],['#A08CB4',S.light]);
                reps.push(['#c7ceea',S.xlight],['#C7CEEA',S.xlight]);
                reps.push([/rgba\(\s*181,\s*145,\s*151,\s*([0-9.]+)\s*\)/g,'rgba('+sRgb+',$1)']);
                reps.push([/rgba\(\s*201,\s*169,\s*166,\s*([0-9.]+)\s*\)/g,'rgba('+rgbStr(S.light)+',$1)']);
                reps.push([/rgba\(\s*180,\s*130,\s*140,\s*([0-9.]+)\s*\)/g,'rgba('+sRgb+',$1)']);
                reps.push([/rgba\(\s*201,\s*122,\s*122,\s*([0-9.]+)\s*\)/g,'rgba('+rgbStr(S.redish)+',$1)']);
                reps.push([/rgba\(\s*160,\s*140,\s*180,\s*([0-9.]+)\s*\)/g,'rgba('+rgbStr(S.light)+',$1)']);
            }

            if(bc!=='dark'){
                var isLight=(bc==='warmlinen'||bc==='softblush');
                if(isLight){
                    var cardBgSolid='#ffffff';
                    reps.push(['#3d2f31',cardBgSolid],['#3D2F31',cardBgSolid],['#3c2f31',cardBgSolid],['#3C2F31',cardBgSolid]);
                    reps.push(['#2a1f21',cardBgSolid],['#2A1F21',cardBgSolid]);
                    reps.push(['#4a3a3c',cardBgSolid],['#4A3A3C',cardBgSolid],['#4a3b3e',cardBgSolid],['#4A3B3E',cardBgSolid]);
                } else {
                    // BACKGROUND
                    reps.push(['#3d2f31',bg],['#3D2F31',bg],['#3c2f31',bg],['#3C2F31',bg]);
                    reps.push(['#2a1f21',bgDk],['#2A1F21',bgDk]);
                    reps.push(['#4a3a3c',bgMid],['#4A3A3C',bgMid],['#4a3b3e',bgMid],['#4A3B3E',bgMid]);
                }

                // Background rgbas
                reps.push([/rgba\(\s*61,\s*47,\s*49,\s*([0-9.]+)\s*\)/g,'rgba('+rgbStr(bg)+',$1)']);
                reps.push([/rgba\(\s*60,\s*47,\s*49,\s*([0-9.]+)\s*\)/g,'rgba('+rgbStr(bg)+',$1)']);
                reps.push([/rgba\(\s*42,\s*31,\s*33,\s*([0-9.]+)\s*\)/g,'rgba('+rgbStr(bgDk)+',$1)']);
            }

            if(bc==='warmlinen'||bc==='softblush'){
                // TEXT — flip to dark for light background
                reps.push(['#f2ebe0',tc.t],['#F2EBE0',tc.t],['#e0d2d0',tc.t],['#E0D2D0',tc.t]);
                reps.push(['#EBE0D6',tc.t],['#ebe0d6',tc.t],['#f5ede6',tc.t],['#F5EDE6',tc.t]);
                reps.push(['#f5f0ed',tc.t],['#F5F0ED',tc.t],['#f0ebe6',tc.t],['#F0EBE6',tc.t]);
                reps.push(['#f0efe8',tc.t],['#F0EFE8',tc.t],['#faf8f6',tc.t],['#FAF8F6',tc.t]);
                reps.push(['#f7ebf0',tc.t],['#F7EBEF',tc.t]);
                reps.push(['#e3d6cc',tc.m],['#E3D6CC',tc.m],['#e0d5cb',tc.m],['#E0D5CB',tc.m]);
                reps.push([/rgba\(\s*242,\s*235,\s*224,\s*([0-9.]+)\s*\)/g,tc.m]);
                reps.push([/rgba\(\s*224,\s*210,\s*208,\s*([0-9.]+)\s*\)/g,tc.m]);
                // White text used in some buttons → dark
                reps.push(['#fff',tc.t],['#FFF',tc.t]);
            }

            // ── Apply replacements ──
            function applyReps(text){
                reps.forEach(function(pair){
                    if(pair[0] instanceof RegExp)text=text.replace(pair[0],pair[1]);
                    else text=text.split(pair[0]).join(pair[1]);
                });
                return text;
            }

            // Rewrite <style> tags
            document.querySelectorAll('style').forEach(function(s){
                var css=s.textContent,orig=css;
                css=applyReps(css);
                if(css!==orig)s.textContent=css;
            });

            // Rewrite inline styles
            document.querySelectorAll('[style]').forEach(function(el){
                var st=el.getAttribute('style'),orig=st;
                st=applyReps(st);
                if(st!==orig)el.setAttribute('style',st);
            });

            // Override CSS custom properties (meal-plan uses :root vars)
            var ov=document.createElement('style');
            ov.textContent=':root{--dark-bg:'+bg+'!important;--card-bg:'+bgDk+'!important;--sage-green:'+A.base+'!important;--muted-sage:'+A.mdark+'!important;--light-text:'+tc.t+'!important;--cream:'+tc.t+'!important;--border-color:rgba('+rgbStr(A.base)+',0.2)!important}';
            document.head.appendChild(ov);
            // Light background comprehensive override
            if(bc==='warmlinen'||bc==='softblush'){
                var lo=document.createElement('style');
                var navBg=darken(bg,0.55);
                var navBgDk=darken(bg,0.62);
                lo.textContent=[
                    'html,body{background:'+bg+'!important;color:'+tc.t+'!important}',
                    '.top-nav{background:'+navBg+'!important;border-bottom:1px solid rgba(0,0,0,0.1)!important}',
                    '.nav-overlay{background:'+navBgDk+'!important}',
                    '.section,.card{background:rgba(255,255,255,0.88)!important;border:1px solid rgba(0,0,0,0.08)!important;box-shadow:0 1px 4px rgba(0,0,0,0.06)!important}',
                    '.section-title,.card-title{color:'+tc.t+'!important}',
                    '.nav-hamburger span{background:'+tc.t+'!important}',
                    '.sync-status{background:rgba(255,255,255,0.9)!important;border-color:rgba(0,0,0,0.1)!important}',
                    'input,textarea,select{background:rgba(255,255,255,0.7)!important;color:'+tc.t+'!important;border-color:rgba(0,0,0,0.12)!important}',
                    'button{color:'+tc.t+'}',
                    '.nav-refresh{color:rgba(255,255,255,0.7)!important}'
                ].join('\n');
                document.head.appendChild(lo);
            }
        });
    })();
    </script>
    <link href="https://fonts.googleapis.com/css2?family=Dancing+Script:wght@400;500;600;700&family=Philosopher:ital,wght@0,400;0,700;1,400;1,700&display=swap" rel="stylesheet">
    <style>
        :root {
            --dark-bg: #3d2f31;
            --card-bg: #2a1f21;
            --sage-green: #a3b899;
            --muted-sage: #7d8f76;
            --light-text: #e0d2d0;
            --cream: #f2ebe0;
            --border-color: rgba(163, 184, 153, 0.2);
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Philosopher', serif;
            background: var(--dark-bg);
            min-height: 100vh;
            padding: 90px 16px 16px;
            color: var(--light-text);
        }
        
        /* Navigation Bar */
        .top-nav {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background: var(--card-bg);
            border-bottom: 1px solid var(--border-color);
            z-index: 9999;
            padding: 0 24px;
        }
        
        .nav-container {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            align-items: center;
            justify-content: space-between;
            height: 60px;
        }
        
        .nav-logo {
            font-size: 1.1rem;
            font-weight: 700;
            color: var(--sage-green);
            text-decoration: none;
        }
        
        .nav-links {
            display: flex;
            gap: 24px;
            align-items: center;
        }
        
        .nav-link {
            color: rgba(242, 235, 224, 0.7);
            text-decoration: none;
            font-size: 0.9rem;
            transition: color 0.2s;
            font-weight: 500;
        }
        
        .nav-link:hover {
            color: var(--sage-green);
        }
        
        .nav-link.active {
            color: var(--sage-green);
        }
        

        /* ===== DUAL VIEW STYLES ===== */
        .dual-goals {
            display: flex;
            gap: 8px;
            margin-bottom: 16px;
        }
        .dual-goals-card {
            flex: 1;
            background: var(--card-bg);
            border-radius: 8px;
            padding: 12px 14px;
            border: 1px solid var(--border-color);
            text-align: center;
        }
        .dual-goals-card.kasey-card {
            border-color: var(--lh-secondary-border, rgba(232,180,184,0.3));
        }
        .dual-goals-name {
            font-size: 0.65rem;
            text-transform: uppercase;
            letter-spacing: 0.12em;
            margin-bottom: 6px;
            font-weight: 600;
        }
        .dual-goals-name.kasey-name { color: var(--lh-secondary, #e8b4b8); }
        .dual-goals-name.charlie-name { color: var(--sage-green); }
        .dual-goals-macros {
            display: flex;
            justify-content: center;
            gap: 16px;
            font-size: 0.78rem;
        }
        .dual-goals-macros span { color: var(--light-text); opacity: 0.6; }
        .dual-goals-macros strong.kasey-accent { color: var(--lh-secondary, #e8b4b8); }
        .dual-goals-macros strong.charlie-accent { color: var(--sage-green); }

        .dual-day-header {
            display: flex;
            gap: 8px;
            margin-bottom: 16px;
        }
        .dual-day-card {
            flex: 1;
            padding: 10px 14px;
            border-radius: 6px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 4px;
        }
        .dual-day-card .person-tag {
            font-size: 0.6rem;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            opacity: 0.7;
            font-weight: 700;
        }
        .dual-day-card .macros {
            font-size: 0.72rem;
            display: flex;
            gap: 10px;
        }

        .dual-columns {
            display: flex;
            gap: 10px;
        }
        .person-column {
            flex: 1;
            min-width: 0;
        }
        .person-col-label {
            font-size: 0.6rem;
            text-transform: uppercase;
            letter-spacing: 0.12em;
            padding: 6px 0;
            text-align: center;
            font-weight: 700;
            margin-bottom: 4px;
            border-radius: 4px 4px 0 0;
        }
        .person-col-label.kasey-label {
            color: var(--lh-secondary, #e8b4b8);
            background: var(--lh-secondary-muted, rgba(232,180,184,0.08));
        }
        .person-col-label.charlie-label {
            color: var(--sage-green);
            background: rgba(163,184,153,0.08);
        }
        .person-meals {
            border-radius: 0 0 6px 6px;
            overflow: hidden;
            border: 1px solid var(--border-color);
        }
        .person-meals.kasey-meals {
            border-color: var(--lh-secondary-border, rgba(232,180,184,0.2));
        }
        .kasey-meals .meal-btn:hover {
            background: var(--lh-secondary-muted, rgba(232,180,184,0.1));
        }
        .kasey-meals .meal-type {
            color: var(--lh-secondary, #e8b4b8);
        }
        .kasey-meals .meal-arrow {
            color: var(--lh-secondary, #e8b4b8);
        }
        .kasey-meals .meal-icon {
            background: var(--lh-secondary-muted, rgba(232,180,184,0.1)) !important;
        }

        .dual-snack-btn {
            margin-top: 10px;
        }
        .dual-notes {
            margin-top: 16px;
            padding-top: 12px;
            border-top: 1px solid rgba(224,210,208,0.08);
        }
        .dual-notes-row {
            display: flex;
            gap: 10px;
        }
        .dual-notes-row > div {
            flex: 1;
            min-width: 0;
        }
        .dual-notes-row textarea {
            width: 100%;
            min-height: 50px;
            padding: 8px;
            background: rgba(61,47,49,0.4);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            color: var(--light-text);
            font-family: 'Philosopher', serif;
            font-size: 0.72rem;
            resize: vertical;
            box-sizing: border-box;
        }
        .dual-notes-label {
            font-size: 0.6rem;
            letter-spacing: 0.1em;
            margin-bottom: 4px;
            text-transform: uppercase;
        }
        .dual-notes-label.kasey-label { color: var(--lh-secondary-border, rgba(232,180,184,0.4)); }
        .dual-notes-label.charlie-label { color: rgba(163,184,153,0.5); }

        @media (max-width: 600px) {
            .dual-columns {
                flex-direction: column;
                gap: 14px;
            }
            .dual-day-header {
                flex-direction: column;
                gap: 6px;
            }
            .dual-goals {
                flex-direction: column;
                gap: 6px;
            }
            .dual-notes-row {
                flex-direction: column;
                gap: 10px;
            }
        }

        @media (max-width: 768px) {
            .nav-links {
                gap: 16px;
            }
            .nav-link {
                font-size: 0.85rem;
            }
        }
        
        .container {
            max-width: 600px;
            margin: 0 auto;
        }
        
        .header {
            text-align: center;
            margin-bottom: 24px;
        }
        
        .header h1 {
            font-family: 'Dancing Script', cursive;
            font-size: 2.5rem;
            color: var(--sage-green);
            font-weight: 400;
        }
        
        .header p {
            color: var(--light-text);
            font-size: 0.875rem;
            letter-spacing: 0.05em;
            margin-top: 4px;
            opacity: 0.7;
        }
        
        .plan-progress {
            background: var(--card-bg);
            border-radius: 8px;
            padding: 14px 16px;
            margin-bottom: 12px;
            border: 1px solid var(--border-color);
        }
        
        .progress-text {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.8rem;
            margin-bottom: 8px;
        }
        
        .progress-text span:first-child {
            color: var(--sage-green);
            font-weight: 600;
            letter-spacing: 0.03em;
        }
        
        .progress-text span:last-child {
            color: var(--light-text);
            opacity: 0.5;
            font-size: 0.75rem;
        }
        
        .progress-bar {
            height: 6px;
            background: rgba(163, 184, 153, 0.15);
            border-radius: 99px;
            overflow: hidden;
        }
        
        .progress-fill {
            height: 100%;
            background: var(--sage-green);
            border-radius: 99px;
            transition: width 0.4s ease;
        }
        
        .calendar-header-row {
            text-align: center;
            margin-bottom: 12px;
        }
        
        .calendar-header-row span {
            font-size: 0.7rem;
            letter-spacing: 0.15em;
            color: var(--sage-green);
            font-weight: 600;
        }
        
        .calendar {
            background: var(--card-bg);
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 16px;
            border: 1px solid var(--border-color);
        }
        
        .week-label {
            font-size: 0.7rem;
            color: var(--muted-sage);
            letter-spacing: 0.15em;
            margin-bottom: 10px;
            display: flex;
            align-items: baseline;
            gap: 8px;
        }
        
        .week-label span {
            font-size: 0.75rem;
            font-weight: 700;
            color: var(--light-text);
            opacity: 0.6;
            letter-spacing: 0.05em;
        }
        
        .day-btn.is-today {
            box-shadow: 0 0 0 2px var(--sage-green), inset 0 0 0 1px rgba(163,184,153,0.3);
        }
        
        .day-btn.is-past .day-check {
            font-size: 0.55rem;
            opacity: 0.7;
        }
        
        .day-check {
            font-size: 0.55rem;
            line-height: 1;
        }
        
        .day-prep-icon {
            font-size: 0.45rem;
            line-height: 1;
            color: var(--sage-green);
            opacity: 0.9;
        }
        
        .week-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 6px;
            margin-bottom: 16px;
        }
        
        .week-grid:last-child {
            margin-bottom: 0;
        }
        
        .day-btn {
            aspect-ratio: 1;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
            font-family: 'Philosopher', serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 2px;
            font-weight: 500;
        }
        
        .day-letter {
            font-size: 0.65rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            opacity: 0.8;
        }
        
        .day-number {
            font-size: 1rem;
            font-weight: 700;
        }
        
        .day-detail {
            background: var(--card-bg);
            border-radius: 8px;
            padding: 20px;
            border: 1px solid var(--border-color);
        }
        
        .day-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 16px;
            border-radius: 6px;
            margin-bottom: 16px;
            color: var(--dark-bg);
            flex-wrap: wrap;
            gap: 4px;
        }
        
        .day-header-left {
            display: flex;
            align-items: baseline;
            gap: 8px;
            flex-wrap: wrap;
        }
        
        .day-num {
            font-size: 1.1rem;
            font-weight: 700;
            white-space: nowrap;
        }
        
        .day-theme {
            font-size: 0.875rem;
            opacity: 0.9;
        }
        
        
        
        
        
        .meal-btn {
            width: 100%;
            background: rgba(61, 47, 49, 0.3);
            border: none;
            border-bottom: 1px solid var(--border-color);
            padding: 14px 16px;
            display: flex;
            align-items: center;
            gap: 12px;
            cursor: pointer;
            transition: all 0.2s;
            text-align: left;
            font-family: 'Philosopher', serif;
        }
        
        .meal-btn:hover {
            background: rgba(163, 184, 153, 0.1);
        }
        
        .meal-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
        }
        
        .meal-info {
            flex: 1;
        }
        
        .meal-type {
            font-size: 0.65rem;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            color: var(--sage-green);
            margin-bottom: 2px;
        }
        
        .meal-name {
            font-size: 0.875rem;
            font-weight: 600;
            color: var(--light-text);
            margin-bottom: 2px;
        }
        
        .meal-portion {
            font-size: 0.75rem;
            color: var(--light-text);
            opacity: 0.6;
        }
        
        .meal-arrow {
            color: var(--sage-green);
            font-size: 1.2rem;
            opacity: 0.5;
        }
        
        /* Modal */
        .modal-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 10002;
            padding: 20px;
        }
        
        .modal-container.active {
            display: flex;
        }
        
        .modal {
            background: var(--card-bg);
            border-radius: 12px;
            max-width: 600px;
            width: 100%;
            max-height: 92vh;
            overflow-y: auto;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
            border: 1px solid var(--border-color);
        }
        
        .modal-header {
            padding: 24px 20px 20px;
            color: var(--dark-bg);
            border-radius: 12px 12px 0 0;
            position: relative;
            overflow: visible;
        }
        
        .modal-header h3 {
            font-size: 1.25rem;
            line-height: 1.3;
            margin-bottom: 8px;
            font-weight: 400;
            padding-right: 44px;
            word-wrap: break-word;
        }
        
        .modal-header .meta {
            font-size: 0.875rem;
            opacity: 0.9;
            padding-right: 44px;
        }
        
        .modal-close {
            position: absolute;
            top: 20px;
            right: 12px;
            background: none;
            border: none;
            color: var(--dark-bg);
            opacity: 0.8;
            font-size: 1.5rem;
            cursor: pointer;
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .modal-close:hover {
            opacity: 1;
        }
        
        .modal-body {
            padding: 20px;
        }
        
        .modal-section {
            margin-bottom: 20px;
        }
        
        .modal-section h4 {
            color: var(--sage-green);
            margin-bottom: 12px;
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.1em;
        }
        
        .modal-section ul {
            list-style: none;
        }
        
        .modal-section li {
            color: var(--light-text);
            font-size: 0.875rem;
            margin-bottom: 6px;
            display: flex;
            gap: 8px;
            word-wrap: break-word;
            overflow-wrap: break-word;
        }
        
        .modal-section li > span:last-of-type,
        .modal-section li > div {
            min-width: 0;
            word-wrap: break-word;
            overflow-wrap: break-word;
        }
        
        .step-text {
            min-width: 0;
            word-wrap: break-word;
            overflow-wrap: break-word;
            flex: 1;
        }
        
        .modal-section li span {
            color: var(--sage-green);
            min-width: 15px;
        }
        
        .modal-section li .step-number {
            background: var(--sage-green);
            color: #fff;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-size: 0.7rem;
            font-weight: 700;
            flex-shrink: 0;
        }
        
        .tip-box {
            background: rgba(163, 184, 153, 0.1);
            border-radius: 8px;
            padding: 12px 16px;
            border: 1px solid var(--border-color);
        }
        
        .tip-box p {
            font-size: 0.875rem;
            color: var(--light-text);
            margin: 0;
        }
        
        .portions-row {
            margin-top: 20px;
            padding-top: 16px;
            border-top: 1px solid var(--border-color);
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }
        
        .portion-tag {
            background: rgba(163, 184, 153, 0.2);
            border-radius: 9999px;
            padding: 6px 12px;
            color: var(--light-text);
            font-size: 0.75rem;
            border: 1px solid var(--border-color);
        }
        

        /* ===== PERSON-AWARE MODAL TINTING ===== */
        .modal-container.kasey-modal .modal-section li span {
            color: var(--lh-secondary, #e8b4b8);
        }
        .modal-container.kasey-modal .modal-section li .step-number {
            background: var(--lh-secondary, #e8b4b8);
            color: #2a1f21;
        }
        .modal-container.kasey-modal .tip-box {
            background: var(--lh-secondary-muted, rgba(232,180,184,0.1));
            border-color: var(--lh-secondary-border, rgba(232,180,184,0.25));
        }
        .modal-container.kasey-modal .portion-tag {
            background: var(--lh-secondary-muted, rgba(232,180,184,0.15));
            border-color: var(--lh-secondary-border, rgba(232,180,184,0.25));
        }
        .modal-container.kasey-modal .modal-section h4 {
            color: var(--lh-secondary, #e8b4b8);
        }

        /* ===== RESPONSIVE: DESKTOP ===== */
        @media (min-width: 769px) {
            .container {
                max-width: 700px;
            }
            .rb-grid {
                grid-template-columns: 1fr 1fr;
            }
            .modal {
                max-width: 640px;
            }
            .grocery-category {
                margin-bottom: 10px;
            }
            .gen-section {
                padding: 24px;
            }
        }

        /* ===== RESPONSIVE: SMALL MOBILE ===== */
        @media (max-width: 480px) {
            body {
                padding: 76px 8px 8px;
            }
            
            .header h1 {
                font-size: 1.8rem;
            }
            
            .container {
                max-width: 100%;
            }
            
            .calendar {
                padding: 12px 8px;
            }
            
            .plan-progress {
                padding: 10px 12px;
            }

            .week-grid {
                gap: 4px;
            }

            .day-btn {
                aspect-ratio: auto;
                padding: 6px 2px;
                border-radius: 4px;
            }

            .day-letter {
                font-size: 0.55rem;
            }

            .day-number {
                font-size: 0.8rem;
            }
            
            .modal {
                max-height: 85vh;
            }
            .modal-container {
                padding: 10px;
            }

            .page-tab {
                padding: 9px 4px;
                font-size: 0.7rem;
            }

            

            

            .day-detail {
                padding: 14px;
            }
            .day-header {
                padding: 10px 12px;
            }
            .day-num {
                font-size: 0.95rem;
            }
            .day-theme {
                font-size: 0.78rem;
            }
            

            .meal-btn {
                padding: 12px;
                gap: 10px;
            }
            .meal-icon {
                width: 34px;
                height: 34px;
                font-size: 1rem;
            }
            .meal-name {
                font-size: 0.8rem;
            }
            .meal-portion {
                font-size: 0.7rem;
            }

            .modal-header {
                padding: 18px 16px 14px;
            }
            .modal-header h3 {
                font-size: 1.1rem;
            }
            .modal-body {
                padding: 16px;
            }
            .modal-section li {
                font-size: 0.8rem;
            }
            .tip-box p {
                font-size: 0.8rem;
            }

            .rb-card {
                padding: 12px;
            }
            .rb-card-name {
                font-size: 0.82rem;
            }
            .rb-filter {
                padding: 6px 10px;
                font-size: 0.7rem;
            }

            .gen-section {
                padding: 14px;
            }
            .gen-section h3 {
                font-size: 0.82rem;
            }
            .gen-row {
                flex-direction: column;
                gap: 6px;
            }
            .gen-label {
                min-width: auto;
            }
            .gen-btn {
                font-size: 0.9rem;
                padding: 12px;
            }

            .diet-tag {
                font-size: 0.65rem;
                padding: 3px 8px;
            }

            .grocery-cat-header {
                padding: 8px 12px;
            }
            .grocery-cat-header h4 {
                font-size: 0.75rem;
            }
            .grocery-item {
                font-size: 0.72rem;
                padding: 5px 0;
            }

            .plan-selector select {
                font-size: 0.75rem !important;
            }
        }

        /* ===== RESPONSIVE: TINY MOBILE ===== */
        @media (max-width: 360px) {
            body {
                padding: 70px 6px 6px;
            }
            .header h1 {
                font-size: 1.5rem;
            }
            .page-tab {
                padding: 8px 2px;
                font-size: 0.62rem;
            }
            .day-header {
                flex-direction: column;
                text-align: center;
            }
            .day-header-left {
                justify-content: center;
            }
        }

        /* ===== HAMBURGER MENU ===== */
        .nav-hamburger {
            display: none;
            background: none;
            border: none;
            cursor: pointer;
            padding: 10px;
            z-index: 10001;
        }
        .nav-hamburger span {
            display: block; width: 24px; height: 2px;
            background: #a3b899; margin: 5px 0;
            transition: all 0.3s ease;
        }
        .nav-hamburger.open span:nth-child(1) { transform: rotate(45deg) translate(5px, 5px); }
        .nav-hamburger.open span:nth-child(2) { opacity: 0; }
        .nav-hamburger.open span:nth-child(3) { transform: rotate(-45deg) translate(5px, -5px); }
        .nav-overlay {
            display: none;
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: #2a1f21;
            z-index: 10000;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        .nav-overlay.open { display: flex; }
        .nav-link-mobile {
            color: rgba(242, 235, 224, 0.7);
            text-decoration: none;
            font-size: 1.3rem;
            font-family: 'Philosopher', Georgia, serif;
            font-weight: 500;
            padding: 18px 40px;
            transition: color 0.2s;
            display: block;
            width: 100%;
            text-align: center;
        }
        .nav-link-mobile:hover { color: #f2ebe0; }
        .nav-link-mobile.active { color: #a3b899; }
        @media (max-width: 768px) {
            .nav-hamburger { display: block; }
            .nav-links { display: none; }
        }

        /* ===== PAGE TABS ===== */
        .page-tabs {
            display: flex;
            gap: 4px;
            background: rgba(42, 31, 33, 0.6);
            border-radius: 8px;
            padding: 4px;
            margin-bottom: 16px;
            border: 1px solid var(--border-color);
        }
        .page-tab {
            flex: 1;
            padding: 10px 8px;
            background: none;
            border: none;
            color: rgba(224, 210, 208, 0.5);
            font-family: 'Philosopher', serif;
            font-size: 0.8rem;
            cursor: pointer;
            border-radius: 6px;
            transition: all 0.2s;
            letter-spacing: 0.03em;
        }
        .page-tab:hover { color: var(--light-text); }
        .page-tab.active {
            background: rgba(163, 184, 153, 0.15);
            color: var(--sage-green);
        }
        .tab-view { display: none; }
        .tab-view.active { display: block; }

        /* ===== RECIPE BANK ===== */
        .rb-toolbar {
            display: flex;
            gap: 8px;
            margin-bottom: 12px;
            flex-wrap: wrap;
        }
        .rb-search {
            flex: 1;
            min-width: 140px;
            padding: 10px 14px;
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            color: var(--light-text);
            font-family: 'Philosopher', serif;
            font-size: 0.85rem;
        }
        .rb-search::placeholder { color: rgba(224, 210, 208, 0.3); }
        .rb-search:focus { outline: none; border-color: var(--sage-green); }
        .rb-filters {
            display: flex;
            gap: 4px;
            flex-wrap: wrap;
        }
        .rb-filter {
            padding: 8px 12px;
            background: none;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            color: rgba(224, 210, 208, 0.5);
            font-family: 'Philosopher', serif;
            font-size: 0.75rem;
            cursor: pointer;
            transition: all 0.2s;
        }
        .rb-filter:hover { color: var(--light-text); }
        .rb-filter.active {
            background: rgba(163, 184, 153, 0.15);
            color: var(--sage-green);
            border-color: rgba(163, 184, 153, 0.3);
        }
        .rb-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 8px;
        }
        .rb-card {
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 14px;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
        }
        .rb-card:hover { border-color: rgba(163, 184, 153, 0.4); }
        .rb-card-top {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 6px;
        }
        .rb-card-name {
            font-size: 0.9rem;
            color: var(--cream);
            font-weight: 400;
            flex: 1;
            padding-right: 8px;
        }
        .rb-card-fav {
            background: none;
            border: none;
            font-size: 1.1rem;
            cursor: pointer;
            padding: 2px;
            opacity: 0.3;
            transition: all 0.2s;
        }
        .rb-card-fav.favorited { opacity: 1; }
        .rb-card-meta {
            font-size: 0.7rem;
            color: rgba(224, 210, 208, 0.4);
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            margin-bottom: 6px;
        }
        .rb-card-tags {
            display: flex;
            gap: 4px;
            flex-wrap: wrap;
        }
        .rb-tag {
            padding: 2px 8px;
            border-radius: 99px;
            font-size: 0.65rem;
            letter-spacing: 0.04em;
        }
        .rb-tag-breakfast { background: rgba(163, 184, 153, 0.15); color: var(--sage-green); }
        .rb-tag-lunch { background: rgba(196, 168, 130, 0.15); color: #c4a882; }
        .rb-tag-dinner { background: rgba(180, 130, 140, 0.15); color: #b4828c; }
        .rb-tag-dessert { background: rgba(160, 140, 180, 0.15); color: #a08cb4; }
        .rb-tag-snack { background: rgba(125, 143, 118, 0.15); color: var(--muted-sage); }
        .rb-tag-cuisine { background: rgba(224, 210, 208, 0.08); color: rgba(224, 210, 208, 0.5); }
        .rb-tag-snack { background: rgba(125, 143, 118, 0.15); color: #7d8f76; }
        .rb-count {
            font-size: 0.75rem;
            color: rgba(224, 210, 208, 0.3);
            text-align: center;
            padding: 12px 0;
        }
        .rb-empty {
            text-align: center;
            padding: 40px 20px;
            color: rgba(224, 210, 208, 0.3);
            font-size: 0.85rem;
        }

        /* ===== GENERATE VIEW ===== */
        .gen-section {
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 12px;
        }
        .gen-section h3 {
            font-size: 0.9rem;
            color: var(--sage-green);
            margin-bottom: 12px;
            font-weight: 400;
            letter-spacing: 0.03em;
        }
        .gen-row {
            display: flex;
            gap: 12px;
            margin-bottom: 12px;
            align-items: center;
        }
        .gen-label {
            font-size: 0.8rem;
            color: rgba(224, 210, 208, 0.6);
            min-width: 90px;
        }
        .gen-input {
            flex: 1;
            padding: 8px 12px;
            background: rgba(61, 47, 49, 0.6);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            color: var(--light-text);
            font-family: 'Philosopher', serif;
            font-size: 0.85rem;
        }
        .gen-input:focus { outline: none; border-color: var(--sage-green); }
        .gen-btn {
            width: auto;
            display: inline-block;
            padding: 10px 22px;
            background: var(--sage-green);
            color: var(--dark-bg);
            border: none;
            border-radius: 8px;
            font-family: 'Philosopher', serif;
            font-size: 0.9rem;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.2s;
            letter-spacing: 0.03em;
        }
        .gen-btn:hover { opacity: 0.9; }
        .gen-btn:disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }
        .gen-btn-secondary {
            background: none;
            border: 1px solid var(--sage-green);
            color: var(--sage-green);
        }
        .gen-status {
            text-align: center;
            padding: 20px;
            font-size: 0.85rem;
            color: rgba(224, 210, 208, 0.5);
        }
        .gen-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid rgba(163, 184, 153, 0.2);
            border-top-color: var(--sage-green);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            margin-right: 8px;
            vertical-align: middle;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        .gen-preview-day {
            background: rgba(61, 47, 49, 0.4);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            padding: 12px;
            margin-bottom: 8px;
        }
        .gen-preview-day h4 {
            font-size: 0.8rem;
            color: var(--sage-green);
            margin-bottom: 8px;
            font-weight: 400;
        }
        .gen-preview-meal {
            font-size: 0.75rem;
            color: rgba(224, 210, 208, 0.6);
            padding: 4px 0;
        }
        .gen-preview-meal strong {
            color: var(--light-text);
            font-weight: 400;
        }
        .gen-checkbox-row {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 8px;
            font-size: 0.8rem;
            color: rgba(224, 210, 208, 0.6);
        }
        .gen-checkbox-row input[type="checkbox"] {
            accent-color: var(--sage-green);
        }

        .gen-chip {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            padding: 6px 12px;
            background: rgba(163, 184, 153, 0.08);
            border: 1px solid rgba(163, 184, 153, 0.2);
            border-radius: 20px;
            font-size: 0.75rem;
            color: rgba(224, 210, 208, 0.6);
            cursor: pointer;
            transition: all 0.2s;
            user-select: none;
        }
        .gen-chip:has(input:checked) {
            background: rgba(163, 184, 153, 0.2);
            border-color: rgba(163, 184, 153, 0.5);
            color: var(--light-text);
        }
        .gen-chip:hover {
            border-color: rgba(163, 184, 153, 0.4);
        }
        .gen-chip input[type="checkbox"] {
            accent-color: var(--sage-green);
            width: 13px;
            height: 13px;
            margin: 0;
        }

        .diet-tag {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 4px 10px;
            background: rgba(163, 184, 153, 0.15);
            border: 1px solid rgba(163, 184, 153, 0.3);
            border-radius: 20px;
            font-size: 0.7rem;
            color: rgba(224, 210, 208, 0.7);
        }
        .diet-tag button {
            background: none;
            border: none;
            color: rgba(180, 130, 140, 0.6);
            font-size: 0.85rem;
            cursor: pointer;
            padding: 0 2px;
            line-height: 1;
        }
        .diet-tag button:hover {
            color: #b4828c;
        }

        .grocery-category {
            margin-bottom: 14px;
            background: var(--card-bg);
            border-radius: 8px;
            border: 1px solid var(--border-color);
            overflow: hidden;
        }
        .grocery-cat-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 14px;
            background: rgba(163,184,153,0.1);
            cursor: pointer;
        }
        .grocery-cat-header h4 {
            margin: 0;
            font-size: 0.8rem;
            color: var(--sage-green);
            letter-spacing: 0.05em;
        }
        .grocery-cat-header span {
            font-size: 0.65rem;
            color: rgba(224,210,208,0.4);
        }
        .grocery-cat-items {
            padding: 6px 14px 10px;
        }
        .grocery-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 6px 0;
            border-bottom: 1px solid rgba(224,210,208,0.06);
            font-size: 0.78rem;
            color: var(--light-text);
            cursor: pointer;
            user-select: none;
        }
        .grocery-item:last-child { border-bottom: none; }
        .grocery-item input[type="checkbox"] {
            accent-color: var(--sage-green);
            flex-shrink: 0;
        }
        .grocery-item.checked span {
            text-decoration: line-through;
            opacity: 0.4;
        }
        .grocery-item .grocery-remove {
            margin-left: auto;
            background: none;
            border: none;
            color: rgba(180,130,140,0.4);
            cursor: pointer;
            font-size: 0.9rem;
            padding: 0 4px;
        }
        .grocery-item .grocery-remove:hover { color: #b4828c; }

        /* Add recipe form */
        #add-recipe-form input,
        #add-recipe-form select,
        #add-recipe-form textarea {
            font-size: 0.8rem;
        }
        @media (max-width: 480px) {
            #add-recipe-form input,
            #add-recipe-form select,
            #add-recipe-form textarea {
                font-size: 0.75rem;
                padding: 7px 10px;
            }
            #grocery-view h3 {
                font-size: 0.9rem !important;
            }
            #modal-swap-list button {
                font-size: 0.72rem !important;
                padding: 8px 10px !important;
            }
        }

        /* ===== PLAN SELECTOR ===== */
        .plan-selector {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 12px;
            padding: 10px 14px;
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 8px;
        }
        .plan-selector label {
            font-size: 0.75rem;
            color: rgba(224, 210, 208, 0.5);
            white-space: nowrap;
        }
        .plan-selector select {
            flex: 1;
            padding: 6px 10px;
            background: rgba(61, 47, 49, 0.6);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            color: var(--light-text);
            font-family: 'Philosopher', serif;
            font-size: 0.85rem;
            appearance: none;
            -webkit-appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath d='M6 8L1 3h10z' fill='%23a3b899'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 10px center;
            padding-right: 28px;
        }
        .plan-selector select:focus {
            outline: none;
            border-color: var(--sage-green);
        }
        .plan-delete-btn {
            background: none;
            border: 1px solid rgba(180, 130, 140, 0.3);
            color: rgba(180, 130, 140, 0.6);
            font-size: 0.7rem;
            padding: 4px 10px;
            border-radius: 6px;
            cursor: pointer;
            font-family: 'Philosopher', serif;
            transition: all 0.2s;
            white-space: nowrap;
        }
        .plan-delete-btn:hover {
            border-color: rgba(180, 130, 140, 0.6);
            color: #b4828c;
        }
    </style>
</head>
<body>
<nav class="top-nav">
<div class="nav-container">
<a href="index.html" class="nav-logo">Our Life Hub</a>
<div class="nav-links">
<a href="index.html" class="nav-link">Home</a>
<a href="kasey-hub.html" class="nav-link">Kasey</a>
<a href="charlie-hub.html" class="nav-link">Charlie</a>
<a href="our-dreams.html" class="nav-link">Us ♡</a>
<a href="meal-plan.html" class="nav-link active">Meals</a>
<a href="settings.html" class="nav-link">Settings</a>
</div>
<div style="display:flex;align-items:center;gap:2px;">
<button onclick="location.reload()" aria-label="Refresh" style="background:none;border:none;color:var(--lh-accent, #a3b899);font-size:1.2rem;cursor:pointer;padding:6px;">&#x21bb;</button>
<button class="nav-hamburger" id="navHamburger" onclick="toggleNav()" aria-label="Menu">
    <span></span>
    <span></span>
    <span></span>
</button>
</div>
</div>
</nav>
<div class="nav-overlay" id="navOverlay" onclick="toggleNav()">
    <a href="index.html" class="nav-link-mobile">Home</a>
    <a href="kasey-hub.html" class="nav-link-mobile">Kasey</a>
    <a href="charlie-hub.html" class="nav-link-mobile">Charlie</a>
    <a href="our-dreams.html" class="nav-link-mobile">Us ♡</a>
    <a href="meal-plan.html" class="nav-link-mobile active">Meals</a>
    <a href="settings.html" class="nav-link-mobile">Settings</a>
</div>

<div class="container">
    <div class="header">
        <h1>Meal Plan</h1>
        <p id="header-subtitle" style="display:none;"></p>
    </div>
    
    <div class="page-tabs">
        <button class="page-tab active" onclick="switchTab('plan')">Plan</button>
        <button class="page-tab" onclick="switchTab('recipes')">Recipes</button>
        <button class="page-tab" onclick="switchTab('grocery')">Grocery</button>
        <button class="page-tab" onclick="switchTab('generate')">Generate</button>
    </div>

    <div id="plan-view" class="tab-view active">
    
    <div class="plan-selector" id="plan-selector" style="display:none;">
        <label>Plan:</label>
        <select id="plan-dropdown" onchange="switchPlan(this.value)"></select>
        <button class="plan-delete-btn" id="plan-delete-btn" onclick="deleteCurrentPlan()">Delete</button>
    </div>

    <div class="dual-goals" id="dual-goals">
        <div class="dual-goals-card kasey-card">
            <div class="dual-goals-name kasey-name" id="dual-kasey-name">Kasey</div>
            <div class="dual-goals-macros">
                <div><span>P:</span> <strong class="kasey-accent" id="goal-protein-k">140-165g</strong></div>
                <div><span>C:</span> <strong class="kasey-accent" id="goal-calories-k">1,500-1,700</strong></div>
            </div>
        </div>
        <div class="dual-goals-card">
            <div class="dual-goals-name charlie-name" id="dual-charlie-name">Charlie</div>
            <div class="dual-goals-macros">
                <div><span>P:</span> <strong class="charlie-accent" id="goal-protein-c">180-210g</strong></div>
                <div><span>C:</span> <strong class="charlie-accent" id="goal-calories-c">2,200-2,500</strong></div>
            </div>
        </div>
    </div>
    
    <div class="plan-progress" id="plan-progress">
        <div class="progress-text"><span id="progress-label">Day 1 of 14</span><span id="progress-dates"></span></div>
        <div class="progress-bar"><div class="progress-fill" id="progress-fill"></div></div>
    </div>

    <div class="calendar">
        <div class="calendar-header-row" style="display:none;">
            <span id="cal-month-label">FEBRUARY 2026</span>
        </div>
        <div class="week-label">WEEK 1 <span id="week1-range"></span> <button onclick="regenWeek(1)" style="float:right;background:none;border:1px solid var(--lh-secondary-border, rgba(232,180,184,0.3));color:var(--lh-secondary, #e8b4b8);font-family:'Philosopher',serif;font-size:0.55rem;padding:2px 8px;border-radius:4px;cursor:pointer;opacity:0.6;" onmouseover="this.style.opacity='1'" onmouseout="this.style.opacity='0.6'">↻ Regenerate</button></div>
        <div class="week-grid" id="week1"></div>
        <div class="week-label">WEEK 2 <span id="week2-range"></span> <button onclick="regenWeek(2)" style="float:right;background:none;border:1px solid var(--lh-secondary-border, rgba(232,180,184,0.3));color:var(--lh-secondary, #e8b4b8);font-family:'Philosopher',serif;font-size:0.55rem;padding:2px 8px;border-radius:4px;cursor:pointer;opacity:0.6;" onmouseover="this.style.opacity='1'" onmouseout="this.style.opacity='0.6'">↻ Regenerate</button></div>
        <div class="week-grid" id="week2"></div>
    </div>
    
    <div class="day-detail">
        <div class="day-header" id="day-header">
            <div class="day-header-left">
                <div class="day-num" id="day-num">1</div>
                <div class="day-theme" id="day-theme">Italian</div>
            </div>
        </div>
        <div class="dual-day-header" id="dual-day-macros">
            <div class="dual-day-card" id="dual-macros-k" style="background:var(--lh-secondary-muted, rgba(232,180,184,0.12));">
                <span class="person-tag" style="color:var(--lh-secondary, #e8b4b8)">Kasey</span>
                <div class="macros"><span id="day-protein-k">145g</span> <span id="day-calories-k">1,600 cal</span></div>
            </div>
            <div class="dual-day-card" id="dual-macros-c" style="background:rgba(163,184,153,0.15);">
                <span class="person-tag">Charlie</span>
                <div class="macros"><span id="day-protein-c">189g</span> <span id="day-calories-c">2,240 cal</span></div>
            </div>
        </div>
        <div class="dual-columns" id="dual-meals">
            <div class="person-column" id="col-kasey">
                <div class="person-col-label kasey-label" id="col-label-k">Kasey</div>
                <div class="person-meals kasey-meals" id="meals-kasey"></div>
            </div>
            <div class="person-column" id="col-charlie">
                <div class="person-col-label charlie-label" id="col-label-c">Charlie</div>
                <div class="person-meals" id="meals-charlie"></div>
            </div>
        </div>
        <div id="dual-extras"></div>
    </div>
    </div><!-- end plan-view -->

    <!-- RECIPE BANK VIEW -->
    <div id="recipes-view" class="tab-view">
        <div class="rb-toolbar">
            <input type="text" class="rb-search" id="rb-search" placeholder="Search recipes..." oninput="filterRecipes()">
        </div>
        <div class="rb-filters" id="rb-filters">
            <button class="rb-filter active" data-filter="all" onclick="setRecipeFilter('all', this)">All</button>
            <button class="rb-filter" data-filter="Breakfast" onclick="setRecipeFilter('Breakfast', this)">Breakfast</button>
            <button class="rb-filter" data-filter="Lunch" onclick="setRecipeFilter('Lunch', this)">Lunch</button>
            <button class="rb-filter" data-filter="Dinner" onclick="setRecipeFilter('Dinner', this)">Dinner</button>
            <button class="rb-filter" data-filter="Dessert" onclick="setRecipeFilter('Dessert', this)">Dessert</button>
            <button class="rb-filter" data-filter="Snack" onclick="setRecipeFilter('Snack', this)">Snack</button>
            <button class="rb-filter" data-filter="favorites" onclick="setRecipeFilter('favorites', this)">♥ Favs</button>
        </div>
        <div class="rb-count" id="rb-count"></div>
        <div id="add-recipe-form" style="display:none;margin-bottom:16px;background:var(--card-bg);border-radius:8px;border:1px solid var(--border-color);padding:14px;">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;">
                <h4 style="margin:0;color:var(--sage-green);font-size:0.85rem;">Add Custom Recipe</h4>
                <button onclick="document.getElementById('add-recipe-form').style.display='none'" style="background:none;border:none;color:rgba(224,210,208,0.4);font-size:1.1rem;cursor:pointer;">×</button>
            </div>
            <input id="ar-name" placeholder="Recipe name" style="width:100%;padding:8px 10px;margin-bottom:8px;background:rgba(61,47,49,0.6);border:1px solid var(--border-color);border-radius:6px;color:var(--light-text);font-family:'Philosopher',serif;font-size:0.8rem;box-sizing:border-box;">
            <div style="display:flex;gap:6px;margin-bottom:8px;">
                <select id="ar-type" style="flex:1;padding:8px;background:rgba(61,47,49,0.6);border:1px solid var(--border-color);border-radius:6px;color:var(--light-text);font-family:'Philosopher',serif;font-size:0.8rem;">
                    <option value="Breakfast">Breakfast</option>
                    <option value="Lunch">Lunch</option>
                    <option value="Dinner" selected>Dinner</option>
                    <option value="Dessert">Dessert</option>
                </select>
                <input id="ar-protein" placeholder="Protein (g)" style="width:70px;padding:8px;background:rgba(61,47,49,0.6);border:1px solid var(--border-color);border-radius:6px;color:var(--light-text);font-family:'Philosopher',serif;font-size:0.8rem;">
                <input id="ar-cal" placeholder="Calories" style="width:70px;padding:8px;background:rgba(61,47,49,0.6);border:1px solid var(--border-color);border-radius:6px;color:var(--light-text);font-family:'Philosopher',serif;font-size:0.8rem;">
            </div>
            <textarea id="ar-ingredients" placeholder="Ingredients (one per line)" style="width:100%;min-height:70px;padding:8px 10px;margin-bottom:8px;background:rgba(61,47,49,0.6);border:1px solid var(--border-color);border-radius:6px;color:var(--light-text);font-family:'Philosopher',serif;font-size:0.78rem;resize:vertical;box-sizing:border-box;"></textarea>
            <textarea id="ar-steps" placeholder="Steps (one per line)" style="width:100%;min-height:70px;padding:8px 10px;margin-bottom:8px;background:rgba(61,47,49,0.6);border:1px solid var(--border-color);border-radius:6px;color:var(--light-text);font-family:'Philosopher',serif;font-size:0.78rem;resize:vertical;box-sizing:border-box;"></textarea>
            <input id="ar-tip" placeholder="Tip or note (optional)" style="width:100%;padding:8px 10px;margin-bottom:10px;background:rgba(61,47,49,0.6);border:1px solid var(--border-color);border-radius:6px;color:var(--light-text);font-family:'Philosopher',serif;font-size:0.8rem;box-sizing:border-box;">
            <button onclick="saveCustomRecipe()" style="width:100%;padding:10px;background:var(--sage-green);color:#1a1a1a;border:none;border-radius:6px;font-family:'Philosopher',serif;font-size:0.8rem;cursor:pointer;font-weight:700;">Save Recipe</button>
        </div>
        <button onclick="document.getElementById('add-recipe-form').style.display='block'" id="add-recipe-btn" style="width:100%;padding:10px;margin-bottom:16px;background:rgba(163,184,153,0.1);border:1px dashed rgba(163,184,153,0.3);border-radius:6px;color:#a3b899;font-family:'Philosopher',serif;font-size:0.78rem;cursor:pointer;letter-spacing:0.03em;">+ Add Custom Recipe</button>
        <div class="rb-grid" id="rb-grid"></div>
    </div>

    <!-- GROCERY LIST VIEW -->
    <div id="grocery-view" class="tab-view">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;">
            <h3 style="margin:0;color:var(--light-text);font-size:1rem;">Grocery List</h3>
            <div style="display:flex;gap:8px;">
                <button onclick="generateGroceryList()" class="gen-btn" style="font-size:0.75rem;padding:8px 14px;margin:0;">Generate from Plan</button>
            </div>
        </div>
        <div id="grocery-select-all-bar" style="display:none;margin-bottom:12px;text-align:right;">
            <button onclick="selectAllGrocery()" class="gen-btn" style="margin:0;background:#7d8f76;color:#fff;font-size:0.72rem;padding:8px 16px;">Select All</button>
        </div>
        <div id="grocery-list-content">
            <div style="color:rgba(224,210,208,0.4);font-size:0.8rem;text-align:center;padding:40px 20px;">
                Tap "Generate from Plan" to build your grocery list from the current meal plan.
            </div>
        </div>
        <div id="grocery-send-bar" style="display:none;position:sticky;bottom:0;padding:12px 0;background:var(--bg-color);">
            <button onclick="sendGroceryToHomeHub()" class="gen-btn" style="width:100%;margin:0;background:#a3b899;">Send Selected to Home Hub</button>
        </div>
    </div>

    <!-- GENERATE PLAN VIEW -->
    <div id="generate-view" class="tab-view">
        <div class="gen-section">
            <h3>Generate New 2-Week Plan</h3>
            <div class="gen-row">
                <span class="gen-label">Start Date</span>
                <input type="date" class="gen-input" id="gen-start-date">
            </div>
            <div class="gen-row">
                <span class="gen-label">Duration</span>
                <select class="gen-input" id="gen-duration">
                    <option value="7">1 Week (7 days)</option>
                    <option value="14" selected>2 Weeks (14 days)</option>
                </select>
            </div>
        </div>

        <div class="gen-section">
            <h3>Preferences</h3>
            <div class="gen-checkbox-row">
                <input type="checkbox" id="gen-favor-favs" checked>
                <label for="gen-favor-favs">Prioritize favorite recipes</label>
            </div>
            <div class="gen-checkbox-row">
                <input type="checkbox" id="gen-new-recipes" checked>
                <label for="gen-new-recipes">Include ~30% new recipe ideas</label>
            </div>
            <div class="gen-checkbox-row">
                <input type="checkbox" id="gen-no-repeat" checked>
                <label for="gen-no-repeat">No same meal two days in a row</label>
            </div>
            <div class="gen-checkbox-row">
                <input type="checkbox" id="gen-avoid-previous" checked>
                <label for="gen-avoid-previous">Avoid meals from current plan <span style="opacity:0.4;font-size:0.65rem;">(fresh recipes only)</span></label>
            </div>
            <div class="gen-checkbox-row">
                <input type="checkbox" id="gen-prep-days" checked>
                <label for="gen-prep-days">Include prep day schedules</label>
            </div>
            <div class="gen-row">
                <span class="gen-label">Prep Style</span>
                <select class="gen-input" id="gen-prep-style">
                    <option value="batch" selected>Batch prep — 2-3 recipes per category, alternate daily</option>
                    <option value="moderate">Moderate — some batch, some fresh</option>
                    <option value="fresh">All fresh — unique meals every day</option>
                </select>
            </div>
        </div>

        <div class="gen-section">
            <h3>Vibe</h3>
            <div class="gen-row">
                <span class="gen-label">Spice Level</span>
                <select class="gen-input" id="gen-spice">
                    <option value="mild">Mild — keep it chill</option>
                    <option value="medium">Medium — some kick</option>
                    <option value="hot" selected>Hot — we love spice 🌶️</option>
                    <option value="extra">Extra — bring the heat 🔥</option>
                </select>
            </div>
            <div class="gen-row" style="flex-direction:column;align-items:flex-start;gap:6px;">
                <span class="gen-label">Cuisine Focus <span style="opacity:0.4;font-weight:400;font-size:0.7rem;">(pick any)</span></span>
                <div style="display:flex;flex-wrap:wrap;gap:6px;width:100%;">
                    <label class="gen-chip"><input type="checkbox" value="mediterranean" id="gen-c-med" checked> Mediterranean</label>
                    <label class="gen-chip"><input type="checkbox" value="mexican" id="gen-c-mex" checked> Mexican / Tex-Mex</label>
                    <label class="gen-chip"><input type="checkbox" value="asian" id="gen-c-asian"> Asian-inspired</label>
                    <label class="gen-chip"><input type="checkbox" value="italian" id="gen-c-ital" checked> Italian</label>
                    <label class="gen-chip"><input type="checkbox" value="comfort" id="gen-c-comfort"> Comfort food</label>
                    <label class="gen-chip"><input type="checkbox" value="indian" id="gen-c-indian"> Indian</label>
                    <label class="gen-chip"><input type="checkbox" value="korean" id="gen-c-korean"> Korean</label>
                    <label class="gen-chip"><input type="checkbox" value="middleeastern" id="gen-c-me"> Middle Eastern</label>
                </div>
            </div>
            <div class="gen-row">
                <span class="gen-label">Dinner Effort</span>
                <select class="gen-input" id="gen-effort">
                    <option value="quick">Quick — 20 min or less</option>
                    <option value="normal" selected>Normal — 20-35 min</option>
                    <option value="involved">Worth it — up to 45 min</option>
                </select>
            </div>
            <div class="gen-row">
                <span class="gen-label">Grocery Runs</span>
                <select class="gen-input" id="gen-grocery-runs">
                    <option value="minimal" selected>Minimal — reuse ingredients across days</option>
                    <option value="moderate">Moderate — some variety is fine</option>
                    <option value="variety">Max variety — don't care about overlap</option>
                </select>
            </div>
            <div class="gen-row" style="align-items:center;gap:12px;">
                <label style="display:flex;align-items:center;gap:10px;cursor:pointer;width:100%;">
                    <input type="checkbox" id="gen-minimize-waste" checked style="accent-color:var(--sage-green);width:18px;height:18px;flex-shrink:0;">
                    <span class="gen-label" style="margin:0;">Minimize Waste <span style="opacity:0.4;font-weight:400;font-size:0.65rem;display:block;margin-top:2px;">Reuse the same proteins, produce & pantry items across meals so nothing goes bad</span></span>
                </label>
            </div>
            <div class="gen-row" style="flex-direction:column;align-items:flex-start;gap:6px;">
                <span class="gen-label">Dessert Style <span style="opacity:0.4;font-weight:400;font-size:0.7rem;">(pick any)</span></span>
                <div style="display:flex;flex-wrap:wrap;gap:6px;width:100%;">
                    <label class="gen-chip"><input type="checkbox" value="light" id="gen-d-light" checked> Light & healthy</label>
                    <label class="gen-chip"><input type="checkbox" value="protein" id="gen-d-protein" checked> Protein-packed</label>
                    <label class="gen-chip"><input type="checkbox" value="treat" id="gen-d-treat"> Real treats</label>
                    <label class="gen-chip"><input type="checkbox" value="skip" id="gen-d-skip"> Skip desserts</label>
                </div>
            </div>
            <div class="gen-row" style="flex-direction:column;align-items:flex-start;gap:6px;">
                <span class="gen-label">Special Requests</span>
                <input type="text" id="gen-special" class="gen-input" style="width:100%;box-sizing:border-box;" placeholder="e.g. &quot;more one-pot meals&quot;, &quot;use up the ricotta&quot;, &quot;lighter lunches&quot;">
            </div>
        </div>

        <div class="gen-section">
            <h3>Dietary Reminders</h3>
            <div id="diet-tags" style="display:flex;flex-wrap:wrap;gap:6px;margin-bottom:10px;"></div>
            <div style="display:flex;gap:6px;">
                <input type="text" id="diet-tag-input" placeholder="Add a reminder..." style="flex:1;padding:8px 12px;background:rgba(61,47,49,0.6);border:1px solid var(--border-color);border-radius:6px;color:var(--light-text);font-family:'Philosopher',serif;font-size:0.8rem;">
                <button onclick="addDietTag()" style="padding:8px 14px;background:var(--sage-green);color:#1a1a1a;border:none;border-radius:6px;font-family:'Philosopher',serif;font-size:0.8rem;cursor:pointer;font-weight:700;">Add</button>
            </div>
        </div>

        <div style="text-align:center;">
        <button class="gen-btn" id="gen-btn" onclick="generatePlan()">Generate Meal Plan</button>
        </div>
        
        <div id="gen-status" class="gen-status" style="display:none;"></div>
        <div id="gen-preview" style="display:none; margin-top: 16px;"></div>
    </div>
</div><!-- end container -->

<div class="modal-container" id="modal">
    <div class="modal">
        <div class="modal-header" id="modal-header">
            <button class="modal-close" onclick="closeModal()">×</button>
            <span id="modal-person-badge" style="display:inline-block;font-size:0.6rem;text-transform:uppercase;letter-spacing:0.1em;padding:2px 8px;border-radius:3px;font-weight:700;margin-bottom:6px;"></span>
            <h3 id="modal-title">Recipe Name</h3>
            <div class="meta" id="modal-meta">25g protein • 350 cal • 25 min</div>
        </div>
        <div class="modal-body">
            <div class="modal-section">
                <h4>Ingredients</h4>
                <ul id="modal-ingredients"></ul>
            </div>
            <div class="modal-section">
                <h4>Instructions</h4>
                <ul id="modal-steps"></ul>
            </div>
            <div class="tip-box" id="modal-tip" style="display: none;">
                <p></p>
            </div>
            <div class="portions-row" id="modal-portions"></div>
            <div id="modal-swap-section" style="display:none;margin-top:12px;">
                <button id="modal-swap-btn" onclick="showSwapOptions()" style="width:100%;padding:10px;background:rgba(163,184,153,0.15);border:1px solid rgba(163,184,153,0.3);border-radius:6px;color:#a3b899;font-family:'Philosopher',serif;font-size:0.78rem;cursor:pointer;letter-spacing:0.03em;">Swap this meal</button>
                <div id="modal-swap-list" style="display:none;margin-top:10px;max-height:250px;overflow-y:auto;"></div>
            </div>
        </div>
    </div>
</div>

<script>
// SNACK MENU - pick whatever sounds good each day (~150-200 cal)
const snackMenu = [
    { name: "3/4 Cup Greek Yogurt", portion: "18g protein - 100 cal", color: "#7d8f76",
        ingredients: ["3/4 cup nonfat Greek yogurt"],
        steps: ["Scoop into bowl. Add whatever sounds good."],
        tip: "Probiotics for gut health, which is increasingly linked to cancer prevention. Great with berries, honey, or nuts.",
        portions: ["18g protein", "100 cal", "0g fiber"]
    },
    { name: "1/2 Cup Cottage Cheese", portion: "14g protein - 90 cal", color: "#7d8f76",
        ingredients: ["1/2 cup low-fat cottage cheese"],
        steps: ["Scoop and eat. Top with anything from this list."],
        tip: "Casein protein for slow, sustained release. Great base for mixing with any fruit on this list.",
        portions: ["14g protein", "90 cal", "0g fiber"]
    },
    { name: "Protein Chia Pudding", portion: "23g protein - 190 cal", color: "#7d8f76",
        ingredients: ["2 tbsp chia seeds", "1/2 cup unsweetened almond milk", "1/2 scoop protein powder", "1/2 tsp vanilla"],
        steps: ["Mix all ingredients. Refrigerate 2+ hours or overnight.", "Top with anything from this list."],
        tip: "Omega-3 ALA from chia plus protein powder. Prep several at once for the week.",
        portions: ["23g protein", "190 cal", "8g fiber"]
    },
    { name: "Barebell Protein Bar", portion: "20g protein - 200 cal", color: "#7d8f76",
        ingredients: ["1 Barebell protein bar (any flavor)"],
        steps: ["Unwrap. Eat."],
        tip: "High protein, low sugar, zero effort. Keep a box at home and one in your bag.",
        portions: ["20g protein", "200 cal", "0 min"]
    },
    { name: "3/4 Cup Edamame", portion: "18g protein - 190 cal", color: "#7d8f76",
        ingredients: ["3/4 cup shelled edamame", "Flaky sea salt"],
        steps: ["Steam or microwave. Salt. Done."],
        tip: "Soy isoflavones have documented anti-cancer effects. One of the highest-protein plant snacks you can grab.",
        portions: ["18g protein", "190 cal", "4g fiber"]
    },
    { name: "String Cheese", portion: "7g protein - 80 cal", color: "#7d8f76",
        ingredients: ["1 Galbani reduced fat mozzarella string cheese"],
        steps: ["Peel and eat."],
        tip: "Calcium plus protein in a grab-and-go package. Keep these stocked.",
        portions: ["7g protein", "80 cal", "0g fiber"]
    },
    { name: "1 Hard-Boiled Egg", portion: "6g protein - 70 cal", color: "#7d8f76",
        ingredients: ["1 egg"],
        steps: ["Boil a batch on Sunday — they keep 7 days in the fridge."],
        tip: "Complete protein plus choline for DNA repair. Batch-prep a dozen at the start of each week.",
        portions: ["6g protein", "70 cal", "0g fiber"]
    },
    { name: "1 Tbsp Pumpkin Seeds", portion: "3g protein - 45 cal", color: "#7d8f76",
        ingredients: ["1 tbsp pumpkin seeds (pepitas)"],
        steps: ["Sprinkle on yogurt, cottage cheese, or eat by the handful."],
        tip: "Rich in zinc for immune function. Crunchy topper for anything.",
        portions: ["3g protein", "45 cal", "1g fiber"]
    },
    { name: "Trail Mix (pre-made batch)", portion: "10g protein - 200 cal", color: "#7d8f76",
        ingredients: ["2 tbsp walnuts", "2 tbsp dried tart cherries", "1 tbsp cacao nibs", "1 tbsp pumpkin seeds"],
        steps: ["Mix a big batch. Portion into baggies for the week."],
        tip: "Tart cherries have among the highest anti-inflammatory scores. Cacao nibs add flavanols. Concentrated antioxidant snack.",
        portions: ["10g protein", "200 cal", "3g fiber"]
    },
    { name: "1/4 Cup Hummus", portion: "5g protein - 100 cal", color: "#7d8f76",
        ingredients: ["1/4 cup hummus"],
        steps: ["Scoop with carrots, bell pepper, or a spoon. No judgment."],
        tip: "Chickpea fiber plus tahini healthy fats. Pairs with any raw veggie on this list.",
        portions: ["5g protein", "100 cal", "3g fiber"]
    },
    { name: "1 Tbsp Pistachios", portion: "2g protein - 45 cal", color: "#7d8f76",
        ingredients: ["1 tbsp shelled pistachios"],
        steps: ["Eat as-is or crush over yogurt."],
        tip: "Gamma-tocopherol (vitamin E form) and lutein. Great crunch.",
        portions: ["2g protein", "45 cal", "1g fiber"]
    },
    { name: "1 Tbsp Walnuts", portion: "2g protein - 50 cal", color: "#7d8f76",
        ingredients: ["1 tbsp walnuts, chopped"],
        steps: ["Eat plain, add to yogurt, or top cottage cheese."],
        tip: "The most anti-inflammatory nut. Only nut with significant omega-3 ALA.",
        portions: ["2g protein", "50 cal", "1g fiber"]
    },
    { name: "1/4 Cup Pomegranate Seeds", portion: "1g protein - 35 cal", color: "#7d8f76",
        ingredients: ["1/4 cup pomegranate seeds"],
        steps: ["Pop the seeds out or buy pre-seeded."],
        tip: "Punicalagins and ellagic acid — heavily studied for prostate cancer prevention especially.",
        portions: ["1g protein", "35 cal", "2g fiber"]
    },
    { name: "Chocolate Covered Almonds (10)", portion: "4g protein - 150 cal", color: "#7d8f76",
        ingredients: ["10 chocolate covered almonds"],
        steps: ["Eat 10. Try not to eat 30."],
        tip: "Dark chocolate flavanols plus vitamin E from almonds. Portion into small bags for the week.",
        portions: ["4g protein", "150 cal", "2g fiber"]
    },
    { name: "1.5 Tbsp Walnut Butter", portion: "3g protein - 140 cal", color: "#7d8f76",
        ingredients: ["1.5 tbsp walnut butter"],
        steps: ["Spread on fruit or eat straight."],
        tip: "Walnuts are the only nut with significant omega-3 ALA. Anti-inflammatory powerhouse.",
        portions: ["3g protein", "140 cal", "1g fiber"]
    },
    { name: "1/2 Banana", portion: "1g protein - 50 cal", color: "#7d8f76",
        ingredients: ["1/2 banana"],
        steps: ["Peel. Eat. Or slice and dip."],
        tip: "Prebiotic fiber for gut health. Potassium for blood pressure.",
        portions: ["1g protein", "50 cal", "1g fiber"]
    },
    { name: "1/2 Cup Mango", portion: "1g protein - 50 cal", color: "#7d8f76",
        ingredients: ["1/2 cup diced mango (fresh or frozen, thawed)"],
        steps: ["Dice fresh or thaw frozen."],
        tip: "Beta-carotene and vitamin C from whole food. Great with cottage cheese or yogurt.",
        portions: ["1g protein", "50 cal", "1g fiber"]
    },
    { name: "1 Cup Carrot Sticks", portion: "1g protein - 50 cal", color: "#7d8f76",
        ingredients: ["1 cup carrot sticks (or baby carrots)"],
        steps: ["Dip in hummus or eat plain."],
        tip: "Beta-carotene from food is safely protective (unlike supplements). Great dipper.",
        portions: ["1g protein", "50 cal", "4g fiber"]
    },
    { name: "1 Tbsp Dark Chocolate Chips", portion: "1g protein - 70 cal", color: "#7d8f76",
        ingredients: ["1 tbsp dark chocolate chips"],
        steps: ["Sprinkle on anything. Or just eat them."],
        tip: "Flavanols from dark chocolate. A little goes a long way as a topper.",
        portions: ["1g protein", "70 cal", "1g fiber"]
    },
    { name: "1 Medium Apple", portion: "0g protein - 95 cal", color: "#7d8f76",
        ingredients: ["1 medium apple"],
        steps: ["Slice or just bite into it."],
        tip: "Pectin fiber feeds beneficial gut bacteria. Great with walnut butter from this list.",
        portions: ["0g protein", "95 cal", "4g fiber"]
    },
    { name: "1/2 Cup Mixed Berries", portion: "0g protein - 40 cal", color: "#7d8f76",
        ingredients: ["1/2 cup mixed berries (fresh or frozen, thawed)"],
        steps: ["Rinse fresh or thaw frozen."],
        tip: "Anthocyanins and ellagic acid — two of the most studied anti-cancer compounds in fruit.",
        portions: ["0g protein", "40 cal", "2g fiber"]
    },
    { name: "1/2 Cup Strawberries", portion: "0g protein - 25 cal", color: "#7d8f76",
        ingredients: ["1/2 cup sliced strawberries"],
        steps: ["Slice and enjoy."],
        tip: "Ellagic acid has been shown to suppress cancer cell growth in lab studies. Also just delicious.",
        portions: ["0g protein", "25 cal", "2g fiber"]
    },
    { name: "1/2 Cup Pineapple", portion: "0g protein - 40 cal", color: "#7d8f76",
        ingredients: ["1/2 cup diced pineapple"],
        steps: ["Dice fresh or use pre-cut."],
        tip: "Bromelain enzyme has anti-inflammatory and potential anti-cancer properties.",
        portions: ["0g protein", "40 cal", "1g fiber"]
    },
    { name: "1 Cup Green Tea", portion: "0g protein - 0 cal", color: "#7d8f76",
        ingredients: ["1 cup brewed green tea"],
        steps: ["Steep 3 min in hot (not boiling) water."],
        tip: "EGCG is one of the most studied anti-cancer compounds. Free calories, real protection.",
        portions: ["0g protein", "0 cal", "0g fiber"]
    }
];


// ═══════════════════════════════════════
// Pinterest-Inspired & Bonus Recipes
// ═══════════════════════════════════════
var additionalRecipes = [
    { name: "Raspberry Yogurt Bark", type: "Dessert", portion: "14g protein - 170 cal", color: "#c4a882",
        ingredients: ["1 cup nonfat Greek yogurt", "1 tsp honey", "1/2 tsp vanilla extract", "3/4 cup fresh raspberries", "1 tbsp mini dark chocolate chips", "1 tbsp crushed walnuts", "1 tsp chia seeds"],
        steps: ["Mix yogurt with honey and vanilla.", "Spread thin on parchment. Press in raspberries, chips, walnuts, chia.", "Freeze 2+ hours. Break into pieces."],
        tip: "Raspberries have the highest ellagic acid of any berry.", portions: ["14g protein", "170 cal", "4g fiber", "5 min"]
    },
    { name: "Banana Snickers Bites", type: "Dessert", portion: "6g protein - 180 cal", color: "#c4a882",
        ingredients: ["1 medium banana", "2 tbsp almond butter", "1 oz dark chocolate (70%+), melted", "1 tbsp walnuts", "Flaky sea salt"],
        steps: ["Slice banana into rounds. Sandwich with almond butter. Dip in chocolate. Sprinkle walnuts + salt. Freeze 20 min."],
        tip: "Tastes like Snickers but it's real food.", portions: ["6g protein", "180 cal", "3g fiber", "10 min"]
    },
    { name: "Apple Samoas", type: "Dessert", portion: "4g protein - 170 cal", color: "#c4a882",
        ingredients: ["1 medium apple, sliced into rings", "2 tbsp almond butter", "1 oz dark chocolate, melted", "2 tbsp toasted coconut flakes", "Flaky sea salt"],
        steps: ["Spread almond butter on apple rings. Drizzle chocolate. Sprinkle coconut + salt."],
        tip: "Apple pectin + dark chocolate flavanols + coconut MCTs.", portions: ["4g protein", "170 cal", "4g fiber", "5 min"]
    },
    { name: "Strawberry Chia Chocolate Bites", type: "Dessert", portion: "5g protein - 160 cal", color: "#c4a882",
        ingredients: ["1/2 cup fresh strawberries, diced", "2 tbsp chia seeds", "1 tbsp cacao powder", "1 tbsp honey", "2 tbsp rolled oats", "1 tbsp dark chocolate chips", "1 tbsp almond butter"],
        steps: ["Mix all ingredients. Roll into balls. Refrigerate 30 min."],
        tip: "Strawberry ellagic acid + chia omega-3s + cacao flavanols.", portions: ["5g protein", "160 cal", "4g fiber", "10 min"]
    },
    { name: "Caramelized Banana Toast", type: "Breakfast", portion: "12g protein - 350 cal", color: "#a3b899",
        ingredients: ["1 slice Ezekiel bread", "1 banana, sliced lengthwise", "2 tbsp almond butter", "1 tsp coconut oil", "1 tbsp honey", "1 tsp cinnamon", "1 tbsp toasted coconut flakes", "Flaky sea salt"],
        steps: ["Toast bread. Caramelize banana in coconut oil 2 min per side. Layer almond butter, banana, honey, cinnamon, coconut, salt."],
        tip: "Celebration breakfast! Pair with supplement shake.", portions: ["12g protein", "350 cal", "5g fiber", "10 min"]
    },
    { name: "Peach Cobbler Overnight Oats", type: "Breakfast", portion: "38g protein - 410 cal", color: "#a3b899",
        ingredients: ["1/2 cup rolled oats", "1 cup almond milk", "collagen", "L-glutamine", "MCT oil", "1 scoop whey", "1 tsp chia seeds", "1 tsp cinnamon", "1/4 tsp nutmeg", "1/2 cup frozen peaches (move to fridge night before)", "1 tbsp walnuts", "1 tsp honey"],
        steps: ["Mix base ingredients night before. Top with peaches, walnuts, honey in morning."],
        tip: "Apple pie spices in overnight oats. Full supplement stack.", portions: ["38g protein", "410 cal", "6g fiber", "5 min"]
    },
    { name: "Strawberry Chocolate Overnight Oats", type: "Breakfast", portion: "40g protein - 430 cal", color: "#a3b899",
        ingredients: ["1/2 cup rolled oats", "1 cup almond milk", "1.5 tbsp cacao powder", "collagen", "L-glutamine", "MCT oil", "1 scoop whey", "1 tsp chia seeds", "Fresh strawberries", "1 tbsp dark chocolate chips", "1 tbsp hemp hearts"],
        steps: ["Blend base, pour over oats + chia. Refrigerate. Morning: melt chips for top layer, add strawberries + hemp hearts."],
        tip: "Chocolate top layer sets like magic. Full supplement stack.", portions: ["40g protein", "430 cal", "7g fiber", "5 min"]
    },
    { name: "Chocolate Chia Pudding with Cool Whip", type: "Dessert", portion: "15g protein - 170 cal", color: "#c4a882",
        ingredients: ["2 tbsp chia seeds", "1/2 cup almond milk", "1 tbsp cacao powder", "1/2 scoop whey", "1 tsp honey", "2 tbsp Cool Whip lite"],
        steps: ["Mix chia, milk, cacao, whey, honey. Refrigerate 2+ hours. Top with Cool Whip."],
        tip: "Chocolate pudding with 15g protein.", portions: ["15g protein", "170 cal", "5g fiber", "5 min"]
    },
    { name: "Banana Nut Date Chia Pudding", type: "Dessert", portion: "10g protein - 190 cal", color: "#c4a882",
        ingredients: ["2 tbsp chia seeds", "1/2 cup almond milk", "1/2 scoop whey", "1/4 tsp vanilla", "1/4 tsp cinnamon", "1 Medjool date, chopped", "1 tbsp walnuts", "Honey drizzle"],
        steps: ["Mix chia, milk, whey, vanilla, cinnamon. Refrigerate overnight. Top with date, walnuts, honey."],
        tip: "Tastes like banana bread pudding.", portions: ["10g protein", "190 cal", "6g fiber", "5 min"]
    },
    { name: "Chocolate Greek Yogurt", type: "Dessert", portion: "18g protein - 150 cal", color: "#c4a882",
        ingredients: ["3/4 cup nonfat Greek yogurt", "1 tbsp cacao powder", "1 tsp honey", "1/4 tsp vanilla", "1 tbsp dark chocolate chips", "Pinch of sea salt"],
        steps: ["Stir cacao into yogurt. Add honey, vanilla, salt. Top with chips."],
        tip: "Chocolate mousse vibes. 18g protein.", portions: ["18g protein", "150 cal", "2g fiber", "2 min"]
    },
    { name: "Strawberry Cheesecake Protein Fluff", type: "Dessert", portion: "22g protein - 160 cal", color: "#c4a882",
        ingredients: ["1/2 cup low-fat cottage cheese", "1/4 cup Greek yogurt", "1/2 cup fresh strawberries", "1 tsp honey", "1/4 tsp vanilla", "1 tbsp graham cracker crumbs"],
        steps: ["Blend cottage cheese + yogurt smooth. Fold in strawberries, honey, vanilla. Top with graham crumbs."],
        tip: "Cottage cheese blended smooth = cheesecake filling. 22g protein.", portions: ["22g protein", "160 cal", "1g fiber", "5 min"]
    },
    { name: "Chocolate Chip Oat Energy Balls", type: "Dessert", portion: "8g protein - 180 cal", color: "#c4a882",
        ingredients: ["1/2 cup rolled oats", "2 tbsp almond butter", "1 tbsp honey", "1 scoop whey", "1 tbsp dark chocolate chips", "1 tbsp hemp hearts"],
        steps: ["Mix all. Roll into balls. Refrigerate 30 min."],
        tip: "No-bake energy balls. Make a batch on prep day.", portions: ["8g protein", "180 cal", "3g fiber", "10 min"]
    },
    { name: "Chocolate Chip Oat Cake", type: "Dessert", portion: "10g protein - 180 cal", color: "#c4a882",
        ingredients: ["1/3 cup rolled oats", "1/2 banana, mashed", "1 egg white", "1 tbsp cacao powder", "1/2 tsp baking powder", "1 tbsp dark chocolate chips"],
        steps: ["Mix all. Pour in mug. Microwave 90 sec."],
        tip: "Mug cake in 2 minutes.", portions: ["10g protein", "180 cal", "4g fiber", "5 min"]
    },
    { name: "Strawberry Coconut Cream Stuffed Dates", type: "Dessert", portion: "3g protein - 170 cal", color: "#c4a882",
        ingredients: ["3 Medjool dates", "2 tbsp coconut cream", "2 strawberries, diced", "1 oz dark chocolate, melted", "1 tsp toasted coconut", "Flaky sea salt"],
        steps: ["Slice dates open. Stuff with coconut cream + strawberries. Dip in chocolate. Sprinkle coconut + salt. Chill 15 min."],
        tip: "Dates are antioxidant powerhouses.", portions: ["3g protein", "170 cal", "3g fiber", "10 min"]
    },
    { name: "Baked Protein Pancake Bowls", type: "Breakfast", portion: "32g protein - 380 cal", color: "#a3b899",
        ingredients: ["1/3 cup rolled oats, blended", "1 scoop whey", "1 egg", "1/4 cup Greek yogurt", "1/4 cup almond milk", "1/2 tsp baking powder", "1/2 tsp vanilla", "Berries", "Maple syrup"],
        steps: ["Mix batter. Pour in greased ramekin. Bake 350°F 20 min. Top with berries + syrup."],
        tip: "Pancake bowl you can bake during other prep.", portions: ["32g protein", "380 cal", "3g fiber", "25 min"]
    },
    { name: "Strawberry Banana Bark", type: "Dessert", portion: "14g protein - 160 cal", color: "#c4a882",
        ingredients: ["1 cup Greek yogurt", "1 tsp honey", "1/4 tsp vanilla", "1/2 banana, sliced", "4-5 strawberries, sliced", "1 tbsp dark chocolate chips", "1 tbsp walnuts", "1 tsp hemp hearts"],
        steps: ["Mix yogurt, honey, vanilla. Spread on parchment. Top with fruit, chips, walnuts, hemp hearts. Freeze 2+ hours."],
        tip: "Banana fiber + strawberry ellagic acid + walnut omega-3s.", portions: ["14g protein", "160 cal", "3g fiber", "5 min"]
    },
    { name: "Maple Cinnamon Roasted Apples", type: "Dessert", portion: "2g protein - 150 cal", color: "#c4a882",
        ingredients: ["2 apples, sliced", "1 tsp coconut oil", "1 tbsp maple syrup", "1 tsp cinnamon", "1/4 tsp nutmeg", "1 tbsp walnuts", "2 tbsp Greek yogurt"],
        steps: ["Toss apples with oil, syrup, spices. Roast 375°F 20-25 min. Top with walnuts + yogurt."],
        tip: "Roasting concentrates natural sugars. Cinnamon regulates blood sugar.", portions: ["2g protein", "150 cal", "4g fiber", "25 min"]
    },
    { name: "Apple Pie Breakfast Bowl", type: "Breakfast", portion: "36g protein - 400 cal", color: "#a3b899",
        ingredients: ["1/2 cup oats", "1 cup almond milk", "collagen", "L-glutamine", "MCT oil", "1 scoop whey", "1 tsp chia seeds", "1 tsp cinnamon", "1/4 tsp nutmeg", "Pinch allspice", "1/2 apple, diced", "1 tbsp walnuts", "1 tbsp maple syrup", "1 tbsp hemp hearts"],
        steps: ["Mix oat base night before with spices. Top with apple, walnuts, syrup, hemp hearts in morning."],
        tip: "Apple pie spices in overnight oats. Full supplement stack.", portions: ["36g protein", "400 cal", "6g fiber", "5 min"]
    },
    { name: "Fluffy Protein Blueberry Pancakes", type: "Breakfast", portion: "38g protein - 420 cal", color: "#a3b899",
        ingredients: ["1/3 cup oats, blended to flour", "1 scoop whey", "1 egg", "1/4 cup Greek yogurt", "1/4 cup almond milk", "1/2 tsp baking powder", "1/4 cup blueberries", "Maple syrup", "Walnuts"],
        steps: ["Blend oats to flour. Mix dry. Whisk wet. Combine. Fold in blueberries. Cook 2-3 min per side. Top with syrup + walnuts."],
        tip: "Weekend pancake treat! Blueberry anthocyanins are powerful anti-cancer compounds.", portions: ["38g protein", "420 cal", "4g fiber", "15 min"]
    },
    { name: "Chicken Teriyaki Bowl", type: "Dinner", portion: "46g protein - 520 cal", color: "#a3b899",
        ingredients: ["6 oz chicken breast", "1/2 cup rice", "teriyaki sauce", "soy sauce", "honey", "garlic powder", "1/2 cucumber", "1 carrot", "rice vinegar", "sesame oil", "Red pepper flakes"],
        steps: ["Cook rice. Cube and sear chicken. Glaze with teriyaki. Make cucumber + carrot salads with rice vinegar + sesame oil. Bowl it."],
        tip: "Cold cucumber and carrot salads contrast the warm teriyaki perfectly.", portions: ["46g protein", "520 cal", "3g fiber", "20 min"]
    },
    { name: "Chicken Fajita Bowl", type: "Dinner", portion: "46g protein - 510 cal", color: "#a3b899",
        ingredients: ["6 oz chicken breast", "1/2 bell pepper", "1/2 onion", "1/2 cup rice", "1/4 cup black beans", "Fajita seasoning", "Salsa", "Cheese", "Sour cream", "Lime"],
        steps: ["Slice chicken, peppers, onions. Sear with fajita spices. Serve over rice with beans, cheese, salsa, sour cream, lime."],
        tip: "Charred peppers and onions are the key. Capsaicin is anti-inflammatory.", portions: ["46g protein", "510 cal", "6g fiber", "20 min"]
    },
    { name: "Turkey Burgers", type: "Dinner", portion: "44g protein - 490 cal", color: "#a3b899",
        ingredients: ["6 oz ground turkey", "1 whole wheat bun", "Pepper jack cheese", "Garlic powder", "Onion powder", "Smoked paprika", "Lettuce, pickles, red onion rings"],
        steps: ["Season turkey with spices. Form patty. Cook 4-5 min per side. Add cheese last minute. Build burger."],
        tip: "Smoked paprika gives a smoky depth. Turkey is leaner than beef.", portions: ["44g protein", "490 cal", "3g fiber", "15 min"]
    },
    { name: "Blackened Lemon Chicken", type: "Dinner", portion: "46g protein - 500 cal", color: "#a3b899",
        ingredients: ["6 oz chicken breast", "1/2 cup farro or rice", "1 cup asparagus or green beans", "Lemon juice", "Smoked paprika", "Cayenne", "Garlic powder", "Thyme", "Oregano"],
        steps: ["Mix blackening spice. Coat chicken. Sear in cast iron 5-6 min per side. Squeeze lemon over. Serve with farro + roasted veggies."],
        tip: "Cast iron blackening is restaurant-quality at home.", portions: ["46g protein", "500 cal", "5g fiber", "20 min"]
    },
    { name: "Garlic Herb Chicken with Mashed Potatoes & Carrots", type: "Dinner", portion: "46g protein - 530 cal", color: "#a3b899",
        ingredients: ["6 oz chicken breast", "1 Yukon Gold potato", "1 cup carrots", "2 tbsp milk", "1 tbsp butter", "2 cloves garlic", "Olive oil", "Rosemary", "Thyme"],
        steps: ["Boil potato, mash with milk + butter. Roast carrots. Cook chicken with garlic herb butter. Plate together."],
        tip: "Classic comfort food done healthy. Garlic allicin is anti-cancer.", portions: ["46g protein", "530 cal", "5g fiber", "30 min"]
    },
    { name: "Crock Pot Korean BBQ Chicken", type: "Dinner", portion: "45g protein - 510 cal", color: "#a3b899",
        ingredients: ["6 oz chicken breast", "1/2 cup rice", "soy sauce", "honey", "rice vinegar", "sesame oil", "garlic", "ginger", "gochujang", "Broccoli", "Sesame seeds", "Green onions"],
        steps: ["Mix sauce: soy, honey, vinegar, sesame oil, garlic, ginger, gochujang. Cook chicken in sauce (crock pot or stovetop). Serve over rice with steamed broccoli, sesame seeds, green onions."],
        tip: "Gochujang is fermented chili paste — probiotic benefits + heat.", portions: ["45g protein", "510 cal", "4g fiber", "25 min"]
    },
    { name: "Chicken Enchilada Bowl", type: "Lunch", portion: "44g protein - 490 cal", color: "#a3b899",
        ingredients: ["5 oz shredded chicken", "1/2 cup rice", "1/2 cup black beans", "1/2 cup enchilada sauce", "1/4 cup cheese", "Sour cream", "Salsa", "Lime", "Hot sauce"],
        steps: ["Reheat chicken, rice, beans, enchilada sauce. Top with cheese, sour cream, salsa, lime, hot sauce."],
        tip: "Deconstructed enchiladas without the rolling.", portions: ["44g protein", "490 cal", "9g fiber", "5 min"]
    },
    { name: "Greek Chicken & Hummus Bowl", type: "Lunch", portion: "43g protein - 470 cal", color: "#a3b899",
        ingredients: ["5-6.5 oz prepped chicken", "1/2 cup brown rice", "1/4 cup hummus", "1/4 cucumber, diced", "2 tbsp feta", "Roasted red peppers", "Olive oil", "Lemon", "Oregano"],
        steps: ["Bowl: rice, chicken. Add hummus, cucumber, roasted red peppers, feta. Drizzle oil + lemon + oregano."],
        tip: "Mediterranean assembly bowl — no cooking needed.", portions: ["43g protein", "470 cal", "5g fiber", "5 min"]
    },
    { name: "Blackened Chicken & Rice Bowl", type: "Lunch", portion: "44g protein - 480 cal", color: "#a3b899",
        ingredients: ["5-6.5 oz prepped chicken", "1/2 cup brown rice", "Steamed broccoli or green beans", "Smoked paprika", "Cayenne", "Garlic powder", "Thyme", "Lemon"],
        steps: ["Toss chicken with blackening spice. Quick sear 2 min. Bowl with rice + veggies + lemon."],
        tip: "Blackening spice transforms meal-prep chicken.", portions: ["44g protein", "480 cal", "5g fiber", "10 min"]
    },
    { name: "Roasted Sweet Potatoes & Carrots", type: "Side", portion: "3g protein - 180 cal", color: "#a3b899",
        ingredients: ["1 sweet potato, cubed", "1 cup carrots", "1 tbsp olive oil", "Smoked paprika", "Garlic powder", "Cinnamon", "Salt, pepper", "Honey drizzle"],
        steps: ["Toss with oil + spices. Roast 400°F 25 min. Drizzle honey."],
        tip: "Beta-carotene powerhouse.", portions: ["3g protein", "180 cal", "5g fiber", "25 min"]
    },
    { name: "Creamy Tuscan Chicken", type: "Dinner", portion: "48g protein - 510 cal", color: "#a3b899",
        ingredients: ["6 oz chicken breast, sliced thin", "1/4 cup sun-dried tomatoes, chopped", "2 cloves garlic, minced", "1/3 cup cottage cheese (blended smooth)", "2 tbsp parmesan", "1 cup baby spinach", "1 tbsp butter", "1/2 tsp oregano", "1/4 tsp crushed red pepper", "Salt, pepper", "Fresh basil"],
        steps: ["Melt butter in skillet over medium heat. Add garlic, oregano, red pepper — sauté 1 min.", "Add sliced chicken, season with salt and pepper. Sear each side until golden and cooked through (pull at 160°F).", "Remove chicken, set aside.", "In same pan, add blended cottage cheese, sun-dried tomatoes, and parmesan. Stir until creamy and warmed through.", "Add spinach, stir until just wilted. Return chicken to the pan, coat in sauce.", "Top with fresh basil and serve."],
        tip: "The cottage cheese blends into a creamy 'Marry Me' sauce without heavy cream. Sun-dried tomatoes add a sweet-tangy depth and are packed with lycopene. One-pan, 30 minutes, restaurant-quality.", portions: ["48g protein", "510 cal", "4g fiber", "30 min"]
    },
    { name: "Chicken Piccata", type: "Dinner", portion: "46g protein - 480 cal", color: "#a3b899",
        ingredients: ["6 oz chicken breast, pounded thin", "2 tbsp whole wheat flour", "1 tbsp olive oil", "1 tbsp butter", "1/4 cup chicken broth", "2 tbsp lemon juice", "2 tbsp capers, drained", "1 clove garlic, minced", "Fresh parsley", "1/2 cup cooked farro or brown rice"],
        steps: ["Pound chicken to even 1/2-inch thickness. Season with salt and pepper, dust lightly with flour.", "Heat olive oil in skillet over medium-high. Sear chicken 3-4 min per side until golden. Remove.", "In same pan, add butter + garlic (30 sec), then broth + lemon juice + capers. Simmer 2 min, scraping up brown bits.", "Return chicken to pan, spoon sauce over. Garnish with parsley.", "Serve over farro or rice."],
        tip: "The lemon-caper sauce is bright and anti-inflammatory. Pounding chicken thin ensures even cooking so it stays juicy. Classic Italian comfort in under 25 minutes.", portions: ["46g protein", "480 cal", "3g fiber", "25 min"]
    },
    { name: "Mediterranean Sheet Pan Chicken", type: "Dinner", portion: "46g protein - 490 cal", color: "#a3b899",
        ingredients: ["6 oz chicken breast", "1 cup broccoli florets", "1/2 cup roasted red pepper strips", "1/4 red onion, sliced", "1/4 cup sun-dried tomatoes", "2 tbsp olive oil", "1 tsp oregano", "1/2 tsp garlic powder", "Squeeze of lemon", "2 tbsp crumbled feta", "Salt, pepper"],
        steps: ["Preheat 425°F. Toss chicken and all veggies with olive oil, oregano, garlic powder, salt, pepper on a sheet pan.", "Spread in single layer — don't crowd the pan.", "Roast 20-25 min until chicken reaches 160°F and veggies are charred.", "Remove, squeeze lemon over everything, scatter feta and sun-dried tomatoes.", "Let chicken rest 5 min before slicing."],
        tip: "One pan, zero cleanup. The high heat chars the broccoli and peppers beautifully. Sun-dried tomatoes add concentrated lycopene. Broccoli is a cruciferous cancer-fighter. This is Mediterranean eating at its simplest.", portions: ["46g protein", "490 cal", "5g fiber", "30 min"]
    },
    { name: "Honey Garlic Chicken & Broccoli", type: "Dinner", portion: "46g protein - 500 cal", color: "#a3b899",
        ingredients: ["6 oz chicken breast, cubed", "2 cups broccoli florets", "3 cloves garlic, minced", "2 tbsp honey", "2 tbsp low-sodium soy sauce", "1 tsp cornstarch + 1 tbsp water (slurry)", "1 tbsp olive oil", "1/2 cup cooked brown rice or quinoa", "Sesame seeds", "Red pepper flakes"],
        steps: ["Heat olive oil in skillet over medium-high. Add chicken, cook 6-8 min until golden.", "Add broccoli, stir-fry 3-4 min until bright green.", "Mix soy sauce, honey, garlic, and cornstarch slurry. Pour into pan.", "Stir 2 min until sauce thickens and coats everything.", "Serve over rice or quinoa. Top with sesame seeds and red pepper flakes."],
        tip: "Better than takeout and ready in 20 minutes. Broccoli is one of the best anti-cancer vegetables. The honey-garlic sauce caramelizes beautifully without excess sugar.", portions: ["46g protein", "500 cal", "4g fiber", "20 min"]
    },
    { name: "Turkey Kofta with Tzatziki", type: "Dinner", portion: "44g protein - 470 cal", color: "#a3b899",
        ingredients: ["6 oz ground turkey (93% lean)", "1/4 cup diced onion", "2 cloves garlic, minced", "1 tsp cumin", "1/2 tsp coriander", "2 tbsp fresh parsley, chopped", "Salt, pepper", "--- TZATZIKI ---", "1/4 cup Greek yogurt", "2 tbsp grated cucumber", "1 tsp lemon juice", "1 small clove garlic, pressed", "Pinch of dill", "--- SERVE WITH ---", "1/2 cup cooked farro or rice", "Sliced cucumber + roasted red peppers"],
        steps: ["Mix turkey with onion, garlic, cumin, coriander, parsley, salt, pepper. Form into small oval patties.", "Grill or pan-sear 4-5 min per side until cooked through.", "Make tzatziki: mix yogurt, cucumber, lemon, garlic, dill.", "Serve kofta over farro with tzatziki, fresh cucumber, and roasted red peppers."],
        tip: "Mediterranean-inspired turkey meatballs with incredible spicing. Cumin and coriander are both anti-inflammatory. The yogurt-based tzatziki adds probiotics and creaminess without heavy sauces.", portions: ["44g protein", "470 cal", "4g fiber", "25 min"]
    },
    { name: "Crispy Chickpea & Quinoa Tzatziki Bowl", type: "Lunch", portion: "38g protein - 460 cal", color: "#a3b899",
        ingredients: ["1/2 cup canned chickpeas, drained and patted dry", "1/2 cup cooked quinoa", "4 oz prepped chicken (optional — omit for vegetarian)", "1/4 cucumber, diced", "Roasted red pepper strips", "2 tbsp red onion, diced", "2 tbsp crumbled feta", "1 tbsp olive oil", "1/2 tsp smoked paprika", "1/2 tsp garlic powder", "--- TZATZIKI ---", "3 tbsp Greek yogurt", "1 tsp lemon juice", "1 small clove garlic", "Pinch of dill"],
        steps: ["Crispy chickpeas: toss drained chickpeas with olive oil, paprika, garlic powder, salt. Roast 400°F 20 min (or air fry 10 min) until crunchy.", "Bowl: quinoa base, chicken if using, cucumber, tomatoes, red onion, feta.", "Top with crispy chickpeas and a generous drizzle of tzatziki."],
        tip: "The crispy chickpeas add incredible crunch and plant-based protein + fiber. Works great as a meatless Monday lunch without the chicken. Quinoa is a complete protein grain.", portions: ["38g protein", "460 cal", "8g fiber", "25 min"]
    },
    { name: "Mediterranean Tuna & White Bean Salad", type: "Lunch", portion: "36g protein - 400 cal", color: "#a3b899",
        ingredients: ["1 can (5 oz) tuna in olive oil, drained", "1/2 cup canned white beans (cannellini), drained", "1 cup arugula or mixed greens", "1/4 cup roasted red peppers, sliced", "2 tbsp red onion, thinly sliced", "1 tbsp capers", "1 tbsp olive oil", "1 tbsp lemon juice", "1/2 tsp dried oregano", "Salt, pepper", "1 hard-boiled egg, halved"],
        steps: ["In a large bowl, combine arugula, white beans, roasted red peppers, red onion, and capers.", "Flake tuna over the top. Add halved egg.", "Whisk olive oil, lemon juice, oregano, salt, pepper. Drizzle over salad.", "Toss gently and serve immediately."],
        tip: "Zero cooking required. Tuna and eggs provide omega-3s for brain and heart health. White beans add fiber and plant protein. Capers are surprisingly rich in antioxidants. Perfect light lunch.", portions: ["36g protein", "400 cal", "6g fiber", "10 min"]
    },
    { name: "Cottage Cheese Baked Oats", type: "Breakfast", portion: "36g protein - 390 cal", color: "#a3b899",
        ingredients: ["1/2 cup rolled oats, blended into flour", "1/2 cup cottage cheese", "1 egg", "1 scoop whey protein", "1/4 cup almond milk", "1/2 tsp baking powder", "1/2 tsp cinnamon", "1/2 tsp vanilla", "1 tsp honey", "--- TOPPINGS ---", "1/4 cup raspberries or blueberries", "1 tbsp walnuts, chopped", "Drizzle of nut butter"],
        steps: ["Preheat 350°F. Blend oats into flour.", "Mix oat flour, cottage cheese, egg, protein powder, almond milk, baking powder, cinnamon, vanilla, honey until smooth.", "Pour into a greased oven-safe ramekin or small baking dish.", "Top with berries. Bake 25 min until golden and set.", "Drizzle with nut butter and walnuts."],
        tip: "Tastes like cake for breakfast. The cottage cheese makes it incredibly moist and adds 14g protein on its own. Meal-prep friendly — make 4 on Sunday, reheat all week. Berries add antioxidants.", portions: ["36g protein", "390 cal", "5g fiber", "30 min"]
    },
    { name: "Savory Egg & Veggie Breakfast Scramble", type: "Breakfast", portion: "35g protein - 370 cal", color: "#a3b899",
        ingredients: ["3 eggs (or 2 whole + 2 whites)", "1 cup baby spinach", "1/4 cup diced bell pepper", "1/4 cup diced onion", "2 tbsp crumbled feta", "1 tsp olive oil", "Salt, pepper, garlic powder", "Hot sauce", "1 slice whole grain toast (optional)"],
        steps: ["Heat olive oil in a nonstick skillet over medium heat.", "Sauté bell pepper and onion 2-3 min until softened.", "Add spinach, stir until just wilted (30 sec).", "Pour in beaten eggs seasoned with salt, pepper, garlic powder.", "Scramble gently until just set — don't overcook.", "Top with feta and hot sauce. Serve with toast if desired."],
        tip: "Classic protein-packed breakfast in 10 minutes. Spinach and bell peppers add vitamin C and folate. Feta makes it feel special. Great for mornings when you want something savory and fast.", portions: ["35g protein", "370 cal", "3g fiber", "10 min"]
    },
    { name: "Cottage Cheese Cookie Dough Bark", type: "Dessert", portion: "16g protein - 180 cal", color: "#c4a882",
        ingredients: ["1 cup cottage cheese, blended smooth", "2 tbsp almond butter", "1 tbsp honey", "1/2 tsp vanilla", "2 tbsp mini dark chocolate chips", "1 tbsp chopped walnuts"],
        steps: ["Blend cottage cheese until completely smooth (no lumps).", "Stir in almond butter, honey, and vanilla.", "Spread onto parchment-lined plate or small sheet pan.", "Sprinkle chocolate chips and walnuts on top, press gently.", "Freeze 2+ hours until solid. Break into bark pieces."],
        tip: "Viral dessert that tastes like frozen cookie dough but packs 16g protein. Dark chocolate chips add antioxidants. Keep in the freezer for whenever sweet cravings hit.", portions: ["16g protein", "180 cal", "2g fiber", "5 min + freeze"]
    },
    { name: "Chocolate Cottage Cheese Pudding", type: "Dessert", portion: "20g protein - 170 cal", color: "#c4a882",
        ingredients: ["1 cup cottage cheese", "2 tbsp unsweetened cocoa powder", "1 tbsp honey or maple syrup", "1/2 tsp vanilla", "Pinch of salt", "--- OPTIONAL TOPPINGS ---", "Pomegranate seeds", "Dark chocolate shavings", "Fresh berries"],
        steps: ["Add cottage cheese, cocoa powder, honey, vanilla, and salt to a blender or food processor.", "Blend until completely smooth and creamy (2-3 min).", "Transfer to a serving bowl or jar. Refrigerate at least 1 hour for best texture.", "Top with pomegranate seeds, chocolate shavings, or berries."],
        tip: "Tastes like chocolate cheesecake mousse with 20g protein and under 170 cal. Make a batch of 4 jars on prep day for the week. The cocoa is rich in flavanoids — heart-healthy antioxidants.", portions: ["20g protein", "170 cal", "3g fiber", "5 min + chill"]
    },
    { name: "Protein Brownie Bites", type: "Dessert", portion: "12g protein - 160 cal", color: "#c4a882",
        ingredients: ["1/2 cup canned black beans, rinsed well", "2 tbsp cocoa powder", "1 scoop chocolate whey protein", "1 egg", "2 tbsp honey", "1/4 tsp baking powder", "Pinch of salt", "1 tbsp mini dark chocolate chips"],
        steps: ["Preheat 350°F. Blend black beans, cocoa, protein powder, egg, honey, baking powder, and salt until smooth.", "Fold in chocolate chips.", "Pour into a greased mini muffin tin (makes 6-8 bites).", "Bake 12-15 min until set. Don't overbake — they firm up as they cool.", "Let cool completely before removing."],
        tip: "You genuinely cannot taste the black beans. They create an incredibly fudgy texture while adding fiber and plant protein. Each bite is like a mini brownie with 12g protein. Freezer-friendly — make a batch and thaw as needed.", portions: ["12g protein", "160 cal", "4g fiber", "20 min"]
    },
    { name: "Egg Roll in a Bowl", type: "Lunch", portion: "40g protein - 420 cal", color: "#a3b899",
        ingredients: ["6 oz ground chicken or turkey", "2 cups coleslaw mix (shredded cabbage + carrots)", "2 cloves garlic, minced", "1 tbsp fresh ginger, grated", "2 tbsp low-sodium soy sauce", "1 tbsp sesame oil", "1 tsp sriracha", "Green onions, sliced", "Sesame seeds"],
        steps: ["Heat sesame oil in a large skillet over medium-high. Brown ground meat 5-6 min, breaking into small pieces.", "Add garlic and ginger, cook 30 sec until fragrant.", "Add coleslaw mix, stir-fry 3-4 min until cabbage is wilted but still has some crunch.", "Pour soy sauce and sriracha over everything, toss to coat.", "Top with green onions and sesame seeds. Eat as-is or over rice."],
        tip: "10 minutes, one pan, zero leftovers. The cabbage is incredibly filling for almost no calories, so the protein ratio is insane. Great for meal prep — holds up 3-4 days in the fridge.", portions: ["40g protein", "420 cal", "5g fiber", "10 min"]
    },
    { name: "Chicken Caesar Wrap", type: "Lunch", portion: "42g protein - 450 cal", color: "#a3b899",
        ingredients: ["5-6 oz prepped chicken, sliced or shredded", "1 large whole wheat tortilla", "1 cup chopped romaine", "2 tbsp Caesar dressing (Greek yogurt-based)", "1 tbsp shaved parmesan", "Squeeze of lemon", "Black pepper", "--- YOGURT CAESAR ---", "3 tbsp Greek yogurt", "1 tsp Dijon mustard", "1 tsp lemon juice", "1 small clove garlic, pressed", "1 tbsp parmesan", "Dash of Worcestershire"],
        steps: ["Make yogurt Caesar: whisk Greek yogurt, Dijon, lemon, garlic, parmesan, Worcestershire.", "Lay tortilla flat. Spread Caesar dressing, layer romaine, chicken, shaved parm.", "Roll tightly, cut in half on the diagonal."],
        tip: "The yogurt-based Caesar dressing has way more protein than store-bought and tastes incredible. Uses prepped chicken from any session. Make the dressing Sunday and it keeps all week. The easiest grab-and-go lunch.", portions: ["42g protein", "450 cal", "3g fiber", "5 min"]
    },
    { name: "Creamy Chicken & Rice (One Pot)", type: "Lunch", portion: "46g protein - 510 cal", color: "#a3b899",
        ingredients: ["6 oz chicken breast, diced", "3/4 cup white or brown rice", "1.5 cups chicken broth", "1/4 cup cottage cheese, blended smooth", "1/2 cup frozen peas or broccoli", "2 cloves garlic, minced", "1 tbsp butter", "1/2 tsp onion powder", "Salt, pepper", "Fresh parsley"],
        steps: ["Melt butter in oven-safe pot. Sear diced chicken 3-4 min, remove.", "Sauté garlic 30 sec, add rice, stir to coat. Pour in broth.", "Cover and bake at 375°F for 25 min (or simmer stovetop 18 min).", "Stir in blended cottage cheese, frozen veggies, and chicken. Cover 5 more min.", "Fluff, season, top with parsley."],
        tip: "Creamy comfort food with 46g protein thanks to the cottage cheese hack. One pot, minimal cleanup. Makes excellent meal prep — portion into 4 containers and reheat all week. The cottage cheese melts into a creamy sauce.", portions: ["46g protein", "510 cal", "3g fiber", "35 min"]
    },
    { name: "Spicy Southwest Chicken Bowl", type: "Lunch", portion: "43g protein - 480 cal", color: "#a3b899",
        ingredients: ["5-6 oz prepped chicken, diced", "1/2 cup cooked rice", "1/4 cup black beans", "1/4 cup corn", "2 tbsp Greek yogurt (as sour cream)", "1 tbsp hot sauce or salsa", "1/2 tsp chili powder", "1/2 tsp cumin", "Squeeze of lime", "Shredded cheese"],
        steps: ["Warm chicken with chili powder and cumin in a skillet or microwave.", "Bowl: rice, beans, corn, spiced chicken.", "Top with Greek yogurt, hot sauce, cheese, lime squeeze."],
        tip: "Uses prepped chicken — just re-spice and warm. Swap Greek yogurt for sour cream to sneak in more protein. Beans + rice = complete protein even without the chicken. 5 minutes from fridge to table.", portions: ["43g protein", "480 cal", "6g fiber", "5 min"]
    },
    { name: "Breakfast Burritos (Freezer-Friendly)", type: "Breakfast", portion: "32g protein - 410 cal", color: "#a3b899",
        ingredients: ["3 eggs, scrambled", "2 oz chicken sausage or turkey sausage, diced", "1/4 cup sautéed spinach", "1/4 cup sautéed onion + bell pepper", "2 tbsp shredded cheese", "2 large whole wheat tortillas", "Hot sauce"],
        steps: ["Cook sausage in skillet 3-4 min. Add onion + peppers, cook 2 min. Add spinach, wilt.", "Scramble eggs in same pan with the veggies and sausage.", "Divide between 2 tortillas, add cheese and hot sauce.", "Roll tightly burrito-style. Wrap each in foil for freezer.", "FREEZE: Up to 3 months. REHEAT: Remove foil, wrap in damp paper towel, microwave 2 min, flip, 1 more min."],
        tip: "Make a batch of 6-8 on prep day and freeze. The ultimate grab-and-go savory breakfast. Chicken sausage keeps it lean while adding tons of flavor. Way better than anything frozen from the store.", portions: ["32g protein", "410 cal", "4g fiber", "15 min"]
    },
    { name: "Sweet Potato Breakfast Hash", type: "Breakfast", portion: "34g protein - 400 cal", color: "#a3b899",
        ingredients: ["1 small sweet potato, diced small (1/2 inch)", "2 oz chicken sausage, sliced", "1/4 cup diced onion", "1 cup baby spinach", "2 eggs", "1 tbsp olive oil", "1/2 tsp smoked paprika", "1/2 tsp garlic powder", "Salt, pepper, hot sauce"],
        steps: ["Heat olive oil in cast iron or skillet over medium. Add sweet potato, season with paprika + garlic powder. Cook 8-10 min, stirring occasionally, until fork-tender and crispy.", "Push potatoes to sides, add sausage and onion to center. Cook 3 min.", "Add spinach, stir until wilted.", "Make 2 wells, crack eggs into them. Cover pan, cook 3-4 min until whites are set.", "Hit with hot sauce and serve straight from the pan."],
        tip: "Savory, spicy, satisfying — the sweet potato gets crispy edges while staying soft inside. The eggs cook right in the hash so it's truly one-pan. Meal prep the hash base, then just crack fresh eggs in the morning.", portions: ["34g protein", "400 cal", "5g fiber", "20 min"]
    },
    { name: "Spicy Sausage & Spinach Frittata", type: "Breakfast", portion: "36g protein - 380 cal", color: "#a3b899",
        ingredients: ["6 eggs + 2 egg whites", "3 oz chicken sausage (spicy Italian or similar), diced", "1 cup baby spinach", "1/4 cup diced onion", "2 tbsp crumbled feta", "1/4 tsp garlic powder", "1/4 tsp red pepper flakes", "Salt, pepper", "1 tsp olive oil"],
        steps: ["Preheat oven to 375°F. Heat olive oil in an oven-safe skillet over medium.", "Cook sausage + onion 3-4 min. Add spinach, stir until wilted.", "Whisk eggs + whites with garlic powder, red pepper flakes, salt, pepper. Pour into skillet over veggies.", "Sprinkle feta on top. Cook stovetop 2 min until edges begin to set.", "Transfer to oven, bake 12-15 min until center is just set.", "Let cool 5 min, slice into 4 wedges."],
        tip: "Makes 4 servings — meal prep the whole thing on Sunday and slice a wedge each morning. Reheats perfectly in the microwave (1 min) or oven (5 min at 350°F). The feta melts into little pockets of salty creaminess. Spicy sausage + red pepper flakes = morning heat.", portions: ["36g protein", "380 cal", "1g fiber", "25 min"]
    },
    { name: "Cajun Chicken Pasta", type: "Dinner", portion: "46g protein - 520 cal", color: "#a3b899",
        ingredients: ["6 oz chicken breast, sliced thin", "4 oz protein pasta or whole wheat penne", "1 cup baby spinach", "1/3 cup cottage cheese, blended smooth", "2 tbsp parmesan", "2 cloves garlic, minced", "1 tbsp olive oil", "--- CAJUN SPICE ---", "1 tsp smoked paprika", "1/2 tsp garlic powder", "1/2 tsp onion powder", "1/4 tsp cayenne", "1/2 tsp oregano", "Salt, pepper"],
        steps: ["Cook pasta per package, reserve 1/2 cup pasta water. Drain.", "Season chicken with cajun spice mix. Heat olive oil in skillet over medium-high, sear chicken 3-4 min per side. Remove, slice.", "In same pan, sauté garlic 30 sec. Add blended cottage cheese, parmesan, and a splash of pasta water. Stir into a creamy sauce.", "Add spinach, stir until wilted. Toss in pasta and chicken, coat everything in sauce.", "Add more pasta water if needed for consistency. Serve immediately."],
        tip: "The cottage cheese becomes an insanely creamy cajun alfredo without the guilt. One pan after the pasta. The cajun spice blend has capsaicin (cayenne) which is anti-inflammatory and thermogenic. Hits that spicy comfort food craving.", portions: ["46g protein", "520 cal", "4g fiber", "25 min"]
    },
    { name: "Lemon Garlic Butter Chicken Pasta", type: "Dinner", portion: "44g protein - 500 cal", color: "#a3b899",
        ingredients: ["6 oz chicken breast, pounded thin", "4 oz whole wheat spaghetti or linguine", "1 cup broccolini or broccoli florets", "3 cloves garlic, minced", "1.5 tbsp butter", "Juice of 1 lemon", "1/4 cup chicken broth", "2 tbsp parmesan", "Red pepper flakes", "Fresh parsley", "Salt, pepper"],
        steps: ["Cook pasta per package, adding broccolini last 3 min. Reserve 1/2 cup pasta water, drain.", "Season chicken with salt and pepper. Heat 1/2 tbsp butter in skillet, sear 3-4 min per side. Remove, rest, slice.", "Same pan: add remaining butter + garlic, cook 30 sec. Add lemon juice + broth, simmer 2 min, scraping up brown bits.", "Toss pasta + broccolini into the pan. Add parmesan, splash of pasta water, red pepper flakes. Toss to coat.", "Top with sliced chicken and fresh parsley."],
        tip: "Light, bright, and not cream-heavy — the lemon-garlic butter sauce is restaurant-quality with 5 ingredients. The broccolini cooks right with the pasta. Parmesan adds umami without heaviness. Under 30 min.", portions: ["44g protein", "500 cal", "5g fiber", "25 min"]
    },
    { name: "Spicy Sausage & Broccoli Orecchiette", type: "Dinner", portion: "42g protein - 490 cal", color: "#a3b899",
        ingredients: ["4 oz protein pasta or whole wheat orecchiette", "2 chicken sausage links (spicy Italian), sliced into coins", "2 cups broccoli florets", "3 cloves garlic, minced", "1/4 tsp red pepper flakes", "2 tbsp parmesan", "1 tbsp olive oil", "Squeeze of lemon", "Salt, pepper"],
        steps: ["Cook pasta per package, adding broccoli florets last 3 min. Reserve 1/2 cup starchy pasta water before draining.", "Heat olive oil in a large skillet over medium-high. Add sausage coins in a single layer — sear 2-3 min per side until crispy edges. Don't move them around.", "Push sausage to one side, add garlic + red pepper flakes to the oil, cook 30 sec until fragrant.", "Dump in drained pasta + broccoli, a big splash of pasta water, and parmesan. Toss vigorously — the starch + cheese creates a glossy sauce.", "Squeeze lemon over the top. Taste for salt. Extra chili flakes if you want more heat."],
        tip: "Classic Italian-American comfort — the sausage renders its own flavorful oil that coats the pasta. The key is getting those crispy edges on the sausage coins. Broccoli is a cruciferous cancer-fighter. Done in the time it takes to boil pasta.", portions: ["42g protein", "490 cal", "5g fiber", "20 min"]
    },
    { name: "Turkey Bolognese Baked Ziti", type: "Dinner", portion: "44g protein - 530 cal", color: "#a3b899",
        ingredients: ["6 oz ground turkey (93% lean)", "4 oz ziti or penne", "1 cup marinara sauce", "1/4 cup ricotta", "1/4 cup shredded mozzarella", "1 tbsp parmesan", "2 cloves garlic, minced", "1/2 tsp Italian seasoning", "1/4 tsp red pepper flakes", "1 cup baby spinach", "Salt, pepper"],
        steps: ["Cook pasta 2 min short of package time (it finishes in the oven). Drain.", "Brown turkey with garlic, Italian seasoning, red pepper flakes. Add marinara, simmer 5 min. Stir in spinach until wilted.", "Mix pasta into the sauce. Transfer to a baking dish.", "Dollop ricotta on top, scatter mozzarella and parmesan.", "Bake 375°F for 15-20 min until bubbly and golden. Let rest 5 min."],
        tip: "Meal prep queen. Make a big batch, portion into containers, reheat all week — it's actually better the next day. The turkey keeps it lean (44g protein!) while the three cheeses make it feel indulgent. Cooked marinara = maximum lycopene.", portions: ["44g protein", "530 cal", "4g fiber", "40 min"]
    },
    { name: "Creamy White Bean & Spinach Pasta", type: "Dinner", portion: "36g protein - 470 cal", color: "#a3b899",
        ingredients: ["4 oz whole wheat pasta (any shape)", "1/2 cup canned white beans (cannellini), drained", "2 cups baby spinach", "3 cloves garlic, minced", "2 tbsp parmesan", "1 tbsp olive oil", "1/4 cup pasta water", "1/4 tsp red pepper flakes", "Squeeze of lemon", "Salt, pepper", "Optional: 3 oz prepped chicken for extra protein"],
        steps: ["Cook pasta, reserve 1/2 cup pasta water, drain.", "In a blender, blend HALF the white beans with 1/4 cup pasta water until smooth. Leave remaining beans whole.", "Heat olive oil in skillet. Sauté garlic 30 sec, add red pepper flakes.", "Pour in blended bean sauce + whole beans. Stir 1 min.", "Add spinach, stir until wilted. Toss in pasta + parmesan + lemon.", "Add pasta water as needed for silky consistency."],
        tip: "The blended white beans become an incredibly silky, protein-rich sauce that coats the pasta beautifully — no cream or cheese needed (though the parmesan helps). Plant protein + fiber bomb. Add chicken to hit 46g+ protein.", portions: ["36g protein", "470 cal", "8g fiber", "20 min"]
    },
    { name: "One-Pot Chicken Pesto Orzo", type: "Dinner", portion: "44g protein - 510 cal", color: "#a3b899",
        ingredients: ["6 oz chicken breast, diced", "3/4 cup orzo", "2 cups chicken broth", "2 tbsp basil walnut pesto", "1 cup baby spinach", "2 tbsp crumbled feta", "1 tbsp olive oil", "2 cloves garlic, minced", "Squeeze of lemon", "Red pepper flakes", "Salt, pepper"],
        steps: ["Heat olive oil in a deep skillet or pot over medium-high. Season chicken, sear 4-5 min. Remove.", "Sauté garlic 30 sec. Add orzo, stir to toast 1 min.", "Pour in broth, bring to a boil. Reduce heat, cover, simmer 10 min until orzo absorbs most liquid.", "Stir in pesto, spinach, and chicken. Cook 2 more min until spinach wilts.", "Top with feta, lemon squeeze, and red pepper flakes."],
        tip: "One pot, zero straining, all flavor. The orzo absorbs the pesto-chicken broth and gets incredibly creamy. Walnut pesto provides omega-3s. The feta melts into little salty pockets. This one converts pesto skeptics.", portions: ["44g protein", "510 cal", "3g fiber", "25 min"]
    },
    { name: "Crock Pot White Chicken Chili", type: "Dinner", portion: "46g protein - 480 cal", color: "#a3b899",
        ingredients: ["1.5 lbs chicken breast", "1 can (15 oz) white beans (cannellini or great northern), drained", "1 can (4 oz) diced green chiles", "1 cup chicken broth", "1/2 onion, diced", "3 cloves garlic, minced", "1 tsp cumin", "1/2 tsp coriander", "1/2 tsp chili powder", "1/4 tsp cayenne", "Juice of 1 lime", "Salt, pepper", "--- TOPPINGS ---", "Greek yogurt (as sour cream)", "Shredded cheese", "Hot sauce", "Green onions"],
        steps: ["Add chicken, beans, green chiles, broth, onion, garlic, cumin, coriander, chili powder, cayenne, salt, pepper to crock pot.", "Cook LOW 6-8 hours or HIGH 3-4 hours.", "Remove chicken, shred with two forks. Return to pot, stir.", "Add lime juice, taste and adjust seasoning.", "Serve topped with Greek yogurt, cheese, hot sauce, green onions."],
        tip: "Set it and forget it — 5 min of prep for 4-6 servings. The green chiles give it a smoky heat without raw tomatoes. Shred the chicken right in the pot. Freezes beautifully for up to 3 months. Greek yogurt topping adds extra protein.", portions: ["46g protein", "480 cal", "8g fiber", "6-8 hrs crock"]
    },
    { name: "Crock Pot Honey Garlic Chicken", type: "Dinner", portion: "48g protein - 460 cal", color: "#a3b899",
        ingredients: ["1.5 lbs chicken breast or thighs", "1/3 cup honey", "1/4 cup low-sodium soy sauce", "3 tbsp ketchup", "4 cloves garlic, minced", "1 tbsp sesame oil", "1 tsp sriracha", "1 tbsp cornstarch + 2 tbsp water (slurry)", "Sesame seeds", "Green onions", "--- SERVE WITH ---", "Steamed rice", "Steamed broccoli"],
        steps: ["Whisk honey, soy sauce, ketchup, garlic, sesame oil, sriracha in crock pot.", "Add chicken, coat in sauce.", "Cook LOW 4-6 hours or HIGH 2-3 hours.", "Remove chicken. Whisk cornstarch slurry into sauce, cook HIGH 10 min to thicken.", "Shred or slice chicken, return to thickened sauce, toss to coat.", "Serve over rice with broccoli. Top with sesame seeds and green onions."],
        tip: "The sauce caramelizes into a sticky, glossy glaze that rivals any takeout. The ketchup isn't weird — it adds tomato sweetness without chunks. Chicken thighs stay incredibly juicy in the crock pot but breasts work too. Makes amazing meal prep bowls.", portions: ["48g protein", "460 cal", "1g fiber", "4-6 hrs crock"]
    },
    { name: "Crock Pot Chicken Cacciatore", type: "Dinner", portion: "46g protein - 470 cal", color: "#a3b899",
        ingredients: ["1.5 lbs chicken thighs (boneless, skinless)", "1.5 cups marinara sauce", "1 bell pepper, sliced", "1/2 onion, sliced", "3 cloves garlic, minced", "1 tsp Italian seasoning", "1/2 tsp smoked paprika", "1/4 tsp red pepper flakes", "1 tbsp balsamic vinegar", "Fresh basil", "Salt, pepper", "--- SERVE OVER ---", "Pasta, farro, or crusty bread"],
        steps: ["Layer sliced onion and bell pepper in bottom of crock pot.", "Season chicken with Italian seasoning, paprika, red pepper flakes, salt, pepper. Place on top of veggies.", "Mix marinara with garlic and balsamic vinegar, pour over everything.", "Cook LOW 6-8 hours or HIGH 3-4 hours.", "Chicken will be fall-apart tender. Shred or serve whole.", "Serve over pasta or farro, topped with fresh basil."],
        tip: "Italian hunter's stew — the chicken slow-cooks in marinara until it practically melts. The balsamic vinegar adds depth. Bell peppers break down into the sauce (not chunky). Cooked marinara = maximum lycopene. This is comfort food at its finest.", portions: ["46g protein", "470 cal", "4g fiber", "6-8 hrs crock"]
    },
    { name: "Crock Pot Lemon Herb Chicken & White Beans", type: "Dinner", portion: "48g protein - 440 cal", color: "#a3b899",
        ingredients: ["1.5 lbs chicken breast", "1 can (15 oz) white beans (cannellini), drained", "2 cups chicken broth", "3 cups baby spinach", "Juice of 2 lemons", "4 cloves garlic, smashed", "2 sprigs fresh rosemary (or 1 tsp dried)", "1 tsp dried oregano", "1 tbsp olive oil", "Salt, pepper", "Red pepper flakes", "Parmesan rind (optional, for extra umami)"],
        steps: ["Add chicken, white beans, broth, lemon juice, garlic, rosemary, oregano, olive oil, salt, pepper to crock pot. Add parmesan rind if using.", "Cook LOW 6-8 hours or HIGH 3-4 hours.", "Remove chicken, shred with two forks.", "Stir spinach into the hot broth until wilted. Return shredded chicken.", "Remove parmesan rind and rosemary sprigs.", "Ladle into bowls. Drizzle olive oil, red pepper flakes."],
        tip: "Brothy, lemony, and incredibly soothing. The white beans break down slightly and thicken the broth. The parmesan rind trick adds incredible umami — don't skip it if you have one. Anti-inflammatory powerhouse: lemon, garlic, rosemary, spinach, beans.", portions: ["48g protein", "440 cal", "7g fiber", "6-8 hrs crock"]
    },
    { name: "Crock Pot Spicy Turkey Taco Bowls", type: "Dinner", portion: "44g protein - 490 cal", color: "#a3b899",
        ingredients: ["1.5 lbs ground turkey (93% lean)", "1 can (15 oz) black beans, drained", "1 cup corn (frozen)", "1 cup chicken broth", "1 tbsp chili powder", "1 tsp cumin", "1/2 tsp smoked paprika", "1/2 tsp garlic powder", "1/4 tsp cayenne", "Salt, pepper", "Juice of 1 lime", "--- TOPPINGS ---", "Rice", "Greek yogurt", "Shredded cheese", "Hot sauce", "Green onions"],
        steps: ["Add turkey, black beans, corn, broth, and all spices to crock pot. Break turkey into chunks.", "Cook LOW 6-8 hours or HIGH 3-4 hours. Stir halfway to break up turkey if possible.", "Add lime juice, stir well, taste and adjust seasoning.", "Serve over rice with Greek yogurt, cheese, hot sauce, green onions."],
        tip: "The turkey absorbs all that chili-cumin flavor over hours of slow cooking. Black beans + turkey = double protein punch. Make a huge batch — it freezes perfectly and reheats for quick taco bowl lunches all week. The cayenne builds heat slowly.", portions: ["44g protein", "490 cal", "9g fiber", "6-8 hrs crock"]
    }
];

const mealData = {
    kasey: {
        goals: { protein: "140-165g", calories: "1,500-1,700" },
        days: [
            {
                day: 1, theme: "Bolognese Night", protein: "137g", calories: "1,520", prep: "PREP DAY — Prep Session 1 + Grocery Run 1 (covers Week 1)",
                meals: [
                    { type: "Breakfast", icon: "🌅", name: "Cacao Berry Smoothie Bowl", portion: "40g protein - 320 cal", color: "#a3b899",
                        ingredients: ["1 cup unsweetened almond milk", "1.5 tbsp cacao powder (NOT Dutch-processed)", "~1/2 scoop Vital Proteins chocolate collagen (~12g)", "5g L-glutamine", "1 tsp Nature's Way MCT oil", "1 scoop ON Gold Standard Banana Cream whey", "1/2 cup frozen blueberries", "1/2 cup nonfat Greek yogurt", "--- TOPPINGS ---", "2 tbsp walnuts, chopped", "1 tbsp ground flaxseed", "1 tsp honey"],
                        steps: ["Blend almond milk, cacao, collagen, L-glutamine, MCT oil, whey, blueberries, and yogurt until thick.", "Pour into bowl.", "Top with walnuts, flaxseed, honey drizzle."],
                        tip: "Prep day fuel! Blend this up first thing — full supplement stack to power through your big cook. Frozen blueberries from the freezer, no fresh produce needed.",
                        portions: ["42g protein", "420 cal", "8g fiber", "5 min"]
                    },
                    { type: "Lunch", icon: "☀️", name: "Chipotle Chicken Wrap", portion: "40g protein - 360 cal", color: "#a3b899",
                        ingredients: ["4 oz shredded chicken (from prep)", "1 Mission Carb Balance tortilla", "1 tbsp chipotle in adobo, minced", "1/4 cup cooked brown rice", "2 tbsp Mexican blend shredded cheese", "2 tbsp salsa", "Squeeze of lime"],
                        steps: ["Warm tortilla in a dry pan or microwave 15 sec.", "Layer rice, chicken, chipotle, cheese, salsa.", "Squeeze lime over. Wrap and eat."],
                        tip: "Cook the chicken first thing during prep — by lunchtime you'll have smoky chipotle chicken ready to wrap. Capsaicin from chipotles is thermogenic and anti-inflammatory.",
                        portions: ["42g protein", "460 cal", "9g fiber", "5 min"]
                    },
                    { type: "Dinner", icon: "🌙", name: "Cauliflower Bolognese over Protein Spaghetti", portion: "43g protein - 400 cal", color: "#a3b899",
                        ingredients: ["9 oz ground turkey (93% lean)", "2 cups frozen riced cauliflower", "2 cups marinara sauce", "7 oz Kroger Protein Grain & Legume Spaghetti", "1/4 cup diced onion", "2 cloves garlic, minced", "1 tbsp olive oil", "2 tbsp shredded Parmesan", "Red pepper flakes", "1/2 tsp Italian seasoning", "Pinch of sugar (optional — cuts acidity)", "Salt, pepper"],
                        steps: ["Boil water for spaghetti. Cook protein pasta 1 min LESS than package says (it'll finish cooking in sauce).", "While pasta cooks: heat olive oil in a large skillet. Sauté onion 3 min until softened.", "Add garlic, cook 30 sec until fragrant.", "Add ground turkey, break into small crumbles. Cook 5-6 min until browned.", "Stir in riced cauliflower, cook 3 min until it softens and disappears into the meat.", "Pour in marinara. Add Italian seasoning, red pepper flakes, and optional pinch of sugar. Simmer 10 min.", "Drain pasta, toss directly into the sauce. Let it absorb for 1 min.", "Plate and top with Parmesan. Crack more black pepper on top.", "PLATE FOR TWO: Kasey = smaller portion (~4 oz turkey, 3 oz pasta). Charlie = larger portion (~5 oz turkey, 4 oz pasta). Eyeball roughly 40/60 split on the sauce and veggies."],
                        tip: "Cauliflower is cruciferous — ricing it into the sauce sneaks in cancer-fighting sulforaphane without anyone noticing. The protein spaghetti adds extra fiber. Cooked tomato sauce = maximum lycopene. The pinch of sugar is a restaurant trick to balance the acid.",
                        portions: ["45g protein", "530 cal", "10g fiber", "25 min"]
                    },
                    { type: "Dessert", icon: "🍨", name: "Yogurt Bark", portion: "14g protein - 140 cal", color: "#c4a882",
                        ingredients: ["1 cup nonfat Greek yogurt", "1 tsp honey", "1/2 tsp vanilla extract", "3/4 cup fresh berries (raspberries, blueberries, or mixed)", "1 tbsp mini dark chocolate chips", "1 tbsp crushed walnuts", "1 tsp chia seeds"],
                        steps: ["Grab from prep — already made and frozen during your prep session. Break off a piece and enjoy."],
                        tip: "Already prepped! Berries have the highest antioxidant content of any fruit — ellagic acid is a potent anti-cancer compound. Walnuts add omega-3s, chia adds fiber.",
                        portions: ["14g protein", "170 cal", "4g fiber", "5 min + freeze"]
                    }
                ]
            },
            {
                day: 2, theme: "Italian Comfort", protein: "137g", calories: "1,490",
                meals: [
                    { type: "Breakfast", icon: "🌅", name: "Kefir Berry Smoothie", portion: "33g protein - 280 cal", color: "#a3b899",
                        ingredients: ["1 cup Lifeway strawberry kefir", "1/2 cup frozen mixed berries", "~1/2 scoop Vital Proteins chocolate collagen (~12g)", "5g L-glutamine", "1 tsp Nature's Way MCT oil", "1/2 banana"],
                        steps: ["Add all ingredients to a blender.", "Blend until smooth, about 30 seconds.", "Pour and drink."],
                        tip: "Kefir has 12+ strains of probiotics vs yogurt's 2-3. This is a gut health powerhouse. The frozen berries make it thick like a milkshake.",
                        portions: ["35g protein", "380 cal", "4g fiber", "3 min"]
                    },
                    { type: "Lunch", icon: "☀️", name: "Lemony Chicken & Grain Bowl", portion: "40g protein - 380 cal", color: "#a3b899",
                        ingredients: ["5 oz grilled chicken (from prep)", "1/2 cup cooked farro or quinoa (from prep)", "1/4 cup chickpeas", "1/4 cup roasted red peppers (jarred)", "1 cup spinach", "1 tbsp olive oil", "Juice of 1/2 lemon", "Garlic powder, red pepper flakes"],
                        steps: ["Reheat chicken and grains.", "Toss spinach with olive oil and lemon juice to slightly wilt.", "Assemble bowl: grains, chicken, chickpeas, roasted red peppers, spinach.", "Sprinkle with garlic powder and red pepper flakes."],
                        tip: "Chickpeas provide folate for DNA repair. Roasted red peppers are loaded with vitamin C. The lemon-olive oil dressing is classic Mediterranean.",
                        portions: ["42g protein", "480 cal", "8g fiber", "3 min reheat"]
                    },
                    { type: "Dinner", icon: "🌙", name: "Turkey & Ricotta Stuffed Zucchini Boats", portion: "44g protein - 390 cal", color: "#a3b899",
                        ingredients: ["3 medium zucchini, halved lengthwise", "9 oz ground turkey (93% lean)", "1 cup ricotta cheese", "2 cups baby spinach, chopped", "2 cloves garlic, minced", "1/4 cup shredded Parmesan", "1 cup marinara sauce", "1 cup shredded mozzarella", "Italian seasoning, red pepper flakes", "1 tbsp olive oil"],
                        steps: ["Preheat oven to 375°F. Halve zucchini lengthwise and scoop out the centers with a spoon (save the scooped bits).", "Heat olive oil in a skillet. Brown ground turkey with garlic, breaking into small crumbles. Season with Italian seasoning and red pepper flakes.", "Chop the scooped zucchini centers and stir into the turkey along with spinach. Cook 1-2 min until spinach wilts.", "Remove from heat. Stir in ricotta and half the Parmesan.", "Fill each zucchini half with the turkey-ricotta mixture, packing it in.", "Spoon marinara over the top. Pile on mozzarella and remaining Parmesan.", "Bake 25-30 min until zucchini is tender and cheese is golden and bubbly.", "PLATE FOR TWO: Make 6 boat halves total. Kasey = 2 halves. Charlie = 3-4 halves. Extra sauce spooned over both."],
                        tip: "Use the fresh zucchini and ricotta tonight before they go bad. The turkey gives it substance and the scooped zucchini centers go right back into the filling so nothing is wasted. Marinara provides lycopene. This is serious comfort food.",
                        portions: ["46g protein", "520 cal", "5g fiber", "35 min"]
                    },
                    { type: "Dessert", icon: "🍨", name: "Chocolate Cottage Cheese Pudding", portion: "20g protein - 140 cal", color: "#c4a882",
                        ingredients: ["1/2 cup low-fat cottage cheese", "1.5 tbsp cacao powder (NOT Dutch-processed)", "1 tsp honey", "1/4 tsp vanilla extract", "Pinch of sea salt", "1 tbsp mini dark chocolate chips"],
                        steps: ["Blend cottage cheese, cacao, honey, vanilla, and salt until completely smooth (about 30 sec in blender or food processor).", "Scoop into a bowl. Top with chocolate chips.", "Eat immediately or chill 30 min for a firmer mousse texture."],
                        tip: "Tastes like chocolate mousse. 20g protein and under 170 cal. The salt makes the chocolate sing. Cacao flavanols are heart-healthy antioxidants.",
                        portions: ["20g protein", "170 cal", "3g fiber", "5 min"]
                    }
                ]
            },
            {
                day: 3, theme: "Stew Night", protein: "137g", calories: "1,510",
                meals: [
                    { type: "Breakfast", icon: "🌅", name: "Peach Cobbler Overnight Oats", portion: "36g protein - 310 cal", color: "#a3b899",
                        ingredients: ["1/2 cup rolled oats", "1 cup unsweetened almond milk", "~1/2 scoop Vital Proteins chocolate collagen (~12g)", "5g L-glutamine", "1 tsp Nature's Way MCT oil", "1 scoop ON Gold Standard Banana Cream whey", "1 tsp chia seeds", "1 tsp cinnamon", "1/4 tsp nutmeg", "--- MORNING TOPPINGS ---", "1/2 cup frozen peaches (move to fridge night before)", "1 tbsp chopped walnuts", "1 tsp honey drizzle"],
                        steps: ["Grab your jar from prep. Move frozen peaches to fridge the night before.", "Morning: top with thawed peaches (should be soft from overnight in fridge), walnuts, honey."],
                        tip: "Made during Prep Session 1 — just grab and add toppings. Full supplement stack with warm cinnamon-nutmeg spice. Peach antioxidants + walnut omega-3s.",
                        portions: ["38g protein", "410 cal", "6g fiber", "3 min + overnight"]
                    },
                    { type: "Lunch", icon: "☀️", name: "Chicken Burrito Bowl", portion: "41g protein - 380 cal", color: "#a3b899",
                        ingredients: ["5 oz grilled chicken (from prep)", "1/2 cup cooked brown rice", "1/2 cup black beans", "1/4 cup corn", "2 tbsp crumbled feta", "Squeeze of lime", "Hot sauce", "1 tbsp olive oil"],
                        steps: ["Reheat chicken, rice, beans, and corn.", "Assemble bowl. Top with feta and a big squeeze of lime.", "Hot sauce to taste."],
                        tip: "Feta + lime gives this a totally different vibe than the salsa-cheese version. Black beans and whole grain rice provide resistant starch that feeds anti-cancer gut bacteria.",
                        portions: ["43g protein", "480 cal", "9g fiber", "3 min reheat"]
                    },
                    { type: "Dinner", icon: "🌙", name: "Spicy Red Lentil & Cauliflower Stew + Chicken", portion: "46g protein - 380 cal", color: "#a3b899",
                        ingredients: ["9 oz grilled chicken breast (from prep)", "1 cup red lentils", "2 cups cauliflower florets", "1/2 cup diced carrots", "2 cups marinara sauce", "1/2 cup diced onion", "2 cloves garlic, minced", "Red pepper flakes, garlic powder, cumin", "1 tbsp olive oil", "Fresh parsley", "Squeeze of lemon"],
                        steps: ["Heat olive oil. Sauté onion and garlic 3 min.", "Add garlic powder, cumin, red pepper flakes. Cook 30 seconds.", "Add lentils, marinara, cauliflower, carrots, and 1.5 cups water.", "Simmer 20 min until lentils are soft and stew is thick.", "Serve topped with sliced chicken, parsley, and a squeeze of lemon.", "PLATE FOR TWO: Divide stew roughly 40/60 (Kasey/Charlie). Top Kasey's bowl with 4 oz sliced chicken, Charlie's with 5 oz. Squeeze lemon over both."],
                        tip: "Red lentils provide incredible fiber plus folate for DNA repair. Cauliflower is cruciferous (sulforaphane). Cooked tomato sauce maximizes lycopene. This is one of the most cancer-protective meals in the plan.",
                        portions: ["48g protein", "510 cal", "14g fiber", "30 min"]
                    },
                    { type: "Dessert", icon: "🍨", name: "Yogurt Bark", portion: "14g protein - 140 cal", color: "#c4a882",
                        ingredients: ["1 cup nonfat Greek yogurt", "1 tsp honey", "1/2 tsp vanilla extract", "3/4 cup fresh berries (raspberries, blueberries, or mixed)", "1 tbsp mini dark chocolate chips", "1 tbsp crushed walnuts", "1 tsp chia seeds"],
                        steps: ["Grab from prep — already made and frozen during your prep session. Break off a piece and enjoy."],
                        tip: "Already prepped! Berries have the highest antioxidant content of any fruit — ellagic acid is a potent anti-cancer compound. Walnuts add omega-3s, chia adds fiber.",
                        portions: ["14g protein", "170 cal", "4g fiber", "5 min + freeze"]
                    }
                ]
            },
            {
                day: 4, theme: "Enchilada Night", protein: "132g", calories: "1,460", prep: "PREP DAY — Prep Session 2 (mid-week refresh)",
                meals: [
                    { type: "Breakfast", icon: "🌅", name: "Protein Yogurt Parfait", portion: "28g protein - 250 cal", color: "#a3b899",
                        ingredients: ["1 cup Oikos Triple Zero vanilla Greek yogurt", "1/2 cup fresh strawberries, sliced", "2 tbsp walnuts, chopped", "1 tsp honey drizzle"],
                        steps: ["Scoop yogurt into a bowl.", "Top with fresh strawberries, walnuts, and honey."],
                        tip: "Use up those fresh strawberries! Ellagic acid in strawberries has been shown to suppress cancer cell growth. Yogurt probiotics support gut health.",
                        portions: ["30g protein", "350 cal", "3g fiber", "3 min"]
                    },
                    { type: "Lunch", icon: "☀️", name: "Chipotle Chicken Wrap", portion: "40g protein - 360 cal", color: "#a3b899",
                        ingredients: ["4 oz shredded chicken (from prep)", "1 Mission Carb Balance tortilla", "1 tbsp chipotle in adobo, minced", "1/4 cup cooked brown rice", "2 tbsp Mexican blend shredded cheese", "2 tbsp salsa", "Squeeze of lime"],
                        steps: ["Warm tortilla in a dry pan or microwave 15 sec.", "Layer rice, chicken, chipotle, cheese, salsa.", "Squeeze lime over. Wrap and eat."],
                        tip: "Same great wrap from prep — still delicious, still easy. The carb balance tortilla keeps this high-fiber and high-protein.",
                        portions: ["42g protein", "460 cal", "9g fiber", "5 min"]
                    },
                    { type: "Dinner", icon: "🌙", name: "Spicy Turkey Enchiladas", portion: "44g protein - 410 cal", color: "#a3b899",
                        ingredients: ["12 oz ground turkey (93% lean)", "1/4 cup diced onion", "2 cloves garlic, minced", "1 tsp cumin", "1 tsp chili powder", "Red pepper flakes", "6 Mission Carb Balance tortillas", "2 cups enchilada sauce", "1 cup Mexican blend shredded cheese", "2 tbsp sour cream", "Hot sauce"],
                        steps: ["Preheat oven to 375°F.", "Brown ground turkey with onion, garlic, cumin, chili powder, and red pepper flakes.", "Divide turkey mix between tortillas. Roll up and place seam-down in a baking dish.", "Pour enchilada sauce over. Top with cheese.", "Bake 20 min until bubbly and golden.", "Top with sour cream and hot sauce.", "PLATE FOR TWO: Kasey = 2-3 enchiladas. Charlie = 3-4 enchiladas. Split sour cream and hot sauce evenly."],
                        tip: "First day eating prepped food! Cumin and chili powder both have anti-inflammatory properties. The carb balance tortillas keep the fiber high. Make a couple extra for Charlie's portions.",
                        portions: ["46g protein", "540 cal", "8g fiber", "35 min"]
                    },
                    { type: "Dessert", icon: "🍨", name: "Chocolate Cottage Cheese Pudding", portion: "20g protein - 140 cal", color: "#c4a882",
                        ingredients: ["1/2 cup low-fat cottage cheese", "1.5 tbsp cacao powder (NOT Dutch-processed)", "1 tsp honey", "1/4 tsp vanilla extract", "Pinch of sea salt", "1 tbsp mini dark chocolate chips"],
                        steps: ["Blend cottage cheese, cacao, honey, vanilla, and salt until completely smooth (about 30 sec in blender or food processor).", "Scoop into a bowl. Top with chocolate chips.", "Eat immediately or chill 30 min for a firmer mousse texture."],
                        tip: "Tastes like chocolate mousse. 20g protein and under 170 cal. The salt makes the chocolate sing. Cacao flavanols are heart-healthy antioxidants.",
                        portions: ["20g protein", "170 cal", "3g fiber", "5 min"]
                    }
                ]
            },
            {
                day: 5, theme: "Comfort Alfredo", protein: "142g", calories: "1,550",
                meals: [
                    { type: "Breakfast", icon: "🌅", name: "Cacao-Berry Overnight Oats", portion: "42g protein - 330 cal", color: "#a3b899",
                        ingredients: ["1/2 cup rolled oats", "1 cup unsweetened almond milk", "1.5 tbsp cacao powder (NOT Dutch-processed)", "~1/2 scoop Vital Proteins chocolate collagen (~12g)", "5g L-glutamine", "1 tsp Nature's Way MCT oil", "1 scoop ON Gold Standard Banana Cream whey", "1 tsp chia seeds", "--- MORNING TOPPINGS ---", "1/2 cup frozen mixed berries (move to fridge night before)", "1 tbsp walnuts", "1 tsp honey"],
                        steps: ["Combine oats, almond milk, cacao, collagen, L-glutamine, MCT oil, whey, and chia seeds in a jar.", "Stir well. Refrigerate overnight.", "Top with thawed berries, walnuts, and honey before eating."],
                        tip: "Prepped — grab from fridge. Cacao oats are basically dessert for breakfast but with your full supplement stack built in.",
                        portions: ["44g protein", "430 cal", "10g fiber", "0 min"]
                    },
                    { type: "Lunch", icon: "☀️", name: "Chicken Fajita Bowl", portion: "42g protein - 390 cal", color: "#a3b899",
                        ingredients: ["K: 5 oz / C: 6.5 oz prepped chicken (from Session 2)", "1/2 cup cooked brown rice", "1/4 cup black beans", "1/3 bell pepper, sliced", "1/4 onion, sliced", "1 tsp fajita seasoning (cumin, chili, garlic, paprika)", "2 tbsp salsa", "1 tbsp sour cream", "Squeeze of lime", "Hot sauce"],
                        steps: ["Quick-sear sliced peppers and onions in a hot pan with fajita seasoning (2 min).", "Bowl: rice, prepped chicken (warm in microwave), fajita veggies.", "Top with beans, salsa, sour cream, lime."],
                        tip: "The charred peppers and onions take this from basic to restaurant-quality. Capsaicin from peppers is anti-inflammatory. Bell peppers have more vitamin C than oranges.",
                        portions: ["44g protein", "490 cal", "6g fiber", "10 min"]
                    },
                    { type: "Dinner", icon: "🌙", name: "Chicken Alfredo with Protein Pasta", portion: "44g protein - 390 cal", color: "#a3b899",
                        ingredients: ["12 oz chicken breast, butterflied or pounded thin", "7 oz Kroger Protein Grain & Legume Spaghetti", "2/3 cup alfredo sauce (light or regular)", "1 cup baby spinach", "2 cloves garlic, minced", "1 tbsp olive oil", "2 tbsp shredded Parmesan", "Red pepper flakes", "Salt, pepper", "Squeeze of lemon (brightens the cream)"],
                        steps: ["Cook protein pasta al dente. Reserve 1/4 cup pasta water before draining.", "Season chicken generously with salt and pepper. Heat olive oil in skillet over medium-high.", "Sear chicken 4-5 min per side until golden and cooked through. Remove, rest 5 min, then slice.", "In the same pan (keep the brown bits!), add garlic — cook 30 sec.", "Add alfredo sauce and a splash of pasta water. Stir to loosen the fond from the pan.", "Toss in spinach until just wilted. Add drained pasta and toss to coat.", "Plate pasta, lay chicken slices on top. Finish with Parmesan, red pepper flakes, and a squeeze of lemon.", "PLATE FOR TWO: Toss all pasta and spinach together in the sauce. Kasey = smaller bowl (~3 oz pasta, 5 oz chicken). Charlie = larger bowl (~4 oz pasta, 7 oz chicken). Parmesan on both."],
                        tip: "The brown bits from the chicken (fond) make the alfredo sauce taste way richer. The lemon squeeze at the end cuts through the cream and makes the whole dish brighter. Spinach sneaks in folate and iron.",
                        portions: ["46g protein", "520 cal", "6g fiber", "20 min"]
                    },
                    { type: "Dessert", icon: "🍨", name: "Yogurt Bark", portion: "14g protein - 140 cal", color: "#c4a882",
                        ingredients: ["1 cup nonfat Greek yogurt", "1 tsp honey", "1/2 tsp vanilla extract", "3/4 cup fresh berries (raspberries, blueberries, or mixed)", "1 tbsp mini dark chocolate chips", "1 tbsp crushed walnuts", "1 tsp chia seeds"],
                        steps: ["Grab from prep — already made and frozen during your prep session. Break off a piece and enjoy."],
                        tip: "Already prepped! Berries have the highest antioxidant content of any fruit — ellagic acid is a potent anti-cancer compound. Walnuts add omega-3s, chia adds fiber.",
                        portions: ["14g protein", "170 cal", "4g fiber", "5 min + freeze"]
                    }
                ]
            },
            {
                day: 6, theme: "Sweet Potato Spice", protein: "139g", calories: "1,470",
                meals: [
                    { type: "Breakfast", icon: "🌅", name: "Egg Muffin Cups + Morning Shake", portion: "36g protein - 280 cal", color: "#a3b899",
                        ingredients: ["--- MORNING BOOST SHAKE ---", "1 cup unsweetened almond milk", "1.5 tbsp cacao powder (NOT Dutch-processed)", "~1/2 scoop Vital Proteins chocolate collagen (~12g)", "5g L-glutamine", "1 tsp Nature's Way MCT oil", "--- EGG MUFFIN CUPS (x2) ---", "2 eggs (from batch)", "Spinach, onion, cheese (baked in)"],
                        steps: ["Blend shake ingredients and sip alongside breakfast.", "Reheat 2 egg muffin cups in microwave ~45 sec."],
                        tip: "Grab from freezer if you're into the second batch, or fridge if they're fresh from last prep. The shake gets your supplements in.",
                        portions: ["38g protein", "380 cal", "2g fiber", "2 min reheat"]
                    },
                    { type: "Lunch", icon: "☀️", name: "Greek Chicken & Hummus Bowl", portion: "41g protein - 370 cal", color: "#a3b899",
                        ingredients: ["K: 5 oz / C: 6.5 oz prepped chicken (from Session 2)", "1/2 cup cooked brown rice", "1/4 cup hummus", "1/4 cucumber, diced", "2 tbsp crumbled feta", "Roasted red pepper strips", "1 tbsp olive oil", "Squeeze of lemon", "Dried oregano", "Red pepper flakes"],
                        steps: ["Bowl: rice, prepped chicken (warm or cold).", "Add hummus on the side, cucumber, roasted red peppers, feta.", "Drizzle with olive oil, lemon, oregano, red pepper flakes."],
                        tip: "Mediterranean-style lunch with chickpea fiber from hummus plus healthy fats from olive oil and feta. Cucumber adds hydration. No cooking needed — just assemble.",
                        portions: ["43g protein", "470 cal", "5g fiber", "5 min"]
                    },
                    { type: "Dinner", icon: "🌙", name: "Spicy Black Bean & Sweet Potato Bowl", portion: "42g protein - 380 cal", color: "#a3b899",
                        ingredients: ["9 oz prepped chicken (from Session 2), diced", "1 medium sweet potato, cubed (roasted during Session 2)", "1 cup black beans", "1/4 cup corn", "2 tbsp crumbled feta", "1/4 cup cooked brown rice or quinoa", "1 tbsp olive oil", "1 tsp cumin", "1/2 tsp chili powder", "Garlic powder, red pepper flakes", "Squeeze of lime", "Hot sauce"],
                        steps: ["Sweet potato should already be roasted from prep. If not: toss cubed sweet potato with olive oil, cumin, chili powder, garlic powder. Roast 400°F 25 min.", "Warm black beans and corn with a pinch of cumin.", "Warm prepped chicken.", "Bowl: rice, sweet potato, chicken, beans, corn.", "Top with feta, lime squeeze, hot sauce.", "PLATE FOR TWO: Split sweet potato roughly even. Kasey = 4 oz chicken + ½ cup rice + smaller bean portion. Charlie = 5 oz chicken + ⅔ cup rice + rest of beans. Feta and lime on both."],
                        tip: "Sweet potato provides beta-carotene safely from food. Black beans are antioxidant powerhouses. Cumin has anti-cancer properties. The prepped chicken makes this a 5-minute assembly.",
                        portions: ["44g protein", "510 cal", "12g fiber", "10 min"]
                    },
                    { type: "Dessert", icon: "🍨", name: "Chocolate Cottage Cheese Pudding", portion: "20g protein - 140 cal", color: "#c4a882",
                        ingredients: ["1/2 cup low-fat cottage cheese", "1.5 tbsp cacao powder (NOT Dutch-processed)", "1 tsp honey", "1/4 tsp vanilla extract", "Pinch of sea salt", "1 tbsp mini dark chocolate chips"],
                        steps: ["Blend cottage cheese, cacao, honey, vanilla, and salt until completely smooth (about 30 sec in blender or food processor).", "Scoop into a bowl. Top with chocolate chips.", "Eat immediately or chill 30 min for a firmer mousse texture."],
                        tip: "Tastes like chocolate mousse. 20g protein and under 170 cal. The salt makes the chocolate sing. Cacao flavanols are heart-healthy antioxidants.",
                        portions: ["20g protein", "170 cal", "3g fiber", "5 min"]
                    }
                ]
            },
            {
                day: 7, theme: "Chipotle Orzo", protein: "136g", calories: "1,520",
                meals: [
                    { type: "Breakfast", icon: "🌅", name: "Apple Pie Breakfast Bowl", portion: "34g protein - 300 cal", color: "#a3b899",
                        ingredients: ["1/2 cup rolled oats", "1 cup unsweetened almond milk", "~1/2 scoop Vital Proteins chocolate collagen (~12g)", "5g L-glutamine", "1 tsp Nature's Way MCT oil", "1 scoop ON Gold Standard Banana Cream whey", "1 tsp chia seeds", "1 tsp cinnamon", "1/4 tsp nutmeg", "Pinch of allspice", "--- MORNING TOPPINGS ---", "1/2 medium apple, diced", "1 tbsp walnuts, chopped", "1 tbsp maple syrup", "1 tbsp hemp hearts"],
                        steps: ["Grab your jar from prep — same batch as Day 5, with apple pie spices instead of cacao.", "Morning: top with diced apple, walnuts, maple syrup, and hemp hearts."],
                        tip: "Made during Prep Session 2. Apple pie spices in your overnight oats. Full supplement stack built in. Apple pectin fiber, walnut omega-3s, cinnamon blood sugar regulation.",
                        portions: ["36g protein", "400 cal", "6g fiber", "5 min + overnight"]
                    },
                    { type: "Lunch", icon: "☀️", name: "Spicy Chicken & Black Bean Bowl", portion: "42g protein - 390 cal", color: "#a3b899",
                        ingredients: ["5 oz chicken breast, seasoned (from prep)", "1/2 cup black beans", "1/2 cup cooked brown rice", "1/4 cup corn", "2 tbsp Mexican blend shredded cheese", "2 tbsp salsa", "Hot sauce, garlic powder"],
                        steps: ["Reheat prepped chicken, rice, beans, and corn.", "Top with cheese, salsa, hot sauce."],
                        tip: "This bowl is a repeat for a reason — high-fiber, high-protein, and you never get tired of it with enough hot sauce.",
                        portions: ["44g protein", "490 cal", "10g fiber", "3 min reheat"]
                    },
                    { type: "Dinner", icon: "🌙", name: "One-Pot Chipotle Chicken & Orzo", portion: "46g protein - 390 cal", color: "#a3b899",
                        ingredients: ["12 oz chicken breast", "1 cup orzo (or use protein spaghetti broken into pieces)", "2 cups marinara sauce", "1 cup baby spinach", "1-2 chipotle peppers in adobo, minced", "3 cloves garlic, minced", "1 tbsp olive oil", "2 tbsp shredded Parmesan", "2 cups chicken broth", "Red pepper flakes"],
                        steps: ["Season chicken. Sear in olive oil 5-6 min per side. Remove and set aside.", "Sauté garlic and minced chipotles 30 seconds.", "Add marinara, broth, and orzo. Stir. Simmer 10 min until orzo is tender.", "Nestle chicken back in. Cook 5 more min.", "Stir in spinach until wilted. Top with Parmesan and red pepper flakes.", "PLATE FOR TWO: Divide the orzo + sauce roughly 40/60. Slice chicken — Kasey gets 5 oz, Charlie gets 7 oz. Parmesan on both."],
                        tip: "Smoky chipotle + marinara is an incredible combo. The one-pot method means the orzo soaks up all that smoky tomato flavor. Lycopene from the marinara, allicin from garlic, capsaicin from chipotle.",
                        portions: ["48g protein", "520 cal", "6g fiber", "25 min"]
                    },
                    { type: "Dessert", icon: "🍨", name: "Yogurt Bark", portion: "14g protein - 140 cal", color: "#c4a882",
                        ingredients: ["1 cup nonfat Greek yogurt", "1 tsp honey", "1/2 tsp vanilla extract", "3/4 cup fresh berries (raspberries, blueberries, or mixed)", "1 tbsp mini dark chocolate chips", "1 tbsp crushed walnuts", "1 tsp chia seeds"],
                        steps: ["Grab from prep — already made and frozen during your prep session. Break off a piece and enjoy."],
                        tip: "Already prepped! Berries have the highest antioxidant content of any fruit — ellagic acid is a potent anti-cancer compound. Walnuts add omega-3s, chia adds fiber.",
                        portions: ["14g protein", "170 cal", "4g fiber", "5 min + freeze"]
                    }
                ]
            },
            {
                day: 8, theme: "Teriyaki Night", protein: "125g", calories: "1,520", prep: "PREP DAY — Prep Session 3 + Grocery Run 2 (covers Week 2)",
                meals: [
                    { type: "Breakfast", icon: "🌅", name: "Strawberry Chocolate Overnight Oats", portion: "38g protein - 330 cal", color: "#a3b899",
                        ingredients: ["1/2 cup rolled oats", "1 cup unsweetened almond milk", "1.5 tbsp cacao powder (NOT Dutch-processed)", "~1/2 scoop Vital Proteins chocolate collagen (~12g)", "5g L-glutamine", "1 tsp Nature's Way MCT oil", "1 scoop ON Gold Standard Banana Cream whey", "1 tsp chia seeds", "--- MORNING TOPPINGS ---", "1/2 cup fresh strawberries, sliced", "1 tbsp mini dark chocolate chips (melted for the top layer)", "1 tbsp hemp hearts"],
                        steps: ["Grab your jar from prep — made during Prep Session 3.", "Morning: melt chocolate chips in the microwave (30 sec). Drizzle over the top for a solid chocolate layer.", "Top with fresh strawberry slices and hemp hearts."],
                        tip: "The chocolate top layer sets up like magic. Full supplement stack built in. Strawberry ellagic acid, cacao flavanols, hemp complete protein.",
                        portions: ["40g protein", "430 cal", "7g fiber", "5 min + overnight"]
                    },
                    { type: "Lunch", icon: "☀️", name: "Turkey Taco Wrap", portion: "38g protein - 350 cal", color: "#a3b899",
                        ingredients: ["4 oz seasoned ground turkey (from prep)", "1 Mission Carb Balance tortilla", "1/4 cup cooked brown rice", "2 tbsp Mexican blend shredded cheese", "2 tbsp salsa", "Hot sauce", "1 tbsp sour cream"],
                        steps: ["Warm tortilla. Reheat turkey and rice.", "Layer turkey, rice, cheese, salsa, sour cream.", "Wrap and eat. Add hot sauce."],
                        tip: "Prepped turkey makes this a 3-minute assembly. The carb balance tortillas have more fiber than most whole wheat breads.",
                        portions: ["40g protein", "450 cal", "8g fiber", "3 min"]
                    },
                    { type: "Dinner", icon: "🌙", name: "Chicken Teriyaki Bowl", portion: "44g protein - 390 cal", color: "#a3b899",
                        ingredients: ["14 oz chicken breast, cubed", "1 cup cooked white or brown rice", "--- TERIYAKI SAUCE ---", "2 tbsp teriyaki sauce", "1 tsp dark soy sauce", "1 tsp honey", "1/2 tsp garlic powder", "Pinch of salt", "--- CHILI CUCUMBER SALAD ---", "1/2 English cucumber, sliced thin", "1 tsp rice wine vinegar", "1/2 tsp sesame oil", "Red pepper flakes", "Pinch of salt", "--- RAW CARROT SALAD ---", "1 medium carrot, peeled into ribbons", "1 tsp rice wine vinegar", "1/2 tsp sesame oil", "Pinch of salt"],
                        steps: ["Cook rice if not prepped. Cube chicken breast.", "Mix teriyaki sauce ingredients in a small bowl.", "Sear chicken in a hot pan 5-6 min, tossing until golden. Add teriyaki sauce, cook 1-2 min until glazed.", "While chicken cooks, toss cucumber with rice vinegar, sesame oil, red pepper flakes, salt.", "Peel carrot into ribbons, toss with rice vinegar, sesame oil, salt.", "Bowl: rice on the bottom, teriyaki chicken on top, cucumber and carrot salads on the sides.", "PLATE FOR TWO: Rice on both plates. Kasey = 6 oz teriyaki chicken + half the cucumber and carrot salads. Charlie = 8 oz chicken + rest. Both get the cold salads on the side."],
                        tip: "Fresh and vibrant. The cold cucumber and carrot salads contrast the warm teriyaki perfectly. Ginger and garlic are both anti-inflammatory powerhouses.",
                        portions: ["46g protein", "520 cal", "3g fiber", "20 min"]
                    },
                    { type: "Dessert", icon: "🍨", name: "Caramelized Banana Bites", portion: "5g protein - 150 cal", color: "#c4a882",
                        ingredients: ["1 medium banana, sliced into rounds", "1 tsp coconut oil", "1 tbsp almond butter", "1 tsp honey", "1/2 tsp cinnamon", "1 tbsp toasted coconut flakes", "1 tsp mini dark chocolate chips", "Pinch of flaky sea salt"],
                        steps: ["Heat coconut oil in a pan over medium heat.", "Lay banana rounds flat, cook 1-2 min per side until golden and caramelized.", "Plate the banana bites. Drizzle almond butter and honey over top.", "Sprinkle cinnamon, coconut flakes, chocolate chips, and sea salt."],
                        tip: "All the best parts of the banana toast, minus the bread. Caramelizing concentrates the natural sugars. The almond butter + chocolate + sea salt combo is unreal.",
                        portions: ["5g protein", "180 cal", "3g fiber", "8 min"]
                    }
                ]
            },
            {
                day: 9, theme: "Lemon Garlic", protein: "134g", calories: "1,450",
                meals: [
                    { type: "Breakfast", icon: "🌅", name: "Baked Protein Pancake Bowls", portion: "36g protein - 300 cal", color: "#a3b899",
                        ingredients: ["1/3 cup rolled oats, blended into flour", "1 scoop ON Gold Standard Banana Cream whey", "~1/2 scoop Vital Proteins chocolate collagen (~12g)", "5g L-glutamine", "1 tsp Nature's Way MCT oil", "1 egg", "1/4 cup nonfat Greek yogurt", "1/4 cup unsweetened almond milk", "1/2 tsp baking powder", "1/2 tsp vanilla", "--- TOPPINGS ---", "1/4 cup mixed berries (fresh, or thaw frozen in fridge overnight)", "1 tsp maple syrup", "1 tbsp chopped walnuts"],
                        steps: ["Preheat 350°F. Blend oats into flour.", "Mix oat flour, whey, collagen, L-glutamine, MCT oil, egg, yogurt, almond milk, baking powder, vanilla.", "Pour into greased oven-safe ramekin or muffin tin.", "Bake 20 min until golden and set.", "Top with berries, maple syrup, walnuts."],
                        tip: "Make batter the night before and bake in the morning while you get ready — hands-off breakfast. Full supplement stack baked right in. The yogurt keeps it fluffy and moist.",
                        portions: ["38g protein", "400 cal", "4g fiber", "25 min"]
                    },
                    { type: "Lunch", icon: "☀️", name: "Spicy Black Bean Quesadilla", portion: "30g protein - 320 cal", color: "#a3b899",
                        ingredients: ["2 Mission Carb Balance tortillas", "1/2 cup black beans, drained", "1/3 cup Mexican blend shredded cheese", "2 tbsp salsa", "Hot sauce", "1 tbsp sour cream", "1 Galbani string cheese on the side"],
                        steps: ["Warm a tortilla in a dry pan over medium heat.", "Spread black beans on half, top with cheese.", "Fold and cook 2-3 min per side until golden and melty.", "Repeat with second tortilla if hungry.", "Dip in salsa and sour cream. Hit with hot sauce."],
                        tip: "Quick pantry lunch — nothing to reheat, just assemble. Black beans are loaded with antioxidants and fiber. String cheese on the side bumps the protein.",
                        portions: ["32g protein", "420 cal", "12g fiber", "5 min"]
                    },
                    { type: "Dinner", icon: "🌙", name: "Lemon Garlic Chicken over Farro", portion: "46g protein - 400 cal", color: "#a3b899",
                        ingredients: ["14 oz chicken breast cutlets", "1 cup cooked farro", "1 tbsp olive oil", "3 cloves garlic, minced", "Juice of 1 lemon", "1/2 tsp oregano", "Red pepper flakes", "2 cups roasted carrots", "2 tbsp shredded Parmesan", "Salt & pepper"],
                        steps: ["Cook farro according to package directions.", "Season chicken with salt, pepper, oregano, red pepper flakes.", "Heat olive oil in a pan over medium-high. Sear chicken 5-6 min per side until golden.", "In the last minute, add garlic to the pan. Squeeze lemon over everything.", "Toss carrots with olive oil, salt, roast at 400°F for 20 min.", "Plate farro, top with chicken, carrots, pan juices, and Parmesan.", "PLATE FOR TWO: Kasey = ½ cup farro, 6 oz chicken, half the carrots. Charlie = ⅔ cup farro, 8 oz chicken, rest of carrots. Spoon pan juices over both. Parmesan on top."],
                        tip: "Use the fresh chicken cutlets tonight — they need to be cooked first. Garlic contains allicin with potent anti-cancer properties. Lemon boosts iron absorption. Cook extra chicken and farro for lunch prep!",
                        portions: ["48g protein", "530 cal", "6g fiber", "30 min"]
                    },
                    { type: "Dessert", icon: "🍨", name: "Strawberry Cheesecake Protein Fluff", portion: "22g protein - 130 cal", color: "#c4a882",
                        ingredients: ["1/2 cup low-fat cottage cheese", "1/4 cup nonfat Greek yogurt", "1/2 cup fresh strawberries, diced", "1 tsp honey", "1/4 tsp vanilla extract", "1 tbsp graham cracker crumbs"],
                        steps: ["Blend cottage cheese and yogurt until smooth.", "Fold in strawberries, honey, and vanilla.", "Top with graham cracker crumbs."],
                        tip: "Cottage cheese blended smooth tastes like cheesecake filling — 22g protein. Strawberry ellagic acid, casein for slow digestion.",
                        portions: ["22g protein", "160 cal", "1g fiber", "5 min"]
                    }
                ]
            },
            {
                day: 10, theme: "Enchilada Night (Round 2)", protein: "123g", calories: "1,510",
                meals: [
                    { type: "Breakfast", icon: "🌅", name: "Chocolate Banana Protein Smoothie", portion: "36g protein - 300 cal", color: "#a3b899",
                        ingredients: ["1 cup unsweetened almond milk", "1 scoop banana cream whey protein", "1/2 scoop Vital Proteins chocolate collagen (~12g)", "5g L-glutamine", "1 tsp Nature's Way MCT oil", "1 medium banana", "1.5 tbsp cacao powder (NOT Dutch-processed)", "1 tbsp chia seeds", "1/2 cup ice"],
                        steps: ["Add almond milk, protein powder, collagen, L-glutamine, MCT oil, and cacao powder to blender.", "Add banana and ice.", "Blend until smooth and thick.", "Pour into a glass or bowl. Top with chia seeds."],
                        tip: "Chocolate + banana is a classic combo. The cacao gives you flavanols for heart health while the collagen + L-glutamine stack handles gut health. Full supplement stack in one glass.",
                        portions: ["38g protein", "400 cal", "5g fiber", "5 min"]
                    },
                    { type: "Lunch", icon: "☀️", name: "Turkey Taco Wrap", portion: "38g protein - 350 cal", color: "#a3b899",
                        ingredients: ["4 oz seasoned ground turkey (from prep)", "1 Mission Carb Balance tortilla", "1/4 cup cooked brown rice", "2 tbsp Mexican blend shredded cheese", "2 tbsp salsa", "Hot sauce", "1 tbsp sour cream"],
                        steps: ["Warm tortilla. Reheat turkey and rice.", "Layer, wrap, eat."],
                        tip: "Quick assembly from prepped ingredients. The carb balance tortillas are doing a lot of heavy lifting on fiber here.",
                        portions: ["40g protein", "450 cal", "8g fiber", "3 min"]
                    },
                    { type: "Dinner", icon: "🌙", name: "Spicy Turkey Enchiladas (Round 2)", portion: "44g protein - 410 cal", color: "#a3b899",
                        ingredients: ["12 oz ground turkey (93% lean)", "1/4 cup diced onion", "2 cloves garlic, minced", "1 tsp cumin", "1 tsp chili powder", "Red pepper flakes", "6 Mission Carb Balance tortillas", "2 cups enchilada sauce", "1 cup Mexican blend shredded cheese", "2 tbsp sour cream", "Hot sauce"],
                        steps: ["Preheat oven to 375°F.", "Brown turkey with onion, garlic, cumin, chili powder, red pepper flakes.", "Roll in tortillas, place in baking dish. Cover with enchilada sauce and cheese.", "Bake 20 min. Top with sour cream and hot sauce.", "PLATE FOR TWO: Same as Day 4 — Kasey = 2-3 enchiladas, Charlie = 3-4. Sour cream and hot sauce on both."],
                        tip: "Round 2! These were good enough the first time to earn a repeat. You know the drill by now. Cumin and chili powder both have anti-inflammatory properties.",
                        portions: ["46g protein", "540 cal", "8g fiber", "35 min"]
                    },
                    { type: "Dessert", icon: "🍨", name: "Caramelized Banana Bites", portion: "5g protein - 150 cal", color: "#c4a882",
                        ingredients: ["1 medium banana, sliced into rounds", "1 tsp coconut oil", "1 tbsp almond butter", "1 tsp honey", "1/2 tsp cinnamon", "1 tbsp toasted coconut flakes", "1 tsp mini dark chocolate chips", "Pinch of flaky sea salt"],
                        steps: ["Heat coconut oil in a pan over medium heat.", "Lay banana rounds flat, cook 1-2 min per side until golden and caramelized.", "Plate the banana bites. Drizzle almond butter and honey over top.", "Sprinkle cinnamon, coconut flakes, chocolate chips, and sea salt."],
                        tip: "All the best parts of the banana toast, minus the bread. Caramelizing concentrates the natural sugars. The almond butter + chocolate + sea salt combo is unreal.",
                        portions: ["5g protein", "180 cal", "3g fiber", "8 min"]
                    }
                ]
            },
            {
                day: 11, theme: "Creamy Lemon", protein: "137g", calories: "1,460", prep: "PREP DAY — Prep Session 4 (final mid-week refresh)",
                meals: [
                    { type: "Breakfast", icon: "🌅", name: "Mango-Coconut Overnight Oats", portion: "33g protein - 310 cal", color: "#a3b899",
                        ingredients: ["1/2 cup rolled oats", "1/2 cup unsweetened almond milk", "1/4 cup Simple Truth light coconut milk", "~1/2 scoop Vital Proteins chocolate collagen (~12g)", "5g L-glutamine", "1 tsp Nature's Way MCT oil", "3 tbsp hemp hearts", "1 tsp chia seeds", "--- MORNING TOPPINGS ---", "1/2 cup frozen mango (move to fridge night before)", "1 tbsp walnuts", "1 tsp honey"],
                        steps: ["Grab your jar from prep — made Day 10 evening with ingredients from Prep Session 3 grocery run.", "Top with thawed mango, walnuts, and honey."],
                        tip: "Coconut milk adds medium-chain fatty acids and a tropical vibe. Mango provides beta-carotene and vitamin C. Uses up that coconut milk.",
                        portions: ["35g protein", "410 cal", "8g fiber", "0 min"]
                    },
                    { type: "Lunch", icon: "☀️", name: "White Bean & Spinach Soup", portion: "36g protein - 320 cal", color: "#a3b899",
                        ingredients: ["5 oz shredded chicken (from prep)", "1 cup cannellini beans", "2 cups baby spinach", "1 cup marinara sauce", "2 cloves garlic", "1/2 cup diced carrots", "1 tbsp olive oil", "4 cups low-sodium chicken broth", "Italian seasoning, garlic powder, red pepper flakes"],
                        steps: ["Reheat a portion of the prepped soup.", "Top with a drizzle of olive oil and Parmesan if you want."],
                        tip: "White beans are loaded with resistant starch that feeds anti-cancer gut bacteria. Combined with spinach and tomato sauce, this is a Mediterranean powerhouse.",
                        portions: ["38g protein", "420 cal", "12g fiber", "3 min reheat"]
                    },
                    { type: "Dinner", icon: "🌙", name: "Creamy Lemon Chicken & Farro", portion: "46g protein - 400 cal", color: "#a3b899",
                        ingredients: ["14 oz chicken breast", "1 cup cooked farro", "1 cup baby spinach", "3 cloves garlic, minced", "Juice of 1 lemon", "1/4 cup chicken broth", "2 tbsp coconut milk (or splash of cream)", "1 tbsp olive oil", "2 tbsp shredded Parmesan", "Red pepper flakes", "Salt & pepper"],
                        steps: ["Cook farro if not prepped already.", "Season chicken. Sear in olive oil 5-6 min per side. Remove and let rest.", "In the same pan, sauté garlic 30 seconds.", "Add broth and lemon juice. Let it reduce by half (~2 min).", "Stir in coconut milk. Add spinach, wilt down.", "Slice chicken. Serve over farro with the creamy lemon sauce spooned over. Top with Parmesan and red pepper flakes.", "PLATE FOR TWO: Kasey = ½ cup farro + 6 oz sliced chicken + half the creamy lemon sauce. Charlie = ⅔ cup farro + 8 oz chicken + rest of sauce. Red pepper flakes on both."],
                        tip: "This is the Mediterranean diet at its best — olive oil, lemon, garlic, whole grains, greens. The pan sauce comes together in 3 minutes and tastes restaurant-quality.",
                        portions: ["48g protein", "530 cal", "6g fiber", "25 min"]
                    },
                    { type: "Dessert", icon: "🍨", name: "Strawberry Cheesecake Protein Fluff", portion: "22g protein - 130 cal", color: "#c4a882",
                        ingredients: ["1/2 cup low-fat cottage cheese", "1/4 cup nonfat Greek yogurt", "1/2 cup fresh strawberries, diced", "1 tsp honey", "1/4 tsp vanilla extract", "1 tbsp graham cracker crumbs"],
                        steps: ["Blend cottage cheese and yogurt until smooth.", "Fold in strawberries, honey, and vanilla.", "Top with graham cracker crumbs."],
                        tip: "Cottage cheese blended smooth tastes like cheesecake filling — 22g protein. Strawberry ellagic acid, casein for slow digestion.",
                        portions: ["22g protein", "160 cal", "1g fiber", "5 min"]
                    }
                ]
            },
            {
                day: 12, theme: "Basil Night", protein: "129g", calories: "1,510",
                meals: [
                    { type: "Breakfast", icon: "🌅", name: "Egg Muffin Cups + Morning Shake", portion: "36g protein - 280 cal", color: "#a3b899",
                        ingredients: ["--- MORNING BOOST SHAKE ---", "1 cup unsweetened almond milk", "1.5 tbsp cacao powder (NOT Dutch-processed)", "~1/2 scoop Vital Proteins chocolate collagen (~12g)", "5g L-glutamine", "1 tsp Nature's Way MCT oil", "--- EGG MUFFIN CUPS (x2) ---", "2 eggs (from batch)", "Spinach, onion, cheese (baked in)"],
                        steps: ["Blend shake ingredients and sip alongside breakfast.", "Reheat 2 egg muffin cups in microwave ~45 sec."],
                        tip: "Last round of egg cups! If you've been freezing them, they reheat perfectly. Shake gets the supplements in.",
                        portions: ["38g protein", "380 cal", "2g fiber", "2 min reheat"]
                    },
                    { type: "Lunch", icon: "☀️", name: "Chicken Enchilada Bowl", portion: "42g protein - 390 cal", color: "#a3b899",
                        ingredients: ["5 oz shredded chicken (from prep)", "1/2 cup cooked brown rice", "1/2 cup black beans", "1/2 cup enchilada sauce", "1/4 cup Mexican blend shredded cheese", "--- TOPPINGS ---", "2 tbsp sour cream", "2 tbsp salsa", "Squeeze of lime", "Hot sauce"],
                        steps: ["Reheat chicken, rice, beans, and enchilada sauce together.", "Top with cheese (it'll melt into the warm bowl).", "Add sour cream, salsa, lime, hot sauce."],
                        tip: "Deconstructed enchiladas without the tortilla-rolling hassle. All the same flavors, easier to portion. Enchilada sauce has capsaicin + lycopene.",
                        portions: ["44g protein", "490 cal", "9g fiber", "5 min reheat"]
                    },
                    { type: "Dinner", icon: "🌙", name: "One-Pot Basil Chicken & Orzo in Marinara", portion: "46g protein - 390 cal", color: "#a3b899",
                        ingredients: ["12 oz chicken breast", "1 cup orzo (or broken protein spaghetti)", "2 cups marinara sauce", "1 cup baby spinach", "1/2 cup diced carrots", "3 cloves garlic, minced", "1 tbsp olive oil", "Fresh basil (or dried)", "2 tbsp shredded Parmesan", "2 cups chicken broth", "Red pepper flakes"],
                        steps: ["Sear seasoned chicken in olive oil. Remove and set aside.", "Sauté garlic and carrots 2 min.", "Add marinara, broth, and orzo. Stir and simmer 10 min.", "Nestle chicken back in. Cook 5 more min until chicken is done.", "Stir in spinach until wilted. Top with basil, Parmesan, red pepper flakes.", "PLATE FOR TWO: Divide orzo + sauce roughly 40/60. Kasey = 5 oz chicken, Charlie = 7 oz. Basil and Parmesan on both."],
                        tip: "One-pot wonder. The orzo absorbs all the marinara flavor. Cooked tomato sauce = max lycopene. Garlic, spinach, olive oil — this is textbook Mediterranean.",
                        portions: ["48g protein", "520 cal", "7g fiber", "25 min"]
                    },
                    { type: "Dessert", icon: "🍨", name: "Caramelized Banana Bites", portion: "5g protein - 150 cal", color: "#c4a882",
                        ingredients: ["1 medium banana, sliced into rounds", "1 tsp coconut oil", "1 tbsp almond butter", "1 tsp honey", "1/2 tsp cinnamon", "1 tbsp toasted coconut flakes", "1 tsp mini dark chocolate chips", "Pinch of flaky sea salt"],
                        steps: ["Heat coconut oil in a pan over medium heat.", "Lay banana rounds flat, cook 1-2 min per side until golden and caramelized.", "Plate the banana bites. Drizzle almond butter and honey over top.", "Sprinkle cinnamon, coconut flakes, chocolate chips, and sea salt."],
                        tip: "All the best parts of the banana toast, minus the bread. Caramelizing concentrates the natural sugars. The almond butter + chocolate + sea salt combo is unreal.",
                        portions: ["5g protein", "180 cal", "3g fiber", "8 min"]
                    }
                ]
            },
            {
                day: 13, theme: "Cajun Friday", protein: "144g", calories: "1,500",
                meals: [
                    { type: "Breakfast", icon: "🌅", name: "Protein Yogurt Parfait + Morning Shake", portion: "36g protein - 300 cal", color: "#a3b899",
                        ingredients: ["--- MORNING BOOST SHAKE ---", "1 cup unsweetened almond milk", "1.5 tbsp cacao powder (NOT Dutch-processed)", "~1/2 scoop Vital Proteins chocolate collagen (~12g)", "5g L-glutamine", "1 tsp Nature's Way MCT oil", "--- PARFAIT ---", "1 cup Oikos Triple Zero vanilla Greek yogurt", "1/2 cup fresh strawberries, sliced", "2 tbsp walnuts, chopped", "1 tsp honey drizzle"],
                        steps: ["Blend shake ingredients and sip alongside breakfast.", "Scoop yogurt into a bowl. Top with strawberries, walnuts, and honey."],
                        tip: "No prep done yet so keep it simple — shake gets your supplements in, parfait is high-protein and zero effort. Use up those fresh strawberries!",
                        portions: ["38g protein", "400 cal", "3g fiber", "5 min"]
                    },
                    { type: "Lunch", icon: "☀️", name: "Blackened Chicken & Rice Bowl", portion: "42g protein - 380 cal", color: "#a3b899",
                        ingredients: ["K: 5 oz / C: 6.5 oz prepped chicken (from Session 3)", "1/2 cup cooked brown rice", "1 cup steamed broccoli or green beans", "Squeeze of lemon", "--- BLACKENING SPICE (toss with chicken) ---", "1/2 tsp smoked paprika", "1/4 tsp cayenne", "1/2 tsp garlic powder", "1/4 tsp thyme", "1/4 tsp oregano"],
                        steps: ["Toss prepped chicken with blackening spice blend.", "Quick-sear in a hot cast iron or pan 2 min to char the spices.", "Bowl: rice, blackened chicken, steamed veggies.", "Squeeze lemon over everything."],
                        tip: "Blackening spice transforms regular prepped chicken into something special. Smoked paprika is anti-inflammatory. The char from high heat creates incredible depth.",
                        portions: ["44g protein", "480 cal", "5g fiber", "10 min"]
                    },
                    { type: "Dinner", icon: "🍳", name: "Cajun Chicken Pasta", portion: "44g protein - 390 cal", color: "#a3b899",
                        ingredients: ["14 oz chicken breast, sliced thin", "9 oz protein pasta or whole wheat penne", "1 cup baby spinach", "2/3 cup cottage cheese, blended smooth", "2 tbsp parmesan", "2 cloves garlic, minced", "1 tbsp olive oil", "--- CAJUN SPICE ---", "1 tsp smoked paprika", "1/2 tsp garlic powder", "1/2 tsp onion powder", "1/4 tsp cayenne", "1/2 tsp oregano", "Salt, pepper"],
                        steps: ["Cook pasta per package, reserve 1/2 cup pasta water. Drain.", "Season chicken with cajun spice mix. Heat olive oil in skillet over medium-high, sear chicken 3-4 min per side. Remove, slice.", "In same pan, sauté garlic 30 sec. Add blended cottage cheese, parmesan, and a splash of pasta water. Stir into a creamy sauce.", "Add spinach, stir until wilted. Toss in pasta and chicken, coat everything in sauce.", "Add more pasta water if needed for consistency.", "PLATE FOR TWO: Toss everything together. Kasey = smaller portion (~4 oz pasta, 6 oz chicken). Charlie = larger portion (~5 oz pasta, 8 oz chicken)."],
                        tip: "Friday night comfort food! The cottage cheese becomes an insanely creamy cajun alfredo without the guilt. One pan after the pasta. Cayenne is anti-inflammatory and thermogenic. Hits that spicy comfort food craving.",
                        portions: ["46g protein", "520 cal", "4g fiber", "25 min"]
                    },
                    { type: "Dessert", icon: "🍨", name: "Strawberry Cheesecake Protein Fluff", portion: "22g protein - 130 cal", color: "#c4a882",
                        ingredients: ["1/2 cup low-fat cottage cheese", "1/4 cup nonfat Greek yogurt", "1/2 cup fresh strawberries, diced", "1 tsp honey", "1/4 tsp vanilla extract", "1 tbsp graham cracker crumbs"],
                        steps: ["Blend cottage cheese and yogurt until smooth.", "Fold in strawberries, honey, and vanilla.", "Top with graham cracker crumbs."],
                        tip: "Cottage cheese blended smooth tastes like cheesecake filling — 22g protein. Strawberry ellagic acid, casein for slow digestion.",
                        portions: ["22g protein", "160 cal", "1g fiber", "5 min"]
                    }
                ]
            },
            {
                day: 14, theme: "Celebration!", protein: "123g", calories: "1,500",
                meals: [
                    { type: "Breakfast", icon: "🌅", name: "Fluffy Protein Blueberry Pancakes", portion: "36g protein - 320 cal", color: "#a3b899",
                        ingredients: ["1/3 cup rolled oats (blended into flour)", "1 scoop ON Gold Standard Banana Cream whey", "1 egg", "1/4 cup nonfat Greek yogurt", "1/4 cup unsweetened almond milk", "1/2 tsp baking powder", "1/2 tsp vanilla extract", "1/4 cup fresh blueberries", "Cooking spray", "--- TOPPINGS ---", "2 tbsp pure maple syrup", "1 tbsp walnuts, chopped", "Extra blueberries"],
                        steps: ["Blend oats into flour. Mix with protein powder and baking powder.", "Whisk egg, yogurt, almond milk, vanilla. Combine wet and dry.", "Gently fold in blueberries.", "Cook 1/4 cup batter per pancake on a nonstick pan, 2-3 min per side.", "Stack and top with maple syrup, walnuts, and extra blueberries."],
                        tip: "Weekend pancake treat! Oat flour + protein powder = high-protein pancakes. Greek yogurt keeps them fluffy. Blueberry anthocyanins are powerful anti-cancer compounds. Take your supplement shake alongside.",
                        portions: ["38g protein", "420 cal", "4g fiber", "15 min"]
                    },
                    { type: "Lunch", icon: "☀️", name: "White Bean & Spinach Soup", portion: "36g protein - 320 cal", color: "#a3b899",
                        ingredients: ["5 oz shredded chicken (from prep)", "1 cup cannellini beans", "2 cups baby spinach", "2 cups marinara sauce", "2 cloves garlic", "1/2 cup diced carrots", "1 tbsp olive oil", "4 cups low-sodium chicken broth", "Italian seasoning, garlic powder, red pepper flakes"],
                        steps: ["Reheat prepped soup. Drizzle with olive oil."],
                        tip: "Last bowl. White beans + spinach + tomato sauce = the Mediterranean trifecta for gut health and cancer prevention.",
                        portions: ["38g protein", "420 cal", "12g fiber", "3 min reheat"]
                    },
                    { type: "Dinner", icon: "🌙", name: "Chicken & Spinach Baked Pasta", portion: "46g protein - 410 cal", color: "#a3b899",
                        ingredients: ["12 oz chicken breast, diced", "7 oz Kroger Protein Grain & Legume Spaghetti", "1 cup marinara sauce", "1/2 cup ricotta cheese", "1 cup baby spinach", "2 cloves garlic, minced", "3/4 cup shredded mozzarella", "2 tbsp shredded Parmesan", "1 tbsp olive oil", "Italian seasoning, red pepper flakes"],
                        steps: ["Preheat oven to 375°F. Cook protein pasta al dente.", "Sear diced chicken in olive oil with garlic. Season with Italian seasoning and red pepper flakes.", "Toss pasta with marinara, chicken, spinach, and ricotta.", "Pour into a small baking dish. Top with mozzarella and Parmesan.", "Bake 15-20 min until cheese is bubbly and golden.", "PLATE FOR TWO: Bake in one dish. Scoop Kasey's portion first (~40%), then Charlie gets the rest (~60%). Or use two small baking dishes if you want it perfect."],
                        tip: "Celebration dinner! 🎉 Marinara lycopene, garlic allicin, spinach folate, olive oil polyphenols, whole grain protein pasta. Every element is evidence-based Mediterranean. You just crushed 14 days. Start the cycle again or build from the recipe bank!",
                        portions: ["48g protein", "540 cal", "7g fiber", "30 min"]
                    },
                    { type: "Dessert", icon: "🍨", name: "Caramelized Banana Bites", portion: "5g protein - 150 cal", color: "#c4a882",
                        ingredients: ["1 medium banana, sliced into rounds", "1 tsp coconut oil", "1 tbsp almond butter", "1 tsp honey", "1/2 tsp cinnamon", "1 tbsp toasted coconut flakes", "1 tsp mini dark chocolate chips", "Pinch of flaky sea salt"],
                        steps: ["Heat coconut oil in a pan over medium heat.", "Lay banana rounds flat, cook 1-2 min per side until golden and caramelized.", "Plate the banana bites. Drizzle almond butter and honey over top.", "Sprinkle cinnamon, coconut flakes, chocolate chips, and sea salt."],
                        tip: "All the best parts of the banana toast, minus the bread. Caramelizing concentrates the natural sugars. The almond butter + chocolate + sea salt combo is unreal.",
                        portions: ["5g protein", "180 cal", "3g fiber", "8 min"]
                    }
                ]
            }
        ]
    },
    charlie: {
        goals: { protein: "180-210g", calories: "2,200-2,500" },
        days: []
    }
};

// Generate Charlie's meals (scaled up: +30% protein, +40% calories)
mealData.charlie.days = mealData.kasey.days.map(function(day) {
    var cDay = JSON.parse(JSON.stringify(day));
    var kProtein = parseInt(day.protein);
    var kCal = parseInt(day.calories.replace(",", ""));
    cDay.protein = Math.round(kProtein * 1.3) + "g";
    cDay.calories = (Math.round(kCal * 1.5 / 100) * 100).toLocaleString();
    
    cDay.meals = cDay.meals.map(function(meal) {
        var m = JSON.parse(JSON.stringify(meal));
        // Scale portions based on person
        var origProtein = parseInt(m.portion);
        var calMatch = m.portion.match(/(\d+) cal/);
        var origCal = calMatch ? parseInt(calMatch[1]) : 0;
        if (isNaN(origProtein) || origCal === 0) return m;
        var newProtein = Math.round(origProtein * 1.3);
        var newCal = Math.round(origCal * 1.5);
        m.portion = newProtein + "g protein - " + newCal + " cal";
        
        m.portions = m.portions.map(function(p) {
            if (p.indexOf("protein") !== -1) return newProtein + "g protein";
            if (p.indexOf("cal") !== -1) return newCal + " cal";
            if (p.indexOf("fiber") !== -1) {
                var f = parseInt(p);
                return Math.round(f * 1.2) + "g fiber";
            }
            return p;
        });
        
        if (m.type === "Dinner" && m.tip) {
            m.tip += "\n\nCHARLIE: Extra cooked tomato sauce with olive oil boosts lycopene absorption, especially important for prostate cancer prevention given your family history.";
        }
        
        return m;
    });
    return cDay;
});

// Add Kasey-specific dinner tips (supplement focus, gut health, anti-inflammatory)
mealData.kasey.days.forEach(function(day) {
    day.meals.forEach(function(m) {
        if (m.type === 'Dinner' && m.tip) {
            m.tip += "\n\nKASEY: Your collagen + L-glutamine stack supports gut lining repair — pair with the cooked veggies here for maximum absorption. Olive oil polyphenols amplify the anti-inflammatory effect.";
        }
    });
});

// ===== PREP SESSION DETAILS =====
var prepSessions = {
    1: {
        name: "Prep Session 1 + Grocery Run 1",
        color: "#a3b899",
        portions: ["Covers Days 1–4 lunches + Day 1 dinner", "Portions for BOTH of you", "~90-120 min total"],
        coveredMeals: [
            {day:1, type:"Lunch", originalName:"Chipotle Chicken Wrap"},
            {day:2, type:"Lunch", originalName:"Lemony Chicken & Grain Bowl"},
            {day:3, type:"Lunch", originalName:"Chicken Burrito Bowl"},
            {day:4, type:"Lunch", originalName:"Chipotle Chicken Wrap"},
            {day:1, type:"Dinner", originalName:"Cauliflower Bolognese over Protein Spaghetti"},
            {day:1, type:"Dessert", originalName:"Yogurt Bark"},
            {day:3, type:"Dessert", originalName:"Yogurt Bark"},
            {day:3, type:"Breakfast", originalName:"Peach Cobbler Overnight Oats"},
            {day:6, type:"Breakfast", originalName:"Egg Muffin Cups + Morning Shake"},
            {day:12, type:"Breakfast", originalName:"Egg Muffin Cups + Morning Shake"}
        ],
        ingredients: [
            "",
            "═══ PERISHABLES TO USE IMMEDIATELY ═══",
            "Ground turkey → split: most for tonight's Bolognese, save 4 oz for Day 2 zucchini boats",
            "Cauliflower → rice for Bolognese + save rest for Day 3 stew",
            "Baby spinach → egg muffins + Day 2 zucchini boats",
            "Zucchini (2 medium) → Day 2 zucchini boats dinner",
            "Ricotta → Day 2 zucchini boats (use ALL — opened last week)",
            "Feta → burrito bowl Day 3 lunch",
            "Broccoli → steam as side Day 2 or 3",
            "",
            "═══ CHICKEN — 5 lbs total (BRINE FIRST!) ═══",
            "→ 5 lbs raw = ~60 oz cooked, here's where it all goes:",
            "→ 24 oz chipotle chicken (Days 1+4 wraps: 6oz × 2 people × 2 days)",
            "→ 12 oz lemon-oregano chicken (Day 2 grain bowls: 6oz × 2 people)",
            "→ 12 oz seasoned chicken (Day 3 burrito bowls: 6oz × 2 people)",
            "→ 12 oz plain for Day 3 stew dinner (shred into stew)",
            "Olive oil, garlic powder, cumin, chili powder, oregano, salt & pepper",
            "3-4 chipotle peppers in adobo (for chipotle chicken)",
            "",
            "═══ GRAINS ═══",
            "1 cup brown rice, dry (→ 2 cups cooked, Day 3 burrito bowls)",
            "2 cups farro, dry (→ 5 cups cooked, grain bowls Days 2+5)",
            "",
            "═══ LUNCH BASES ═══",
            "1 can black beans (Day 3 burrito bowls)",
            "1/2 cup corn (Day 3 burrito bowls)",
            "1 can chickpeas, drained (grain bowls Days 2+5)",
            "1 jar roasted red peppers (grain bowls)",
            "Feta + lime + hot sauce (burrito bowls)",
            "2 lemons (grain bowls — add day-of with fresh spinach)",
            "",
            "═══ EGG MUFFIN CUPS — 12 total (ONE tin) ═══",
            "→ 8 used (Days 6+12 breakfasts: 2 per person × 2 mornings)",
            "→ 4 extras for snacking or if someone wants 3",
            "12 eggs, splash of milk",
            "2 cups baby spinach, chopped",
            "1/2 cup diced onion",
            "1 cup shredded cheese",
            "→ FREEZE 4 immediately for Day 12 (label them!)",
            "→ Fridge the other 8 (Days 6 breakfast + extras)",
            "",
            "═══ YOGURT BARK — 1 big batch for Days 1+3 (4 servings) ═══",
            "4 cups nonfat Greek yogurt, 4 tsp honey, 2 tsp vanilla extract",
            "3 cups fresh mixed berries (raspberries, blueberries, or mixed)",
            "4 tbsp mini dark chocolate chips, 4 tbsp crushed walnuts, 4 tsp chia seeds",
            "",
            "═══ GROCERY RUN 1 — covers ALL of Week 1 (Days 1-7) ═══",
            "~5 lbs chicken breast (Session 1 — brine + cook today)",
            "~3 lbs chicken breast (Session 2 Day 4 — FREEZE immediately, thaw Day 3 night)",
            "~2 lbs chicken breast (fresh dinners Days 5+7 — FREEZE, thaw as needed)",
            "1 lb ground turkey (Day 4 enchilada dinner — fridge, use within 3 days)",
            "Fresh strawberries 1 pint (Days 1-5 toppings)",
            "Fresh berries 2 pints (Days 1+3 yogurt bark + breakfast toppings)",
            "Bananas 3-4",
            "2 lemons",
            "Marinara sauce (Bolognese tonight + Day 3 stew)",
            "Enchilada sauce + flour tortillas (Day 4 dinner)",
            "Alfredo sauce (Day 5 dinner)",
            "Protein spaghetti/pasta (Day 5 dinner)",
            "Hummus + English cucumber + roasted red peppers (Day 6 Greek bowl lunch)",
            "1 large sweet potato (Day 6 dinner)",
            "Orzo pasta (Day 7 dinner)",
            "Frozen peaches (Day 3 Peach Cobbler Oats)",
            "1 bell pepper + 1 onion (Day 5 fajita bowl — fridge for mid-week)"
        ],
        steps: [
            "BRINE THE CHICKEN FIRST — Dissolve 1/4 cup kosher salt in 4 cups warm water. Add 5 lbs chicken breast. Refrigerate 30-60 min while you do everything else.",
            "FREEZE WEEK'S CHICKEN — Immediately put Session 2 chicken (3 lbs) and dinner chicken (2 lbs) in separate labeled freezer bags. You'll thaw them later.",
            "START RICE + FARRO — 1 cup dry rice + 2 cups dry farro. Both cook while you prep everything else.",
            "EGG MUFFIN CUPS — Preheat 375°F. Whisk 12 eggs + milk + salt & pepper. Grease ONE muffin tin. Divide spinach, onion, cheese into 12 cups. Pour egg. Bake 20 min. FREEZE 4 for Day 12. Fridge the other 8.",
            "COOK BRINED CHICKEN — Pat DRY with paper towels. Season with olive oil + spices. Sear 1 min/side in hot pan, then bake 400°F 12-15 min. PULL AT 160°F. Rest 10 FULL MINUTES.",
            "PORTION THE CHICKEN — You cooked ~60 oz. Split it 4 ways:\n→ CHIPOTLE (24 oz): Shred + toss with chipotles in adobo. This is for Days 1+4 wraps.\n→ LEMON-OREGANO (12 oz): Slice + season with oregano, lemon, garlic. For Day 2 grain bowls.\n→ SEASONED (12 oz): Dice + season with cumin, chili powder. For Day 3 burrito bowls.\n→ PLAIN (12 oz): Shred plain — goes into Day 3 stew dinner.",
            "PREP PANTRY ITEMS — Drain & rinse: 1 can black beans (Day 3 burrito bowls), 1 can chickpeas (Day 2 grain bowls). Measure 1/2 cup corn (Day 3 bowls). Set all aside for packing containers.",
            "PACK LUNCH CONTAINERS — 8 total, labeled K or C:\n→ DAY 1 + DAY 4 CHIPOTLE WRAPS (4 containers): K = 5 oz chipotle chicken, C = 6.5 oz. Tortillas + toppings stay separate.\n→ DAY 2 GRAIN BOWLS (2 containers): K = 5 oz lemon chicken + ½ cup farro + chickpeas + roasted red peppers. C = 6.5 oz chicken + ⅔ cup farro + chickpeas + peppers.\n→ DAY 3 BURRITO BOWLS (2 containers): K = 5 oz seasoned chicken + ½ cup rice + black beans + corn. C = 6.5 oz + ⅔ cup rice + beans + corn.\n→ Add fresh toppings the morning you eat (spinach, lemon, feta, lime, hot sauce).",
            "YOGURT BARK — One big batch on a parchment-lined sheet pan: mix yogurt + honey + vanilla, spread thin, press in berries, scatter choc chips + walnuts + chia. Freeze 2+ hours. Break into pieces — store in a container. Covers Days 1+3 dessert for both of you.",
            "STORE FARRO — Save ~2.5 cups cooked farro for Day 5 grain bowls (stays fresh 5 days in fridge).",
            "PEACH COBBLER OATS — 2 jars for Day 3 breakfast: oats, almond milk, collagen, L-glutamine, MCT oil, whey, chia, cinnamon, nutmeg. Refrigerate. Move frozen peaches to fridge the night before. Add thawed peaches + walnuts + honey in the morning.",
            "LABEL EVERYTHING — K or C on every container. Fridge stew chicken separately for Day 3.",
            "TONIGHT'S DINNER: BOLOGNESE — Brown ALL your ground turkey. Add riced cauliflower, marinara, Italian seasoning. Enough for tonight's dinner (2 portions each). Save remaining raw cauliflower in fridge for Day 3 stew. Start this while you're finishing up packing containers, or after prep is done."
        ],
        tip: "Big day but everything multitasks. Brine goes in first. Egg muffins bake while chicken cooks. Rice and farro cook themselves. Dinner is the last step — start the Bolognese while you're wrapping up containers or after everything is packed. Use ALL ricotta in tomorrow's zucchini boats and ALL ground turkey tonight — they're your most perishable items."
    },
    4: {
        name: "Prep Session 2",
        color: "#a3b899",
        portions: ["Covers Days 5–7 lunches + Day 4 dinner", "Portions for BOTH of you", "~60 min total"],
        coveredMeals: [
            {day:5, type:"Lunch", originalName:"Chicken Fajita Bowl"},
            {day:6, type:"Lunch", originalName:"Greek Chicken & Hummus Bowl"},
            {day:7, type:"Lunch", originalName:"Spicy Chicken & Black Bean Bowl"},
            {day:4, type:"Dinner", originalName:"Spicy Turkey Enchiladas"},
            {day:6, type:"Dinner", originalName:"Spicy Black Bean & Sweet Potato Bowl"},
            {day:5, type:"Breakfast", originalName:"Cacao-Berry Overnight Oats"},
            {day:7, type:"Breakfast", originalName:"Apple Pie Breakfast Bowl"},
            {day:5, type:"Dessert", originalName:"Yogurt Bark"},
            {day:7, type:"Dessert", originalName:"Yogurt Bark"}
        ],
        ingredients: [
            "",
            "═══ CHICKEN — 3 lbs (thaw from freezer Day 3 night, BRINE FIRST!) ═══",
            "→ 3 lbs raw = ~36 oz cooked, here's where it goes:",
            "→ 12 oz for Day 5 grain bowls (6oz × 2 people)",
            "→ 12 oz for Day 6 burrito bowls (6oz × 2 people)",
            "→ 12 oz for Day 7 black bean bowls (6oz × 2 people)",
            "",
            "═══ TURKEY — 1 lb (for tonight's enchilada dinner) ═══",
            "1 lb ground turkey (93% lean)",
            "Enchilada sauce, cheese, tortillas",
            "",
            "═══ GRAINS ═══",
            "1.5 cups brown rice, dry (→ 3 cups cooked, Days 6+7 lunches)",
            "1 bell pepper + 1 onion (Day 5 fajita bowl)", "Hummus + cucumber + feta + roasted red peppers (Day 6 Greek bowl)",
            "",
            "═══ LUNCH BASES ═══",
            "1 can black beans (Days 6+7 bowls)",
            "1 cup corn (Days 6+7 bowls)",
            "Feta + lime (Day 6 burrito bowls)",
            "Spinach + lemon (Day 5 grain bowls — add fresh day-of)",
            "",
            "═══ OVERNIGHT OATS — 4 jars (Days 5+7 breakfasts) ═══",
            "2 cups rolled oats, 4 cups almond milk",
            "Collagen, L-glutamine, MCT oil (× 4 jars)",
            "Hemp hearts, chia seeds",
            "Cacao powder (for Day 5 Cacao-Berry jars)",
            "Diced apple + cinnamon + nutmeg + walnuts + maple syrup (Day 7 Apple Pie jars — add toppings in morning)",
            "",
            "═══ SWEET POTATO (Day 6 dinner) ═══",
            "1 large sweet potato — cube + roast during this session",
            "Olive oil, cumin, chili powder, garlic powder",
            "",
            "═══ YOGURT BARK — 1 big batch for Days 5+7 (4 servings) ═══",
            "4 cups nonfat Greek yogurt, 4 tsp honey, 2 tsp vanilla extract",
            "3 cups fresh mixed berries",
            "4 tbsp mini dark chocolate chips, 4 tbsp crushed walnuts, 4 tsp chia seeds"
        ],
        steps: [
            "BRINE CHICKEN — Thawed from freezer, into salt water, fridge 30 min.",
            "START RICE — 1.5 cups dry brown rice.",
            "ROAST SWEET POTATO — Cube, toss with oil + spices, roast 400°F 25 min. Store for Day 6 dinner.",
            "COOK BRINED CHICKEN — Pat dry, season, sear + bake (400°F, pull at 160°F, rest 10 min). You need ~36 oz cooked for 3 days of lunches for both of you.",
            "PREP PANTRY ITEMS — Drain & rinse: 1 can black beans (Days 5+6+7 bowls). Measure 1 cup corn (Days 6+7 bowls). Set aside for packing containers.",
            "PACK LUNCH CONTAINERS — 6 total, labeled K or C:\n→ DAY 5 FAJITA BOWLS (2 containers): K = 5 oz chicken + ½ cup rice + black beans. C = 6.5 oz + ⅔ cup rice + beans. Sear peppers + onion fresh that morning (2 min).\n→ DAY 6 GREEK BOWLS (2 containers): K = 5 oz chicken + ½ cup rice. C = 6.5 oz + ⅔ cup rice. Add hummus, cucumber, feta, roasted red peppers day-of.\n→ DAY 7 BLACK BEAN BOWLS (2 containers): K = 5 oz chicken + ½ cup rice + beans + corn. C = 6.5 oz + ⅔ cup rice + beans + corn.\n→ Fresh toppings day-of (salsa, sour cream, lime, feta).",
            "OVERNIGHT OATS — 4 jars: base mix in all. 2 jars get cacao powder (Day 5). 2 jars plain with apple pie spices (Day 7 — add diced apple + walnuts + maple in the morning).",
            "YOGURT BARK — Same as Session 1: mix yogurt + honey + vanilla, spread on parchment, press in berries, scatter choc chips + walnuts + chia. Freeze. Covers Days 5+7 dessert for both of you.",
            "Check egg muffin supply — should have 8 in fridge for Day 6 breakfast.",
            "TONIGHT'S DINNER: ENCHILADAS — Brown 1 lb turkey with onion, garlic, cumin, chili powder. Roll into tortillas with enchilada sauce + cheese. Bake 375°F 20 min. Start this while you're packing containers or after prep is wrapped up."
        ],
        tip: "Quick mid-week session! Sweet potato roasts itself while you cook chicken. Finish all your prep and packing first, then get the enchiladas in the oven. You're halfway through Week 1!"
    },
    8: {
        name: "Prep Session 3 + Grocery Run 2",
        color: "#a3b899",
        portions: ["Covers Days 8–10 lunches + Day 10 dinner", "Portions for BOTH of you", "~75 min total"],
        coveredMeals: [
            {day:8, type:"Lunch", originalName:"Turkey Taco Wrap"},
            {day:10, type:"Lunch", originalName:"Turkey Taco Wrap"},
            {day:13, type:"Lunch", originalName:"Blackened Chicken & Rice Bowl"},
            {day:10, type:"Dinner", originalName:"Spicy Turkey Enchiladas (Round 2)"},
            {day:8, type:"Breakfast", originalName:"Strawberry Chocolate Overnight Oats"},
            {day:11, type:"Breakfast", originalName:"Mango-Coconut Overnight Oats"}
        ],
        ingredients: [
            "",
            "═══ TURKEY — 3 lbs total (BRINE FIRST!) ═══",
            "→ 3 lbs raw = ~38 oz cooked, here's where it goes:",
            "→ 12 oz Day 8 taco wraps (6oz × 2 people)",
            "→ 12 oz Day 10 taco wraps (6oz × 2 people)",
            "→ 14 oz Day 10 enchilada dinner (7oz × 2 people)",
            "1 cup diced onion, 4 cloves garlic",
            "Cumin, chili powder, garlic powder, red pepper flakes, salt",
            "",
            "═══ CHICKEN — 1.5 lbs (for Day 13 black bean bowl lunch) ═══",
            "→ 1.5 lbs raw = ~18 oz cooked",
            "→ 12 oz Day 13 black bean bowls (6oz × 2 people)",
            "→ 6 oz extra (snack or bulk up a lunch)",

            "",
            "═══ GRAINS ═══",
            "2 cups brown rice, dry (→ 4 cups cooked, Days 8+10+13 lunches)",
            "",
            "═══ LUNCH BASES ═══",
            "2 cans black beans (Days 8+10 wraps + Day 13 bowl)",
            "1 cup corn (Day 13 bowl)",
            "Cheese, sour cream, salsa (wraps)",
            "Feta + lime (Day 13 bowl)",
            "",
            "═══ OVERNIGHT OATS — 2 jars (Day 8 Strawberry Chocolate breakfast) ═══",
            "1 cup rolled oats, 2 cups almond milk",
            "Collagen, L-glutamine, MCT oil, whey (× 2)",
            "Cacao powder, chia seeds",
            "Dark chocolate chips (melt for top layer in morning)",
            "Fresh strawberries + hemp hearts (morning toppings)",
            "",
            "═══ MANGO OATS — 2 jars (make Day 10 night for Day 11 breakfast) ═══",
            "1 cup rolled oats, 1 cup coconut milk + 1 cup almond milk",
            "Collagen, L-glutamine, MCT oil (× 2)",
            "Frozen mango chunks, toasted coconut flakes (morning toppings)",
            "",
            "═══ GROCERY RUN 2 — covers ALL of Week 2 (Days 8-14) ═══",
            "~3 lbs ground turkey (Session 3 — cook today)",
            "~1.5 lbs chicken breast (Session 3 — brine + cook today for Day 13)",
            "~3.5 lbs chicken breast (Session 4 Day 11 — FREEZE, thaw Day 10 night)",
            "~3 lbs chicken breast (fresh dinners Days 8,9,11,12,14 — FREEZE, thaw as needed)",
            "1 pint fresh strawberries (Days 8-13 — breakfast toppings + cheesecake fluff dessert)",
            "Fresh blueberries (Day 14 pancakes — weekend breakfast!)",
            "5-6 bananas (Days 8-14 — banana bites dessert + smoothies)",
            "1 English cucumber + carrots (Day 8 teriyaki sides)",
            "1 lemon (Day 9 lemon garlic dinner)",
            "Teriyaki sauce (Day 8 dinner)",
            "Enchilada sauce (Day 10 dinner)",
            "Coconut milk (Day 11 mango oats)",
            "Frozen mango (Day 11 oats)",
            "FRESH ricotta (Day 14 baked pasta — don't open until Day 14!)",
            "Cottage cheese 2 tubs (Days 9+11+13 cheesecake fluff dessert + Day 13 cajun pasta sauce)",
            "Graham crackers (Days 9+11+13 cheesecake fluff topping)",
            "Coconut oil + almond butter + toasted coconut flakes (banana bites dessert Days 8+10+12+14)",
            "Orzo pasta (Day 12 dinner)",
            "Broccoli or green beans (Day 13 blackened chicken bowl)",
            "Smoked paprika + cayenne (blackening spice — check spice rack)"
        ],
        steps: [
            "BRINE TURKEY + CHICKEN — Same salt water method. Both go in together, fridge 30 min.",
            "FREEZE WEEK'S CHICKEN — Session 4 chicken (3.5 lbs) + dinner chicken (3 lbs) into labeled freezer bags immediately.",
            "START RICE — 2 cups dry brown rice.",
            "COOK TURKEY — Brown all 3 lbs with onion, garlic, cumin, chili powder, garlic powder. Split into:\n→ TACO WRAPS Days 8+10 (4 containers): K = 5 oz, C = 6.5 oz each day.\n→ DAY 10 ENCHILADA DINNER: Set aside 14 oz (7 oz each). Fridge.",
            "COOK BRINED CHICKEN — Pat dry, season, sear + bake. Pull at 160°F, rest 10 min. Split into:\n→ DAY 13 BLACKENED BOWLS (2 containers): K = 5 oz, C = 6.5 oz. Toss with blackening spice + sear day-of.",
            "PREP PANTRY ITEMS — Drain & rinse: 2 cans black beans (Days 8+10 wraps + Day 13 bowl). Measure 1 cup corn (Day 13 bowl). Set aside for packing containers.",
            "PACK LUNCH CONTAINERS — 6 total, labeled K or C:\n→ DAYS 8+10 TACO WRAPS (4 containers): Turkey + rice + beans + cheese. Tortillas + sour cream + salsa stay separate.\n→ DAY 13 BLACKENED BOWLS (2 containers): Chicken + rice. Add broccoli/green beans fresh day-of.",
            "STRAWBERRY CHOCOLATE OATS — 2 jars: blend almond milk + cacao + collagen + L-glutamine + MCT + whey. Pour over oats + chia. Refrigerate. (Morning: melt choc chips, drizzle on top, add strawberries + hemp hearts.)",
            "NOTE: Day 10 evening, make 2 MANGO-COCONUT OATS for Day 11 breakfast. Ingredients are in the pantry from today's grocery run."
        ],
        tip: "Start of Week 2! Brine turkey + chicken together. The teriyaki (Day 8) and lemon garlic (Day 9) dinners are cooked fresh that night — thaw 1 lb chicken each morning. Don't forget to make the mango oats on Day 10 evening!"
    },
    11: {
        name: "Prep Session 4",
        color: "#a3b899",
        portions: ["Covers Days 11–14 lunches (soup + enchilada bowls)", "Portions for BOTH of you", "~60 min total"],
        coveredMeals: [
            {day:11, type:"Lunch", originalName:"White Bean & Spinach Soup"},
            {day:12, type:"Lunch", originalName:"Chicken Enchilada Bowl"},
            {day:14, type:"Lunch", originalName:"White Bean & Spinach Soup"},
            {day:12, type:"Breakfast", originalName:"Egg Muffin Cups + Morning Shake"}
        ],
        ingredients: [
            "",
            "═══ CHICKEN — 3.5 lbs (thaw from freezer Day 10 night, BRINE FIRST!) ═══",
            "→ 3.5 lbs raw = ~42 oz cooked, here's where it goes:",
            "→ 12 oz diced for Day 12 enchilada bowls (6oz × 2 people)",
            "→ 30 oz shredded into soup (Days 11+14 lunches: 4 servings × ~7.5oz)",
            "",
            "═══ WHITE BEAN SOUP (4 servings: Days 11+14 lunches for both of you) ═══",
            "3 cans cannellini beans",
            "6 cups baby spinach",
            "3 cups marinara sauce",
            "6 cloves garlic, 1.5 cups diced carrots",
            "3 tbsp olive oil",
            "12 cups low-sodium chicken broth",
            "Italian seasoning, garlic powder, red pepper flakes",
            "",
            "═══ ENCHILADA BOWL BASES (Day 12 lunch) ═══",
            "1 cup brown rice, dry (→ 2 cups cooked)",
            "1 can black beans",
            "1/2 cup corn",
            "1/4 cup enchilada sauce",
            "Shredded cheese, sour cream, salsa, lime"
        ],
        steps: [
            "BRINE CHICKEN — Last time! Salt water, fridge, 30 min.",
            "START RICE — 1 cup dry.",
            "COOK BRINED CHICKEN — Pat dry, season, sear + bake. Pull at 160°F, rest 10 min. Dice 12 oz with cumin + chili powder for enchilada bowls. Shred remaining ~30 oz for soup.",
            "PREP PANTRY ITEMS — Drain & rinse: 1 can black beans, measure 1/2 cup corn, 1/4 cup enchilada sauce for Day 12 bowls. Set aside for packing.",
            "MAKE THE SOUP — Sauté garlic + carrots in olive oil. Add broth + marinara + beans. Simmer 10 min. Add spinach until wilted. Stir in shredded chicken. Season.\n→ 4 containers total: 2 for Day 11, 2 for Day 14. K gets ~1.5 cups per serving, C gets ~2 cups.",
            "PACK ENCHILADA BOWLS — 2 containers for Day 12:\n→ K = 5 oz diced chicken + ½ cup rice + black beans + corn + enchilada sauce + cheese.\n→ C = 6.5 oz chicken + ⅔ cup rice + beans + corn + sauce + cheese.",
            "THAW EGG MUFFINS — Pull the 4 frozen muffins from Day 1 into the fridge for Day 12 breakfast.",
            "🎉 Last prep session! Just 3 fresh dinners left (Days 11, 12, 14) and you're DONE."
        ],
        tip: "Final session! The soup covers 4 lunches (Days 11+14). By now you're chicken-brining pros. Thaw 1 lb chicken each morning for the remaining fresh dinners. Don't forget to pull those frozen egg muffins out for Day 12!"
    }
};

// State
var currentPerson = "kasey";
var showingSnacks = false;

// ===== DATE SYSTEM =====
// Plan starts Feb 15, 2026 — 14 days through Feb 28
var PLAN_START = new Date(2026, 1, 15); // Sun Feb 15
var PLAN_DAYS = 14;
var SHORT_DAYS = ["Sun", "Mon", "Tue", "Wed", "Thu", "Fri", "Sat"];
var SHORT_MONTHS = ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"];

function getPlanDayFromDate(date) {
    var start = new Date(PLAN_START);
    start.setHours(0,0,0,0);
    var check = new Date(date);
    check.setHours(0,0,0,0);
    var diff = Math.floor((check - start) / (1000 * 60 * 60 * 24));
    return diff + 1; // 1-indexed
}

function getDateForPlanDay(dayNum) {
    var d = new Date(PLAN_START);
    d.setDate(d.getDate() + dayNum - 1);
    return d;
}

// Figure out today's plan day, clamp to 1-14
var todayPlanDay = getPlanDayFromDate(new Date());
if (todayPlanDay < 1) todayPlanDay = 1;
if (todayPlanDay > PLAN_DAYS) todayPlanDay = PLAN_DAYS;
var currentDay = todayPlanDay;

// ===== MULTI-PLAN SYSTEM =====
var savedPlans = [{
    id: 'plan_original',
    label: 'Feb 15–28',
    startDate: '2026-02-15',
    days: 14,
    kaseyDays: mealData.kasey.days,
    charlieDays: mealData.charlie.days
}];
var currentPlanIndex = 0;

function renderPlanSelector() {
    var sel = document.getElementById('plan-selector');
    var dd = document.getElementById('plan-dropdown');
    var delBtn = document.getElementById('plan-delete-btn');
    
    if (savedPlans.length <= 1) {
        sel.style.display = 'none';
        return;
    }
    
    sel.style.display = 'flex';
    dd.innerHTML = '';
    savedPlans.forEach(function(p, i) {
        var opt = document.createElement('option');
        opt.value = i;
        opt.textContent = p.label;
        opt.selected = i === currentPlanIndex;
        dd.appendChild(opt);
    });
    
    // Don't allow deleting the original plan
    delBtn.style.display = currentPlanIndex === 0 ? 'none' : 'inline-block';
}

function switchPlan(index) {
    index = parseInt(index);
    if (index < 0 || index >= savedPlans.length) return;
    currentPlanIndex = index;
    
    var plan = savedPlans[index];
    PLAN_START = new Date(plan.startDate + 'T00:00:00');
    PLAN_DAYS = plan.days;
    mealData.kasey.days = plan.kaseyDays;
    mealData.charlie.days = plan.charlieDays;
    
    // Update subtitle
    var sd = new Date(plan.startDate + 'T00:00:00');
    var ed = new Date(sd); ed.setDate(ed.getDate() + plan.days - 1);
    document.getElementById('header-subtitle').textContent = 'Kasey & Charlie \u2022 ' + SHORT_MONTHS[sd.getMonth()] + ' ' + sd.getDate() + '\u2013' + ed.getDate();
    
    // Reset to appropriate day
    var todayD = getPlanDayFromDate(new Date());
    if (todayD < 1) todayD = 1;
    if (todayD > PLAN_DAYS) todayD = 1;
    currentDay = todayD;
    
    renderPlanSelector();
    renderCalendar();
    selectDay(currentDay);
}

function deleteCurrentPlan() {
    if (currentPlanIndex === 0) return;
    if (!confirm('Delete this plan? This cannot be undone.')) return;
    savedPlans.splice(currentPlanIndex, 1);
    currentPlanIndex = 0;
    switchPlan(0);
    saveAllPlansToFirebase();
}

function saveAllPlansToFirebase() {
    // Update current plan's data before saving
    savedPlans[currentPlanIndex].kaseyDays = mealData.kasey.days;
    savedPlans[currentPlanIndex].charlieDays = mealData.charlie.days;
    
    if (!window.fbReady) {
        localStorage.setItem('mealplan_allplans', JSON.stringify(savedPlans));
        return;
    }
    try {
        var imports = window.firestoreImports;
        imports.setDoc(imports.doc(window.db, 'mealPlanData', 'allPlans'), {
            plans: JSON.stringify(savedPlans),
            updatedAt: new Date().toISOString()
        });
    } catch(e) {
        localStorage.setItem('mealplan_allplans', JSON.stringify(savedPlans));
    }
}

function loadAllPlansFromFirebase(callback) {
    // Save the fresh original plan data before loading
    var freshOriginal = JSON.parse(JSON.stringify(savedPlans[0]));
    
    function mergeLoaded(loaded) {
        if (loaded && loaded.length > 0) {
            // Always keep fresh original as plan 0, merge any extra AI-generated plans
            savedPlans = [freshOriginal];
            for (var i = 1; i < loaded.length; i++) {
                if (loaded[i] && loaded[i].kaseyDays) savedPlans.push(loaded[i]);
            }
        }
    }
    
    if (!window.fbReady) {
        var saved = localStorage.getItem('mealplan_allplans');
        if (saved) {
            try { mergeLoaded(JSON.parse(saved)); } catch(e) {}
        }
        callback();
        return;
    }
    try {
        var imports = window.firestoreImports;
        imports.getDoc(imports.doc(window.db, 'mealPlanData', 'allPlans')).then(function(snap) {
            if (snap.exists() && snap.data().plans) {
                try { mergeLoaded(JSON.parse(snap.data().plans)); } catch(e) {}
            }
            callback();
        }).catch(function() { callback(); });
    } catch(e) { callback(); }
}

var dayColors = [
    "#a3b899", "#8fa882", "#7d8f76", "#a3b899", "#8fa882", "#b8c9ad", "#7d8f76",
    "#a3b899", "#8fa882", "#7d8f76", "#a3b899", "#8fa882", "#b8c9ad", "#7d8f76"
];

function getData() {
    return mealData[currentPerson];
}

function renderProgress() {
    var pct = Math.round((currentDay / PLAN_DAYS) * 100);
    document.getElementById("progress-fill").style.width = pct + "%";
    
    var startStr = SHORT_MONTHS[PLAN_START.getMonth()] + " " + PLAN_START.getDate();
    var endDate = getDateForPlanDay(PLAN_DAYS);
    var endStr = SHORT_MONTHS[endDate.getMonth()] + " " + endDate.getDate();
    
    document.getElementById("progress-label").textContent = "Day " + currentDay + " of " + PLAN_DAYS;
    document.getElementById("progress-dates").textContent = startStr + " – " + endStr;
}

function renderCalendar() {
    // Week ranges
    var w1Start = getDateForPlanDay(1);
    var w1End = getDateForPlanDay(7);
    var w2Start = getDateForPlanDay(8);
    var w2End = getDateForPlanDay(14);
    document.getElementById("week1-range").textContent = SHORT_MONTHS[w1Start.getMonth()] + " " + w1Start.getDate() + "–" + w1End.getDate();
    document.getElementById("week2-range").textContent = SHORT_MONTHS[w2Start.getMonth()] + " " + w2Start.getDate() + "–" + w2End.getDate();
    
    // Month label
    document.getElementById("cal-month-label").textContent = SHORT_MONTHS[PLAN_START.getMonth()].toUpperCase() + " " + PLAN_START.getFullYear();
    
    var todayDayNum = getPlanDayFromDate(new Date());
    
    ["week1", "week2"].forEach(function(id, weekIdx) {
        var grid = document.getElementById(id);
        grid.innerHTML = "";
        for (var i = 0; i < 7; i++) {
            var dayNum = weekIdx * 7 + i + 1;
            var dayDate = getDateForPlanDay(dayNum);
            var dateNum = dayDate.getDate();
            
            var btn = document.createElement("button");
            btn.className = "day-btn";
            
            var isActive = dayNum === currentDay;
            var isToday = dayNum === todayDayNum;
            var isPast = dayNum < todayDayNum;
            var isFuture = dayNum > todayDayNum;
            
            if (isToday) btn.classList.add("is-today");
            if (isPast) btn.classList.add("is-past");
            
            var baseColor = dayColors[dayNum - 1];
            
            if (isActive) {
                btn.style.background = baseColor;
                btn.style.color = "#2a1f21";
            } else if (isPast) {
                btn.style.background = "rgba(163,184,153,0.08)";
                btn.style.color = "rgba(224,210,208,0.4)";
            } else {
                btn.style.background = "rgba(163,184,153,0.1)";
                btn.style.color = "var(--light-text)";
            }
            
            var checkMark = isPast && !isActive ? '<span class="day-check">✓</span>' : '';
            var todayDot = isToday && !isActive ? '<span style="width:4px;height:4px;border-radius:50%;background:var(--sage-green);display:inline-block;"></span>' : '';
            
            var prepIcon = '';
            var kDay = mealData.kasey && mealData.kasey.days && mealData.kasey.days[dayNum - 1];
            if (kDay && kDay.prep) {
                prepIcon = '<span class="day-prep-icon">◆</span>';
            }
            
            btn.innerHTML = '<span class="day-letter">' + SHORT_DAYS[dayDate.getDay()] + '</span><span class="day-number">' + dateNum + '</span>' + checkMark + todayDot + prepIcon;
            btn.onclick = (function(d) { return function() { currentDay = d; showingSnacks = false; render(); }; })(dayNum);
            grid.appendChild(btn);
        }
    });
}

// ===== DYNAMIC PREP SESSION BUILDER =====
// Detects when meals have been swapped and adjusts prep display accordingly
function buildDynamicPrep(sessionDay, basePrepSession) {
    if (!basePrepSession.coveredMeals) return basePrepSession;
    
    var data = getData();
    var swaps = [];
    
    basePrepSession.coveredMeals.forEach(function(cm) {
        var dayData = data.days[cm.day - 1];
        if (!dayData) return;
        var currentMeal = null;
        dayData.meals.forEach(function(m) {
            if (m.type === cm.type) currentMeal = m;
        });
        if (!currentMeal) return;
        if (currentMeal.name !== cm.originalName) {
            swaps.push({
                day: cm.day,
                type: cm.type,
                oldName: cm.originalName,
                newName: currentMeal.name,
                newMeal: currentMeal
            });
        }
    });
    
    // No swaps? Return as-is
    if (swaps.length === 0) return basePrepSession;
    
    // Count which original meals are fully vs partially gone
    var mealCounts = {};
    basePrepSession.coveredMeals.forEach(function(cm) {
        if (!mealCounts[cm.originalName]) mealCounts[cm.originalName] = {swapped:0, total:0};
        mealCounts[cm.originalName].total++;
    });
    swaps.forEach(function(s) {
        if (mealCounts[s.oldName]) mealCounts[s.oldName].swapped++;
    });
    
    // Build day-number patterns for fully-removed meals
    var swappedDayTypes = [];
    swaps.forEach(function(s) {
        var mc = mealCounts[s.oldName];
        if (mc.swapped >= mc.total) {
            swappedDayTypes.push({day: s.day, type: s.type, oldName: s.oldName});
        }
    });
    
    // Build specific search terms from old meal names
    var uniqueTerms = [];
    swappedDayTypes.forEach(function(st) {
        var words = st.oldName.replace(/[&+(),]/g, ' ').split(/\s+/);
        var generic = ['the','and','a','in','on','of','with','over','One','Pot','Spicy','Bowl','Rice',
                       'Chicken','Turkey','Day','Round','2','Protein','Fresh','Frozen','Morning','Cups',
                       'Shake','Oats','Overnight','Baked','Pasta','Wrap','Black','Bean','Sweet',
                       'Yogurt','Greek','Cream','Cheese','Sauce','Lemon','Garlic','Spinach',
                       'Berry','Mixed','Chocolate','Banana','Apple','Honey','Maple',
                       'Broccoli','Potato','Farro','Quinoa','Grain','White','Soup',
                       'Stuffed','Roasted','Creamy','Grilled'];
        words.forEach(function(w) {
            if (w.length > 4 && generic.indexOf(w) === -1) {
                uniqueTerms.push({term: w.toLowerCase(), day: st.day});
            }
        });
    });
    
    // Build modified copy
    var ps = JSON.parse(JSON.stringify(basePrepSession));
    
    // Helper: check if a line references a swapped-out meal
    function lineMatchesSwapped(line) {
        if (!line) return false;
        var lower = line.toLowerCase();
        var matched = false;
        uniqueTerms.forEach(function(ut) {
            var dayRef = "day " + ut.day;
            if (lower.indexOf(ut.term) !== -1 && lower.indexOf(dayRef) !== -1) matched = true;
            if (lower.indexOf(ut.term) !== -1 && lower.indexOf("batch") !== -1) matched = true;
        });
        if (!matched) {
            swappedDayTypes.forEach(function(st) {
                var pattern = "day " + st.day + " " + st.type.toLowerCase();
                if (lower.indexOf(pattern) !== -1) matched = true;
                var pattern2 = "day " + st.day + " " + st.type.toLowerCase().substring(0, 4);
                if (lower.indexOf(pattern2) !== -1) matched = true;
            });
        }
        return matched;
    }
    
    // Remove old ingredient/step lines referencing swapped meals (clean replace, no strikethrough)
    if (uniqueTerms.length > 0 || swappedDayTypes.length > 0) {
        ps.ingredients = ps.ingredients.filter(function(line) {
            return !lineMatchesSwapped(line);
        });
        ps.steps = ps.steps.filter(function(step) {
            var lower = step.toLowerCase();
            var matched = false;
            uniqueTerms.forEach(function(ut) {
                if (lower.indexOf(ut.term) !== -1) matched = true;
            });
            if (!matched) {
                swappedDayTypes.forEach(function(st) {
                    var dayRef = "day " + st.day;
                    var typeRef = st.type.toLowerCase();
                    if (lower.indexOf(dayRef) !== -1 && lower.indexOf(typeRef) !== -1) matched = true;
                });
            }
            return !matched;
        });
    }
    
    // Add new meal ingredients at the end
    swaps.forEach(function(s) {
        if (s.newMeal && s.newMeal.ingredients && s.newMeal.ingredients.length > 0) {
            ps.ingredients.push("--- Day " + s.day + " " + s.newName + " (new) ---");
            s.newMeal.ingredients.forEach(function(ing) {
                if (ing && ing.indexOf("---") !== 0 && ing.trim() !== '') {
                    ps.ingredients.push(ing);
                }
            });
        }
    });
    
    // Add a small swap note at the top
    var swapNote = "\u21b9 Updated: ";
    swaps.forEach(function(s, i) {
        if (i > 0) swapNote += " \u00b7 ";
        swapNote += "Day " + s.day + " " + s.type + " \u2192 " + s.newName;
    });
    ps.ingredients.unshift(swapNote);
    
    // Update tip with a clean note
    var reducedMeals = [];
    var seen = {};
    swaps.forEach(function(s) {
        var mc = mealCounts[s.oldName];
        if (!seen[s.oldName]) {
            seen[s.oldName] = true;
            if (mc.swapped < mc.total) {
                reducedMeals.push(s.oldName + " (now " + (mc.total - mc.swapped) + " serving" + ((mc.total - mc.swapped) > 1 ? "s" : "") + ")");
            }
        }
    });
    var tipNote = swaps.length + " meal" + (swaps.length > 1 ? "s" : "") + " replaced \u2014 prep list updated automatically.";
    if (reducedMeals.length > 0) tipNote += " Reduced: " + reducedMeals.join(", ") + ".";
    ps.tip = tipNote + (ps.tip ? " " + ps.tip : "");
    
    return ps;
}


// Returns number of swaps detected for a given prep session (used for banner indicator)
function countPrepSwaps(sessionDay) {
    var ps = prepSessions[sessionDay];
    if (!ps || !ps.coveredMeals) return 0;
    var data = getData();
    var count = 0;
    ps.coveredMeals.forEach(function(cm) {
        var dayData = data.days[cm.day - 1];
        if (!dayData) return;
        dayData.meals.forEach(function(m) {
            if (m.type === cm.type && m.name !== cm.originalName) count++;
        });
    });
    return count;
}

function renderDayDetail() {
    var kData = mealData.kasey;
    var cData = mealData.charlie;
    var kDay = kData.days[currentDay - 1];
    var cDay = cData.days[currentDay - 1];
    if (!kDay) { currentDay = 1; kDay = kData.days[0]; cDay = cData.days[0]; }
    if (!kDay) return;
    var dayDate = getDateForPlanDay(currentDay);
    var dateStr = SHORT_DAYS[dayDate.getDay()] + ", " + SHORT_MONTHS[dayDate.getMonth()] + " " + dayDate.getDate();

    // -- Shared day header (date + theme) --
    var header = document.getElementById("day-header");
    header.style.background = dayColors[currentDay - 1];
    document.getElementById("day-num").textContent = dateStr;
    document.getElementById("day-theme").textContent = kDay.theme;

    // -- Per-person macro cards --
    document.getElementById("day-protein-k").textContent = kDay.protein + " protein (meals)";
    document.getElementById("day-calories-k").textContent = kDay.calories + " cal + snacks";
    document.getElementById("day-protein-c").textContent = cDay.protein + " protein (meals)";
    document.getElementById("day-calories-c").textContent = cDay.calories + " cal + snacks";

    // -- Goal cards (update names from settings) --
    var names = (window.LifeHubSettings && window.LifeHubSettings.current.names) || {name1:'Kasey',name2:'Charlie'};
    document.getElementById("dual-kasey-name").textContent = names.name1;
    document.getElementById("dual-charlie-name").textContent = names.name2;
    document.getElementById("goal-protein-k").textContent = kData.goals.protein;
    document.getElementById("goal-calories-k").textContent = kData.goals.calories;
    document.getElementById("goal-protein-c").textContent = cData.goals.protein;
    document.getElementById("goal-calories-c").textContent = cData.goals.calories;
    var colLabelK = document.getElementById("col-label-k");
    var colLabelC = document.getElementById("col-label-c");
    if (colLabelK) colLabelK.textContent = names.name1;
    if (colLabelC) colLabelC.textContent = names.name2;
    var macroTagK = document.querySelector("#dual-macros-k .person-tag");
    var macroTagC = document.querySelector("#dual-macros-c .person-tag");
    if (macroTagK) macroTagK.textContent = names.name1;
    if (macroTagC) macroTagC.textContent = names.name2;

    // -- Prep day banner (shared, above both columns) --
    var existingPrep = document.getElementById("prep-banner");
    if (existingPrep) existingPrep.remove();
    if (kDay.prep) {
        var prepBanner = document.createElement("div");
        prepBanner.id = "prep-banner";
        currentPerson = "kasey"; // for prep session context
        var swapCount = countPrepSwaps(currentDay);
        var bannerBg = swapCount > 0 ? "rgba(201,168,76,0.2)" : "rgba(163,184,153,0.15)";
        var bannerBorder = swapCount > 0 ? "rgba(201,168,76,0.4)" : "rgba(163,184,153,0.3)";
        var bannerColor = swapCount > 0 ? "#c9a84c" : "#a3b899";
        prepBanner.style.cssText = "background:" + bannerBg + ";border:1px solid " + bannerBorder + ";border-radius:6px;padding:10px 14px;margin-bottom:12px;font-size:0.8rem;color:" + bannerColor + ";text-align:center;letter-spacing:0.03em;cursor:pointer;transition:background 0.2s;";
        var swapBadge = swapCount > 0 ? ' <span style="background:rgba(201,168,76,0.3);padding:2px 8px;border-radius:10px;font-size:0.65rem;margin-left:6px;">' + swapCount + ' meal' + (swapCount > 1 ? 's' : '') + ' changed</span>' : '';
        prepBanner.innerHTML = "" + kDay.prep + swapBadge + ' <span style="opacity:0.6; margin-left:6px;">tap for details \u203a</span>';
        prepBanner.onmouseenter = function() { this.style.background = "rgba(163,184,153,0.25)"; };
        prepBanner.onmouseleave = function() { this.style.background = bannerBg; };
        prepBanner.onclick = function() {
            currentPerson = "kasey";
            var ps = prepSessions[currentDay];
            if (ps) openModal(buildDynamicPrep(currentDay, ps));
        };
        var dualMeals = document.getElementById("dual-meals");
        dualMeals.parentNode.insertBefore(prepBanner, dualMeals);
    }

    var dualCols = document.getElementById("dual-meals");
    var extrasDiv = document.getElementById("dual-extras");
    extrasDiv.innerHTML = "";

    if (showingSnacks) {
        // Snack mode: full width, hide columns
        dualCols.style.display = "none";
        var container = extrasDiv;
        var backBtn = document.createElement("button");
        backBtn.className = "meal-btn";
        backBtn.style.background = "var(--lh-accent-muted, rgba(163,184,153,0.15))";
        backBtn.style.borderColor = "var(--lh-accent, #a3b899)";
        backBtn.innerHTML = '<div class="meal-icon" style="background:rgba(163,184,153,0.2)">\u2190</div><div class="meal-info"><div class="meal-type" style="color:#a3b899">Back to ' + dateStr + '</div><div class="meal-name">Return to meals</div></div>';
        backBtn.onclick = function() { showingSnacks = false; render(); };
        container.appendChild(backBtn);
        var snackHeader = document.createElement("div");
        snackHeader.style.cssText = "text-align:center; padding: 16px 0 8px; color: rgba(242,235,224,0.5); font-size: 0.8rem; letter-spacing: 0.1em; text-transform: uppercase;";
        snackHeader.textContent = "Mix & match \u2022 build your own snacks";
        container.appendChild(snackHeader);
        snackMenu.forEach(function(snack) {
            var btn = document.createElement("button");
            btn.className = "meal-btn";
            btn.innerHTML = '<div class="meal-icon" style="background: rgba(163,184,153,0.15)">\u2728</div><div class="meal-info"><div class="meal-type">Snack</div><div class="meal-name">' + snack.name + '</div><div class="meal-portion">' + snack.portion + '</div></div><div class="meal-arrow">\u203a</div>';
            btn.onclick = (function(s) { return function() { openModal(s); }; })(snack);
            container.appendChild(btn);
        });
    } else {
        dualCols.style.display = "";

        // -- Helper to build meal list for a person --
        function buildMealColumn(person, day, containerEl) {
            containerEl.innerHTML = "";
            var typeIcons = { "Breakfast": "\uD83C\uDF05", "Lunch": "\u2600\uFE0F", "Dinner": "\uD83C\uDF19", "Dessert": "\uD83C\uDF68", "Snack": "\u2728" };
            var iconMap = { "sun": "\u2600\uFE0F", "moon": "\uD83C\uDF19", "star": "\u2728", "dessert": "\uD83C\uDF68" };
            day.meals.forEach(function(meal, mi) {
                var btn = document.createElement("button");
                btn.className = "meal-btn";
                var rawIcon = meal.icon || typeIcons[meal.type] || "\u2728";
                var displayIcon = iconMap[rawIcon] || rawIcon;
                btn.innerHTML = '<div class="meal-icon" style="background:rgba(163,184,153,0.15)">' + displayIcon + '</div><div class="meal-info"><div class="meal-type">' + meal.type + '</div><div class="meal-name">' + meal.name + '</div><div class="meal-portion">' + meal.portion + '</div></div><div class="meal-arrow">\u203a</div>';
                btn.onclick = (function(p, m, idx) {
                    return function() {
                        currentPerson = p;
                        openModal(m, idx);
                    };
                })(person, meal, mi);
                containerEl.appendChild(btn);
            });
        }

        buildMealColumn("kasey", kDay, document.getElementById("meals-kasey"));
        buildMealColumn("charlie", cDay, document.getElementById("meals-charlie"));

        // Snack button (full width, below columns)
        var snackBtn = document.createElement("button");
        snackBtn.className = "meal-btn dual-snack-btn";
        snackBtn.style.borderColor = "rgba(163,184,153,0.4)";
        snackBtn.style.background = "rgba(163,184,153,0.05)";
        snackBtn.style.border = "1px solid rgba(163,184,153,0.3)";
        snackBtn.style.borderRadius = "6px";
        snackBtn.innerHTML = '<div class="meal-icon" style="background: rgba(163,184,153,0.2)">\u2728</div><div class="meal-info"><div class="meal-type" style="color:#a3b899">Snack Menu</div><div class="meal-name" style="color:#a3b899">' + snackMenu.length + ' items \u2022 mix & match however you want</div><div class="meal-portion">proteins, fruits, dips, nuts & more</div></div><div class="meal-arrow" style="color:#a3b899">\u203a</div>';
        snackBtn.onclick = function() { showingSnacks = true; render(); };
        extrasDiv.appendChild(snackBtn);

        // Day notes (side by side)
        var notesDiv = document.createElement("div");
        notesDiv.className = "dual-notes";
        var noteKeyK = 'dayNote_' + currentPlanIndex + '_' + currentDay + '_kasey';
        var noteKeyC = 'dayNote_' + currentPlanIndex + '_' + currentDay + '_charlie';
        var savedNoteK = localStorage.getItem(noteKeyK) || '';
        var savedNoteC = localStorage.getItem(noteKeyC) || '';
        notesDiv.innerHTML = '<div style="font-size:0.6rem;color:rgba(224,210,208,0.3);letter-spacing:0.1em;margin-bottom:8px;text-transform:uppercase;">Day Notes</div>' +
            '<div class="dual-notes-row">' +
            '<div><div class="dual-notes-label kasey-label">' + names.name1 + '</div><textarea id="day-note-k" placeholder="How did today go?">' + savedNoteK + '</textarea></div>' +
            '<div><div class="dual-notes-label charlie-label">' + names.name2 + '</div><textarea id="day-note-c" placeholder="How did today go?">' + savedNoteC + '</textarea></div>' +
            '</div>';
        extrasDiv.appendChild(notesDiv);

        setTimeout(function() {
            var taK = document.getElementById('day-note-k');
            var taC = document.getElementById('day-note-c');
            if (taK) taK.addEventListener('input', function() { localStorage.setItem(noteKeyK, this.value); saveDayNotesToFirebase(); });
            if (taC) taC.addEventListener('input', function() { localStorage.setItem(noteKeyC, this.value); saveDayNotesToFirebase(); });
        }, 50);
    }
}


var currentModalMeal = null;
var currentModalMealIndex = -1;

// Adjust breakfast ingredients for Charlie's larger portions
function adjustIngredientsForCharlie(mealName, ingredients) {
    var ings = ingredients.slice(); // copy
    var name = (mealName || '').toLowerCase();
    
    // Determine breakfast category
    var isOats = name.indexOf('overnight') !== -1 || name.indexOf('oats') !== -1 || name.indexOf('cobbler') !== -1 || name.indexOf('cacao berry') !== -1 || name.indexOf('mango') !== -1 || name.indexOf('apple pie') !== -1 || name.indexOf('strawberry chocolate') !== -1;
    var isSmoothie = name.indexOf('smoothie') !== -1 || name.indexOf('kefir') !== -1;
    var isPancake = name.indexOf('pancake') !== -1;
    var isEggMuffin = name.indexOf('egg muffin') !== -1;
    var isParfait = name.indexOf('parfait') !== -1;
    var isToast = name.indexOf('toast') !== -1 || name.indexOf('caramelized banana') !== -1;
    
    // Apply specific swaps
    ings = ings.map(function(ing) {
        if (!ing) return ing;
        
        if (isOats) {
            // Scale up oats, whey, nuts
            if (ing === '1/2 cup rolled oats') return '3/4 cup rolled oats';
            if (ing.indexOf('1 scoop ON Gold Standard') !== -1) return '1.5 scoops ON Gold Standard Banana Cream whey';
            if (ing === '1 tbsp chopped walnuts' || ing === '1 tbsp walnuts' || ing === '1 tbsp walnuts, chopped') return '2 tbsp walnuts, chopped';
            if (ing === '1 tsp honey drizzle' || ing === '1 tsp honey') return '2 tsp honey';
            if (ing === '3 tbsp hemp hearts') return '4 tbsp hemp hearts';
        }
        
        if (isSmoothie) {
            if (ing.indexOf('1 scoop ON Gold Standard') !== -1) return '2 scoops ON Gold Standard Banana Cream whey';
            if (ing === '1/2 cup nonfat Greek yogurt') return '3/4 cup nonfat Greek yogurt';
            if (ing === '2 tbsp walnuts, chopped') return '3 tbsp walnuts, chopped';
            if (ing === '1/2 cup frozen blueberries') return '3/4 cup frozen blueberries';
            // Kefir smoothie (no whey in original)
            if (ing === '1 cup Lifeway strawberry kefir') return '1.5 cups Lifeway strawberry kefir';
            if (ing === '1/2 banana') return '1 banana';
            if (ing === '1/2 cup frozen mixed berries') return '3/4 cup frozen mixed berries';
        }
        
        if (isPancake) {
            if (ing.indexOf('1/3 cup') !== -1 && ing.indexOf('oats') !== -1) return ing.replace('1/3 cup', '1/2 cup');
            if (ing === '1 egg') return '2 eggs';
            if (ing === '1/4 cup nonfat Greek yogurt') return '1/3 cup nonfat Greek yogurt';
            if (ing.indexOf('1/4 cup') !== -1 && ing.indexOf('berries') !== -1) return ing.replace('1/4 cup', '1/3 cup');
            if (ing === '1 tbsp chopped walnuts' || ing === '1 tbsp walnuts, chopped') return '2 tbsp walnuts, chopped';
            if (ing.indexOf('1 scoop ON Gold Standard') !== -1) return '1.5 scoops ON Gold Standard Banana Cream whey';
        }
        
        if (isEggMuffin) {
            if (ing.indexOf('EGG MUFFIN CUPS (x2)') !== -1) return '--- EGG MUFFIN CUPS (x3) ---';
            if (ing === '2 eggs (from batch)') return '3 eggs (from batch)';
        }
        
        if (isParfait) {
            if (ing === '1 cup Oikos Triple Zero vanilla Greek yogurt') return '1.5 cups Oikos Triple Zero vanilla Greek yogurt';
            if (ing === '2 tbsp walnuts, chopped') return '3 tbsp walnuts, chopped';
            if (ing === '1 tsp honey drizzle') return '2 tsp honey drizzle';
            if (ing === '1/2 cup fresh strawberries, sliced') return '3/4 cup fresh strawberries, sliced';
        }
        
        if (isToast) {
            if (ing.indexOf('1 slice') !== -1 && ing.indexOf('bread') !== -1) return '2 slices ' + ing.replace('1 slice ', '');
            if (ing === '1 medium banana, sliced lengthwise') return '1.5 bananas, sliced lengthwise';
            if (ing === '2 tbsp almond butter') return '3 tbsp almond butter';
        }
        
        return ing;
    });
    
    // Add a Charlie header
    ings.unshift('--- CHARLIE\'S PORTIONS ---');
    
    // Add extra ingredients for specific breakfasts
    if (isSmoothie && name.indexOf('kefir') !== -1) {
        // Kefir smoothie has no whey — add one for Charlie
        var kefirIdx = -1;
        for (var i = 0; i < ings.length; i++) {
            if (ings[i] && ings[i].indexOf('kefir') !== -1) { kefirIdx = i; break; }
        }
        if (kefirIdx >= 0) ings.splice(kefirIdx + 1, 0, '1 scoop ON Gold Standard Banana Cream whey (Charlie add-on)');
    }
    if (isEggMuffin) {
        // Add toast with nut butter
        ings.push('--- CHARLIE ADD-ON ---');
        ings.push('1 slice Ezekiel bread, toasted');
        ings.push('1 tbsp almond butter');
    }
    
    return ings;
}

function openModal(meal, mealIndex) {
    currentModalMeal = meal;
    currentModalMealIndex = (typeof mealIndex === 'number') ? mealIndex : -1;
    
    var modal = document.getElementById("modal");
    var header = document.getElementById("modal-header");
    var isCharlie = (currentPerson === 'charlie');
    var names = (window.LifeHubSettings && window.LifeHubSettings.current.names) || {name1:'Kasey',name2:'Charlie'};
    var personName = isCharlie ? names.name2 : names.name1;
    var kaseyName = names.name1;
    var charlieName = names.name2;
    
    // Person-aware header color (cached computed styles)
    var cs = getComputedStyle(document.documentElement);
    var accentColor = cs.getPropertyValue('--lh-accent').trim() || '#a3b899';
    var secondaryColor = cs.getPropertyValue('--lh-secondary').trim() || '#e8b4b8';
    var headerColor = isCharlie ? (meal.color || accentColor) : secondaryColor;
    header.style.background = headerColor;
    
    // Apply person-color class to entire modal (Kasey = pink, Charlie = green)
    if (!isCharlie) {
        modal.classList.add('kasey-modal');
    } else {
        modal.classList.remove('kasey-modal');
    }
    
    // Person badge — only show for plan meals (not recipe bank or prep sessions)
    var badge = document.getElementById("modal-person-badge");
    if (currentModalMealIndex >= 0) {
        badge.textContent = personName + "\u2019s portion";
        badge.style.background = "rgba(0,0,0,0.15)";
        badge.style.color = "var(--dark-bg)";
        badge.style.display = "inline-block";
    } else {
        badge.style.display = "none";
    }
    
    // Tint section headers for person color (Kasey=pink, Charlie=green)
    var sectionHeaders = modal.querySelectorAll('.modal-section h4');
    sectionHeaders.forEach(function(h) {
        h.style.color = isCharlie ? '' : secondaryColor;
    });
    // Tint swap button for person color
    var swapBtn = document.getElementById('modal-swap-btn');
    if (swapBtn) {
        if (!isCharlie) {
            swapBtn.style.background = 'var(--lh-secondary-muted)';
            swapBtn.style.borderColor = 'var(--lh-secondary-border)';
            swapBtn.style.color = secondaryColor;
        } else {
            swapBtn.style.background = '';
            swapBtn.style.borderColor = '';
            swapBtn.style.color = '';
        }
    }
    
    document.getElementById("modal-title").textContent = meal.name;
    document.getElementById("modal-meta").textContent = meal.portions.join(" \u2022 ");
    
    var ingList = document.getElementById("modal-ingredients");
    ingList.innerHTML = "";
    
    // Build the display ingredients — person-specific adjustments
    var displayIngredients = meal.ingredients.slice(); // copy
    if (currentPerson === 'charlie' && meal.type === 'Breakfast') {
        displayIngredients = adjustIngredientsForCharlie(meal.name, displayIngredients);
    } else if (currentPerson === 'kasey' && meal.type === 'Breakfast') {
        displayIngredients.unshift('--- ' + kaseyName.toUpperCase() + "'" + (kaseyName.toUpperCase().slice(-1) === 'S' ? '' : 'S') + ' PORTIONS ---');
    }
    
    displayIngredients.forEach(function(ing) {
        if (!ing || ing.trim() === '') return; // skip empty lines
        var li = document.createElement("li");
        if (ing.indexOf("---") === 0) {
            var divColor = isCharlie ? 'var(--sage-green)' : 'var(--lh-secondary, #e8b4b8)';
            li.innerHTML = '<span></span><div class="step-text"><strong style="color:' + divColor + '; font-size: 0.75rem; letter-spacing: 0.05em;">' + ing.replace(/---/g, "").trim() + '</strong></div>';
        } else if (ing.indexOf("═══") !== -1 || ing.indexOf("===") !== -1) {
            var isWarning = ing.indexOf("⚠️") !== -1 || ing.indexOf("ADJUST") !== -1;
            var ingHeaderColor = isWarning ? "#c9a84c" : "var(--sage-green)";
            li.innerHTML = '<span></span><div class="step-text"><strong style="color:' + ingHeaderColor + '; font-size: 0.72rem; letter-spacing: 0.04em; border-top: 1px solid rgba(163,184,153,0.2); padding-top: 8px; margin-top: 4px; display: block;">' + ing.replace(/[═=]+/g, "").trim() + '</strong></div>';
        } else if (ing.indexOf("→") === 0) {
            var isSwapNote = ing.indexOf("SKIP") !== -1 || ing.indexOf("REDUCE") !== -1 || ing.indexOf("ADD") !== -1;
            var arrowColor = isSwapNote ? "color:#c9a84c;" : "opacity:0.5;";
            var textStyle = isSwapNote ? "font-size:0.75rem;color:#c9a84c;" : "opacity:0.5;font-size:0.72rem;";
            li.innerHTML = '<span style="' + arrowColor + '">→</span><div class="step-text" style="' + textStyle + '">' + ing.substring(1).trim() + '</div>';
        } else if (ing.indexOf("\u21b9") === 0 || ing.indexOf("\u26a1") === 0) {
            li.innerHTML = '<span style="color:#c9a84c;font-size:0.7rem;">\u21b9</span><div class="step-text" style="font-size:0.75rem;color:#c9a84c;font-style:italic;">' + ing.substring(1).trim() + '</div>';
        } else {
            li.innerHTML = '<span>\u2022</span><div class="step-text">' + ing + '</div>';
        }
        ingList.appendChild(li);
    });
    
    var stepList = document.getElementById("modal-steps");
    stepList.innerHTML = "";
    var plateColor = isCharlie ? accentColor : secondaryColor;
    meal.steps.forEach(function(step, i) {
        var li = document.createElement("li");
        var displayStep = step;
        
        // Person-aware plating: highlight your portions, dim other person's
        if (step.indexOf('PLATE FOR TWO') !== -1 && currentModalMealIndex >= 0) {
            var pName = isCharlie ? charlieName : kaseyName;
            var oName = isCharlie ? kaseyName : charlieName;
            var pLow = pName.toLowerCase();
            var oLow = oName.toLowerCase();
            var raw = step.replace(/^PLATE FOR TWO:\s*/i, '');
            // Split into sentences, then classify each
            var sentences = raw.split(/(?<=\.)\s*/);
            var styled = [];
            sentences.forEach(function(sent) {
                if (!sent.trim()) return;
                // Split sentence into clauses on commas for finer classification
                var clauses = sent.split(/,\s*/);
                var styledClauses = [];
                clauses.forEach(function(cl) {
                    var low = cl.toLowerCase();
                    var hasMine = low.indexOf(pLow) !== -1;
                    var hasOther = low.indexOf(oLow) !== -1;
                    if (hasMine && !hasOther) {
                        styledClauses.push('<strong style="color:' + plateColor + '">' + cl + '</strong>');
                    } else if (hasOther && !hasMine) {
                        styledClauses.push('<span style="opacity:0.35">' + cl + '</span>');
                    } else if (hasMine && hasOther) {
                        // Both names in one clause — show full text, bold mine
                        var bolded = cl.replace(new RegExp('(' + pName + ')', 'gi'), '<strong style="color:' + plateColor + '">$1</strong>');
                        styledClauses.push(bolded);
                    } else {
                        styledClauses.push(cl);
                    }
                });
                styled.push(styledClauses.join(', '));
            });
            displayStep = '🍽 ' + styled.join(' ');
        }
        
        var formatted = displayStep.replace(/\n/g, '<br>');
        li.innerHTML = '<span class="step-number">' + (i + 1) + '</span><div class="step-text">' + formatted + '</div>';
        stepList.appendChild(li);
    });
    
    var tipBox = document.getElementById("modal-tip");
    if (meal.tip) {
        tipBox.style.display = "block";
        tipBox.querySelector("p").innerHTML = meal.tip.replace(/\n\n/g, "<br><br>");
    } else {
        tipBox.style.display = "none";
    }
    
    var portions = document.getElementById("modal-portions");
    var portionsHtml = '';
    meal.portions.forEach(function(p) {
        portionsHtml += '<span class="portion-tag">' + p + '</span>';
    });
    
    // Add person-specific boost notes (Charlie's portion scaling, Kasey's supplement notes)
    var charlieBoost = '';
    var kaseyBoost = '';
    if (meal.type === 'Breakfast') {
        if (isCharlie) {
            var mealName = (meal.name || '').toLowerCase();
            if (mealName.indexOf('overnight') !== -1 || mealName.indexOf('oats') !== -1 || mealName.indexOf('breakfast bowl') !== -1 || mealName.indexOf('cobbler') !== -1 || mealName.indexOf('mango') !== -1 || mealName.indexOf('cacao berry') !== -1 || mealName.indexOf('strawberry chocolate') !== -1) {
                charlieBoost = '💪 ' + charlieName.toUpperCase() + '\'S BOOST: Use ¾ cup oats (not ½), add extra ½ scoop whey, and double the nut topping. Adds ~15g protein and ~150 cal.';
            } else if (mealName.indexOf('smoothie') !== -1 || mealName.indexOf('kefir') !== -1) {
                charlieBoost = '💪 ' + charlieName.toUpperCase() + '\'S BOOST: Add 1 extra scoop whey + 1 tbsp nut butter. Adds ~25g protein and ~200 cal.';
            } else if (mealName.indexOf('pancake') !== -1) {
                charlieBoost = '💪 ' + charlieName.toUpperCase() + '\'S BOOST: Make 1 extra pancake (add 1 more egg + ¼ cup oat flour to batter). Top with extra walnuts. Adds ~15g protein and ~180 cal.';
            } else if (mealName.indexOf('egg muffin') !== -1) {
                charlieBoost = '💪 ' + charlieName.toUpperCase() + '\'S BOOST: Eat 3 muffin cups instead of 2. Add a piece of toast with 1 tbsp peanut-free nut butter. Adds ~15g protein and ~200 cal.';
            } else if (mealName.indexOf('parfait') !== -1) {
                charlieBoost = '💪 ' + charlieName.toUpperCase() + '\'S BOOST: Use 1 full cup yogurt (not ¾). Add extra scoop of granola and double the nuts. Adds ~12g protein and ~150 cal.';
            } else if (mealName.indexOf('toast') !== -1 || mealName.indexOf('banana') !== -1) {
                charlieBoost = '💪 ' + charlieName.toUpperCase() + '\'S BOOST: Use 2 slices of bread instead of 1. Add 1 tbsp almond butter + extra banana. Adds ~10g protein and ~200 cal.';
            } else {
                charlieBoost = '💪 ' + charlieName.toUpperCase() + '\'S BOOST: Add an extra ½ scoop whey + 1 tbsp nut butter to hit your higher protein target. Adds ~15g protein and ~150 cal.';
            }
        } else {
            var mealName = (meal.name || '').toLowerCase();
            if (mealName.indexOf('overnight') !== -1 || mealName.indexOf('oats') !== -1 || mealName.indexOf('cobbler') !== -1 || mealName.indexOf('cacao berry') !== -1 || mealName.indexOf('mango') !== -1 || mealName.indexOf('apple pie') !== -1 || mealName.indexOf('strawberry chocolate') !== -1) {
                kaseyBoost = '\u2728 ' + kaseyName.toUpperCase() + ': Collagen + L-glutamine are blended in for gut lining repair. MCT oil helps absorb fat-soluble vitamins. This is your full supplement stack — no extra pills needed.';
            } else if (mealName.indexOf('smoothie') !== -1 || mealName.indexOf('kefir') !== -1) {
                kaseyBoost = '\u2728 ' + kaseyName.toUpperCase() + ': Your supplement stack (collagen, L-glutamine, MCT oil) blends right in. The blueberries add anthocyanins — one of the most potent anti-cancer compounds in fruit.';
            } else if (mealName.indexOf('pancake') !== -1) {
                kaseyBoost = '\u2728 ' + kaseyName.toUpperCase() + ': Full supplement stack baked into the batter — collagen, L-glutamine, MCT oil all heat-stable at this temp. Berries on top add antioxidants.';
            } else if (mealName.indexOf('egg muffin') !== -1) {
                kaseyBoost = '\u2728 ' + kaseyName.toUpperCase() + ': 2 muffin cups hit your calorie target without overshooting. Take your collagen + L-glutamine in coffee or a small smoothie on the side.';
            } else if (mealName.indexOf('parfait') !== -1) {
                kaseyBoost = '\u2728 ' + kaseyName.toUpperCase() + ': Greek yogurt probiotics support the gut lining your L-glutamine is repairing. Strawberry ellagic acid is a studied anti-cancer compound. Light and effective.';
            } else if (mealName.indexOf('toast') !== -1 || mealName.indexOf('banana') !== -1) {
                kaseyBoost = '\u2728 ' + kaseyName.toUpperCase() + ': One slice keeps you in your calorie window. Take collagen + L-glutamine in coffee or tea alongside. The almond butter provides vitamin E.';
            } else {
                kaseyBoost = '\u2728 ' + kaseyName.toUpperCase() + ': Your supplement stack (collagen, L-glutamine, MCT oil) should be taken with this meal for best absorption with fats and protein.';
            }
        }
    }
    if (charlieBoost) {
        portionsHtml += '<div style="width:100%;margin-top:4px;padding:8px 10px;background:rgba(201,168,76,0.12);border:1px solid rgba(201,168,76,0.25);border-radius:4px;font-size:0.72rem;color:#c9a84c;letter-spacing:0.01em;line-height:1.4;">' + charlieBoost + '</div>';
    }
    if (kaseyBoost) {
        portionsHtml += '<div style="width:100%;margin-top:4px;padding:8px 10px;background:var(--lh-secondary-muted, rgba(232,180,184,0.12));border:1px solid var(--lh-secondary-border, rgba(232,180,184,0.25));border-radius:4px;font-size:0.72rem;color:var(--lh-secondary, #e8b4b8);letter-spacing:0.01em;line-height:1.4;">' + kaseyBoost + '</div>';
    }
    portions.innerHTML = portionsHtml;
    
    // Show swap button only for plan meals (not snacks or prep sessions)
    var swapSection = document.getElementById('modal-swap-section');
    var swapList = document.getElementById('modal-swap-list');
    if (swapSection) {
        swapSection.style.display = (currentModalMealIndex >= 0 && meal.type) ? 'block' : 'none';
        swapList.style.display = 'none';
    }
    
    modal.classList.add("active");
}

function closeModal() {
    document.getElementById("modal").classList.remove("active");
}

function showSwapOptions() {
    if (!currentModalMeal || currentModalMealIndex < 0) return;
    var swapList = document.getElementById('modal-swap-list');
    var mealType = currentModalMeal.type; // Breakfast, Lunch, Dinner, Dessert
    
    // Find alternatives from recipe bank
    var alternatives = [];
    var currentName = currentModalMeal.name;
    
    // First check recipe bank
    recipeBank.forEach(function(recipe) {
        if (recipe.name === currentName) return;
        if (recipe.type === mealType) {
            alternatives.push(recipe);
        }
    });
    
    // Also check all meals in the current plan for same type
    var data = getData();
    var seen = {};
    seen[currentName] = true;
    data.days.forEach(function(day) {
        day.meals.forEach(function(m) {
            if (m.type === mealType && !seen[m.name] && m.ingredients) {
                seen[m.name] = true;
                alternatives.push(m);
            }
        });
    });
    
    if (alternatives.length === 0) {
        swapList.innerHTML = '<div style="padding:12px;text-align:center;color:rgba(224,210,208,0.4);font-size:0.75rem;">No alternatives found. Add more recipes to your bank!</div>';
        swapList.style.display = 'block';
        return;
    }
    
    var html = '<div style="font-size:0.65rem;color:rgba(224,210,208,0.35);letter-spacing:0.08em;text-transform:uppercase;margin-bottom:8px;">Pick a replacement:</div>';
    alternatives.forEach(function(alt, i) {
        html += '<button onclick="swapMeal(' + i + ')" style="width:100%;display:flex;justify-content:space-between;align-items:center;padding:10px 12px;margin-bottom:4px;background:rgba(61,47,49,0.5);border:1px solid var(--border-color);border-radius:6px;color:var(--light-text);font-family:\'Philosopher\',serif;font-size:0.78rem;cursor:pointer;text-align:left;">' +
            '<span>' + alt.name + '</span>' +
            '<span style="opacity:0.5;font-size:0.7rem;">' + (alt.portion || '') + '</span>' +
            '</button>';
    });
    
    swapList.innerHTML = html;
    swapList.style.display = 'block';
    
    // Store alternatives for selection
    window._swapAlternatives = alternatives;
}

function swapMeal(altIndex) {
    var alt = window._swapAlternatives[altIndex];
    if (!alt || currentModalMealIndex < 0) return;
    
    var data = getData();
    var day = data.days[currentDay - 1];
    var oldMeal = day.meals[currentModalMealIndex];
    
    // Replace the meal, keep the original icon/type
    var newMeal = JSON.parse(JSON.stringify(alt));
    if (!newMeal.icon) {
        var fallbackIcons = { "Breakfast": "🌅", "Lunch": "☀️", "Dinner": "🌙", "Dessert": "🍨", "Snack": "✨" };
        newMeal.icon = oldMeal.icon || fallbackIcons[newMeal.type] || "✨";
    }
    if (!newMeal.type && oldMeal.type) newMeal.type = oldMeal.type;
    day.meals[currentModalMealIndex] = newMeal;
    
    // Save to Firebase
    saveAllPlansToFirebase();
    
    // Close modal and re-render
    closeModal();
    render();
}

document.getElementById("modal").addEventListener("click", function(e) {
    if (e.target === this) closeModal();
});

document.addEventListener("keydown", function(e) {
    if (e.key === "Escape") closeModal();
});


function render() {
    renderPlanSelector();
    renderProgress();
    renderCalendar();
    renderDayDetail();
}

render();
</script>
<script>
function toggleNav() {
    var h = document.getElementById('navHamburger');
    var o = document.getElementById('navOverlay');
    if (!h || !o) return;
    var isOpen = o.classList.contains('open');
    if (isOpen) {
        h.classList.remove('open');
        o.classList.remove('open');
        document.body.style.overflow = '';
    } else {
        h.classList.add('open');
        o.classList.add('open');
        document.body.style.overflow = 'hidden';
    }
}

// ===== TAB SWITCHING =====
function switchTab(tab) {
    document.querySelectorAll('.page-tab').forEach(function(t) { t.classList.remove('active'); });
    document.querySelectorAll('.tab-view').forEach(function(v) { v.classList.remove('active'); });
    document.querySelector('.page-tab[onclick*="' + tab + '"]').classList.add('active');
    document.getElementById(tab + '-view').classList.add('active');
    if (tab === 'recipes') renderRecipeBank();
    if (tab === 'generate') initGenerateView();
}

// ===== RECIPE BANK =====
var recipeBank = [];
var rbFilter = 'all';
var rbSearch = '';

function extractRecipesFromPlan() {
    var recipes = [];
    var seen = {};
    mealData.kasey.days.forEach(function(day) {
        day.meals.forEach(function(meal) {
            var key = meal.name;
            if (seen[key]) { seen[key].timesUsed++; return; }
            var proteinMatch = meal.portion.match(/(\d+)g protein/);
            var calMatch = meal.portion.match(/(\d+)\s*cal/);
            var timeMatch = (meal.portions || []).join(' ').match(/(\d+)\s*min/);
            var recipe = {
                id: 'r_' + recipes.length + '_' + Math.random().toString(36).substr(2,6),
                name: meal.name, type: meal.type,
                protein: proteinMatch ? parseInt(proteinMatch[1]) : 0,
                calories: calMatch ? parseInt(calMatch[1]) : 0,
                prepTime: timeMatch ? parseInt(timeMatch[1]) : 0,
                ingredients: meal.ingredients || [], steps: meal.steps || [],
                tip: meal.tip || '', portion: meal.portion || '',
                portions: meal.portions || [], color: meal.color || '#a3b899',
                cuisineTags: guessCuisine(meal.name, meal.ingredients),
                favorite: false, timesUsed: 1, source: 'original'
            };
            seen[key] = recipe;
            recipes.push(recipe);
        });
    });
    snackMenu.forEach(function(s, i) {
        recipes.push({
            id: 'r_s' + i + '_' + Math.random().toString(36).substr(2,6),
            name: s.name, type: 'Snack',
            protein: parseInt((s.portion || '').match(/(\d+)g/)?.[1] || 0),
            calories: parseInt((s.portion || '').match(/(\d+)\s*cal/)?.[1] || 0),
            prepTime: 0, ingredients: s.ingredients || [], steps: s.steps || [],
            tip: s.tip || '', portion: s.portion || '',
            portions: s.portions || [], color: s.color || '#7d8f76',
            cuisineTags: [], favorite: false, timesUsed: 0, source: 'original'
        });
    });
    
    // Include Pinterest-inspired & bonus recipes
    if (typeof additionalRecipes !== 'undefined') {
        additionalRecipes.forEach(function(r, i) {
            var pm = (r.portion || '').match(/(\d+)g protein/);
            var cm = (r.portion || '').match(/(\d+)\s*cal/);
            var exists = recipes.some(function(existing) { return existing.name === r.name; });
            if (!exists) {
                recipes.push({
                    id: 'r_bonus_' + i + '_' + Math.random().toString(36).substr(2,6),
                    name: r.name, type: r.type,
                    protein: pm ? parseInt(pm[1]) : 0,
                    calories: cm ? parseInt(cm[1]) : 0,
                    prepTime: 0, ingredients: r.ingredients || [], steps: r.steps || [],
                    tip: r.tip || '', portion: r.portion || '',
                    portions: r.portions || [], color: r.color || '#a3b899',
                    cuisineTags: guessCuisine(r.name, r.ingredients),
                    favorite: false, timesUsed: 0, source: 'bonus'
                });
            }
        });
    }

    return recipes;
}

function guessCuisine(name, ingredients) {
    var n = (name + ' ' + ingredients.join(' ')).toLowerCase();
    var tags = [];
    if (n.match(/chipotle|enchilada|burrito|taco|mexican|salsa|cumin/)) tags.push('Mexican');
    if (n.match(/asian|soy sauce|ginger|sesame/)) tags.push('Asian');
    if (n.match(/alfredo|orzo|marinara|italian|basil|parmesan|ricotta|mozzarella|bolognese/)) tags.push('Italian');
    if (n.match(/lemon|farro|olive oil|chickpea|mediterranean|feta/)) tags.push('Mediterranean');
    if (n.match(/smoothie|oats|parfait|muffin/)) tags.push('American');
    if (tags.length === 0) tags.push('American');
    return tags;
}

function saveCustomRecipe() {
    var name = document.getElementById('ar-name').value.trim();
    var type = document.getElementById('ar-type').value;
    var protein = parseInt(document.getElementById('ar-protein').value) || 0;
    var cal = parseInt(document.getElementById('ar-cal').value) || 0;
    var ingredientsRaw = document.getElementById('ar-ingredients').value.trim();
    var stepsRaw = document.getElementById('ar-steps').value.trim();
    var tip = document.getElementById('ar-tip').value.trim();
    
    if (!name) { alert('Please enter a recipe name.'); return; }
    if (!ingredientsRaw) { alert('Please enter at least one ingredient.'); return; }
    
    var ingredients = ingredientsRaw.split('\n').map(function(s) { return s.trim(); }).filter(Boolean);
    var steps = stepsRaw ? stepsRaw.split('\n').map(function(s) { return s.trim(); }).filter(Boolean) : ['Prepare as desired.'];
    
    var recipe = {
        id: 'r_custom_' + Date.now() + '_' + Math.random().toString(36).substr(2,6),
        name: name,
        type: type,
        protein: protein,
        calories: cal,
        prepTime: 0,
        ingredients: ingredients,
        steps: steps,
        tip: tip || '',
        portion: protein + 'g protein - ' + cal + ' cal',
        portions: [protein + 'g protein', cal + ' cal'],
        color: type === 'Dessert' ? '#c4a882' : '#a3b899',
        cuisineTags: guessCuisine(name, ingredients),
        favorite: false,
        timesUsed: 0,
        source: 'custom'
    };
    
    recipeBank.push(recipe);
    saveRecipeBankToFirebase();
    renderRecipeBank();
    
    // Clear form
    document.getElementById('ar-name').value = '';
    document.getElementById('ar-protein').value = '';
    document.getElementById('ar-cal').value = '';
    document.getElementById('ar-ingredients').value = '';
    document.getElementById('ar-steps').value = '';
    document.getElementById('ar-tip').value = '';
    document.getElementById('add-recipe-form').style.display = 'none';
}

function setRecipeFilter(filter, btn) {
    rbFilter = filter;
    document.querySelectorAll('.rb-filter').forEach(function(f) { f.classList.remove('active'); });
    btn.classList.add('active');
    renderRecipeBank();
}

function filterRecipes() {
    rbSearch = document.getElementById('rb-search').value.toLowerCase();
    renderRecipeBank();
}

function renderRecipeBank() {
    var grid = document.getElementById('rb-grid');
    var count = document.getElementById('rb-count');
    grid.innerHTML = '';
    
    var filtered = recipeBank.filter(function(r) {
        if (rbFilter === 'favorites' && !r.favorite) return false;
        if (rbFilter !== 'all' && rbFilter !== 'favorites' && r.type !== rbFilter) return false;
        if (rbSearch && r.name.toLowerCase().indexOf(rbSearch) === -1 && 
            r.cuisineTags.join(' ').toLowerCase().indexOf(rbSearch) === -1 &&
            r.ingredients.join(' ').toLowerCase().indexOf(rbSearch) === -1) return false;
        return true;
    });
    
    filtered.sort(function(a, b) {
        if (a.favorite && !b.favorite) return -1;
        if (!a.favorite && b.favorite) return 1;
        // In "All" view, push Snacks to the bottom
        if (rbFilter === 'all' || rbFilter === 'favorites') {
            var aSnack = a.type === 'Snack' ? 1 : 0;
            var bSnack = b.type === 'Snack' ? 1 : 0;
            if (aSnack !== bSnack) return aSnack - bSnack;
        }
        return a.name.localeCompare(b.name);
    });
    
    count.textContent = filtered.length + ' recipe' + (filtered.length !== 1 ? 's' : '');
    
    if (filtered.length === 0) {
        grid.innerHTML = '<div class="rb-empty">No recipes found</div>';
        return;
    }
    
    filtered.forEach(function(r) {
        var card = document.createElement('div');
        card.className = 'rb-card';
        card.onclick = function(e) {
            if (e.target.closest('.rb-card-fav')) return;
            openModal({ name: r.name, color: r.color, portions: r.portions, ingredients: r.ingredients, steps: r.steps, tip: r.tip });
        };
        var tagClass = 'rb-tag-' + r.type.toLowerCase();
        var cuisineHtml = r.cuisineTags.map(function(t) { return '<span class="rb-tag rb-tag-cuisine">' + t + '</span>'; }).join('');
        card.innerHTML = '<div class="rb-card-top">' +
            '<span class="rb-card-name">' + r.name + '</span>' +
            '<button class="rb-card-fav ' + (r.favorite ? 'favorited' : '') + '" onclick="toggleFavorite(\'' + r.id + '\')">' + (r.favorite ? '♥' : '♡') + '</button>' +
            '</div>' +
            '<div class="rb-card-meta"><span>' + r.protein + 'g protein</span><span>' + r.calories + ' cal</span>' + (r.prepTime ? '<span>' + r.prepTime + ' min</span>' : '') + '</div>' +
            '<div class="rb-card-tags"><span class="rb-tag ' + tagClass + '">' + r.type + '</span>' + cuisineHtml + '</div>';
        grid.appendChild(card);
    });
}

function toggleFavorite(id) {
    recipeBank.forEach(function(r) { if (r.id === id) r.favorite = !r.favorite; });
    saveRecipeBankToFirebase();
    renderRecipeBank();
}

// ===== FIREBASE FOR RECIPE BANK =====
var fbReady = false;

function saveRecipeBankToFirebase() {
    if (!window.fbReady) { localStorage.setItem('mealplan_recipes', JSON.stringify(recipeBank)); return; }
    try {
        var imports = window.firestoreImports;
        imports.setDoc(imports.doc(window.db, 'mealPlanData', 'recipeBank'), {
            recipes: JSON.stringify(recipeBank), updatedAt: new Date().toISOString()
        });
    } catch(e) { localStorage.setItem('mealplan_recipes', JSON.stringify(recipeBank)); }
}

function loadRecipeBankFromFirebase(callback) {
    if (!window.fbReady) {
        var saved = localStorage.getItem('mealplan_recipes');
        if (saved) recipeBank = JSON.parse(saved);
        callback();
        return;
    }
    try {
        var imports = window.firestoreImports;
        imports.getDoc(imports.doc(window.db, 'mealPlanData', 'recipeBank')).then(function(snap) {
            if (snap.exists() && snap.data().recipes) recipeBank = JSON.parse(snap.data().recipes);
            callback();
        }).catch(function() { callback(); });
    } catch(e) { callback(); }
}

function savePlanToFirebase(planObj) {
    if (!window.fbReady) { localStorage.setItem('mealplan_current', JSON.stringify(planObj)); return; }
    try {
        var imports = window.firestoreImports;
        imports.setDoc(imports.doc(window.db, 'mealPlanData', 'currentPlan'), {
            plan: JSON.stringify(planObj), updatedAt: new Date().toISOString()
        });
    } catch(e) { localStorage.setItem('mealplan_current', JSON.stringify(planObj)); }
}

function initRecipeBank() {
    loadRecipeBankFromFirebase(function() {
        if (recipeBank.length === 0) {
            recipeBank = extractRecipesFromPlan();
            saveRecipeBankToFirebase();
        } else {
            // Always merge in new recipes that may be missing from saved bank
            var existingNames = {};
            recipeBank.forEach(function(r) { existingNames[r.name] = true; });
            var added = 0;
            var allSources = extractRecipesFromPlan();
            allSources.forEach(function(r) {
                if (!existingNames[r.name]) {
                    recipeBank.push(r);
                    existingNames[r.name] = true;
                    added++;
                }
            });
            if (added > 0) saveRecipeBankToFirebase();
        }
        // Consolidate duplicate recipe variants (same recipe, different names)
        var renameMap = { 'Berry Crumble': 'Warm Mixed Berry Crumble', 'Berry Crumble for Two': 'Warm Mixed Berry Crumble' };
        recipeBank.forEach(function(r) { if (renameMap[r.name]) r.name = renameMap[r.name]; });
        // Deduplicate by name — keep first occurrence (preserves favorites)
        var seen = {};
        var deduped = [];
        recipeBank.forEach(function(r) {
            if (!seen[r.name]) {
                seen[r.name] = true;
                deduped.push(r);
            }
        });
        if (deduped.length < recipeBank.length) {
            recipeBank = deduped;
            saveRecipeBankToFirebase();
        }
    });
}

// ===== GENERATE PLAN =====
// ===== DIETARY REMINDERS =====
var dietaryReminders = [
    "Anti-cancer Mediterranean focus",
    "No avocado (except choc mousse)",
    "No peanut butter",
    "No mushrooms",
    "No raw/chunky tomatoes — marinara, tomato sauce & sun-dried OK",
    "No olives",
    "No artichoke hearts",
    "No cilantro",
    "No turmeric",
    "Bell peppers as supporting only",
    "Heavily glazed fish only",
    "Love spice"
];

function loadDietaryReminders() {
    var defaults = dietaryReminders.slice(); // copy the hardcoded defaults
    var saved = localStorage.getItem('mealplan_diet_reminders');
    if (saved) {
        try {
            var parsed = JSON.parse(saved);
            // Merge: add any new defaults not already in saved list
            defaults.forEach(function(d) {
                var found = parsed.some(function(s) { return s.toLowerCase() === d.toLowerCase(); });
                if (!found) parsed.push(d);
            });
            // Remove old merged reminder if we split it into separate ones
            parsed = parsed.filter(function(s) {
                return s !== 'No chunky/raw tomatoes or olives — marinara & cooked sauces OK';
            });
            dietaryReminders = parsed;
            saveDietaryReminders();
        } catch(e) {}
    }
}
loadDietaryReminders();

function saveDietaryReminders() {
    localStorage.setItem('mealplan_diet_reminders', JSON.stringify(dietaryReminders));
}

function renderDietTags() {
    var container = document.getElementById('diet-tags');
    if (!container) return;
    container.innerHTML = dietaryReminders.map(function(tag, i) {
        return '<span class="diet-tag">' + tag + '<button onclick="removeDietTag(' + i + ')">×</button></span>';
    }).join('');
}

function addDietTag() {
    var input = document.getElementById('diet-tag-input');
    var val = input.value.trim();
    if (!val) return;
    dietaryReminders.push(val);
    saveDietaryReminders();
    renderDietTags();
    input.value = '';
}

function removeDietTag(index) {
    dietaryReminders.splice(index, 1);
    saveDietaryReminders();
    renderDietTags();
}

function getDietaryRestrictionsForPrompt() {
    if (dietaryReminders.length === 0) return 'None specified.';
    return 'YOU MUST FOLLOW ALL OF THESE — they are hard restrictions from the user:\n' + 
        dietaryReminders.map(function(r, i) { return (i+1) + '. ' + r; }).join('\n');
}

// ===== DAY NOTES =====
var dayNotesSaveTimer = null;
function saveDayNotesToFirebase() {
    clearTimeout(dayNotesSaveTimer);
    dayNotesSaveTimer = setTimeout(function() {
        if (!window.db) return;
        // Collect all day notes from localStorage
        var allNotes = {};
        for (var i = 0; i < localStorage.length; i++) {
            var key = localStorage.key(i);
            if (key.indexOf('dayNote_') === 0) {
                allNotes[key] = localStorage.getItem(key);
            }
        }
        try {
            var imports = window.firestoreImports;
            imports.setDoc(imports.doc(window.db, 'mealPlanData', 'dayNotes'), { notes: allNotes });
        } catch(e) { console.error('Day notes save error:', e); }
    }, 1500); // Debounce 1.5s
}

function loadDayNotesFromFirebase() {
    if (!window.db) return;
    try {
        var imports = window.firestoreImports;
        imports.getDoc(imports.doc(window.db, 'mealPlanData', 'dayNotes')).then(function(snap) {
            if (snap.exists() && snap.data().notes) {
                var notes = snap.data().notes;
                Object.keys(notes).forEach(function(key) {
                    if (!localStorage.getItem(key)) {
                        localStorage.setItem(key, notes[key]);
                    }
                });
            }
        });
    } catch(e) { console.error('Day notes load error:', e); }
}

// ===== GROCERY LIST =====
var groceryData = [];

var GROCERY_CATEGORIES = {
    'Produce': ['spinach','baby spinach','onion','garlic','lemon','lime','carrots','carrot','strawberries','strawberry','blueberries','blueberry','berries','banana','apple','mango','pineapple','parsley','basil','ginger','jalapeño','tomato','tomatoes','lettuce','arugula','kale','zucchini','cucumber','celery','bell pepper','broccoli','cauliflower','sweet potato','potato','green onion','scallion','fresh'],
    'Protein': ['chicken','turkey','beef','salmon','shrimp','fish','egg','eggs','ground turkey','ground beef','chicken breast','pork','steak','tuna','sausage','bacon'],
    'Dairy': ['cheese','yogurt','greek yogurt','milk','almond milk','sour cream','cream','butter','feta','parmesan','mozzarella','string cheese','coconut milk','cream cheese','cottage cheese','ricotta'],
    'Grains & Bread': ['rice','brown rice','oats','rolled oats','farro','quinoa','tortilla','tortillas','bread','spaghetti','pasta','noodle','pita','wrap','bun','orzo','protein pasta'],
    'Canned & Jarred': ['black beans','cannellini','chickpeas','beans','marinara','salsa','chipotle','adobo','roasted red pepper','tomato sauce','broth','olives','corn','enchilada sauce','sun-dried'],
    'Frozen': ['frozen berries','frozen blueberries','frozen mixed berries','frozen peaches','frozen mango','riced cauliflower','frozen'],
    'Spices & Oils': ['olive oil','cumin','chili powder','garlic powder','oregano','cinnamon','paprika','red pepper flakes','italian seasoning','salt','pepper','cayenne','turmeric','nutmeg','vanilla','honey','maple syrup','soy sauce','hot sauce','vinegar','sesame oil','teriyaki','ketchup','balsamic','rice vinegar','cornstarch'],
    'Baking & Snacks': ['chocolate','dark chocolate','dark chocolate chips','walnuts','almonds','chia seeds','flaxseed','hemp hearts','cocoa','cacao','almond butter','trail mix','graham crackers','coconut flakes','medjool dates'],
    'Supplements': ['collagen supplement','l-glutamine','mct oil','vital proteins','whey protein','protein powder','collagen']
};

function categorizeIngredient(text) {
    var lower = text.toLowerCase();
    // Skip section headers
    if (lower.indexOf('---') !== -1) return null;
    // Skip prep references
    if (lower.indexOf('from prep') !== -1 || lower.indexOf('from batch') !== -1 || lower.indexOf('from session') !== -1) {
        // Still include but mark it
    }
    // Check each category
    var scores = {};
    Object.keys(GROCERY_CATEGORIES).forEach(function(cat) {
        scores[cat] = 0;
        GROCERY_CATEGORIES[cat].forEach(function(keyword) {
            if (lower.indexOf(keyword) !== -1) {
                scores[cat] += keyword.length; // longer match = more specific
            }
        });
    });
    var best = 'Other';
    var bestScore = 0;
    Object.keys(scores).forEach(function(cat) {
        if (scores[cat] > bestScore) {
            bestScore = scores[cat];
            best = cat;
        }
    });
    return best;
}

function generateGroceryList() {
    // ===== SMART GROCERY LIST GENERATOR v3 =====
    // Uses intelligent ingredient extraction instead of manual alias tables
    // Pipeline: preprocess → extract core item → smart combine → dedup → render
    
    // ── CANONICAL DISPLAY NAMES ──
    // Only needed for preferred display — NOT for matching (matching is automatic)
    var DISPLAY_NAMES = {
        'chicken breast': 'chicken breast',
        'ground turkey': 'ground turkey',
        'greek yogurt': 'Greek yogurt',
        'almond milk': 'almond milk',
        'coconut milk': 'coconut milk',
        'cottage cheese': 'cottage cheese',
        'brown rice': 'brown rice',
        'rolled oats': 'rolled oats',
        'olive oil': 'olive oil',
        'sesame oil': 'sesame oil',
        'baby spinach': 'baby spinach',
        'chia seeds': 'chia seeds',
        'hemp hearts': 'hemp hearts',
        'black beans': 'black beans',
        'cannellini beans': 'cannellini beans',
        'marinara sauce': 'marinara sauce',
        'enchilada sauce': 'enchilada sauce',
        'chicken broth': 'chicken broth',
        'dark chocolate chips': 'dark chocolate chips',
        'sun dried tomatoes': 'sun-dried tomatoes',
        'roasted red peppers': 'roasted red peppers',
        'green onions': 'green onions',
        'bell pepper': 'bell pepper',
        'sweet potato': 'sweet potato'
    };

    // ── MERGE RULES: items that should combine even though core extraction differs ──
    // Maps alternate core forms → canonical core form
    var MERGE_MAP = {
        // Produce
        'spinach': 'baby spinach',
        'apple': 'apples', 'apples': 'apples',
        'banana': 'bananas', 'bananas': 'bananas',
        'carrot': 'carrots', 'carrots': 'carrots',
        'lemon': 'lemons', 'lemons': 'lemons',
        'lime': 'limes', 'limes': 'limes',
        'onion': 'onion', 'yellow onion': 'onion',
        'scallions': 'green onions', 'scallion': 'green onions', 'green onion': 'green onions',
        'cucumber': 'cucumber', 'english cucumber': 'cucumber',
        'broccoli': 'broccoli', 'broccolini': 'broccoli', 'broccoli florets': 'broccoli',
        'cauliflower': 'cauliflower', 'cauliflower florets': 'cauliflower', 'riced cauliflower': 'cauliflower',
        'sweet potato': 'sweet potato', 'sweet potatoes': 'sweet potato',
        'bell pepper': 'bell pepper', 'bell peppers': 'bell pepper', 'red bell pepper': 'bell pepper', 'green bell pepper': 'bell pepper',
        'strawberries': 'strawberries', 'strawberry': 'strawberries',
        'blueberries': 'blueberries', 'blueberry': 'blueberries',
        'raspberries': 'raspberries', 'raspberry': 'raspberries',
        'peaches': 'frozen peaches', 'peach': 'frozen peaches',
        'mango': 'frozen mango', 'mango chunks': 'frozen mango',
        'date': 'medjool dates', 'dates': 'medjool dates', 'medjool date': 'medjool dates',
        'basil': 'fresh basil', 'parsley': 'fresh parsley',
        'ginger': 'fresh ginger',
        'cabbage': 'cabbage',
        'zucchini': 'zucchini',
        'arugula': 'arugula',
        'romaine': 'romaine lettuce', 'lettuce': 'romaine lettuce',
        // Protein
        'chicken': 'chicken breast', 'chicken thighs': 'chicken breast', 'chicken breast cutlet': 'chicken breast',
        'ground turkey': 'ground turkey', 'turkey': 'ground turkey',
        'egg': 'eggs', 'eggs': 'eggs',
        'chicken sausage': 'chicken sausage', 'sausage': 'chicken sausage',
        'tuna': 'canned tuna',
        // Dairy
        'yogurt': 'greek yogurt', 'greek yogurt': 'greek yogurt',
        'feta': 'feta cheese', 'feta cheese': 'feta cheese',
        'parmesan': 'parmesan cheese', 'parmesan cheese': 'parmesan cheese',
        'mozzarella': 'mozzarella cheese', 'mozzarella cheese': 'mozzarella cheese',
        'ricotta': 'ricotta cheese', 'ricotta cheese': 'ricotta cheese',
        'cottage cheese': 'cottage cheese',
        'almond milk': 'almond milk',
        'coconut milk': 'coconut milk',
        'butter': 'butter',
        'cream cheese': 'cream cheese',
        'sour cream': 'sour cream',
        'cheese': 'shredded cheese', 'shredded cheese': 'shredded cheese', 'mexican blend cheese': 'shredded cheese',
        // Grains
        'oats': 'rolled oats', 'rolled oats': 'rolled oats',
        'rice': 'brown rice', 'brown rice': 'brown rice', 'white rice': 'brown rice',
        'tortilla': 'tortillas', 'tortillas': 'tortillas', 'flour tortillas': 'tortillas',
        'pasta': 'protein pasta', 'whole wheat pasta': 'protein pasta', 'whole wheat penne': 'protein pasta',
        'whole wheat spaghetti': 'protein pasta', 'protein spaghetti': 'protein pasta',
        'spaghetti': 'protein pasta', 'penne': 'protein pasta',
        'orzo': 'orzo pasta',
        'farro': 'farro',
        'quinoa': 'quinoa',
        // Canned & Jarred
        'black beans': 'black beans',
        'white beans': 'cannellini beans', 'cannellini beans': 'cannellini beans', 'great northern beans': 'cannellini beans',
        'chickpeas': 'chickpeas',
        'marinara': 'marinara sauce', 'marinara sauce': 'marinara sauce', 'tomato sauce': 'marinara sauce',
        'broth': 'chicken broth', 'chicken broth': 'chicken broth',
        'enchilada sauce': 'enchilada sauce',
        'roasted red peppers': 'roasted red peppers', 'roasted red pepper strips': 'roasted red peppers',
        'sun-dried tomatoes': 'sun-dried tomatoes', 'sun dried tomatoes': 'sun-dried tomatoes',
        'corn': 'corn', 'frozen corn': 'corn',
        'chipotle peppers': 'chipotle peppers in adobo', 'chipotle in adobo': 'chipotle peppers in adobo',
        // Oils & Sauces
        'olive oil': 'olive oil', 'extra virgin olive oil': 'olive oil',
        'sesame oil': 'sesame oil',
        'soy sauce': 'soy sauce',
        'teriyaki sauce': 'teriyaki sauce',
        'alfredo sauce': 'alfredo sauce',
        'hot sauce': 'hot sauce', 'sriracha': 'hot sauce',
        'honey': 'honey',
        'maple syrup': 'maple syrup', 'pure maple syrup': 'maple syrup',
        'rice vinegar': 'rice vinegar', 'rice wine vinegar': 'rice vinegar',
        'balsamic vinegar': 'balsamic vinegar',
        'ketchup': 'ketchup',
        'salsa': 'salsa',
        'hummus': 'hummus',
        // Baking & Snacks
        'chocolate chips': 'dark chocolate chips', 'dark chocolate': 'dark chocolate chips', 'dark chocolate chips': 'dark chocolate chips',
        'walnuts': 'walnuts', 'walnut': 'walnuts',
        'chia seeds': 'chia seeds', 'chia': 'chia seeds',
        'hemp hearts': 'hemp hearts',
        'coconut flakes': 'toasted coconut flakes',
        'graham crackers': 'graham crackers',
        'cornstarch': 'cornstarch',
        // Supplements (keep separate from food)
        'collagen': 'collagen supplement', 'vital proteins collagen': 'collagen supplement', 'vital proteins chocolate collagen': 'collagen supplement',
        'banana cream whey': 'whey protein', 'whey': 'whey protein', 'whey protein': 'whey protein', 'protein powder': 'whey protein',
        'l-glutamine': 'L-glutamine',
        'mct oil': 'MCT oil',
        'cacao powder': 'cacao powder', 'cocoa powder': 'cacao powder'
    };

    // ── STEP 1: INTELLIGENT LINE CLASSIFICATION ──
    // Returns [] if line is NOT a grocery item, otherwise returns array of cleaned items
    function preprocessLine(text) {
        if (!text || typeof text !== 'string') return [];
        text = text.trim();
        if (!text) return [];
        
        var lower = text.toLowerCase();
        
        // === DEFINITE NON-ITEMS (structural, instructional, empty) ===
        // Headers and dividers
        if (text.match(/[═━─]{2,}/) || text.indexOf('===') !== -1 || text.indexOf('---') !== -1) return [];
        if (text.match(/^[═─━\s]*$/)) return [];
        // Emoji instructions
        if (text.match(/^[\uD800-\uDBFF][\uDC00-\uDFFF]/)) return [];
        // Arrow lines (portioning/allocation)
        if (text.match(/^→/)) return [];
        // Lines that ARE instructions (verb-first)
        if (lower.match(/^(brine|note:|cook|reheat|preheat|brown|whisk|blend|stir|pour|toss|top with|serve|remove|place|season|add to|transfer|drizzle|garnish|soak|save|store|thaw|defrost|rest|let|freeze|label|check|portion|pack|shred|slice|dice|make|mix|start|boil|simmer|roast|bake|sear|heat|cool|chill|wrap|roll|stuff|assemble|combine|fold|knead|spread|layer|arrange|marinate|brush|coat|dip|cover|tent|flip|stir-fry|saute|sauté|grill|broil|steam|poach|reduce|deglaze|caramelize)\b/)) return [];
        // Allocation/routing lines ("Cauliflower → rice for Bolognese")
        if (text.match(/\w+\s*→\s*\w/)) return [];
        // Perishable routing ("Ground turkey (ALL of it) → tonight's...")
        if (lower.indexOf('all of it') !== -1) return [];
        if (lower.indexOf('tonight') !== -1 || lower.indexOf('this morning') !== -1) return [];
        // Day/meal references as standalone items
        if (lower.match(/^(day \d|days \d|week \d)/)) return [];
        // Portioning lines
        if (lower.match(/^k:/i) || (lower.indexOf('k: ') !== -1 && lower.indexOf('c: ') !== -1)) return [];
        if (lower.match(/^k =|^c =/i)) return [];
        // "from prep/session/batch/freezer" references
        if (lower.match(/(from prep|from batch|from session|leftover from|already prepped|from freezer|from the fridge|grab from|from day)/)) return [];
        // Skip lines that describe where food goes, not what to buy
        if (lower.match(/^(that's \d|you'll|this is for|split it|goes into|for tonight|enough for)/)) return [];
        
        // === CLEAN THE LINE ===
        // Handle batch lines FIRST — before dash stripping destroys them
        // "Batch 1 — Raspberry: 1 cup yogurt, 3/4 cup raspberries, walnuts" → extract after colon
        if (text.match(/^Batch\s+\d/i)) {
            var colonIdx = text.indexOf(':');
            if (colonIdx !== -1) text = text.substring(colonIdx + 1).trim();
            else return [];
        }
        // Strip ALL parentheticals — grocery items never have useful info inside parens
        text = text.replace(/\([^)]*\)/g, '');
        // Handle unclosed parens (from split lines) — strip from open paren onward
        text = text.replace(/\(.*$/, '');
        // Strip trailing dashes with instructions — everything after em-dash is a note
        text = text.replace(/\s*—\s*.*$/gi, '');
        text = text.replace(/\s*--\s*.*$/gi, '');
        text = text.trim();
        if (!text) return [];
        
        // === SPLIT MULTI-ITEM LINES ===
        var items = [];
        
        // Split on " + " (e.g., "1 bell pepper + 1 onion")
        if (text.indexOf(' + ') !== -1 && !text.match(/\d+\s*\+\s*\d+\s*(cup|oz|lb|tbsp|tsp)/)) {
            text.split(/\s*\+\s*/).forEach(function(p) { if (p.trim()) items.push(p.trim()); });
            return items;
        }
        
        // Handle "X or Y" — it's a choice, just use first option
        // "Broccoli or Green Beans" → "Broccoli"
        // But NOT "1/2 cup white or brown rice" (or is mid-description)
        if (text.match(/\b or \b/i) && !text.match(/\d+.*\bor\b/)) {
            var orParts = text.split(/\s+or\s+/i);
            if (orParts[0].trim()) items.push(orParts[0].trim());
            return items;
        }
        
        // Smart comma split: only split if BOTH sides look like ingredients
        if (text.indexOf(',') !== -1) {
            var parts = text.split(',').map(function(s) { return s.trim(); }).filter(Boolean);
            if (parts.length >= 2) {
                // Detect if a part is a prep modifier (not a standalone ingredient)
                var isPrepModifier = function(p) {
                    return p.match(/^(sliced|diced|chopped|minced|crushed|grated|shredded|peeled|cored|halved|quartered|cubed|mashed|torn|trimmed|blended|melted|softened|thawed|pressed|toasted|roasted|crumbled|packed|drained|rinsed|divided|sifted|beaten|whisked|warmed|chilled|frozen|dried|smoked|ground|pitted|seeded|deveined|deboned|julienned|zested|broken|cut |into |for |to taste|thinly|thin |at room|room temp|roughly|finely|lightly|well|plus|with skin|skin on|bone in|boneless|skinless|pounded|butterflied|scored|cleaned|washed|soaked|blanched|al dente|cooked|raw|whole|dry|fresh|not dutch|93%)/i);
                };
                
                var realParts = [];
                parts.forEach(function(p, idx) {
                    if (idx > 0 && isPrepModifier(p)) {
                        // This is a modifier for the previous item — skip it
                        return;
                    }
                    realParts.push(p);
                });
                
                if (realParts.length >= 2) {
                    realParts.forEach(function(p) { if (p.trim()) items.push(p.trim()); });
                    return items;
                }
            }
        }
        
        if (text.trim()) items.push(text.trim());
        return items;
    }
    
    // ── STEP 2: EXTRACT CORE INGREDIENT ──
    // "1/2 cup rolled oats, blended into flour" → { qty: 0.5, unit: 'cup', core: 'rolled oats', raw: '...' }
    function extractIngredient(text) {
        text = text.trim();
        if (!text) return null;
        
        // Pre-clean
        var clean = text
            .replace(/^~/, '')
            .replace(/\([^)]*\)/g, '')
            .replace(/,?\s*(or more|or less|optional|to taste|as needed|if desired|for topping|for serving|for dipping|on the side|baked in|and more|plus more)\s*/gi, '')
            .trim();
        if (!clean) return null;
        
        // Handle qty-at-end: "Bananas 3-4" → "3-4 Bananas"
        var endQty = clean.match(/^([a-zA-Z][a-zA-Z\s]+?)\s+(\d+[\.\d]*(?:\s*[-–]\s*\d+[\.\d]*)?)$/);
        if (endQty) {
            clean = endQty[2] + ' ' + endQty[1];
        }
        
        // ── Parse quantity ──
        var qty = 0;
        var rest = clean;
        var qtyMatch = clean.match(/^(\d+[\.\d]*(?:\s*[-–]\s*\d+[\.\d]*)?(?:\s*\/\s*\d+)?)\s*(.*)/);
        if (qtyMatch) {
            var qtyStr = qtyMatch[1];
            rest = qtyMatch[2].trim();
            if (qtyStr.indexOf('/') !== -1) {
                var fp = qtyStr.split('/');
                qty = parseFloat(fp[0]) / parseFloat(fp[1]);
            } else if (qtyStr.match(/[-–]/)) {
                var rp = qtyStr.split(/[-–]/);
                qty = (parseFloat(rp[0]) + parseFloat(rp[1])) / 2;
            } else {
                qty = parseFloat(qtyStr);
            }
            if (isNaN(qty)) qty = 1;
        }
        
        // ── Parse unit ──
        var unitMap = {
            'cup': 'cup', 'cups': 'cup', 'c': 'cup',
            'tbsp': 'tbsp', 'tablespoon': 'tbsp', 'tablespoons': 'tbsp',
            'tsp': 'tsp', 'teaspoon': 'tsp', 'teaspoons': 'tsp',
            'oz': 'oz', 'ounce': 'oz', 'ounces': 'oz',
            'lb': 'lb', 'lbs': 'lb', 'pound': 'lb', 'pounds': 'lb',
            'can': 'can', 'cans': 'can',
            'jar': 'jar', 'jars': 'jar',
            'clove': 'clove', 'cloves': 'clove',
            'scoop': 'scoop', 'scoops': 'scoop',
            'slice': 'slice', 'slices': 'slice',
            'medium': 'medium', 'large': 'large', 'small': 'small',
            'bunch': 'bunch', 'head': 'head', 'bag': 'bag',
            'pint': 'pint', 'pints': 'pint',
            'sprig': 'sprig', 'sprigs': 'sprig'
        };
        var unit = '';
        var item = rest;
        var uMatch = rest.match(/^(\w+)\s+(.*)/);
        if (uMatch && unitMap[uMatch[1].toLowerCase()]) {
            unit = unitMap[uMatch[1].toLowerCase()];
            item = uMatch[2];
        }
        item = item.replace(/,\s*$/, '').replace(/^\s*of\s+/i, '').trim();
        
        // ── Extract CORE ingredient name ──
        // Strategy: strip aggressively to get just the purchasable item name
        var core = item;
        
        // FIRST: strip everything after first comma — it's always a prep description
        // "Apple, Cored and Sliced Into Rings" → "Apple"
        // "garlic, minced" → "garlic"
        var commaIdx = core.indexOf(',');
        if (commaIdx > 0) core = core.substring(0, commaIdx);
        
        core = core.toLowerCase().trim();
        
        // Strip "into X" patterns: "banana into 1-inch rounds" → "banana"
        core = core.replace(/\s+into\s+.*/gi, '');
        // Strip "for X" patterns: "chicken for stew" → "chicken"
        core = core.replace(/\s+for\s+.*/gi, '');
        // Strip "or X" alternatives: "chicken breast or thighs" → "chicken breast"
        core = core.replace(/\s+or\s+.*/gi, '');
        // Strip "and X" when it's an alternative: "salt and pepper" etc handled elsewhere
        // But "macaroni and cheese" should stay — only strip if followed by a different food word
        
        // Strip size/state/prep adjectives
        var stripWords = [
            'fresh','frozen','canned','packed','drained','rinsed','raw','cooked','whole',
            'boneless','skinless','unsweetened','nonfat','low-sodium','low sodium',
            'room temperature','softened','melted','thawed','warmed','chilled',
            'dry','dried','mini','ripe','overripe','firm','extra firm',
            'sliced','diced','chopped','minced','crushed','grated','shredded',
            'peeled','cored','halved','quartered','cubed','julienned','mashed',
            'torn','trimmed','crumbled','toasted','roasted','steamed','blanched',
            'sauteed','sautéed','caramelized','charred','grilled','baked','fried',
            'smoked','pickled','deveined','deboned','pitted','seeded','scored',
            'butterflied','pounded','broken','cleaned','washed','soaked',
            'thinly','thin','thick','roughly','finely','lightly',
            'lengthwise','crosswise',
            'prepped','seasoned','cutlet','lean','spicy','plain',
            'italian','similar','optional'
        ];
        stripWords.forEach(function(w) {
            core = core.replace(new RegExp('\\b' + w + '\\b', 'gi'), '');
        });
        
        // Strip brand names
        core = core.replace(/\b(oikos triple zero|kroger|mission carb balance|on gold standard|vital proteins|nature's way|simple truth)\b/gi, '');
        // Strip percentages like "93% lean"
        core = core.replace(/\d+%\s*\w*/g, '');
        // Strip size descriptors when followed by actual item: "1 large sweet potato" - "large" was unit, already handled
        // But sometimes they sneak into the item string
        core = core.replace(/\b(small|medium|large)\b/gi, '');
        
        // Clean up
        core = core.replace(/[^a-z0-9 '-]/g, ' ').replace(/\s+/g, ' ').trim();
        // Strip trailing numbers that leaked through (e.g., "bananas 3" from "bananas 3-4")
        core = core.replace(/\s+\d+[\.\d-]*\s*$/, '').trim();
        // Strip leading/trailing short junk words
        core = core.replace(/^(a|an|the|some|about|approximately)\s+/i, '').trim();
        core = core.replace(/\s+(each|total|approx)$/i, '').trim();
        // Strip trailing "s" normalization is too risky (beans ≠ bean), skip it
        
        if (!core || core.length < 2) return null;
        
        // Apply merge map
        if (MERGE_MAP[core]) core = MERGE_MAP[core];
        
        // Apply display name
        var displayName = DISPLAY_NAMES[core] || core.replace(/\b\w/g, function(c) { return c.toUpperCase(); }).replace(/\b(Of|And|Or|In|On|The|A|An|For|To|With)\b/g, function(w) { return w.toLowerCase(); });
        
        return { qty: qty, unit: unit, core: core, displayName: displayName, raw: text };
    }
    
    // ── STEP 3: SMART CLASSIFICATION ──
    // Is this a purchasable grocery item or something else?
    function isGroceryItem(core) {
        if (!core || core.length < 2) return false;
        if (core.length > 50) return false;
        
        // Not grocery: salt, pepper, water, ice
        if (core.match(/^(salt|pepper|salt pepper|water|ice|cooking spray|pinch|sea salt|kosher salt|warm water|cold water|salt water)$/)) return false;
        
        // Not grocery: cooking instructions that snuck through
        if (core.match(/\b(day \d|stew|bolognese|burrito|wrap|bowl|dinner|lunch|breakfast|dessert|tonight|morning|fridge|freezer|container|label|leftovers?|extra|snack)\b/i)) return false;
        
        // Not grocery: equipment or actions
        if (core.match(/\b(pan|skillet|oven|pot|sheet|foil|parchment|paper towel|jar|container|rack|thermometer|tongs|spatula|knife|cutting board|blender|food processor)\b/i)) return false;
        
        return true;
    }
    
    // Is this a pantry staple spice? (small qty = you already have it)
    function isPantrySpice(core, unit, qty) {
        var spices = ['cumin','chili powder','garlic powder','onion powder','oregano','italian seasoning',
            'cinnamon','paprika','smoked paprika','red pepper flakes','cayenne','nutmeg','thyme',
            'coriander','black pepper','white pepper','baking powder','baking soda','vanilla extract',
            'vanilla','turmeric','cloves','allspice','bay leaf','bay leaves','rosemary','sage',
            'dill','gochujang','worcestershire','dijon','mustard'];
        var isSpice = false;
        spices.forEach(function(s) { if (core.indexOf(s) !== -1) isSpice = true; });
        // Small quantities of spices = pantry staple, skip
        if (isSpice && (qty === 0 || unit === 'tsp' || unit === 'tbsp' || (unit === '' && qty <= 2))) return true;
        return false;
    }
    
    // ── STEP 4: SMART SCALING ──
    function getSmartScale(core, unit, baseScale) {
        if (baseScale === 1) return 1; // prep sessions already scaled
        // Aromatics: minimal increase
        if (unit === 'clove' || core.match(/\b(garlic|ginger|shallot)\b/)) return 1.25;
        // Proteins & grains: double
        if (core.match(/\b(chicken|turkey|beef|salmon|shrimp|fish|egg|sausage|tuna|tofu)\b/)) return 2;
        if (core.match(/\b(rice|oats|pasta|farro|quinoa|orzo|tortilla|bread)\b/)) return 2;
        // Dairy bulk: double
        if (core.match(/\b(yogurt|milk|cottage cheese|ricotta)\b/)) return 2;
        // Produce: double
        if (core.match(/\b(spinach|broccoli|carrot|pepper|sweet potato|zucchini|cucumber|lettuce|arugula|cabbage|corn|cauliflower|bean|tomato|onion|potato)\b/)) return 2;
        // Fruits: double
        if (core.match(/\b(banana|apple|strawberr|blueberr|raspberr|mango|peach|lemon|lime|berries)\b/)) return 2;
        // Canned goods: double
        if (unit === 'can' || core.match(/\b(beans|chickpea|marinara|broth|enchilada|salsa)\b/)) return 2;
        // Cheese: moderate
        if (core.match(/\b(cheese|feta|parmesan|mozzarella)\b/)) return 1.5;
        // Oils, sauces: moderate
        if (core.match(/\b(oil|vinegar|sauce|honey|syrup|butter|ketchup)\b/)) return 1.5;
        if (unit === 'tbsp' || unit === 'tsp') return 1.25;
        // Default
        return 2;
    }
    
    // ── UNIT HELPERS ──
    function toBaseUnit(qty, unit) {
        if (unit === 'lb') return { qty: qty * 16, unit: 'oz' };
        if (unit === 'tsp') return { qty: qty / 3, unit: 'tbsp' };
        if (unit === 'cup') return { qty: qty * 16, unit: 'tbsp' };
        return { qty: qty, unit: unit };
    }
    function convertForDisplay(qty, unit) {
        if (unit === 'oz' && qty >= 16) return { qty: Math.round(qty / 16 * 10) / 10, unit: 'lb' };
        if (unit === 'tbsp' && qty >= 8) return { qty: Math.round(qty / 16 * 4) / 4, unit: 'cup' };
        return { qty: qty, unit: unit };
    }
    function formatQty(qty) {
        if (qty === 0) return '';
        var whole = Math.floor(qty);
        var frac = qty - whole;
        if (frac < 0.1) return whole.toString();
        if (Math.abs(frac - 0.25) < 0.05) return (whole ? whole + ' ' : '') + '\u00BC';
        if (Math.abs(frac - 0.33) < 0.05) return (whole ? whole + ' ' : '') + '\u2153';
        if (Math.abs(frac - 0.5) < 0.05) return (whole ? whole + ' ' : '') + '\u00BD';
        if (Math.abs(frac - 0.67) < 0.05) return (whole ? whole + ' ' : '') + '\u2154';
        if (Math.abs(frac - 0.75) < 0.05) return (whole ? whole + ' ' : '') + '\u00BE';
        return (Math.round(qty * 10) / 10).toString();
    }
    function pluralUnit(unit, qty) {
        if (!unit || qty <= 1) return unit;
        var p = { cup:'cups', can:'cans', lb:'lbs', clove:'cloves', scoop:'scoops', slice:'slices', jar:'jars', bunch:'bunches', head:'heads', bag:'bags', pint:'pints', sprig:'sprigs' };
        return p[unit] || unit;
    }
    
    // ── STEP 5: COMBINE ──
    var combined = {};
    
    function addIngredient(text, baseScale) {
        var parsed = extractIngredient(text);
        if (!parsed) return;
        if (!isGroceryItem(parsed.core)) return;
        if (isPantrySpice(parsed.core, parsed.unit, parsed.qty)) return;
        
        var key = parsed.core;
        var scale = getSmartScale(parsed.core, parsed.unit, baseScale);
        var normalized = (parsed.qty && parsed.unit) ? toBaseUnit(parsed.qty * scale, parsed.unit) : { qty: (parsed.qty || 0) * scale, unit: parsed.unit || '' };
        
        if (!combined[key]) {
            combined[key] = { name: parsed.displayName, qty: normalized.qty, unit: normalized.unit, category: categorizeIngredient(parsed.displayName) };
        } else {
            if (combined[key].unit === normalized.unit) {
                combined[key].qty += normalized.qty;
            } else if (!combined[key].unit && normalized.unit) {
                combined[key].unit = normalized.unit;
                combined[key].qty += normalized.qty;
            } else if (combined[key].unit && !normalized.unit) {
                combined[key].qty += normalized.qty;
            } else {
                var eb = toBaseUnit(combined[key].qty, combined[key].unit);
                var nb = toBaseUnit(normalized.qty, normalized.unit);
                if (eb.unit === nb.unit) {
                    combined[key].qty = eb.qty + nb.qty;
                    combined[key].unit = eb.unit;
                } else {
                    combined[key].qty += normalized.qty;
                }
            }
        }
    }
    
    // ── Detect prepped meals ──
    function isMealPrepped(meal) {
        var all = ((meal.steps || []).join(' ') + ' ' + (meal.tip || '') + ' ' + (meal.ingredients || []).join(' ')).toLowerCase();
        var kw = ['from prep', 'from batch', 'from session', 'grab from fridge', 'grab from the fridge', 'grab from freezer', 'you made this', 'already prepped', 'should already be prepped', 'reheat prepped', 'reheat a portion'];
        for (var i = 0; i < kw.length; i++) { if (all.indexOf(kw[i]) !== -1) return true; }
        if (all.match(/prepped\s+(on|last|\u2014|-)/)) return true;
        return false;
    }
    
    function isMealTotalForTwo(meal) {
        var stepsText = (meal.steps || []).join(' ').toLowerCase();
        var ingText = (meal.ingredients || []).join(' ').toLowerCase();
        if (stepsText.indexOf('plate for two') !== -1) return true;
        if (ingText.indexOf('already prepped & portioned') !== -1) return true;
        return false;
    }
    
    // ===== COLLECT ALL INGREDIENTS =====
    // Use BOTH persons' data for complete grocery list
    var kaseyDays = mealData.kasey.days;
    var charlieDays = mealData.charlie.days;
    
    // 1. Prep session ingredients (scale = 1, already for both people)
    Object.keys(prepSessions).forEach(function(dayKey) {
        prepSessions[dayKey].ingredients.forEach(function(rawLine) {
            preprocessLine(rawLine).forEach(function(item) { addIngredient(item, 1); });
        });
    });
    
    // 2. Kasey's meal ingredients with smart scaling
    kaseyDays.forEach(function(day) {
        day.meals.forEach(function(meal) {
            if (!meal.ingredients || isMealPrepped(meal)) return;
            // Total-for-two meals (PLATE FOR TWO): scale 1. Per-person meals: scale 2.
            var scale = isMealTotalForTwo(meal) ? 1 : 2;
            meal.ingredients.forEach(function(rawLine) {
                preprocessLine(rawLine).forEach(function(item) { addIngredient(item, scale); });
            });
        });
    });
    
    // 2b. Charlie's breakfast extras (his scaled portions need additional ingredients)
    charlieDays.forEach(function(day) {
        day.meals.forEach(function(meal) {
            if (!meal.ingredients || isMealPrepped(meal)) return;
            if (meal.type === 'Breakfast') {
                var adjusted = adjustIngredientsForCharlie(meal.name, meal.ingredients);
                adjusted.forEach(function(rawLine) {
                    if (rawLine.indexOf('---') === 0) return;
                    preprocessLine(rawLine).forEach(function(item) { addIngredient(item, 1); });
                });
            }
        });
    });
    
    // ── STEP 6: POST-COMBINE DEDUP ──
    // Catch near-duplicates that slipped through (e.g., "chicken broth" vs "low-sodium chicken broth")
    var keys = Object.keys(combined);
    for (var i = 0; i < keys.length; i++) {
        if (!combined[keys[i]]) continue;
        for (var j = i + 1; j < keys.length; j++) {
            if (!combined[keys[i]]) break; // outer item got merged away
            if (!combined[keys[j]]) continue;
            var a = keys[i], b = keys[j];
            // If one contains the other, merge into the longer (more specific) one
            if (a.length > 3 && b.length > 3 && (a.indexOf(b) !== -1 || b.indexOf(a) !== -1)) {
                var keep = a.length >= b.length ? a : b;
                var drop = a.length >= b.length ? b : a;
                // Merge quantities if both exist
                if (combined[keep] && combined[drop]) {
                    if (combined[keep].unit === combined[drop].unit) {
                        combined[keep].qty += combined[drop].qty;
                    } else {
                        var kb = toBaseUnit(combined[keep].qty, combined[keep].unit);
                        var db = toBaseUnit(combined[drop].qty, combined[drop].unit);
                        if (kb.unit === db.unit) {
                            combined[keep].qty = kb.qty + db.qty;
                            combined[keep].unit = kb.unit;
                        }
                    }
                }
                delete combined[drop];
            }
        }
    }
    
    // ── STEP 7: FINALIZE & RENDER ──
    var finalItems = [];
    Object.keys(combined).forEach(function(key) {
        if (!combined[key]) return;
        var item = combined[key];
        if (item.qty > 0) {
            var converted = convertForDisplay(item.qty, item.unit);
            item.qty = converted.qty;
            item.unit = converted.unit;
            item.qty = Math.ceil(item.qty * 4) / 4;
        }
        finalItems.push(item);
    });
    
    var grouped = {};
    finalItems.forEach(function(item) {
        var cat = item.category || 'Other';
        if (!grouped[cat]) grouped[cat] = [];
        grouped[cat].push(item);
    });
    
    var categoryOrder = ['Produce', 'Protein', 'Dairy', 'Grains & Bread', 'Canned & Jarred', 'Frozen', 'Spices & Oils', 'Baking & Snacks', 'Supplements', 'Other'];
    
    groceryData = [];
    var totalCount = finalItems.length;
    var html = '<div style="padding:8px 0 4px;opacity:0.5;font-size:0.65rem;text-align:center;">' + totalCount + ' items for both of you across the full plan</div>';
    categoryOrder.forEach(function(cat) {
        if (!grouped[cat] || grouped[cat].length === 0) return;
        var items = grouped[cat];
        items.sort(function(a, b) { return a.name.localeCompare(b.name); });
        
        html += '<div class="grocery-category">';
        html += '<div class="grocery-cat-header" onclick="this.nextElementSibling.style.display=this.nextElementSibling.style.display===\'none\'?\'block\':\'none\'">';
        html += '<h4>' + cat + '</h4>';
        html += '<span>' + items.length + ' items</span>';
        html += '</div>';
        html += '<div class="grocery-cat-items">';
        items.forEach(function(item) {
            var idx = groceryData.length;
            var displayText = '';
            if (item.qty > 0) {
                displayText = formatQty(item.qty) + (item.unit ? ' ' + pluralUnit(item.unit, item.qty) : '') + ' ' + item.name;
            } else {
                displayText = item.name;
            }
            groceryData.push({ text: displayText, checked: false, category: cat });
            html += '<div class="grocery-item" id="gi-' + idx + '" onclick="if(event.target.className!==\'grocery-remove\')toggleGroceryItem(' + idx + ')">';
            html += '<input type="checkbox" onchange="toggleGroceryItem(' + idx + ')">';
            html += '<span>' + displayText + '</span>';
            html += '<button class="grocery-remove" onclick="removeGroceryItem(' + idx + ')">×</button>';
            html += '</div>';
        });
        html += '</div></div>';
    });
    
    document.getElementById('grocery-list-content').innerHTML = html;
    document.getElementById('grocery-send-bar').style.display = 'block';
    document.getElementById('grocery-select-all-bar').style.display = 'block';
}

function toggleGroceryItem(idx) {
    groceryData[idx].checked = !groceryData[idx].checked;
    var el = document.getElementById('gi-' + idx);
    if (el) {
        el.classList.toggle('checked');
        var cb = el.querySelector('input[type="checkbox"]');
        if (cb) cb.checked = groceryData[idx].checked;
    }
}

function removeGroceryItem(idx) {
    var el = document.getElementById('gi-' + idx);
    if (el) el.remove();
    groceryData[idx] = null;
}

function sendGroceryToHomeHub() {
    // Build items from CHECKED items only
    var items = [];
    var categoryOrder = ['Produce', 'Protein', 'Dairy', 'Grains & Bread', 'Canned & Jarred', 'Frozen', 'Spices & Oils', 'Baking & Snacks', 'Supplements', 'Other'];
    
    var checkedCount = groceryData.filter(function(item) { return item && item.checked; }).length;
    if (checkedCount === 0) {
        var btn = document.querySelector('#grocery-send-bar button');
        btn.textContent = '⚠ Select items first!';
        btn.style.background = '#b4828c';
        setTimeout(function() {
            btn.textContent = 'Send Selected to Home Hub';
            btn.style.background = '#a3b899';
        }, 2000);
        return;
    }
    
    categoryOrder.forEach(function(cat) {
        var catItems = groceryData.filter(function(item) {
            return item && item.checked && item.category === cat;
        });
        if (catItems.length > 0) {
            // Add category header
            items.push({ text: '── ' + cat.toUpperCase() + ' ──', completed: false });
            catItems.forEach(function(item) {
                items.push({ text: item.text.replace('(prep) ', ''), completed: false });
            });
        }
    });
    
    // Save to localStorage (same key the index page uses)
    localStorage.setItem('groceries', JSON.stringify(items));
    
    // Also save to Firebase if available
    if (window.db) {
        try {
            var setDoc = window.firestoreImports.setDoc;
            var doc = window.firestoreImports.doc;
            setDoc(doc(window.db, 'groceries', 'data'), { items: items })
                .then(function() { console.log('Groceries synced to Firebase'); })
                .catch(function(e) { console.error('Firebase grocery sync error:', e); });
        } catch(e) {
            console.error('Firebase grocery error:', e);
        }
    }
    
    // Visual feedback
    var btn = document.querySelector('#grocery-send-bar button');
    btn.textContent = '✓ Sent ' + checkedCount + ' items to Home Hub!';
    btn.style.background = '#7d8f76';
    setTimeout(function() {
        btn.textContent = 'Send Selected to Home Hub';
        btn.style.background = '#a3b899';
    }, 2500);
}

function selectAllGrocery() {
    var allChecked = groceryData.every(function(item) { return !item || item.checked; });
    groceryData.forEach(function(item, idx) {
        if (!item) return;
        item.checked = !allChecked;
        var el = document.getElementById('gi-' + idx);
        if (el) {
            if (!allChecked) {
                el.classList.add('checked');
            } else {
                el.classList.remove('checked');
            }
            var cb = el.querySelector('input[type="checkbox"]');
            if (cb) cb.checked = !allChecked;
        }
    });
    var btn = document.querySelector('#grocery-select-all-bar button');
    btn.textContent = allChecked ? 'Select All' : 'Deselect All';
}

function initGenerateView() {
    var startInput = document.getElementById('gen-start-date');
    if (!startInput.value) {
        var latestEnd = new Date(PLAN_START);
        latestEnd.setDate(latestEnd.getDate() + PLAN_DAYS);
        savedPlans.forEach(function(p) {
            var pEnd = new Date(p.startDate + 'T00:00:00');
            pEnd.setDate(pEnd.getDate() + p.days);
            if (pEnd > latestEnd) latestEnd = pEnd;
        });
        startInput.value = latestEnd.toISOString().split('T')[0];
    }
    renderDietTags();
    var tagInput = document.getElementById('diet-tag-input');
    if (tagInput) {
        tagInput.addEventListener('keydown', function(e) {
            if (e.key === 'Enter') { e.preventDefault(); addDietTag(); }
        });
    }
    
    // Dessert: "Skip" unchecks others, and checking others unchecks "Skip"
    var skipEl = document.getElementById('gen-d-skip');
    var otherDesserts = ['gen-d-light', 'gen-d-protein', 'gen-d-treat'];
    if (skipEl && !skipEl._listenerAdded) {
        skipEl.addEventListener('change', function() {
            if (this.checked) {
                otherDesserts.forEach(function(id) { document.getElementById(id).checked = false; });
            }
        });
        skipEl._listenerAdded = true;
    }
    otherDesserts.forEach(function(id) {
        var el = document.getElementById(id);
        if (el && !el._listenerAdded) {
            el.addEventListener('change', function() {
                if (this.checked) skipEl.checked = false;
            });
            el._listenerAdded = true;
        }
    });
}

function getPreviousPlanMeals() {
    // Gather all unique meal names from the current active plan
    var names = {};
    var data = getData();
    if (data && data.days) {
        data.days.forEach(function(day) {
            if (day.meals) {
                day.meals.forEach(function(m) {
                    if (m.name && m.type !== 'Snack') names[m.name] = true;
                });
            }
        });
    }
    var list = Object.keys(names);
    return list.length > 0 ? list.join(', ') : '(none)';
}

function buildSkeletonPrompt(startDate, duration, recipeSummary, opts) {
    // Spice level instruction
    var spiceText = { mild: 'Keep spice levels mild — no hot sauce, minimal red pepper flakes.', medium: 'Medium spice — some heat is good but not every meal.', hot: 'We love spicy food — generous red pepper flakes, hot sauce, chipotle, jalapeño.', extra: 'MAX SPICE — every dinner should have real heat. Chipotle, gochujang, habanero, sriracha, cayenne.' };
    
    // Cuisine labels
    var cuisineLabels = { mediterranean: 'Mediterranean', mexican: 'Mexican/Tex-Mex', asian: 'Asian-inspired', italian: 'Italian', comfort: 'Comfort food', indian: 'Indian', korean: 'Korean', middleeastern: 'Middle Eastern', mixed: 'Mixed variety' };
    var cuisineStr = opts.cuisines.map(function(c) { return cuisineLabels[c] || c; }).join(', ');
    var cuisineInstruction = opts.cuisines.length >= 4 ? 'Wide variety of cuisines including: ' + cuisineStr + '. Mix them throughout the week.' :
        opts.cuisines.length === 1 && opts.cuisines[0] === 'mixed' ? 'Mix cuisines throughout the week — Mediterranean, Mexican, Asian, Italian, comfort food.' :
        'Focus on these cuisines: ' + cuisineStr + '. Distribute them across the plan.';
    
    // Effort level
    var effortText = { quick: 'All dinners must be 20 min or less — one-pot, sheet pan, or assembly meals only.', normal: 'Dinners should be 20-35 min with simple techniques.', involved: 'Dinners can take up to 45 min — stuffed dishes, baked meals, multi-step recipes are fine.' };
    
    // Grocery strategy
    var groceryText = { minimal: 'IMPORTANT: Reuse the same core ingredients across multiple days to minimize the grocery list. Overlap proteins, grains, and produce.', moderate: 'Some ingredient overlap is fine but mix it up enough to keep things interesting.', variety: 'Maximize variety — different proteins, grains, and flavors each day.' };
    
    // Dessert styles
    var dessertLabels = { light: 'light & healthy (under 200 cal, fruit/yogurt based)', protein: 'protein-packed (chia pudding, protein bark, yogurt bowls)', treat: 'real treats (chocolate mousse, baked crumbles, warm brownies, under 300 cal)' };
    var skipDessert = opts.skipDessert;
    var dessertInstruction = '';
    if (skipDessert) {
        dessertInstruction = 'NO desserts. Only Breakfast, Lunch, and Dinner.';
    } else {
        var dessertStyles = opts.desserts.filter(function(d) { return d !== 'skip'; }).map(function(d) { return dessertLabels[d] || d; });
        if (dessertStyles.length > 1) {
            dessertInstruction = 'Mix dessert styles throughout the week: ' + dessertStyles.join('; ') + '.';
        } else if (dessertStyles.length === 1) {
            dessertInstruction = 'Desserts should be ' + dessertStyles[0] + '.';
        } else {
            dessertInstruction = 'Include a light dessert each day — under 200 cal.';
        }
    }
    
    // ── Build prep style instructions from UI settings ──
    var prepText = '';
    if (opts.prepStyle === 'batch') {
        prepText = 'STRUCTURE: Breakfast (batch prep — make once, eat 2-3 days), Lunch (batch prep — cook once, eat 3-4 days), Dinner (fresh cook nightly)' + (skipDessert ? '' : ', Dessert (make one, eat 3-4 nights)') + '\n\n' +
        '--- BATCH PREP RULES ---\n' +
        'BREAKFASTS: Pick only 2-3 breakfast recipes per week. Alternate them so variety feels fresh. Overnight oats and chia puddings keep 3 days. Egg muffins keep 5 days.\n' +
        'LUNCHES: Pick only 2-3 lunch recipes per week. Batch cook protein + grain on prep day, portion into containers. Alternate between them.\n' +
        (skipDessert ? '' : 'DESSERTS: Pick only 2-3 desserts per week. Alternate between them. Puddings, bark, and energy bites keep well.\n') +
        'DINNERS: Different each night (fresh cook), but reuse the same proteins and produce across the week.\n' +
        'The plan should feel like 2 grocery runs and 2 prep sessions per week — not 14 unique cooking days.';
    } else if (opts.prepStyle === 'moderate') {
        prepText = 'STRUCTURE: Breakfast (mix of prepped and fresh), Lunch (batch prep 2-3 days, some fresh), Dinner (fresh cook nightly)' + (skipDessert ? '' : ', Dessert') + '\n\n' +
        'Batch prep some breakfasts and lunches (repeat 2-3 days), but mix in some fresh options too. Dinners are always fresh.';
    } else {
        prepText = 'STRUCTURE: Breakfast, Lunch, Dinner' + (skipDessert ? '' : ', Dessert') + ' — all unique meals, fresh daily.\n\n' +
        'Every meal is different. Maximum variety.';
    }
    
    // Add no-repeat rule if enabled
    if (opts.noRepeat) {
        prepText += '\nABSOLUTE RULE: No meal name should appear on two consecutive days. Always alternate.';
    }
    
    var prompt = 'Generate a ' + duration + '-day meal plan skeleton. Output ONLY meal names and daily totals.\n\n' +
        'TARGETS: Kasey: 140-165g protein, ~1,500-1,700 cal/day. Charlie: 180-210g protein, ~2,200-2,500 cal/day.\n' +
        'RESTRICTIONS: ' + getDietaryRestrictionsForPrompt() + '\n' +
        prepText + '\n\n' +
        '--- PREFERENCES ---\n' +
        (spiceText[opts.spice] || spiceText.hot) + '\n' +
        cuisineInstruction + '\n' +
        (effortText[opts.effort] || effortText.normal) + '\n' +
        (groceryText[opts.groceryRuns] || groceryText.minimal) + '\n' +
        (opts.minimizeWaste ? 'MINIMIZE WASTE: Reuse the same core proteins, produce, and pantry items across multiple meals. Pick recipes that share ingredients (e.g., if Day 1 uses chicken breast and broccoli, use those same ingredients in Days 2-3 too). Limit unique produce items to ~8-10 for the whole plan. Avoid one-off specialty ingredients that will go bad after a single use.\n' : '') +
        dessertInstruction + '\n' +
        (opts.favorFavs ? 'Prioritize FAV recipes from the bank.\n' : '') +
        (opts.prepDays ? 'Mark 2 prep days per week.\n' : '') +
        (opts.newRecipes ? '~70% from bank, ~30% new creative ideas (mark with isNew:true). New recipes should fit the cuisine/spice preferences. Include protein and calories in portion.\n' : 'Use ONLY recipes from bank.\n') +
        (opts.avoidPrevious ? '\nAVOID THESE MEALS — they were in the previous plan and the user wants fresh options:\n' + getPreviousPlanMeals() + '\nDo NOT use any of those meal names. Pick different recipes from the bank or create new ones.\n' : '') +
        (opts.special ? '\nSPECIAL REQUEST FROM USER (follow this closely): ' + opts.special + '\n' : '') +
        '\nRECIPE BANK:\n' + recipeSummary + '\n\n' +
        'START: ' + startDate + ', ' + duration + ' days.\n\n' +
        'Return ONLY a JSON array. No markdown. No backticks. COMPACT format:\n' +
        '[{"day":1,"theme":"Italian","protein":"148g","calories":"1,560","prep":null,' +
        '"meals":[{"type":"Breakfast","name":"Exact Recipe Name From Bank","portion":"42g protein - 420 cal","isNew":false},' +
        '{"type":"Lunch","name":"Name","portion":"38g protein - 450 cal","isNew":false},' +
        '{"type":"Dinner","name":"Name","portion":"48g protein - 520 cal","isNew":false}' +
        (skipDessert ? '' : ',{"type":"Dessert","name":"Name","portion":"8g protein - 150 cal","isNew":false}') +
        ']}]\n\n' +
        'IMPORTANT: Use EXACT recipe names from the bank for bank recipes. Only include type, name, portion, and isNew per meal. Nothing else.';
    
    return prompt;
}


async function callAI(prompt) {
    // ── API ENDPOINT CONFIG ──
    // Set your Cloudflare Worker URL here for published sites.
    // Leave blank to use Claude.ai artifact proxy (only works inside Claude).
    var WORKER_URL = 'https://meal-plan-ai.myreliacare.workers.dev'; // Cloudflare Worker proxy
    
    // Try worker first (works on GitHub Pages), fall back to direct API (works in Claude artifact viewer)
    var response;
    try {
        response = await fetch(WORKER_URL, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                model: 'claude-sonnet-4-20250514',
                max_tokens: 8000,
                system: 'You are a meal plan generator. You ONLY output raw JSON — no markdown, no backticks, no explanation. Just the JSON array.',
                messages: [{ role: 'user', content: prompt }]
            })
        });
    } catch(workerErr) {
        // Worker unreachable (likely in Claude artifact viewer) — try direct API
        try {
            response = await fetch('https://api.anthropic.com/v1/messages', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    model: 'claude-sonnet-4-20250514',
                    max_tokens: 8000,
                    system: 'You are a meal plan generator. You ONLY output raw JSON — no markdown, no backticks, no explanation. Just the JSON array.',
                    messages: [{ role: 'user', content: prompt }]
                })
            });
        } catch(directErr) {
            throw new Error('Could not reach AI service. If on GitHub Pages, check your Cloudflare Worker is deployed. If in Claude, try again. (' + directErr.message + ')');
        }
    }
    
    var rawText;
    try {
        rawText = await response.text();
    } catch(readErr) {
        throw new Error('Could not read API response: ' + readErr.message);
    }
    
    if (!response.ok) {
        // Try to extract a useful error message
        try {
            var errData = JSON.parse(rawText);
            throw new Error('API error (' + response.status + '): ' + (errData.error?.message || rawText.substring(0, 200)));
        } catch(parseErr) {
            if (parseErr.message.indexOf('API error') === 0) throw parseErr;
            throw new Error('API error (' + response.status + '): ' + rawText.substring(0, 200));
        }
    }
    
    var data;
    try {
        data = JSON.parse(rawText);
    } catch(jsonErr) {
        throw new Error('Invalid JSON from API: ' + rawText.substring(0, 200));
    }
    
    if (!data.content || !data.content[0]) {
        throw new Error('Empty response from AI. Try again.');
    }
    
    var text = data.content.map(function(c) { return c.text || ''; }).join('');
    text = text.replace(/```json|```/g, '').trim();
    
    // Try to extract JSON from the response even if there's text around it
    var jsonStart = text.indexOf('[');
    var jsonEnd = text.lastIndexOf(']');
    if (jsonStart === -1 || jsonEnd === -1) {
        // Try object format
        jsonStart = text.indexOf('{');
        jsonEnd = text.lastIndexOf('}');
    }
    if (jsonStart !== -1 && jsonEnd !== -1 && jsonEnd > jsonStart) {
        text = text.substring(jsonStart, jsonEnd + 1);
    }
    
    try {
        return JSON.parse(text);
    } catch(parseErr) {
        // Try to repair truncated JSON (common when response hits token limit)
        // Strategy: find the last complete object in an array
        if (text.charAt(0) === '[') {
            // Try progressively removing from the end to find valid JSON
            var lastGoodClose = text.lastIndexOf('}');
            while (lastGoodClose > 0) {
                var attempt = text.substring(0, lastGoodClose + 1) + ']';
                try {
                    var partial = JSON.parse(attempt);
                    console.warn('Repaired truncated JSON — recovered ' + partial.length + ' items');
                    return partial;
                } catch(e2) {
                    // Find the next } going backwards
                    lastGoodClose = text.lastIndexOf('}', lastGoodClose - 1);
                }
            }
        }
        console.error('AI response text:', text.substring(0, 500));
        throw new Error('Could not parse AI response as JSON. The AI may have returned text instead of data. Try again.');
    }
}

function hydrateSkeletonWithRecipes(skeleton) {
    // Build lookup from recipe bank
    var lookup = {};
    recipeBank.forEach(function(r) {
        lookup[r.name.toLowerCase()] = r;
    });
    
    // Color map for meal types
    var typeColors = {
        'Breakfast': '#a3b899',
        'Lunch': '#c4a882',
        'Dinner': '#b4828c',
        'Dessert': '#a08cb4'
    };
    var typeIcons = {
        'Breakfast': '\u2600\uFE0F',
        'Lunch': '\uD83C\uDF5C',
        'Dinner': '\uD83C\uDF73',
        'Dessert': '\uD83C\uDF53'
    };
    
    return skeleton.map(function(day) {
        day.meals = day.meals.map(function(m) {
            var bankRecipe = lookup[m.name.toLowerCase()];
            
            if (bankRecipe) {
                // Fill from recipe bank
                m.icon = typeIcons[m.type] || '';
                m.color = bankRecipe.color || typeColors[m.type] || '#a3b899';
                m.ingredients = bankRecipe.ingredients || [];
                m.steps = bankRecipe.steps || [];
                m.tip = bankRecipe.tip || '';
                m.portions = bankRecipe.portions || [m.portion];
                if (!m.portion) m.portion = bankRecipe.portion;
            } else {
                // New recipe or unmatched — mark for AI detail pass
                m.icon = typeIcons[m.type] || '';
                m.color = typeColors[m.type] || '#a3b899';
                m.ingredients = m.ingredients || [];
                m.steps = m.steps || [];
                m.tip = m.tip || '';
                m.portions = m.portions || [m.portion];
                m.isNew = true;
                m.needsDetails = true;
            }
            return m;
        });
        return day;
    });
}

async function fillNewRecipeDetails(days, statusEl) {
    // Collect all unique meals that need details
    var newMeals = [];
    days.forEach(function(day) {
        day.meals.forEach(function(m) {
            if (m.needsDetails && !newMeals.some(function(x) { return x.name === m.name; })) {
                newMeals.push({ name: m.name, type: m.type, portion: m.portion });
            }
        });
    });
    
    if (newMeals.length === 0) return days;
    
    // Batch into groups of 3 to avoid truncated responses
    var batches = [];
    for (var i = 0; i < newMeals.length; i += 3) {
        batches.push(newMeals.slice(i, i + 3));
    }
    
    var detailLookup = {};
    
    for (var b = 0; b < batches.length; b++) {
        var batch = batches[b];
        statusEl.innerHTML = '<span class="gen-spinner"></span> Generating new recipes (' + (b + 1) + '/' + batches.length + ')...';
        
        var prompt = 'Create recipe details for these ' + batch.length + ' meals. Anti-cancer Mediterranean focus. RESTRICTIONS: ' + getDietaryRestrictionsForPrompt() + '\n\n' +
            'Meals:\n' + batch.map(function(m, i) { return (i+1) + '. ' + m.name + ' (' + m.type + ', ' + m.portion + ')'; }).join('\n') + '\n\n' +
            'Return ONLY a JSON array with ' + batch.length + ' objects. No backticks. No markdown. Each recipe:\n' +
            '[{"name":"Exact Name","ingredients":["1 cup item","2 tbsp item"],"steps":["Step 1.","Step 2."],"tip":"One sentence health tip.","portions":["42g protein","420 cal","8g fiber","25 min"]}]\n' +
            'Keep ingredients to 8-12 items and steps to 4-6 per recipe. Be concise.';
        
        try {
            var details = await callAI(prompt);
            if (!Array.isArray(details)) details = [details];
            details.forEach(function(d) {
                if (d && d.name) detailLookup[d.name.toLowerCase()] = d;
            });
        } catch(e) {
            console.warn('Batch ' + (b+1) + ' failed:', e.message);
            // Continue with other batches
        }
    }
    
    // Apply details back to days
    var filled = 0;
    var unfilled = 0;
    days.forEach(function(day) {
        day.meals.forEach(function(m) {
            if (m.needsDetails) {
                var detail = detailLookup[m.name.toLowerCase()];
                if (detail) {
                    m.ingredients = detail.ingredients || [];
                    m.steps = detail.steps || [];
                    m.tip = detail.tip || '';
                    m.portions = detail.portions || [m.portion];
                    filled++;
                } else {
                    // Provide placeholder so the meal is still usable
                    m.ingredients = m.ingredients.length ? m.ingredients : ['See recipe name for inspiration'];
                    m.steps = m.steps.length ? m.steps : ['Cook to your liking!'];
                    m.tip = m.tip || 'New recipe — customize to your taste.';
                    m.portions = m.portions.length > 1 ? m.portions : [m.portion];
                    unfilled++;
                }
                delete m.needsDetails;
            }
        });
    });
    
    if (unfilled > 0) {
        statusEl.innerHTML = 'Generated! ' + filled + ' new recipes detailed' + (unfilled > 0 ? ', ' + unfilled + ' need manual details' : '') + '.';
    }
    
    return days;
}

async function generatePlan() {
    var btn = document.getElementById('gen-btn');
    var status = document.getElementById('gen-status');
    var preview = document.getElementById('gen-preview');
    
    btn.disabled = true;
    btn.style.display = 'block';
    status.style.display = 'block';
    preview.style.display = 'none';
    
    // Make sure recipe bank is populated
    if (recipeBank.length === 0) {
        status.innerHTML = '<span class="gen-spinner"></span> Building recipe bank...';
        recipeBank = extractRecipesFromPlan();
        if (recipeBank.length === 0) {
            status.innerHTML = 'Error: No recipes found in the current plan. Cannot generate.';
            btn.disabled = false;
            return;
        }
    }
    
    var startDate = document.getElementById('gen-start-date').value;
    var duration = parseInt(document.getElementById('gen-duration').value);
    // Read multi-select cuisines
    var cuisineIds = ['gen-c-med','gen-c-mex','gen-c-asian','gen-c-ital','gen-c-comfort','gen-c-indian','gen-c-korean','gen-c-me'];
    var cuisines = cuisineIds.map(function(id) {
        var el = document.getElementById(id);
        return el && el.checked ? el.value : null;
    }).filter(Boolean);
    
    // Read multi-select dessert styles
    var dessertIds = ['gen-d-light','gen-d-protein','gen-d-treat','gen-d-skip'];
    var desserts = dessertIds.map(function(id) {
        var el = document.getElementById(id);
        return el && el.checked ? el.value : null;
    }).filter(Boolean);
    
    var opts = {
        favorFavs: document.getElementById('gen-favor-favs').checked,
        newRecipes: document.getElementById('gen-new-recipes').checked,
        noRepeat: document.getElementById('gen-no-repeat').checked,
        avoidPrevious: document.getElementById('gen-avoid-previous').checked,
        prepDays: document.getElementById('gen-prep-days').checked,
        prepStyle: document.getElementById('gen-prep-style').value,
        spice: document.getElementById('gen-spice').value,
        cuisines: cuisines.length > 0 ? cuisines : ['mixed'],
        effort: document.getElementById('gen-effort').value,
        groceryRuns: document.getElementById('gen-grocery-runs').value,
        minimizeWaste: document.getElementById('gen-minimize-waste').checked,
        desserts: desserts,
        skipDessert: desserts.indexOf('skip') !== -1,
        special: (document.getElementById('gen-special').value || '').trim()
    };
    
    var recipeSummary = recipeBank.filter(function(r) { return r.type !== 'Snack'; }).map(function(r) {
        return r.type + ': ' + r.name + ' (' + r.protein + 'g/' + r.calories + 'cal' + 
            (r.favorite ? ' FAV' : '') + ')';
    }).join('\n');
    
    try {
        // Phase 1: Get lightweight skeleton from AI
        status.innerHTML = '<span class="gen-spinner"></span> Planning meals (' + recipeBank.length + ' recipes in bank)...';
        var prompt = buildSkeletonPrompt(startDate, duration, recipeSummary, opts);
        var skeleton = await callAI(prompt);
        
        if (!Array.isArray(skeleton)) {
            if (skeleton.days && Array.isArray(skeleton.days)) skeleton = skeleton.days;
            else throw new Error('Unexpected response format');
        }
        
        // Phase 2: Fill in recipe details from bank
        status.innerHTML = '<span class="gen-spinner"></span> Filling in recipes...';
        var hydrated = hydrateSkeletonWithRecipes(skeleton);
        
        // Phase 3: Get details for any new recipes
        hydrated = await fillNewRecipeDetails(hydrated, status);
        
        var plan = {
            planName: duration + '-Day Anti-Cancer Mediterranean Plan',
            startDate: startDate,
            days: hydrated
        };
        
        status.innerHTML = 'Plan generated! Review below.';
        showPlanPreview(plan);
        
    } catch(e) {
        console.error('Generation error:', e);
        var errorMsg = e.message || 'Unknown error';
        status.innerHTML = '<div style="color:#d4919e;margin-bottom:12px;">⚠ ' + errorMsg + '</div>' +
            '<button class="gen-btn gen-btn-secondary" onclick="generatePlan()" style="width:auto;padding:10px 20px;">Try Again</button>';
        btn.disabled = false;
    }
}

function showPlanPreview(plan) {
    var preview = document.getElementById('gen-preview');
    var btn = document.getElementById('gen-btn');
    preview.style.display = 'block';
    
    var html = '<div class="gen-section"><h3>' + (plan.planName || 'New Meal Plan') + '</h3>';
    
    var sd = new Date(plan.startDate + 'T00:00:00');
    var dayNames = ["Sun","Mon","Tue","Wed","Thu","Fri","Sat"];
    var monthNames = ["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];
    
    plan.days.forEach(function(day) {
        var dayDate = new Date(sd);
        dayDate.setDate(dayDate.getDate() + day.day - 1);
        var dateStr = dayNames[dayDate.getDay()] + ' ' + monthNames[dayDate.getMonth()] + ' ' + dayDate.getDate();
        
        html += '<div class="gen-preview-day">';
        html += '<h4>' + dateStr + ' — ' + day.theme + (day.prep ? '' : '') + '</h4>';
        html += '<div style="font-size:0.65rem;color:rgba(224,210,208,0.35);margin-bottom:6px;">' + day.protein + ' protein • ' + day.calories + ' cal</div>';
        day.meals.forEach(function(m) {
            var newBadge = m.isNew ? ' <span style="color:#a3b899;">NEW</span>' : '';
            html += '<div class="gen-preview-meal">' + m.icon + ' <strong>' + m.name + '</strong>' + newBadge + ' <span style="opacity:0.4;">— ' + m.portion + '</span></div>';
        });
        html += '</div>';
    });
    
    html += '</div>';
    html += '<div style="display:flex;gap:8px;flex-direction:column;">';
    html += '<button class="gen-btn" onclick="acceptPlan()">Use This Plan</button>';
    html += '<button class="gen-btn gen-btn-secondary" onclick="regenPlan()">Regenerate</button>';
    html += '</div>';
    
    preview.innerHTML = html;
    btn.disabled = false;
    btn.style.display = 'none';
    
    window._pendingPlan = plan;
}

function regenPlan() {
    document.getElementById('gen-btn').style.display = 'block';
    document.getElementById('gen-preview').style.display = 'none';
    generatePlan();
}

async function regenWeek(weekNum) {
    var startDay = weekNum === 1 ? 1 : 8;
    var endDay = weekNum === 1 ? 7 : 14;
    var weekLabel = 'Week ' + weekNum;
    
    if (!confirm('Regenerate ' + weekLabel + '? This will replace Days ' + startDay + '–' + endDay + ' with new meals.')) return;
    
    // Collect meals from the OTHER week (both persons, avoid repeating them)
    var otherWeekMeals = [];
    [mealData.kasey.days, mealData.charlie.days].forEach(function(days) {
        if (!days) return;
        days.forEach(function(day) {
            if ((weekNum === 1 && day.day > 7) || (weekNum === 2 && day.day <= 7)) {
                if (day.meals) day.meals.forEach(function(m) {
                    if (m.name && m.type !== 'Snack' && otherWeekMeals.indexOf(m.name) === -1) {
                        otherWeekMeals.push(m.name);
                    }
                });
            }
        });
    });
    
    // Build recipe summary
    var recipeSummary = recipeBank.filter(function(r) { return r.type !== 'Snack'; }).map(function(r) {
        return r.type + ': ' + r.name + ' (' + r.protein + 'g/' + r.calories + 'cal' + (r.favorite ? ' FAV' : '') + ')';
    }).join('\n');
    
    // Get current settings from generate page
    var spice = document.getElementById('gen-spice').value;
    var effort = document.getElementById('gen-effort').value;
    var prepStyle = document.getElementById('gen-prep-style').value;
    var minimizeWaste = document.getElementById('gen-minimize-waste').checked;
    var noRepeat = document.getElementById('gen-no-repeat').checked;
    
    // Get start date for this week
    var weekStart = getDateForPlanDay(startDay);
    var startDate = weekStart.getFullYear() + '-' + String(weekStart.getMonth() + 1).padStart(2, '0') + '-' + String(weekStart.getDate()).padStart(2, '0');
    
    // Build a mini opts object
    var opts = {
        spice: spice, effort: effort, prepStyle: prepStyle,
        minimizeWaste: minimizeWaste, noRepeat: noRepeat,
        cuisines: ['mediterranean', 'mexican', 'italian'],
        favorFavs: true, prepDays: true, newRecipes: true,
        skipDessert: false, desserts: ['light', 'protein'],
        special: '', avoidPrevious: true
    };
    
    // Show a status overlay
    var statusEl = document.getElementById('gen-status');
    statusEl.style.display = 'block';
    statusEl.innerHTML = '<span class="gen-spinner"></span> Regenerating ' + weekLabel + '...';
    switchTab('generate');
    
    try {
        var avoidList = otherWeekMeals.length > 0 ? otherWeekMeals.join(', ') : getPreviousPlanMeals();
        
        var prompt = buildSkeletonPrompt(startDate, 7, recipeSummary, opts);
        // Inject avoid list
        prompt = prompt.replace('START: ' + startDate, 'AVOID THESE MEALS (from the other week): ' + avoidList + '\nDo NOT reuse any of those.\n\nSTART: ' + startDate);
        // Fix day numbering to be 1-7
        prompt = prompt.replace('7-day meal plan', '7-day meal plan (this is ' + weekLabel + ' of a 2-week plan)');
        
        var skeleton = await callAI(prompt);
        if (!Array.isArray(skeleton)) {
            if (skeleton.days && Array.isArray(skeleton.days)) skeleton = skeleton.days;
            else throw new Error('Unexpected response format');
        }
        
        // Renumber days to match week position
        skeleton.forEach(function(day, i) {
            day.day = startDay + i;
        });
        
        // Hydrate with recipe bank
        statusEl.innerHTML = '<span class="gen-spinner"></span> Filling in recipes...';
        var hydrated = hydrateSkeletonWithRecipes(skeleton);
        hydrated = await fillNewRecipeDetails(hydrated, statusEl);
        
        // Replace days in current plan
        var plan = savedPlans[currentPlanIndex];
        var kaseyData = mealData.kasey.days;
        var charlieData = mealData.charlie.days;
        
        var CHARLIE_PROTEIN_MULT = 1.3;
        var CHARLIE_CAL_MULT = 1.4;
        
        hydrated.forEach(function(newDay) {
            var idx = newDay.day - 1;
            
            var kaseyDay = {
                day: newDay.day, theme: newDay.theme, protein: newDay.protein, calories: newDay.calories,
                prep: newDay.prep || null,
                meals: newDay.meals.map(function(m) {
                    return { type: m.type, icon: m.icon, name: m.name, portion: m.portion,
                        color: m.color || '#a3b899', ingredients: m.ingredients, steps: m.steps,
                        tip: m.tip, portions: m.portions };
                })
            };
            
            // Build Charlie's version
            var charlieDay = JSON.parse(JSON.stringify(kaseyDay));
            var kProtein = parseInt(kaseyDay.protein); var kCal = parseInt(kaseyDay.calories.replace(",", ""));
            charlieDay.protein = Math.round(kProtein * CHARLIE_PROTEIN_MULT) + "g";
            charlieDay.calories = (Math.round(kCal * CHARLIE_CAL_MULT / 100) * 100).toLocaleString();
            charlieDay.meals = charlieDay.meals.map(function(m) {
                var origProtein = parseInt(m.portion); var calM = m.portion.match(/(\d+) cal/); var origCal = calM ? parseInt(calM[1]) : 0;
                if (!isNaN(origProtein) && origCal > 0) {
                    m.portion = Math.round(origProtein * CHARLIE_PROTEIN_MULT) + "g protein - " + Math.round(origCal * CHARLIE_CAL_MULT) + " cal";
                }
                return m;
            });
            
            kaseyData[idx] = kaseyDay;
            charlieData[idx] = charlieDay;
            
            // Add new recipes to bank
            newDay.meals.forEach(function(m) {
                if (m.isNew) {
                    var exists = recipeBank.some(function(r) { return r.name === m.name; });
                    if (!exists) {
                        var pm = m.portion.match(/(\d+)g protein/); var cm = m.portion.match(/(\d+)\s*cal/);
                        recipeBank.push({
                            id: 'r_ai_' + Math.random().toString(36).substr(2,8),
                            name: m.name, type: m.type,
                            protein: pm ? parseInt(pm[1]) : 0, calories: cm ? parseInt(cm[1]) : 0,
                            prepTime: 0, ingredients: m.ingredients, steps: m.steps,
                            tip: m.tip, portion: m.portion, portions: m.portions,
                            color: m.color || '#a3b899',
                            cuisineTags: guessCuisine(m.name, m.ingredients),
                            favorite: false, timesUsed: 1, source: 'ai-generated'
                        });
                    }
                }
            });
        });
        
        // Update plan data
        plan.kaseyDays = kaseyData;
        plan.charlieDays = charlieData;
        
        saveRecipeBankToFirebase();
        saveAllPlansToFirebase();
        
        statusEl.innerHTML = '<div style="color:#a3b899;font-weight:700;">✓ ' + weekLabel + ' regenerated!</div>';
        
        setTimeout(function() {
            switchTab('plan');
            selectDay(startDay);
            render();
            statusEl.style.display = 'none';
        }, 800);
        
    } catch(e) {
        console.error('Regen error:', e);
        statusEl.innerHTML = '<div style="color:#d4919e;">⚠ ' + (e.message || 'Unknown error') + '</div>' +
            '<button class="gen-btn gen-btn-secondary" onclick="regenWeek(' + weekNum + ')" style="width:auto;padding:10px 20px;margin-top:8px;">Try Again</button>';
    }
}

function acceptPlan() {
    var plan = window._pendingPlan;
    if (!plan || !plan.days || plan.days.length === 0) {
        alert('No plan to save. Try generating again.');
        return;
    }
    
    // Build Kasey's days
    var kaseyDays = plan.days.map(function(d) {
        return {
            day: d.day, theme: d.theme, protein: d.protein, calories: d.calories,
            prep: d.prep || null,
            meals: d.meals.map(function(m) {
                return { type: m.type, icon: m.icon, name: m.name, portion: m.portion,
                    color: m.color || '#a3b899', ingredients: m.ingredients, steps: m.steps,
                    tip: m.tip, portions: m.portions };
            })
        };
    });
    
    // Build Charlie's scaled meals (Kasey ~1350cal/140-165g → Charlie ~2300cal/180-210g)
    var CHARLIE_PROTEIN_MULT = 1.3;
    var CHARLIE_CAL_MULT = 1.4;
    var charlieDays = kaseyDays.map(function(day) {
        var cDay = JSON.parse(JSON.stringify(day));
        var kProtein = parseInt(day.protein); var kCal = parseInt(day.calories.replace(",", ""));
        cDay.protein = Math.round(kProtein * CHARLIE_PROTEIN_MULT) + "g";
        cDay.calories = (Math.round(kCal * CHARLIE_CAL_MULT / 100) * 100).toLocaleString();
        cDay.meals = cDay.meals.map(function(m) {
            var origProtein = parseInt(m.portion); var calM = m.portion.match(/(\d+) cal/); var origCal = calM ? parseInt(calM[1]) : 0;
            if (isNaN(origProtein) || origCal === 0) return m;
            m.portion = Math.round(origProtein * CHARLIE_PROTEIN_MULT) + "g protein - " + Math.round(origCal * CHARLIE_CAL_MULT) + " cal";
            m.portions = m.portions.map(function(p) {
                if (p.indexOf("protein") !== -1) return Math.round(origProtein * CHARLIE_PROTEIN_MULT) + "g protein";
                if (p.indexOf("cal") !== -1) return Math.round(origCal * CHARLIE_CAL_MULT) + " cal";
                if (p.indexOf("fiber") !== -1) return Math.round(parseInt(p) * 1.2) + "g fiber";
                return p;
            });
            if (m.type === "Dinner" && m.tip) m.tip += "\n\nCHARLIE: Add extra protein (side of chicken/eggs) and larger grain portions to hit your targets.";
            return m;
        });
        return cDay;
    });
    
    // Create date label
    var sd = new Date(plan.startDate + 'T00:00:00');
    var ed = new Date(sd); ed.setDate(ed.getDate() + plan.days.length - 1);
    var mo = SHORT_MONTHS;
    var label = mo[sd.getMonth()] + ' ' + sd.getDate() + '\u2013' + (sd.getMonth() === ed.getMonth() ? '' : mo[ed.getMonth()] + ' ') + ed.getDate();
    
    // Add new plan to saved plans
    var newPlan = {
        id: 'plan_' + Date.now(),
        label: label,
        startDate: plan.startDate,
        days: plan.days.length,
        kaseyDays: kaseyDays,
        charlieDays: charlieDays
    };
    savedPlans.push(newPlan);
    
    // Add new recipes to bank
    plan.days.forEach(function(day) {
        day.meals.forEach(function(m) {
            if (m.isNew) {
                var exists = recipeBank.some(function(r) { return r.name === m.name; });
                if (!exists) {
                    var pm = m.portion.match(/(\d+)g protein/); var cm = m.portion.match(/(\d+)\s*cal/);
                    recipeBank.push({
                        id: 'r_ai_' + Math.random().toString(36).substr(2,8),
                        name: m.name, type: m.type,
                        protein: pm ? parseInt(pm[1]) : 0, calories: cm ? parseInt(cm[1]) : 0,
                        prepTime: 0, ingredients: m.ingredients, steps: m.steps,
                        tip: m.tip, portion: m.portion, portions: m.portions,
                        color: m.color || '#a3b899',
                        cuisineTags: guessCuisine(m.name, m.ingredients),
                        favorite: false, timesUsed: 1, source: 'ai-generated'
                    });
                }
            }
        });
    });
    saveRecipeBankToFirebase();
    saveAllPlansToFirebase();
    
    // Switch to the new plan
    document.getElementById('gen-btn').style.display = 'block';
    document.getElementById('gen-btn').disabled = false;
    document.getElementById('gen-preview').style.display = 'none';
    document.getElementById('gen-status').innerHTML = '<div style="color:#a3b899;font-weight:700;">✓ Plan saved! Switching to it now...</div>';
    window._pendingPlan = null; // prevent double-accept
    
    setTimeout(function() {
        switchPlan(savedPlans.length - 1);
        switchTab('plan');
        document.getElementById('gen-status').style.display = 'none';
    }, 800);
}

// Init recipe bank on load
initRecipeBank();

// URL param support: ?day=X jumps to that day
(function() {
 var params = new URLSearchParams(window.location.search);
 var dayParam = parseInt(params.get('day'));
 if (dayParam && dayParam >= 1 && dayParam <= PLAN_DAYS) {
 currentDay = dayParam;
 selectDay(currentDay);
 }
})();
</script>

<script type="module">
import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
import { getFirestore, doc, setDoc, getDoc } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

try {
    const firebaseConfig = {
        apiKey: "AIzaSyCDda9sPwSY-RQ5rrM5THOvcLtHvcPRYd4",
        authDomain: "our-habit-hub.firebaseapp.com",
        projectId: "our-habit-hub",
        storageBucket: "our-habit-hub.firebasestorage.app",
        messagingSenderId: "78555830496",
        appId: "1:78555830496:web:3e457e54729cc11b825885"
    };
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    window.db = db;
    window.firestoreImports = { doc, setDoc, getDoc };
    window.fbReady = true;
    
    // Reload data now that Firebase is ready
    if (typeof window.initRecipeBank === 'function') window.initRecipeBank();
    if (typeof window.loadAllPlansFromFirebase === 'function') {
        window.loadAllPlansFromFirebase(function() {
            if (typeof window.renderPlanSelector === 'function') window.renderPlanSelector();
        });
    }
    if (typeof window.loadDayNotesFromFirebase === 'function') window.loadDayNotesFromFirebase();
} catch(e) {
    console.log('Firebase init failed, using localStorage fallback', e);
}
</script>
</body>
</html>
